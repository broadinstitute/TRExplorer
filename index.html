<!DOCTYPE html>
<html>

<head>
<title>TRExplorer</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2"></script>

<!-- script src="https://storage.googleapis.com/tgg-viewer/igv.js-bw2/dist/igv.min.js?version=2024-08-06"></script -->
<script src="https://cdn.jsdelivr.net/npm/igv@3.4.0/dist/igv.min.js"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6R8FPBQRFH"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-6R8FPBQRFH');
</script>

<style>
    body {
        padding: 0;
        margin: 0;
        overflow-x: auto;  /* Enable horizontal scrolling for the entire page */
        min-width: 1000px; /* Set a minimum width to prevent content from becoming too narrow */
    }

    #header-stripe {
        background-color: #1b1c1d;
        color: white;
        text-decoration: none;
        padding-top: 20px;
        padding-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }


    #header-title a {
        color: white;
        font-size: 22px;
        font-family: 'Arial Narrow Bold', sans-serif;
        white-space: nowrap;
        font-weight: 700;
        vertical-align: middle;
    }

    #header-title a:hover {
        color: rgba(255, 255, 255, 0.9);
    }

    #header-nav {
        display: flex;
        justify-content: right;
        vertical-align: middle;
        gap: 1.5em;
        font-size: 1.15em;
        font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
    }

    #header-nav a {
        color: rgba(255, 255, 255, 0.9);
        transition: color 0.2s;
    }

    #header-nav a:hover {
        color: white;
    }

    #github-icon {
        font-size: 1.3em;
    }

    /* IGV.js styles */
    #igv-row {
        display: none;
        margin-left: 20px;
        margin-right: 20px;
    }

    #advanced-search-form .checkbox {
        padding-right: 20px;
    }

    .igv-checkbox-container-table td {
        padding: 0px !important;
        width: 100%;
        border-top-width: 0px !important;
    }

    .igv-checkbox-container-header-row {
        padding: 7px 0px 7px 0px !important;
        border: 0px;
    }
    .igv-track-selection-table {
        border: 0px !important;
        padding: 0px;
    }

    .igv-track-selection-table td {
        vertical-align: top;
    }

    .igv-track-selection-table th {
        background: white;
    }

    .igv-number-of-loci-column {
        text-align: right !important;
        white-space: nowrap;
    }

    .igv-track-checkbox {
        margin-right: 15px;
        margin-bottom: 10px;
        display: block;
    }

    .question, .disease-associated-icon {
        margin-left: 10px;
        cursor: pointer;
    }

    .igv-row-sidebar-title {
        font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
        font-size: 18px;
        font-weight: 700;
    }

    .igv-row-sidebar-text {
        display: block;
        font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
        font-size: 14px;
    }

    #show-igv-divider {
        text-align: center;
        margin: 1.5em 0;
        position: relative;
        cursor: pointer;
    }

    #show-igv-divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        border-top: 1px solid #ddd;
        z-index: 0;
    }

    #show-igv-divider span {
        position: relative;
        display: inline-block;
        background-color: white;
        padding: 0 15px;
        color: #1a3c6d;
        font-weight: 500;
        font-size: 0.95em;
        z-index: 1;
        transition: color 0.2s;
    }

    #show-igv-divider:hover span {
        color: #2185d0;
    }

    #show-igv-divider i {
        font-size: 0.8em;
        margin-left: 5px;
        transition: transform 0.2s;
    }

    .info-font-size {
        font-size: 1.12em;
    }

    #search-query {
        margin-right: 5px;
        border: 1px solid rgba(34, 36, 38, 0.15) !important;
        border-radius: 4px !important;
    }

    #filter-button {
        border-radius: 4px !important;
        margin-right: 10px;
    }

    #filter-button .chevron.icon {
        margin-left: 2px;
    }

    #filter-button .chevron.icon.rotated {
        transform: rotate(90deg);
    }

    #filter-button:hover {
        background-color: #f8f8f8 !important;
    }

    #search-button {
        border-radius: 4px !important;
    }

    /* Results table */
    #results-table {
        margin-top: 1em;
        position: relative;  /* Add this to establish a positioning context */
    }

    #results-table.loading {
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    #results-table table.ui.table {
        border-left: none;
        border-right: none;
    }

    #results-table table.ui.table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: white;  /* Ensure header has solid background */
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);  /* Add subtle shadow for depth */
    }

    #results-table table.ui.table th,
    #results-table table.ui.table td {
        border-left: none;
        border-right: none;
    }

    #results-table table.ui.table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    #results-table table.ui.table tr:nth-child(odd) {
        background-color: white;
    }

    #results-table table.ui.table tr:hover {
        background-color: #e6f0ff;
    }

    #results-table table.ui.table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .show-popup {
        cursor: pointer;
    }

    /* Loading indicators */
    .ui.loader {
        margin-top: 2em;
    }

    #loading-container {
        background: white;
        padding: 0.5em 0;
        margin-top: 3.7em;
        margin-bottom: 1em;
        border-radius: 4px;
        height: 40px;
    }

    .loading-indicator {
        display: flex;
        align-items: center;
        color: #888;
        font-size: 1.1em;
        font-weight: 300;
        height: 100%;
    }

    .disease-associated-row {
        background-color: #ffdddd !important;
    }

    .disease-associated-row:hover {
        background-color: #eae9fc !important;
    }

    .loading-indicator .ui.loader {
        margin: 0;
        margin-right: 20px;
    }

    /* Pagination */
    .top-pagination {
        margin-top: 2.5em !important;
    }

    .pagination-container {
        margin-top: 1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        gap: 1em;
        flex-wrap: wrap;
    }

    .total-results {
        color: #666;
        font-size: 1.1em;
        white-space: nowrap;
        margin-right: 1em;
        order: 1;
    }

    .export-selector {
        display: flex;
        align-items: center;
        gap: 0.5em;
        color: #666;
        font-size: 1em;
        white-space: nowrap;
        order: 2;
        flex-grow: 1;
    }

    /* Make export dropdown menu tall enough to show all options */
    .export-selector .ui.selection.dropdown .menu {
        max-height: none !important;
    }

    .page-size-selector {
        display: flex;
        align-items: center;
        gap: 0.5em;
        color: #666;
        font-size: 1em;
        white-space: nowrap;
        order: 3;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        order: 4;
    }

    .pagination-controls .ui.button {
        padding: 8px;
        min-width: 36px;
        background: white;
        border: 1px solid #ddd;
        box-shadow: none;
    }

    .pagination-controls .ui.button:hover {
        background: #f8f8f8;
    }

    .pagination-controls .ui.button.disabled {
        opacity: 0.5;
        background: white;
    }

    .page-input-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0 4px;
        white-space: nowrap;
    }

    .page-input-container input {
        width: 60px;
        height: 36px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px;
    }

    .page-input-container .total-pages {
        color: #666;
    }

    /* Responsive adjustments */
    @media screen and (max-width: 1030px) {
        .page-grid-margin {
            max-width: 20px !important;
            width: 20px !important;
        }
    }

    @media screen and (max-width: 991px) {
        .pagination-container {
            justify-content: flex-start;
        }

        .total-results {
            flex-basis: 100%;
            margin-bottom: 0.5em;
        }

        .export-selector {
            margin: 0;
            margin-right: 1em;
        }
    }

    @media screen and (max-width: 767px) {
        .pagination-container {
            gap: 0.75em;
        }

        .export-selector, .page-size-selector {
            flex-basis: 100%;
            margin: 0;
        }

        .pagination-controls {
            width: 100%;
            justify-content: center;
        }
    }

    /* Misc UI elements */
    .no-results {
        margin-top: 2em;
        text-align: left;
        color: #888;
        font-size: 1.2em;
    }

    #results-area {
        position: relative;
    }

    .action-cell {
        cursor: pointer;
        color: #2185d0;
        transition: all 0.2s;
    }

    .cell-in-polymorphism-column {
        cursor: pointer;
        color: #2185d0;
    }

    .action-link {
        color: #2185d0;
        cursor: pointer;
        border-bottom: 1px dotted #2185d0;
        transition: all 0.2s;
    }

    .action-link:hover {
        opacity: 0.8;
    }

    /* Style for disabled export dropdown */
    .export-selector .ui.selection.dropdown.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Style for disabled export label */
    .export-selector .export-label {
        transition: opacity 0.2s;
    }
    .export-selector .ui.selection.dropdown.disabled + .export-label {
        opacity: 0.5;
    }

    .results-table-column-settings-checkbox-flex-container {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        max-height: calc(11 * 35px);
        gap: 5px 20px;
    }

    .results-table-column-settings-checkbox-item {
        min-width: 200px;
        padding: 5px 0;
    }

    #results-table-column-settings-dialog.ui.modal, #faq-modal.ui.modal, #downloads-modal.ui.modal, #whats-new-modal.ui.modal {
        width: 70% !important;
    }
</style>

<script>
    /** --------- START of utils for dot plots  ---------- */
    const dotPlotGenerateMatrix = (sequence) => {
        const sequenceArray = Array.from(sequence);
        return sequenceArray.map((baseJ) =>
            sequenceArray.map((baseI) => (baseI === baseJ ? 1 : 0))
        );
    }

    const dotPlotIsNoise = (matrix, i, j, minDiagonalRun = 3) => {
        const size = matrix.length;
        for (const directionJ of [1, -1]) {
            let runLength = 0;
            for (const direction of [1, -1]) {
                let currentI = i;
                let currentJ = j;
                while (
                    currentI >= 0 &&
                    currentJ >= 0 &&
                    currentI < size &&
                    currentJ < size &&
                    matrix[currentI][currentJ] > 0
                    ) {
                    currentI += direction;
                    currentJ += direction * directionJ;
                    runLength += 1;
                    if (runLength >= minDiagonalRun) {
                        return false;
                    }
                }
            }
        }
        return true;
    }

    const dotPlotFilterOutNoise = (matrix, minDiagonalRun = 3, setNoiseToDifferentColor = false) => {
        for (let i = 0; i < matrix.length; i++) {
            for (let j = 0; j < matrix.length; j++) {
                if (matrix[i][j] > 0 && dotPlotIsNoise(matrix, i, j, minDiagonalRun)) {
                    matrix[i][j] = setNoiseToDifferentColor ? 2 : 0;
                }
            }
        }
    }

    function plotDotPlot(dotPlotCanvas, sequence, pixelsPerCell = 1, setNoiseToDifferentColor = false) {

        if (!sequence) {
            console.warn("Sequence is empty")
            return
        }
        const separatorPositions = []
        const filteredSequenceChars = []
        for (const c of sequence) {
            if (c === "|") {
                separatorPositions.push(filteredSequenceChars.length)
            } else {
                filteredSequenceChars.push(c)
            }
        }
        const filteredSequence = filteredSequenceChars.join("")

        const matrix = dotPlotGenerateMatrix(filteredSequence)
        dotPlotFilterOutNoise(matrix, 6, setNoiseToDifferentColor)


        const size = matrix.length;
        const scaledSize = size * pixelsPerCell;
        const pixelData = new Uint8ClampedArray(scaledSize * scaledSize * 4);
        for (let i = 0; i < size; i++) {
            for (let j = 0; j < size; j++) {
                const value = matrix[i][j];
                let r = 255, g = 255, b = 255, a = 255;
                if (value === 1) {
                    r = 0
                    g = 0
                    b = 0
                } else if (value === 2) {
                    r = 255
                    g = 0
                    b = 0
                }
                for (let dy = 0; dy < pixelsPerCell; dy++) {
                    for (let dx = 0; dx < pixelsPerCell; dx++) {
                        const scaledRow = i * pixelsPerCell + dy
                        const scaledCol = j * pixelsPerCell + dx
                        const pixelIndex = (scaledRow * scaledSize + scaledCol) * 4
                        pixelData[pixelIndex] = r
                        pixelData[pixelIndex + 1] = g
                        pixelData[pixelIndex + 2] = b
                        pixelData[pixelIndex + 3] = a
                    }
                }
            }
        }

        dotPlotCanvas.width = matrix.length * pixelsPerCell
        dotPlotCanvas.height = matrix.length * pixelsPerCell

        const context = dotPlotCanvas.getContext("2d")
        context.putImageData(new ImageData(pixelData, scaledSize, scaledSize), 0, 0)
        context.fillStyle = "rgba(0, 0, 255, 1)"
        for (const position of separatorPositions) {
            const x = position * pixelsPerCell
            context.fillRect(x, 0, 1.5, dotPlotCanvas.height)
        }
    }

    /*
    Example:

    const pixelsPerCell = 2 // higher number increases resolution
    const dotPlotCanvas = document.getElementById("dotPlotCanvas")
    plotDotPlot(dotPlotCanvas, inputSequence, pixelsPerCell, false)
    dotPlotCanvas.style.width = "100px"
    dotPlotCanvas.style.height = "100px"

     */
    /** --------- END of utils for dot plots  ---------- */
</script>
<script>
    /** --------- START of utils for IGV.js  ---------- */

    const generateIgvConfig = (addSelectedTracks) => {

        // specify IGV tracks and the data to display in them
        const tracks = []


        if (addSelectedTracks) {
            tracks.push({
                name: "Refseq",
                format: "refgene",
                url: `${REFERENCE_BASE_URL}/ncbiRefSeq.txt.gz`,
                indexed: true,
                indexURL: `${REFERENCE_BASE_URL}/ncbiRefSeq.txt.gz.tbi`,
                infoURL: "https://www.ncbi.nlm.nih.gov/gene/?term=$$",
                height: 150,
            })

            ALL_AVAILABLE_TRACKS.forEach((rt) => {
                const trackName = rt[0]
                const trackDisplayName = rt[1]
                const trackURL = rt[2]
                if (!GLOBAL_PAGE_STATE[trackName]) {
                    return
                }

                if (trackName == 'igv_gencode') {
                    tracks.push({
                        name: trackDisplayName,
                        format: 'refgene',
                        url: trackURL,
                        indexURL: `${trackURL}.tbi`,
                        indexed: true,
                        searchable: true,
                        height: 350,
                        visibilityWindow: -1,
                        displayMode: 'EXPANDED',
                        color: 'rgb(76,171,225)',
                    })
                } else if (trackURL.endsWith('.bed.gz')) {
                    tracks.push({
                        format: 'bed',
                        name: trackDisplayName,
                        url: trackURL,
                        indexURL: `${trackURL}.tbi`,
                        indexed: true,
                        searchable: false,
                        displayMode: 'EXPANDED',
                    })
                } else if (trackURL.endsWith('.gtf.gz')) {
                    tracks.push({
                        format: 'gtf',
                        name: trackDisplayName,
                        url: trackURL,
                        indexed: true,
                        searchable: false,
                        displayMode: 'EXPANDED',
                    })
                } else {
                    tracks.push({
                        name: trackDisplayName,
                        url: trackURL,
                    })
                }

            })

            // Add custom tracks if they have URLs
            for (let i = 1; i <= 3; i++) {
                const url = GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`]
                if (url && url.trim() !== '') {
                    tracks.push({
                        name: url.split('/').pop(),
                        url: url.trim()
                    })
                }
            }
        }

        const reference = {
            "id": "hg38",
            "name": "Human (GRCh38/hg38)",
            "fastaURL": "https://igv-genepattern-org.s3.amazonaws.com/genomes/seq/hg38/hg38.fa",
            "indexURL": "https://igv-genepattern-org.s3.amazonaws.com/genomes/seq/hg38/hg38.fa.fai",
            "cytobandURL": "https://s3.amazonaws.com/igv.org.genomes/hg38/annotations/cytoBandIdeo.txt.gz",
            "aliasURL": "https://s3.amazonaws.com/igv.org.genomes/hg38/hg38_alias.tab",
            "chromosomeOrder": "chr1, chr2, chr3, chr4, chr5, chr6, chr7, chr8, chr9, chr10, chr11, chr12, chr13, chr14, chr15, chr16, chr17, chr18, chr19, chr20, chr21, chr22, chrX, chrY",
            "tracks": tracks,
        }

        const locus = GLOBAL_PAGE_STATE['igvLoc']
        return {
            reference: reference,
            showCursorTrackingGuide: true,
            minimumBases: 40,  //required for https://github.com/igvteam/igv.js/issues/2046
            locus: locus,
        }
    }

    async function updateIgv() {

        // create igv.js browser object if it hasn't been created yet
        if (!window.igvBrowser) {
            const config = generateIgvConfig(false)
            window.igvBrowser = await igv.createBrowser(document.getElementById("igv-viewport"), config)

            //window.igvBrowser.trackViews.forEach((trackView) => { monkeyPatchPopupData(trackView.track) }
            window.igvBrowser.on('trackremoved', (track) => {
                // get the track id that matches the url
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    if (track.url === rt[2]) {
                        const trackName = rt[0]
                        $(`input[name="${trackName}"]`).prop('checked', false)
                        GLOBAL_PAGE_STATE[trackName] = 0
                        writePersistentPageStateToUrl()
                    }
                })
            })

            window.igvBrowser.on('locuschange', (locus) => {
                if (locus[0] && locus[0].chr && locus[0].start && locus[0].end) {
                    GLOBAL_PAGE_STATE['igvLoc'] = `${locus[0].chr}:${parseInt(locus[0].start)}-${parseInt(locus[0].end)}`
                    writePersistentPageStateToUrl()
                }
            })

            // add the IGV tracks selection button
            $($('#igv-viewport')[0].shadowRoot).find('.igv-navbar-left-container').after(
                //$('.igv-navbar-left-container').after(
                `<button id="igv-select-tracks-button" class="ui primary basic button" style="height:25px; padding:2px 15px 2px 30px; border-color:#06359d !important; border-width: 1px !important; border-radius:5px; color:#06359d !important; background-color: white !important; cursor: pointer;">
               Select IGV Tracks
               <i class="setting icon" style="margin-left:10px" />
            </button>`
            )

            $('#igv-tr-explorer-catalog-tracks-checkboxes').html($('#igv-tr-explorer-catalog-tracks-checkboxes').html() +
                TR_EXPLORER_CATALOG.map((rt) => `
                <tr><td>
                    <div class="inline-field"><div class="ui checkbox igv-track-checkbox"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div> ${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '" ></i>' : ''}
                </td><td class="igv-number-of-loci-column">
                     ${rt[3].toLocaleString()}
                </td></tr>
            `).join(' ') + `
                <tr>
                    <td style="padding: 5px 0px !important">
                        <i>Source Catalogs:</i>
                        <i class="question circle icon link" style="margin-left: 15px;" data-html="These 4 catalogs were merged to create the TRExplorer Catalog. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."></i>
                    </td>
                    <td></td>
                </tr>
            ` +
                TR_EXPLORER_SOURCE_CATALOGS.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="margin-left: 30px !important; display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' '))

            $('#igv-variation-cluster-tracks-checkboxes').html($('#igv-variation-cluster-tracks-checkboxes').html() +
                TR_VARIATION_CLUSTERS.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' ')
            )

            $('#igv-other-tr-catalog-tracks-checkboxes').html($('#igv-other-tr-catalog-tracks-checkboxes').html() +
                GENOME_WIDE_TR_CATALOGS.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' ')
            )

            $('#igv-known-disease-loci-checkboxes').html($('#igv-known-disease-loci-checkboxes').html() +
                KNOWN_TR_LOCI_TRACK.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' ')
            )

            $('#igv-reference-tracks-checkboxes').html($('#igv-reference-tracks-checkboxes').html() +
                `<tr><td>` +
                REFERENCE_TRACKS.map((rt) => `
                <div class="ui checkbox igv-track-checkbox"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>
            `).join(' ')
                + `</td></tr>`
            )

            $('#igv-custom-tracks').html($('#igv-custom-tracks').html() +
                `<tr>
                <td colspan="2">
                    <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-1" placeholder="Enter a public data file URL for custom track #1. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                    <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-2" placeholder="Enter a public data file URL for custom track #2. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                    <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-3" placeholder="Enter a public data file URL for custom track #3. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                </td>
            </tr>`
            )

            $(".ui.checkbox").checkbox()

            $($('#igv-viewport')[0].shadowRoot).find('#igv-select-tracks-button').click(() => {
                //$('#igv-select-tracks-button').click(() => {
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    const trackName = rt[0]
                    const isChecked = GLOBAL_PAGE_STATE[trackName] === 1
                    $(`input[name="${trackName}"]`).prop('checked', isChecked)
                })

                $('#igv-track-selection-dialog').modal('show')
                $('.question').popup({ on: 'click' })
            })
            $('#igv-tracks-modal-apply-button').click(async() => {
                // update GLOBAL_PAGE_STATE with selected tracks
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    const trackName = rt[0]
                    const isChecked = $(`input[name="${trackName}"]`).is(':checked')
                    GLOBAL_PAGE_STATE[trackName] = isChecked ? 1 : 0
                })

                // update custom track URLs
                for (let i = 1; i <= 3; i++) {
                    const url = $(`#igv-custom-track-url-${i}`).val()
                    GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] = url || ''
                }

                writePersistentPageStateToUrl()
                await updateIgv()
            })
        }

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            const igvConfig = generateIgvConfig(true)

            console.log("Updating igv config to", igvConfig)
            await window.igvBrowser.loadSessionObject(igvConfig)
        }
    }
    /** --------- END of utils for IGV.js  ---------- */
</script>
<script>
    /** --------- START of utils for motif frequency  ---------- */

    const computeMotifFrequenciesTableHtml = (motifFrequencyTableRows, showTitle = false) => {
        const helpText = `
        Motifs detected at this locus by the Vamos v2.1 pipeline when applied to 94 HPRC T2T assemblies.
        Percentages represent what fraction of the 94 haplotype sequences is covered by each motif.
        `

        let result = ''
        result += `<div class='info-font-size' style='display: flex; flex-direction: column; align-items: center'>`
        if (showTitle) {
            result += `<span style='font-weight: bold; margin-bottom: 20px'>Motif Variability <i class='question circle icon link' style='margin-left: 15px;' data-html='${helpText}'></i></span>`
        }
        result += `<table style='border-spacing: 20px 3px'>`
        result += `<tr><td><b>Frequency</b></td><td><b>Motif</b></td><td><span style='white-space: nowrap'><b>Efficient Motif</b></span></td></tr>`
        result += `${motifFrequencyTableRows.join('')}`
        result += `</table>`
        result += '</div>'
        if (!showTitle) {
            result += `<br /><div style='text-align: justify; color: #555555' ><b>Details:</b> ${helpText}</div>`
        }
        return result
    }

    const parseMotifFrequenciesString = (frequenciesString, maxRowsToShow=null) => {
        if (!frequenciesString) {
            return ''
        }

        try {
            let resultMotifs = computeMotifFrequenciesTableRows(frequenciesString)
            const totalMotifs = resultMotifs.length
            if (maxRowsToShow && resultMotifs.length > maxRowsToShow) {
                resultMotifs = resultMotifs.slice(0, maxRowsToShow)
                resultMotifs.push(`<tr><td colspan='3' style='text-align:center; color:#AAAAAA'><i>... ${totalMotifs - maxRowsToShow} more motifs. See locus page ...</i></td></tr>`)
            }

            if (totalMotifs > 0) {
                const dataHtml = computeMotifFrequenciesTableHtml(resultMotifs)
                return `<span class="show-popup action-link" data-html="${dataHtml}">${totalMotifs} motifs</span>`
            } else {
                return ''
            }
        } catch (e) {
            console.error('Error parsing motif frequencies string:', e)
            return ''
        }
    }

    /** --------- END of utils for motif frequency  ---------- */
</script>
<script>
    /** --------- START of utils for periodicity plots  ---------- */
    const shiftStringBy = (string, shift) => {
        if (shift === 0 || string.length === 0) {
            return string
        }
        const normalizedShift = shift % string.length
        return string.slice(-normalizedShift) + string.slice(0, string.length - normalizedShift)
    }

    const hashString = (string) => {
        let hash = 0
        for (let i = 0; i < string.length; i++) {
            hash = (hash << 5) - hash + string.charCodeAt(i)
            hash |= 0
        }
        return Math.abs(hash)
    }

    const generatePeriodicityMatrixWithBackwardLook = (sequence, minMotifSize = 1, maxMotifSize = 50) => {
        const clampedMin = Math.max(minMotifSize, 1)
        const clampedMax = Math.min(maxMotifSize, Math.floor(sequence.length / 2))
        const rowCount = Math.max(clampedMax, clampedMin)
        const matrix = Array.from({ length: rowCount }, () => Array(sequence.length).fill(0))

        let hashCache = new Map()
        for (let row = clampedMin - 1; row < clampedMax; row++) {
            const period = row + 1
            let prevShiftedMotif
            for (let column = 0; column < sequence.length; column++) {
                const motifEndingAtThisLetter = sequence.slice(column - period + 1, column + 1)
                const shiftedMotifEndingAtThisLetter = shiftStringBy(motifEndingAtThisLetter, (column + 1) % period)
                let shiftedMotif
                if (prevShiftedMotif === shiftedMotifEndingAtThisLetter) {
                    shiftedMotif = shiftedMotifEndingAtThisLetter
                } else if (column + period < sequence.length && sequence[column] === sequence[column + period]) {
                    const motifStartingAtThisLetter = sequence.slice(column, column + period)
                    const shiftedMotifStartingAtThisLetter = shiftStringBy(motifStartingAtThisLetter, column % period)
                    shiftedMotif = shiftedMotifStartingAtThisLetter
                    prevShiftedMotif = shiftedMotif
                } else {
                    prevShiftedMotif = null
                    continue
                }

                if (hashCache.has(shiftedMotif)) {
                    matrix[row][column] = hashCache.get(shiftedMotif)
                } else {
                    const hash = hashString(shiftedMotif)
                    hashCache.set(shiftedMotif, hash)
                    matrix[row][column] = hash
                }
            }
        }

        return matrix
    }

    const generatePeriodicityMatrix = (sequence, minMotifSize = 1, maxMotifSize = 50) => {
        const clampedMin = Math.max(minMotifSize, 1)
        const clampedMax = Math.min(maxMotifSize, Math.floor(sequence.length / 2))
        const rowCount = Math.max(clampedMax, clampedMin)
        const matrix = Array.from({ length: rowCount }, () => Array(sequence.length).fill(0))

        let hashCache = new Map()
        for (let row = clampedMin - 1; row < clampedMax; row++) {
            const period = row + 1
            for (let column = 0; column < sequence.length - period; column++) {
                if (sequence[column] !== sequence[column + period]) {
                    continue
                }
                const motif = sequence.slice(column, column + period)
                const shiftedMotif = shiftStringBy(motif, column % period)
                if (hashCache.has(shiftedMotif)) {
                    matrix[row][column] = hashCache.get(shiftedMotif)
                } else {
                    const hash = hashString(shiftedMotif)
                    hashCache.set(shiftedMotif, hash)
                    matrix[row][column] = hash
                }
            }
        }

        return matrix
    }

    const hexToRgb = (hex) => {
        const normalized = hex.replace("#", "")
        const bigint = parseInt(normalized, 16)
        return {
            r: (bigint >> 16) & 255,
            g: (bigint >> 8) & 255,
            b: bigint & 255,
        }
    }

    const plotPeriodicityPlot = (canvas, sequence, pixelsPerCell = 2, minRunLength = 3, useBackwardLook = false, startWithPeriod=1, endWithPeriod=24) => {

        const separatorPositions = []
        const filteredSequenceChars = []
        for (const c of sequence) {
            if (c === "|") {
                separatorPositions.push(filteredSequenceChars.length)
            } else {
                filteredSequenceChars.push(c)
            }
        }
        const filteredSequence = filteredSequenceChars.join("")

        let matrix
        if (useBackwardLook) {
            matrix = generatePeriodicityMatrixWithBackwardLook(filteredSequence, startWithPeriod, endWithPeriod)
        } else {
            matrix = generatePeriodicityMatrix(filteredSequence, startWithPeriod, endWithPeriod)
        }


        // zip matrix[2] with the filteredSequence
        //console.log(Array.from(filteredSequence).map((value, index) => `${value}:  ${matrix[2][index]}`).join("\n"))

        filterOutNoiseInPeriodicityMatrix(matrix, minRunLength)

        const rowCount = matrix.length
        const columnCount = matrix[0]?.length || 0
        if (rowCount === 0 || columnCount === 0) {
            return
        }

        const backgroundColor = hexToRgb("#FFFFFF")
        const motifPalette = ['#24f2a5', '#f27124', '#d8f224', '#24f257', '#d824f2', '#247ef2', '#64f224', '#2431f2', '#6424f2', '#f29824', '#f2e524', '#8b24f2', '#f224e5', '#24f27e', '#3ef224', '#f22424', '#24f2cb', '#f22471', '#24f2f2', '#f2be24', '#b124f2', '#24cbf2', '#8bf224', '#b1f224', '#3e24f2', '#f224be', '#24a5f2', '#f24a24', '#2457f2', '#f22498', '#24f231']

        const width = columnCount * pixelsPerCell
        const height = rowCount * pixelsPerCell
        const fontSize = 11
        const labelOffset = Math.ceil(fontSize * 2)
        const pixelData = new Uint8ClampedArray(width * height * 4)

        for (let row = 0; row < rowCount; row++) {
            for (let column = 0; column < columnCount; column++) {
                const value = matrix[row][column]
                const paletteIndex = value === 0 ? -1 : value % motifPalette.length
                const color = paletteIndex >= 0 ? hexToRgb(motifPalette[paletteIndex]) : backgroundColor

                for (let dy = 0; dy < pixelsPerCell; dy++) {
                    for (let dx = 0; dx < pixelsPerCell; dx++) {
                        const pixelRow = row * pixelsPerCell + dy
                        const pixelCol = column * pixelsPerCell + dx
                        const pixelIndex = (pixelRow * width + pixelCol) * 4
                        pixelData[pixelIndex] = color.r
                        pixelData[pixelIndex + 1] = color.g
                        pixelData[pixelIndex + 2] = color.b
                        pixelData[pixelIndex + 3] = 255
                    }
                }
            }
        }

        canvas.width = width + labelOffset
        canvas.height = height
        const context = canvas.getContext("2d")
        context.putImageData(new ImageData(pixelData, width, height), labelOffset, 0)
        canvas.style.height = `${1 * pixelsPerCell * rowCount}px`
        context.fillStyle = "rgba(0, 0, 255, 1)"
        for (const position of separatorPositions) {
            const x = labelOffset + position * pixelsPerCell
            context.fillRect(x, 0, 1.5, height)
        }

        context.fillStyle = "rgba(0, 0, 0, 1)"
        context.textAlign = "left"
        context.textBaseline = "middle"
        context.font = `${fontSize}px monospace`

        let lastLabelY = -Infinity
        const minSpacing = fontSize * 1.2

        for (let row = 0; row < rowCount; row++) {
            const y = row * pixelsPerCell + pixelsPerCell / 2
            //const isBoundary = row === 0 || row === rowCount - 1
            const drawLabel = (row + 1) % 3 === 0
            const hasSpace = (y - lastLabelY >= minSpacing)
            if (drawLabel && hasSpace) {
                context.fillText(`${row + 1}`, 2, y)
                lastLabelY = y
            }
        }

        return matrix
    }

    const computeBarScores = (matrix) => {
        if (matrix.length === 0 || matrix[0].length === 0) {
            return []
        }
        const width = matrix[0].length
        return matrix.map((row, index) => {
            const matches = row.reduce((count, value) => count + (value > 0 ? 1 : 0), 0)
            const period = index + 1
            const denominator = Math.max(width - period + 1, 1)
            return matches / denominator
        })
    }

    const isNoiseInPeriodicityMatrix = (matrix, i, j, minRunLength = 3) => {
        // check if the horizontal run starting at (i, j) is at least minRunLength of the same value
        let runLength = 1
        const width = matrix[0].length
        const value = matrix[i][j]
        for (let dx = 1; j + dx < width; dx++) {
            if (matrix[i][j + dx] !== value) {
                break
            }

            runLength += 1
            if (runLength >= minRunLength) {
                return false
            }
        }
        for (let dx = 1; j - dx >= 0; dx++) {
            if (matrix[i][j - dx] !== value) {
                break
            }

            runLength += 1
            if (runLength >= minRunLength) {
                return false
            }
        }

        return true
    }

    const filterOutNoiseInPeriodicityMatrix = (matrix, minRunLength = 3) => {
        const matrixRows = matrix.length
        const matrixColumns = matrix[0].length
        for (let i = 0; i < matrixRows; i++) {
            for (let j = 0; j < matrixColumns; j++) {
                if (matrix[i][j] > 0 && isNoiseInPeriodicityMatrix(matrix, i, j, minRunLength)) {
                    matrix[i][j] = 0
                }
            }
        }
    }

    const buildPeriodicityMatrixBarChart = (container, periodicityMatrix) => {
        container.innerHTML = ""
        container.style.display = "flex"
        container.style.alignItems = "flex-end"
        container.style.gap = "6px"
        container.style.height = "160px"
        container.style.marginTop = "16px"

        const scores = computeBarScores(periodicityMatrix)
        const maxScore = Math.max(...scores, 0)

        scores.forEach((score, index) => {
            const wrapper = document.createElement("div")
            wrapper.style.display = "flex"
            wrapper.style.flexDirection = "column"
            wrapper.style.alignItems = "center"
            wrapper.style.font = "11px monospace"

            const bar = document.createElement("div")
            const normalized = maxScore === 0 ? 0 : (score / maxScore)
            bar.style.height = `${normalized * 120}px`
            bar.style.width = "10px"
            bar.style.backgroundColor = "#4cc9f0" //"#6366F1" //"#4cc9f0"
            bar.style.borderRadius = "2px 2px 0 0"
            //bar.title = `Period ${index + 1}: ${(score * 100).toFixed(1)}%`

            const label = document.createElement("span")
            label.style.paddingTop = "5px"
            label.textContent = `${index + 1}`

            wrapper.appendChild(bar)
            wrapper.appendChild(label)
            container.appendChild(wrapper)
        })
    }


    /*
    Example:
    <canvas id="periodicityMatrixCanvas"></canvas>
    <div id="barPlotContainer"></div>


    const pixelsPerCell = 10
    const minRunLength = 3
    const useBackwardLook = false

    const periodicityCanvas = document.getElementById("periodicityMatrixCanvas")
    const periodicityMatrix = plotPeriodicityPlot(periodicityCanvas, inputSequence, pixelsPerCell, minRunLength, useBackwardLook)

    const barPlotContainer = document.getElementById("barPlotContainer")
    buildPeriodicityMatrixBarChart(barPlotContainer, periodicityMatrix)
    */

    /** --------- END of utils for periodicity plots  ---------- */
</script>
<script>
    /** --------- START of utils for polymorphism charts  ---------- */

    const createAlleleFrequencyChart = (chartData) => {
        const frequencies = chartData.frequencies
        const thisObj = chartData.thisObj
        const refAlleleSize = chartData.refAlleleSize
        const chartWidth = chartData.chartWidth
        const chartHeight = chartData.chartHeight
        const minAlleleSize = chartData.minAlleleSize
        const maxAlleleSize = chartData.maxAlleleSize
        const axisUnits = chartData.axisUnits

        const chartLabel = chartData.label

        //frequencies.sort((a, b) => a.size - b.size)

        const yLookup = {}
        const xLabels =  []
        const colors = []
        const borderColors = []
        for (let i = minAlleleSize - 1; i <= maxAlleleSize + 1; i++) {
            xLabels.push(i)
            yLookup[i] = 0
        }
        for (let x of xLabels) {
            yLookup[x] = frequencies.find(f => f.size === x)?.count || 0
            colors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 0.7)' : 'rgba(33, 133, 208, 0.5)')
            borderColors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 1)' : 'rgba(33, 133, 208, 1)')
        }

        // Destroy any existing chart on this canvas
        const existingChart = Chart.getChart(thisObj);
        if (existingChart) {
            existingChart.destroy();
        }


        //set y-limit to the nearest whole power of 10 divided by 2, rounding up
        const yLimit = Math.pow(10, Math.ceil(Math.log10(2 * Math.max(...frequencies.map(f => f.count))))) / 2
        new Chart(thisObj, {
            type: 'bar',
            data: {
                labels: xLabels,
                datasets: [{
                    data: xLabels.map(d => yLookup[d]),
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: true,
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            boxHeight: 10,
                            padding: 5,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                return [{
                                    text: `Ref. Allele: ${refAlleleSize} repeats`,
                                    fillStyle: 'rgba(255, 165, 0, 0.7)',
                                    strokeStyle: 'rgba(255, 165, 0, 1)',
                                    lineWidth: 1,
                                    hidden: false,
                                    index: 0
                                }]
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Count: ${context.raw}`
                            }
                        },
                        position: 'nearest',
                        yAlign: 'bottom'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: axisUnits,
                            font: {
                                size: 13
                            },
                        },
                        ticks: {
                            font: {
                                size: 13
                            },
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        min: 0,
                        max: parseInt(yLimit),
                        title: {
                            display: true,
                            text: '# of alleles',
                            font: {
                                size: 13
                            },
                        },
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (Math.floor(value) === value) {
                                    return parseInt(value)
                                }
                            },
                            font: {
                                size: 13
                            },
                        },
                        afterBuildTicks: (axis) => {
                            const ticks = [0, 3, 10, 30, 100, 300, 1000, 3000, 10000]
                            axis.ticks = ticks.filter(t => t <= axis.max).map(t => ({value: t}))
                        }
                    }
                }
            }
        })

        thisObj.style.minWidth = chartWidth

        thisObj.style.height = chartHeight
        thisObj.style.minHeight = chartHeight
        thisObj.style.maxHeight = chartHeight
    }

    const parseBiallelicHistogramString = function(frequenciesString) {
        // example: frequencies = "2/2:58,2/3:34,3/3:4"
        const data = []
        const lookup = {}
        const items = frequenciesString.split(',')
        for (let i = 0; i < items.length; i++) {
            try {
                const value = items[i].split(':')
                const genotype = value[0].split('/')
                const allele1 = parseInt(genotype[0])
                const allele2 = parseInt(genotype[1])
                const shortAlleleSize = Math.min(allele1, allele2)
                const longAlleleSize = Math.max(allele1, allele2)
                const count = parseInt(value[1])
                data.push({ x: longAlleleSize, y: shortAlleleSize, v: count})
                lookup[`${shortAlleleSize}/${longAlleleSize}`] = count
            } catch (e) {
                console.error('Error parsing biallelic histogram string:', e)
                return [[], {}]
            }
        }

        return [data, lookup]
    }

    const createBiallelicHistogramChart = (chartData) => {
        let lookup = chartData.lookup
        const thisObj = chartData.thisObj
        const refAlleleSize = chartData.refAlleleSize
        const chartWidth = chartData.chartWidth
        const chartHeight = chartData.chartHeight
        const minAlleleSize = chartData.minAlleleSize - 1
        const maxAlleleSize = chartData.maxAlleleSize + 1
        const axisUnits = chartData.axisUnits

        // Find the range of allele sizes
        let data = chartData.data
        //const allShortAlleles = data.map(d => d.y)
        //const allLongAlleles = data.map(d => d.x)

        // Calculate bin size if range exceeds 30
        const maxBins = 20
        const needsBinning = (maxAlleleSize - minAlleleSize) > maxBins
        const binSize = needsBinning ? Math.ceil((maxAlleleSize - minAlleleSize) / maxBins) : 1

        // Create labels for both axes
        const shortAlleleLabels = []
        const longAlleleLabels = []

        // Create binned or regular labels
        for (let i = Math.max(0, minAlleleSize - binSize); i <= maxAlleleSize + binSize; i += binSize) {
            const binEnd = i + binSize
            const label = needsBinning ? `${i}-${binEnd}` : i
            shortAlleleLabels.push(label)
            longAlleleLabels.push(label)
        }

        if (needsBinning) {
            data = []
            for (const shortAlleleLabel of shortAlleleLabels) {
                for (const longAlleleLabel of longAlleleLabels) {
                    let binCount = 0
                    const shortAlleleStart = parseInt(shortAlleleLabel.split('-')[0])
                    const shortAlleleEnd = parseInt(shortAlleleLabel.split('-')[1])
                    const longAlleleStart = parseInt(longAlleleLabel.split('-')[0])
                    const longAlleleEnd = parseInt(longAlleleLabel.split('-')[1])
                    for (let short = shortAlleleStart; short < shortAlleleEnd; short++) {
                        for (let long = longAlleleStart; long < longAlleleEnd; long++) {
                            const value = lookup[`${short}/${long}`]
                            if (value) {
                                binCount += value
                            }
                        }
                    }
                    data.push({x: longAlleleLabel, y: shortAlleleLabel, v: binCount})
                }
            }

            lookup = {}
            for (const d of data) {
                if (d.v > 0) {
                    lookup[`${d.y}/${d.x}`] = d.v
                }
            }
        }

        // Calculate maxCount from the binned data
        const maxCount = Math.max(...data.map(d => d.v))

        // Destroy any existing chart
        const existingChart = Chart.getChart(thisObj)
        if (existingChart) {
            existingChart.destroy()
        }

        // Create the chart
        new Chart(thisObj, {
            type: 'matrix',
            data: {
                datasets: [{
                    data: data,
                    backgroundColor: function(context) {
                        const value = context.dataset.data[context.dataIndex].v
                        if (value === 0) return 'rgba(255, 255, 255, 0)'
                        const alpha = Math.pow(value / maxCount, 0.5)  // Square root to make small values more visible
                        return `rgba(33, 133, 208, ${alpha})`
                    },
                    borderColor: 'rgba(0, 0, 0, 0.5)',
                    borderWidth: function(context) {
                        const value = context.dataset.data[context.dataIndex].v
                        if (value === 0) return 0
                        return 1
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    x: {
                        type: 'category',
                        offset: false,  // Remove offset to center labels
                        labels: longAlleleLabels,
                        title: {
                            display: true,
                            text: `Long allele (${axisUnits})`,
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: true
                        }
                    },
                    y: {
                        type: 'category',
                        offset: false,  // Remove offset to center labels
                        reverse: true,  // Reverse y-axis
                        labels: shortAlleleLabels,
                        title: {
                            display: true,
                            text: `Short allele (${axisUnits})`,
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: true
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                const c = context[0]
                                const value = c.dataset.data[c.dataIndex].v
                                if (value === 0) return ''
                                const shortLabel = shortAlleleLabels[c.parsed.y]
                                const longLabel = longAlleleLabels[c.parsed.x]
                                // if it's a bin, show the range
                                if (typeof shortLabel === 'string' && typeof longLabel === 'string' && shortLabel.includes('-') && longLabel.includes('-')) {
                                    const shortStart = parseInt(shortLabel.split('-')[0])
                                    const shortEnd = parseInt(shortLabel.split('-')[1])
                                    const longStart = parseInt(longLabel.split('-')[0])
                                    const longEnd = parseInt(longLabel.split('-')[1])
                                    return `Genotype Bin:\n${longStart}  long  allele < ${longEnd}\n${shortStart}  short allele < ${shortEnd}`
                                } else {
                                    return `Genotype: ${shortLabel}/${longLabel}`
                                }
                            },
                            label: function(context) {
                                const c = context
                                const value = c.dataset.data[c.dataIndex].v
                                if (value === 0) return null
                                const shortLabel = shortAlleleLabels[c.parsed.y]
                                const longLabel = longAlleleLabels[c.parsed.x]
                                const genotype = `${shortLabel}/${longLabel}`
                                return `Individuals: ${lookup[genotype] || 0}`
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        })

        thisObj.style.minWidth = chartWidth
        thisObj.style.height = chartWidth
        thisObj.style.minHeight = chartWidth
        thisObj.style.maxHeight = chartWidth
    }

    /** --------- END of utils for polymorphism charts  ---------- */
</script>

<script>

    const TR_CATALOG_BASE_URL = "https://storage.googleapis.com/tandem-repeat-catalog"

    const SHARED_TR_CATALOG_SIZES = {
        known_disease_loci: 63,
        illumina_174k_catalog: 174300,
        tr_explorer_catalog: 4863041,
        tr_explorer_catalog_v2: 5543507,
    }

    const TR_EXPLORER_SOURCE_CATALOGS = [
        ["igv_kd_loci_july_2024", "Known disease-associated TR loci (July 2024)", `${TR_CATALOG_BASE_URL}/other_catalogs/KnownDiseaseAssociatedLoci_July2024.bed.gz`, SHARED_TR_CATALOG_SIZES['known_disease_loci']],
        ["igv_illumina_174k_source", "Illumina 174k", `${TR_CATALOG_BASE_URL}/other_catalogs/Illumina174kPolymorphicTRs.bed.gz`, SHARED_TR_CATALOG_SIZES['illumina_174k_catalog']],
        ["igv_perfect_repeats_hg38", "Perfect repeats in hg38", `${TR_CATALOG_BASE_URL}/other_catalogs/PerfectRepeatsInGRCh38.bed.gz`, 4558281],
        ["igv_polymorphic_trs_in_t2t", "Polymorphic TRs in T2T assemblies", `${TR_CATALOG_BASE_URL}/other_catalogs/PolymorphicTRsInT2TAssemblies.bed.gz`, 1937805],
    ]

    const TR_EXPLORER_CATALOG  = [
        ["igv_tr_explorer_catalog_v1", "TRExplorer catalog v1.0", `${TR_CATALOG_BASE_URL}/v1.0/TRExplorer.repeat_catalog_v1.hg38.1_to_1000bp_motifs.bed.gz`, SHARED_TR_CATALOG_SIZES['tr_explorer_catalog'], "TR catalog described in [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]"],
        ["igv_tr_explorer_catalog_v2", "TRExplorer catalog v2.0 draft", `${TR_CATALOG_BASE_URL}/v2.0/TRExplorer.repeat_catalog_v2.hg38.1_to_1000bp_motifs.bed.gz`, SHARED_TR_CATALOG_SIZES['tr_explorer_catalog_v2'], "Draft version 2.0 of the TR catalog described in [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]. This version introduces loci from the Vamos v2.1 catalog in order to improve coverage of VNTRs."],
    ]

    const TR_VARIATION_CLUSTERS = [
        ["igv_vc_v1", "Variation clusters v1.0", `${TR_CATALOG_BASE_URL}/v1.0/variation_clusters_v1.hg38.bed.gz`, 271362, "Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."],
        ["igv_vc_and_isolated_v1", "Variation clusters and isolated repeats v1.0", `${TR_CATALOG_BASE_URL}/v1.0/TRExplorer.variation_clusters_and_isolated_TRs_v1.hg38.TRGT.bed.gz`, 4542828, "This catalog contains intervals representing variation clusters, as well as entries for all TRExplorer catalog loci that are not within a variation cluster. Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."],
        ["igv_vc_and_isolated_v1_0_1", "Variation clusters and isolated repeats v1.0.1", `${TR_CATALOG_BASE_URL}/v1.0.1/TRExplorer.variation_clusters_and_isolated_TRs_v1.0.1.hg38.TRGT.bed.gz`, 4439813, "This catalog contains intervals representing variation clusters, as well as entries for all TRExplorer catalog loci that are not within a variation cluster. v1.0.1 removes 103,015 isolated repeat loci from v1.0 but that occur inside very large variation clusters which exceeded the max region size of the variation cluster algorithm. Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."],
    ];

    const KNOWN_TR_LOCI_TRACK = [
        ["igv_kd_loci", "Disease-associated loci (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/KnownDiseaseAssociatedLoci.bed.gz`, 68],
        ["igv_trgt_kd_loci", "TRGT repo: disease-associated loci (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/TRGT.pathogenic_repeats.hg38.bed.gz`, 56],
        ["igv_strchive_kd_loci", "STRchive catalog for TRGT (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/STRchive-disease-loci-v2.4.0.hg38.TRGT.B2FLLAlV.bed.gz`, 73],
    ]

    const GENOME_WIDE_TR_CATALOGS = [
        ["igv_illumina_174k", "Illumina 174k", `${TR_CATALOG_BASE_URL}/other_catalogs/Illumina174kPolymorphicTRs.bed.gz`, SHARED_TR_CATALOG_SIZES['illumina_174k_catalog']],
        ["igv_trgt", "TRGT", `${TR_CATALOG_BASE_URL}/other_catalogs/TRGT.bed.gz`, 171146, "Genome-wide catalog provided in the <a href='https://github.com/PacificBiosciences/trgt/tree/3d10c75/repeats' target='_blank'>TRGT repo</a> (downloaded March, 2025)"],
        ["igv_ucsc_sr", "UCSC simple repeat track", `${TR_CATALOG_BASE_URL}/other_catalogs/UCSC_SimpleRepeatTrack.bed.gz`, 965511],
        ["igv_vamos", "VAMOS v2.1", `${TR_CATALOG_BASE_URL}/other_catalogs/VamosCatalog_v2.1.bed.gz`, 1243954],
        ["igv_gangstr", "GangSTR v17", `${TR_CATALOG_BASE_URL}/other_catalogs/GangSTR_v17.bed.gz`, 1340266],
        ["igv_hipstr", "HipSTR", `${TR_CATALOG_BASE_URL}/other_catalogs/HipSTR.bed.gz`, 1638945],
        ["igv_adotto", "Adotto v1.2", `${TR_CATALOG_BASE_URL}/other_catalogs/Adotto_v1.2.bed.gz`, 2934805],
        ["igv_popstr", "PopSTR v2", `${TR_CATALOG_BASE_URL}/other_catalogs/PopSTR_v2.bed.gz`, 5401401],
        ["igv_platinum_trs", "Platinum TRs", `${TR_CATALOG_BASE_URL}/other_catalogs/PlatinumTRs.bed.gz`, 7524815, "The TR catalog described in [<a href='https://pubmed.ncbi.nlm.nih.gov/39149261/' target=_blank>Porubsky et al. 2024</a>]"],
        ["igv_chiu", "Chiu et al.", `${TR_CATALOG_BASE_URL}/other_catalogs/Chiu_et_al.bed.gz`, 18759399, "The TR catalog described in [<a href='https://pubmed.ncbi.nlm.nih.gov/38947075/' target=_blank>Chiu et al. 2024</a>]"],
    ]

    REFERENCE_BASE_URL = "https://storage.googleapis.com/tgg-viewer/ref/GRCh38"

    const REFERENCE_TRACKS = [
        ["igv_gencode", "Gencode v49", `${REFERENCE_BASE_URL}/gencode_v49/gencode.v49.GRCh38.sorted.txt.gz`],
        ["igv_segdups", "SegDups > 1000bp", `${REFERENCE_BASE_URL}/segdups/segdups.gtf.gz`],
        ["igv_36k_map", "36-mer mappability", `${REFERENCE_BASE_URL}/mappability/GRCh38_no_alt_analysis_set_GCA_000001405.15-k36_m2.bw`],
        ["igv_100k_map", "100-mer mappability", `${REFERENCE_BASE_URL}/mappability/GRCh38_no_alt_analysis_set_GCA_000001405.15-k100_m2.bw`],
        ["igv_haploinsuf", "ClinGen haploinsufficiency track", `${REFERENCE_BASE_URL}/clingen/ClinGen_haploinsufficiency_gene_GRCh38.sorted.bed.gz`],
        ["igv_triplosens", "ClinGen triplosensitivity track", `${REFERENCE_BASE_URL}/clingen/ClinGen_triplosensitivity_gene_GRCh38.sorted.bed.gz`],
        ["igv_repeatmask", "UCSC RepeatMasker", `${REFERENCE_BASE_URL}/hg38.RepeatMasker.bed.gz`],
    ]

    const ALL_AVAILABLE_TRACKS = [
        ...TR_EXPLORER_SOURCE_CATALOGS,
        ...TR_EXPLORER_CATALOG,
        ...TR_VARIATION_CLUSTERS,
        ...GENOME_WIDE_TR_CATALOGS,
        ...KNOWN_TR_LOCI_TRACK,
        ...REFERENCE_TRACKS,
    ]

    // initialize BigQuery client
    const PROJECT_ID = 'cmg-analysis'
    const DATASET_ID = 'tandem_repeat_explorer'
    const TABLE_ID = 'catalog_20251117_063426'
    const COMPLETE_TABLE_ID = `\`${PROJECT_ID}.${DATASET_ID}.${TABLE_ID}\``

    const SHOW_COLUMNS_VALUE_DELIMITER = 'i'

    const IGV_LOCUS_PADDING = 150
    const REFERENCE_REGION_REGEXP = /^(?:chr)?([XYMTt0-9]+):([\d,]+)-([\d,]+)$/i

    const ALL_STDEV_COLUMNS = [
        'HPRC100_Stdev',
        'AoU1027_Stdev',
        'TenK10K_Stdev',
        'StdevFromIllumina174k',
        'StdevFromT2TAssemblies',
    ]

    const STDEV_SIGMA_SUBSCRIPTS = {
        'HPRC100_Stdev': 'Hprc100',
        'AoU1027_Stdev': 'AoU1027',
        'TenK10K_Stdev': '10k10k',
        'StdevFromIllumina174k': '1kGP',
        'StdevFromT2TAssemblies': 'T2T',
    }

    const AXIS_UNITS = {
        'HPRC100_AlleleHistogram': 'Repeat Count: LPS',
        'TenK10K_AlleleHistogram': 'Repeat Count',
        'AlleleFrequenciesFromIllumina174k': 'Repeat Count',
        'AlleleFrequenciesFromT2TAssemblies': 'Repeat Count',
        'HPRC100_BiallelicHistogram': 'Repeat Count: LPS',
        'TenK10K_BiallelicHistogram': 'Repeat Count',
    }

    const ALLELE_HISTOGRAM_SHORT_NAMES = {
        'HPRC100_AlleleHistogram': 'HPRC100',
        'TenK10K_AlleleHistogram': 'TenK10K Phase 1',
        'AlleleFrequenciesFromIllumina174k': '1kGP',
        'AlleleFrequenciesFromT2TAssemblies': 'T2T',
        'HPRC100_BiallelicHistogram': 'HPRC100',
        'TenK10K_BiallelicHistogram': 'TenK10K Phase 1',
    }
    const ALLELE_FREQUENCY_CHART_TITLES = {
        'HPRC100_AlleleHistogram': 'Allele Frequencies from HPRC 100 PacBio samples',
        'TenK10K_AlleleHistogram': 'Allele Frequencies from TenK10K Phase 1 short-read genomes',
        'AlleleFrequenciesFromIllumina174k': 'Allele Frequencies from 1kGP short-read genomes',
        'AlleleFrequenciesFromT2TAssemblies': 'Allele Frequencies from 78 diploid T2T assemblies',
        'HPRC100_BiallelicHistogram': 'Genotype Heatmap from HPRC 100 PacBio samples',
        'TenK10K_BiallelicHistogram': 'Genotype Heatmap from TenK10K Phase 1 short-read genomes',
    }

    const ALLELE_FREQUENCY_CHART_SUBTITLES = {
        'HPRC100_AlleleHistogram': 'based on TRGT calls in 100 PacBio HiFi samples from the Human Pan-genome Reference Consortium (HPRC)',
        'TenK10K_AlleleHistogram': 'based on ExpansionHunter calls in 1,925 short-read genomes from the <a href=https://www.biorxiv.org/content/10.1101/2024.11.02.621562v2 target=_blank>TenK10K Phase 1 dataset</a>',
        'AlleleFrequenciesFromIllumina174k': 'based on ExpansionHunter calls in <a href=https://github.com/Illumina/RepeatCatalogs/blob/master/docs/str_diversity_1kg.md target=_blank>2,504 short-read genomes from 1kGP</a>',
        'AlleleFrequenciesFromT2TAssemblies': 'based on assembly-to-hg38 alignments of 78 diploid T2T assemblies as described in <a href=https://pubmed.ncbi.nlm.nih.gov/37214979 target=_blank>Weisburd et al. 2023</a>',
        'HPRC100_BiallelicHistogram': 'based on TRGT calls in 100 PacBio HiFi samples from the Human Pan-genome Reference Consortium (HPRC)',
        'TenK10K_BiallelicHistogram': 'based on ExpansionHunter calls in 1,925 short-read genomes from the <a href=https://www.biorxiv.org/content/10.1101/2024.11.02.621562v2 target=_blank>TenK10K Phase 1 dataset</a>',
    }

    const STDEV_HELP_TEXTS = {
        'HPRC100_Stdev': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_AlleleHistogram']}. Allele sizes were computed using the longest pure segment (LPS) as described in [<a href=&quot;https://www.biorxiv.org/content/10.1101/2025.01.06.631535v2&quot; target=_blank>Danzi et al. 2025</a>]. <br /><br /><b>Range:</b> 0 to 330.7`,
        'AoU1027_Stdev': `This is the standard deviation of the allele frequency distribution based on TRGT calls in PacBio HiFi samples from 1,027 African American participants in the All of Us (AoU) project. Allele sizes were computed using the longest pure segment (LPS) as described in [<a href=&quot;https://www.biorxiv.org/content/10.1101/2025.01.06.631535v2&quot; target=_blank>Danzi et al. 2025</a>]. <br /><br /><b>Range:</b> 0 to 932.1`,
        'TenK10K_Stdev': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_AlleleHistogram']}. <br /><br />TenK10K Phase 1 primarily contains individuals of European ancestry.`,
        'StdevFromIllumina174k': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromIllumina174k']}. <br /><br /><b>Range:</b> 0 to 31.5`,
        'StdevFromT2TAssemblies': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromT2TAssemblies']}. <br /><br /><b>Range:</b> 0 to 1267.3`
    }

    const ALLELE_HISTOGRAM_HELP_TEXTS = {
        'HPRC100_AlleleHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_AlleleHistogram']}.`,
        'TenK10K_AlleleHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_AlleleHistogram']}.`,
        'AlleleFrequenciesFromIllumina174k': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromIllumina174k']}.`,
        'AlleleFrequenciesFromT2TAssemblies': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromT2TAssemblies']}.`,
        'HPRC100_BiallelicHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_BiallelicHistogram']}.`,
        'TenK10K_BiallelicHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_BiallelicHistogram']}.`,
    }

    const gene_region_priority = "with significance defined as coding > 5' UTR > 3' UTR > exon in non-coding gene > intron > promoter region spanning 1,000bp upstream of the 5' UTR"
    const RESULTS_TABLE_COLUMN_HELP_TEXTS = {
        LocusId: 'A unique id of this TR locus in hg38',
        ReferenceRegion: 'Genomic coordinates of the TR locus in the hg38 reference genome. <b>Example:</b> 1:94418421-94418442',
        ReferenceRepeatSequence: 'The repeat sequence in hg38',
        ReferenceLeftFlank: 'The sequence immediately to the left of the TR locus in hg38',
        ReferenceRightFlank: 'The sequence immediately to the right of the TR locus in hg38',
        ReferenceMotif: 'The repeat motif in hg38 and its size in base pairs',
        CanonicalMotif: 'The repeat motif in hg38, normalized by computing all cyclic rotations of the motif and its reverse complement, and then selecting the one that is alphabetically first. <b>For example:</b> the canonical version of <i>CTG</i> is <i>AGC</i>',
        polymorphism: 'Summary of available polymorphism data for the TR locus',
        Source: 'TRExplorer catalog version, as well as the source catalog that contributed this TR locus to the TRExplorer catalog',
        TRsInRegion: 'Number of other TRs in the vicinity of this locus that are separated from each other by no more than 6bp of spacer sequence',
        NumRepeatsInReference: 'Number of repeats calculated by taking the width of the TR locus reference interval and dividing it by the motif size, then rounding down to the nearest integer',
        ReferenceRepeatPurity: 'The fraction of bases within the TR locus reference sequence that match perfect repeats of the specified motif. For example, CAG.CAG.CAG has purity = 1.0, while CAG.CAA.CAG has purity = 0.89<br /><br /><b>Range:</b> 0 to 1',
        variationCluster: 'Summarizes whether the TR locus resides within a variation cluster. Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href=\'https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2\' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]',
        isPathogenic: 'Whether this is a known disease-associated locus (provided as a separate column to enable sorting)',
        AoU1027_OE_LengthPercentile: 'Observed / Expected TR length metric from the TR constraint model described in [<a href=&quot;https://www.biorxiv.org/content/10.1101/2025.01.06.631535v2&quot; target=&quot;_blank&quot;>Danzi et al. 2025</a>], displayed as a percentile rank relative to all other TR loci in the catalog',
        RepeatMaskerIntervals: 'UCSC Repeat masker intervals that overlap the TR locus',
        VamosMotifFrequencies: 'Different motifs detected at this locus by the Vamos v2.1 pipeline when applied to 94 HPRC assemblies',
        FlanksAndLocusMappability: 'UCSC 36-mer mappability scores averaged across the TR locus and +/- 150bp of its flanking sequences<br /><br /><b>Range:</b> 0 to 1',
        GencodeGeneRegion: `The most significant gene region that overlaps the TR locus in Gencode v48 ${gene_region_priority}`,
        GencodeGeneName: 'Gencode v48 gene name',
        GencodeGeneId: 'Gencode v48 gene ID (ENSG)',
        GencodeTranscriptId: 'Gencode v48 transcript ID (ENST)',
        RefSeqGeneRegion: `The most significant RefSeq gene region that overlaps the TR locus ${gene_region_priority}`,
        RefSeqGeneId: 'RefSeq gene ID',
        RefSeqTranscriptId: 'RefSeq transcript ID',
        RefSeqGeneName: 'RefSeq gene name',
        ManeGeneRegion: `The most significant gene region that overlaps the TR locus in MANE v1.4 ${gene_region_priority}`,
        ManeGeneId: 'MANE v1.4 gene ID',
        ManeGeneName: 'MANE v1.4 gene name',
        ManeTranscriptId: 'MANE v1.4 transcript ID',
        HPRC100_BiallelicHistogram: 'Biallelic histogram of HPRC100',
        TenK10K_BiallelicHistogram: 'Biallelic histogram of TenK10K Phase 1',
        dotPlot: 'Dot plot visualization of the reference repeat sequence and flanking sequences. Vertical blue lines represent locus boundaries',
    }

    /*
    const GENE_REGION_COLORS = {
        'CDS': 'rgb(208,5,5)',
        'exon': 'rgb(255,168,0)',
        'intron': 'rgb(40,126,40)',
        'intergenic': 'rgb(0,178,255)',
        '5\' UTR': 'rgb(0,72,255)',
        '3\' UTR': 'rgb(0,72,255)',
        'promoter': 'rgb(93,1,196)',
    }
    */

    const DEFAULT_SORT_COLUMN = 'chrom_index, start_0based'
    const DEFAULT_SORT_DIRECTION = 'ASC'


    // persistent page state (added to the URL)
    let DEFAULT_GLOBAL_PAGE_STATE = {
        currentPage: 1,
        pageSize: 100,

        sc: DEFAULT_SORT_COLUMN,
        sd: DEFAULT_SORT_DIRECTION,

        showIGV: 0,
        igvLoc: 'chr4:3074821-3074990',

        showRs: 0,  //show results table
        searchQuery: '',
        showAdvFilters: 0,

        sourceCatalog: 'tr_explorer_catalog_v2', // Source catalog filter
        keepMotifSize: '',
        keepMotif: '',

        keepCodingLoci: 0,
        keepFiveUTRLoci: 0,
        keepThreeUTRLoci: 0,
        keepPromoterLoci: 0,
        keepIntronLoci: 0,
        keepIntergenicLoci: 0,
        keepNonCodingExonLoci: 0,

        polymorphismFilter: 0,
        polymorphismFilterType: '',
        polymorphismThreshold: '',
        vcFilter: 0,
        vcFilterType: '',

        // Custom track URLs
        igv_custom_track_url_1: '',
        igv_custom_track_url_2: '',
        igv_custom_track_url_3: '',
    }

    // set default IGV.js tracks
    ALL_AVAILABLE_TRACKS.forEach((rt) => {
        DEFAULT_GLOBAL_PAGE_STATE[rt[0]] = 0
    })
    DEFAULT_GLOBAL_PAGE_STATE['igv_kd_loci'] = 1
    DEFAULT_GLOBAL_PAGE_STATE['igv_tr_explorer_catalog_v2'] = 1


    // based on https://raw.githubusercontent.com/broadinstitute/str-analysis/refs/heads/main/str_analysis/variant_catalogs/variant_catalog_without_offtargets.GRCh38.json
    const MOTIFS_AT_KNOWN_DISEASE_ASSOCIATED_LOCI =  [
        'CAG',
        'GCC',
        'GAA',
        'GTC',
        'CAGG',
        'TTTG',
        'GGGCC',
        'ATTCT',
        'GGCCCC',
        'GGCCTG',
        'GGCGCGGAGC',
        'CGCGGGGCGGGG',
        'CCTCGCTGTGCCGCTGCCGA',
        'CCTCATGGTGGTGGCTGGGGGCAG',

        /*
        //BEAN1
        "TAGAA",
        "TGGAA",

        //DAB1
        "GAAAT",

        //MARCHF6
        "ATTTC",

        //RAPGEF2,
        "TTTCA",

        //RFC1
        "AAGGC",
        "AAGGG",
        "ACAGG",
        "AGAGG",
        "AGGGC",
        */
    ].join(', ')


    const writePersistentPageStateToUrl = () => {
        // Create object with only non-default values
        const nonDefaultParams = {}
        for (const [key, value] of Object.entries(GLOBAL_PAGE_STATE)) {
            if (value !== DEFAULT_GLOBAL_PAGE_STATE[key]) {
                nonDefaultParams[key] = value
            }
        }

        // Convert to URL hash using jQuery's param method
        const hash = '#' + $.param(nonDefaultParams)

        // Get current hash to check if state has changed
        const currentHash = window.location.hash
        if (currentHash !== hash) {
            // Update URL and add to browser history
            window.history.pushState(null, '', hash)
        }
    }

    const computeIntervalSize = (interval) => {
        const [chrom, start_end] = interval.split(':')
        const [start, end] = start_end.split('-')
        return parseInt(end) - parseInt(start)
    }


    const queryBigQuery = async (query, startIndex=null, pageSize=null, exportToFileFormat=null, toolName=null) => {
        try {
            const url = `https://us-central1-cmg-analysis.cloudfunctions.net/query_db`
            console.log("Page state:", GLOBAL_PAGE_STATE)
            console.log(exportToFileFormat ? `Exporting to ${toolName || ''} ${exportToFileFormat}:`: `Sending query:`, query.replace(/[\n\r\s]+/g, ' '))
            const requestBody = {
                sql: query,
                export_to_file_format: exportToFileFormat,
                tool_name: toolName,
                start_index: startIndex,
                page_size: pageSize,
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody),
            })

            if (!response.ok) {
                throw new Error(`BigQuery API error: ${response.status} ${response.statusText}`)
            }

            return await response.json()
        } catch (error) {
            console.error('Error querying BigQuery:', error)
            throw new Error(`BigQuery query error: ${error.message || 'Unknown error'}`)
        }
    }

    const parseAlleleFrequenciesString = (frequenciesString) => {
        try {
            const data = []
            const items = frequenciesString.split(',')
            for (let i = 0; i < items.length; i++) {
                const [size, count] = items[i].split(':')
                data.push({
                    size: parseInt(size.replace('x', '')),
                    count: parseInt(count)
                })
            }
            return data
        } catch (e) {
            console.error('Error parsing allele frequencies string:', e)
            return []
        }
    }

    const parseRepeatMaskerIntervals = (repeatMaskerIntervals) => {
        if (!repeatMaskerIntervals) {
            return ''
        }

        let values = new Set()
        let count = 0
        let details = []
        for (let token of repeatMaskerIntervals.split(', ')) {
            const tokenEntries = token.split(':')
            if (!'Simple_repeat|Low_complexity'.includes(tokenEntries[0])) {
                values.add(tokenEntries[0])
                count += 1
                details.push(`<span style='font-family: monospace'>${tokenEntries[0]}: ${tokenEntries[1]}</span>`)
            }
        }

        if (count == 0) {
            return ''
        }

        return `<span class="show-popup action-link" data-html="${details.join('<br />')}">${Array.from(values).join(', ')}</span>`
    }

    const showTruncatedSequence = (sequence, truncateAt=12, showSize=true, leftTruncate=false, addBpSuffix=false) => {
        let sequenceSizeString = ''
        if (showSize) {
            sequenceSizeString += `(${sequence.length}${addBpSuffix? 'bp' : ''})`
        }
        if (sequence.length > truncateAt) {
            let result = `<span class="show-popup action-link" style="white-space: nowrap" data-html="<span style='font-family: monospace'>${sequence.replace(/.{1,100}/g, chunk => chunk + ' ')}</span>">`
            if (leftTruncate) {
                const truncatedSequence = sequence.substring(sequence.length - truncateAt, sequence.length)
                result += `<span style="font-family: monospace">${sequenceSizeString}</span> &nbsp; ...${truncatedSequence}`
            } else {
                const truncatedSequence = sequence.substring(0, truncateAt)
                result += `<span style="font-family: monospace">${truncatedSequence}</span>... &nbsp; ${sequenceSizeString}`
            }
            result += `</span>`
            return result
        } else {
            let result = `<span style="white-space: nowrap">`
            if (leftTruncate) {
                result += `${sequenceSizeString} &nbsp; <span style="font-family: monospace">${sequence}</span>`
            } else {
                result += `<span style="font-family: monospace">${sequence}</span> &nbsp; ${sequenceSizeString}`
            }
            result += `</span>`
            return result
        }
    }

    const computeMotifFrequenciesTableRows = (frequenciesString) => {
        if (!frequenciesString) {
            return []
        }
        const items = frequenciesString.split(',')
        let total = 0
        let motifCounts = {}
        let efficientMotifs = {}
        for (let i = 0; i < items.length; i++) {
            let motif = '', efficientMotif = '', count = '0'
            const numTokens = items[i].split(':').length
            if (numTokens == 3) {
                [motif, efficientMotif, count] = items[i].split(':')
            } else if(numTokens == 2) {
                [motif, count] = items[i].split(':')
            }

            count = parseInt(count)
            if (Number.isNaN(count)) {
                console.warn(`Unable to parse the count for motif ${motif} in ${frequenciesString}. Skipping...`)
                continue
            }
            motif = motif.trim()
            motifCounts[motif] = count
            efficientMotifs[motif] = efficientMotif.trim()
            total += count
        }

        const minimumFrequencyThreshold = 0  // 0.01

        // convert counts to fractions
        let motifCount = 0
        let homopolymerMotifCount = 0
        for (let motif in motifCounts) {
            motifCounts[motif] /= total
            if (motifCounts[motif] >= minimumFrequencyThreshold) {
                motifCount += 1
                if (motif.length == 1) {
                    homopolymerMotifCount += 1
                }
            }
        }

        if (motifCount <= 1 || homopolymerMotifCount == motifCount) {
            return []
        }

        const truncateMotifAt = 35
        let resultMotifs = []
        for (let motif in motifCounts) {
            let motifRow
            let motifPercentString
            if (motifCounts[motif] >= 0.01) {
                motifRow = '<tr>'
                motifPercentString = (motifCounts[motif] * 100.0).toFixed(0)
            } else {
                motifRow = `<tr style='color:#AAAAAA'>`
                motifPercentString = (motifCounts[motif] * 100.0).toFixed(1)
            }
            motifRow += `<td style='text-align:right'><i>${motifPercentString}%</i></td>`
            motifRow += `<td><span style='white-space: nowrap; font-family: monospace'>${motif.length > truncateMotifAt ? (motif.substring(0, truncateMotifAt) + '... (' + motif.length + 'bp)') : motif}</span></td>`
            if (efficientMotifs[motif]) {
                motifRow += `<td><span style='white-space: nowrap; font-family: monospace'>`
                if (efficientMotifs[motif] != motif) {
                    motifRow += `${efficientMotifs[motif].length <= truncateMotifAt ? efficientMotifs[motif] : (efficientMotifs[motif].substring(0, truncateMotifAt) + '... (' + efficientMotifs[motif].length + 'bp)')}`
                } else {
                    motifRow += '<i>same as motif</i>'
                }
                motifRow += `</span></td>`
            } else {
                motifRow += `<td><i>unavailable</i></td>`
            }
            motifRow += '</tr>'

            resultMotifs.push(motifRow)
        }

        return resultMotifs
    }

    const getGeneRegionColumnValue = (geneRegion) => {
        if (!geneRegion) return ''
        //const color = GENE_REGION_COLORS[geneRegion]
        const regionRename = {
            'CDS': 'coding',
            'exon': 'exon (non-coding gene)'
        }
        return `${regionRename[geneRegion] || geneRegion}`
    }

    const getPolymorphismSummaryColumnValue = (row) => {
        return `<span class="cell-in-polymorphism-column" ${getHtmlAttributesForPolymorphism(row)}>
            <span class="action-link">
                <b><sub>${STDEV_SIGMA_SUBSCRIPTS['HPRC100_Stdev']}</sub></b>
            </span>
            <span style="color: #333;">
                = ${row.HPRC100_Stdev != null ? row.HPRC100_Stdev.toFixed(1) : '<span style="color: #888888;">not available</span>'} &nbsp; &nbsp;
            </span>
            ${row.AoU1027_Stdev != null ? `<span class="action-link"><sub>${STDEV_SIGMA_SUBSCRIPTS["AoU1027_Stdev"]}</sub></span>` : ''}
            ${row.AoU1027_Stdev != null ? `<span style="color: #333;">
                = ${row.AoU1027_Stdev != null ? row.AoU1027_Stdev.toFixed(1) : '<span style="color: #888888;">not available</span>'} &nbsp; &nbsp;
            </span>` : ''}
            <span class="action-link">
                ${row['TenK10K_Stdev'] != null ? `<sub>${STDEV_SIGMA_SUBSCRIPTS["TenK10K_Stdev"]}</sub>` : ''}  ${row.StdevFromIllumina174k != null ? `<sub>${STDEV_SIGMA_SUBSCRIPTS["StdevFromIllumina174k"]}</sub>` : ''}  ${row.StdevFromT2TAssemblies != null ? `<sub>${STDEV_SIGMA_SUBSCRIPTS["StdevFromT2TAssemblies"]}</sub>` : ''}
            </span>
        </span>
        `
    }

    const generatePolymorphismDialogContent = (row) => {
        const stdevColumns = ['HPRC100_Stdev', 'AoU1027_Stdev', 'TenK10K_Stdev', 'StdevFromIllumina174k', 'StdevFromT2TAssemblies']
        const alleleFrequencyColumns = ['HPRC100_AlleleHistogram', 'TenK10K_AlleleHistogram', 'AlleleFrequenciesFromIllumina174k', 'AlleleFrequenciesFromT2TAssemblies']

        const nStdevsNotAvailable = [row.HPRC100_Stdev == null, row.AoU1027_Stdev == null, row.TenK10K_Stdev == null, row.StdevFromIllumina174k == null, row.StdevFromT2TAssemblies == null].filter(Boolean).length

        let polymorphismDialogContent1 = `<div class="content info-font-size" style="text-align: center">`

        if (nStdevsNotAvailable == stdevColumns.length) {
            polymorphismDialogContent1 += `<span style="color: #686868;">No polymorphism data available</span><br /><br />`
        } else {
            polymorphismDialogContent1 += `
                <div><span style="font-weight: bold">Allele Frequency Distribution Summary Statistics</span></div>
                    <div style="margin-top: 5px">
                        <table style="margin: 0 auto">
            `
        }

        for (const key of stdevColumns) {
            if (row[key] != null) {
                polymorphismDialogContent1 += `
                    <tr>
                        <td style="text-align: left;">
                            <span style="font-size: 1.2em;"><sub style="font-size: 0.7em;">${STDEV_SIGMA_SUBSCRIPTS[key]}</sub></span>
                        </td>
                        <td style="text-align: right;">
                            = ${row[key].toFixed(3)}
                        </td>
                        <td style="text-align: right;">
                            <i class="question circle icon link" style="margin-left: 15px;" data-html="${STDEV_HELP_TEXTS[key]}"></i>
                        </td>
                    </tr>
                `
            }
        }
        polymorphismDialogContent1 += "</table>"

        if (nStdevsNotAvailable > 0) {
            polymorphismDialogContent1 += "<br />"
            let namesOfMissingSigmas = []
            for (const key of stdevColumns) {
                if (row[key] == null) {
                    namesOfMissingSigmas.push(`<span style="font-size: 1.2em;"><sub style="font-size: 0.7em;">${STDEV_SIGMA_SUBSCRIPTS[key]}</sub></span>`)
                }
            }
            polymorphismDialogContent1 += ` ${namesOfMissingSigmas.join(' &amp; ')} ${namesOfMissingSigmas.length > 1 ? 'are' : 'is'} not available for this locus`
        }

        if (row.AoU1027_OE_LengthPercentile != null) {
            polymorphismDialogContent1 += `
                <div style="margin-top: 25px">
                    Constraint (O/E Length) percentile = ${((100*row.AoU1027_OE_LengthPercentile).toFixed(1))}% <i class="question circle icon link" style="margin-left: 15px;" data-html="${RESULTS_TABLE_COLUMN_HELP_TEXTS['AoU1027_OE_LengthPercentile']}"></i>
                </div>
            `
        }

        polymorphismDialogContent1 += "</div>"

        // check if any of the allele frequency columns are available
        const alleleFrequencyColumnsAvailable = alleleFrequencyColumns.some(column => row[column] != null)
        if (alleleFrequencyColumnsAvailable) {
            // calculate the height of the allele frequency charts
            polymorphismDialogContent1 += `
                <div style="margin-top: 15px;">
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px">
            `

            for (const columnName of alleleFrequencyColumns) {
                if (row[columnName] != null) {
                    polymorphismDialogContent1 += `
                        <div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">
                            <div style="margin-bottom: 5px;"><b>${ALLELE_FREQUENCY_CHART_TITLES[columnName]}</b><br /><span style="color: #686868;">${ALLELE_FREQUENCY_CHART_SUBTITLES[columnName]}</span></div>
                            <canvas class="allele-frequency-chart" data-label="${ALLELE_HISTOGRAM_SHORT_NAMES[columnName]}" data-frequencies-column="${columnName}" data-ref-allele-size="${row.NumRepeatsInReference}" data-axis-units="${AXIS_UNITS[columnName]}" data-chart-width="500px" data-chart-height="200px" style="width: 100%; height: 100px;"></canvas>
                        </div>
                    `
                }
            }
            polymorphismDialogContent1 += '</div></div>'
        }

        const biallelicHistogramColumns = ['HPRC100_BiallelicHistogram', 'TenK10K_BiallelicHistogram']
        const biallelicHistogramColumnsAvailable = biallelicHistogramColumns.some(column => row[column] != null)
        if (biallelicHistogramColumnsAvailable) {
            polymorphismDialogContent1 += `
                <div style="margin-top: 15px;">
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px">
            `
            for (const columnName of biallelicHistogramColumns) {
                if (row[columnName] != null) {
                    polymorphismDialogContent1 += `
                        <div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">
                            <div style="margin-bottom: 5px;"><b>${ALLELE_FREQUENCY_CHART_TITLES[columnName]}</b><br /><span style="color: #686868;">${ALLELE_FREQUENCY_CHART_SUBTITLES[columnName]}</span></div>
                            <canvas class="biallelic-histogram-chart" data-label="${ALLELE_HISTOGRAM_SHORT_NAMES[columnName]}" data-frequencies-column="${columnName}" data-ref-allele-size="${row.NumRepeatsInReference}" data-axis-units="${AXIS_UNITS[columnName]}" data-chart-width="500px" data-chart-height="200px" style="width: 100%; height: 100px;"></canvas>
                        </div>
                    `
                }
            }
            polymorphismDialogContent1 += '</div></div>'
        }

        return polymorphismDialogContent1
    }


    const renderChartsInPolymorphismDialog = (row) => {

        let alleleFrequencyChartData = []
        $('.allele-frequency-chart').each(function() {
            const frequenciesColumn = $(this).data('frequencies-column')
            const frequenciesString = row[frequenciesColumn]
            if (!frequenciesString) return   // Skip if no data

            const frequencies = parseAlleleFrequenciesString(frequenciesString)

            alleleFrequencyChartData.push({
                frequencies: frequencies,
                thisObj: this,
                refAlleleSize: $(this).data('ref-allele-size'),
                axisUnits: $(this).data('axis-units'),
                chartWidth: $(this).data('chart-width'),
                chartHeight: $(this).data('chart-height'),
                label: $(this).data('label'),
                minAlleleSize: Math.min(...frequencies.map(f => f.size)),
                maxAlleleSize: Math.max(...frequencies.map(f => f.size))
            })
        })

        //compute overall min, max for all charts and then create the charts
        let overallMinAlleleSize = Math.min(...alleleFrequencyChartData.map(d => d.minAlleleSize))
        let overallMaxAlleleSize = Math.max(...alleleFrequencyChartData.map(d => d.maxAlleleSize))

        alleleFrequencyChartData.forEach((chartData) => {
            chartData.minAlleleSize = overallMinAlleleSize
            chartData.maxAlleleSize = overallMaxAlleleSize

            createAlleleFrequencyChart(chartData)
        })

        let biallelicHistogramChartData = []
        $('.biallelic-histogram-chart').each(function() {
            const frequenciesColumn = $(this).data('frequencies-column')
            let frequenciesString = row[frequenciesColumn]
            if (!frequenciesString) return   // Skip if no data

            let [data, lookup] = parseBiallelicHistogramString(frequenciesString)

            biallelicHistogramChartData.push({
                data: data,
                lookup: lookup,
                thisObj: this,
                refAlleleSize: $(this).data('ref-allele-size'),
                axisUnits: $(this).data('axis-units'),
                chartWidth: $(this).data('chart-width'),
                chartHeight: $(this).data('chart-height'),
                label: $(this).data('label'),
                minAlleleSize: Math.min(...data.map(f => Math.min(f.x, f.y))),
                maxAlleleSize: Math.max(...data.map(f => Math.max(f.x, f.y)))
            })
        })

        overallMinAlleleSize = Math.min(...biallelicHistogramChartData.map(d => d.minAlleleSize))
        overallMaxAlleleSize = Math.max(...biallelicHistogramChartData.map(d => d.maxAlleleSize))

        biallelicHistogramChartData.forEach((chartData) => {
            chartData.minAlleleSize = overallMinAlleleSize
            chartData.maxAlleleSize = overallMaxAlleleSize

            createBiallelicHistogramChart(chartData)
        })

    }

    const getAlleleHistogramColumnValue = (row, columnName) => {
        if (row[columnName] ) {
            return `<canvas class="allele-frequency-inline-chart cell-in-polymorphism-column" ${getHtmlAttributesForPolymorphism(row)} data-frequencies="${row[columnName]}" data-ref-allele-size="${row['NumRepeatsInReference']}" data-axis-units="${AXIS_UNITS[columnName]}" style="width: 100%; height: 100px"></canvas>`
        } else {
            let otherHistograms = ''
            for ( const c of ALL_STDEV_COLUMNS ) {
                if (row[c] != null) {
                    otherHistograms += `<span class="action-link"><sub>${STDEV_SIGMA_SUBSCRIPTS[c]}</sub></span>`
                }
            }

            let result = `<span class="cell-in-polymorphism-column" ${getHtmlAttributesForPolymorphism(row)}><span style="color: #888888; text-align: center; display: block; width: 100%;">`
            if (otherHistograms) {
                result += `not available (but has ${otherHistograms})`
            } else {
                result += `not available`
            }
            result += `</span></span>`
            return result
        }
    }

    let TABLE_COLUMNS = {
        LocusId: {
            displayName: 'LocusId',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['LocusId'],
            getValue: (row, truncateAt=30) => showTruncatedSequence(row['LocusId'], truncateAt, false),
            getSortColumns: () => ['chrom_index', 'start_0based', 'end_1based', 'LocusId'],
            getRequiredColumns: () => ['chrom_index', 'start_0based', 'end_1based', 'LocusId']
        },
        ReferenceRegion: {
            displayName: 'Interval (hg38)',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRegion'],
            getValue: (row) => row['ReferenceRegion'].replace(/^chr/i, ''),
            getSortColumns: () => ['chrom_index', 'start_0based', 'end_1based'],
            getRequiredColumns: () => ['chrom_index', 'start_0based', 'end_1based', 'ReferenceRegion']
        },
        ReferenceMotif: {
            displayName: 'Motif',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceMotif'],
            getValue: (row, truncateAt=12) => showTruncatedSequence(row['ReferenceMotif'], truncateAt, true),
            getSortColumns: () => ['MotifSize', 'ReferenceMotif'],
            getRequiredColumns: () => ['MotifSize', 'ReferenceMotif']
        },
        CanonicalMotif: {
            displayName: 'Canonical Motif',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['CanonicalMotif'],
            getValue: (row, truncateAt=12) => showTruncatedSequence(row['CanonicalMotif'], truncateAt, true),
            getSortColumns: () => ['MotifSize', 'CanonicalMotif'],
            getRequiredColumns: () => ['MotifSize', 'CanonicalMotif']
        },
        ReferenceRepeatSequence: {
            displayName: 'Repeat Sequence',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRepeatSequence'],
            getValue: (row, truncateAt=50) => showTruncatedSequence(row['ReferenceRepeatSequence'], truncateAt, true),
            getSortColumns: () => ['ReferenceRepeatSequence'],
            getRequiredColumns: () => ['ReferenceRepeatSequence']
        },
        ReferenceLeftFlank: {
            displayName: 'Left Flank',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceLeftFlank'],
            getValue: (row, truncateAt=50) => `<div style='text-align: right'>${showTruncatedSequence(row['ReferenceLeftFlank'], truncateAt, true, true)}</div>`,
            getSortColumns: () => ['ReferenceLeftFlank'],
            getRequiredColumns: () => ['ReferenceLeftFlank']
        },
        ReferenceRightFlank: {
            displayName: 'Right Flank',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRightFlank'],
            getValue: (row, truncateAt=50) => showTruncatedSequence(row['ReferenceRightFlank'], truncateAt, true),
            getSortColumns: () => ['ReferenceRightFlank'],
            getRequiredColumns: () => ['ReferenceRightFlank']
        },
        GencodeGeneRegion: {
            displayName: 'Region',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeGeneRegion'],
            getValue: (row) => getGeneRegionColumnValue(row['GencodeGeneRegion']),
            getSortColumns: () => ['GencodeGeneRegion'],
            getRequiredColumns: () => ['GencodeGeneRegion'],
        },
        GencodeGeneName: {
            displayName: 'Gene',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeGeneName'],
            getValue: (row) => row['GencodeGeneName'],
            getSortColumns: () => ['GencodeGeneName'],
            getRequiredColumns: () => ['GencodeGeneName'],
        },
        polymorphism: {
            displayName: 'Polymorphism Summary',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['polymorphism'],
            getValue: getPolymorphismSummaryColumnValue,
            getSortColumns: () => ['HPRC100_Stdev'],
            getRequiredColumns: () => REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN,
        },
        Source: {
            displayName: 'Source',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['Source'],
            getValue: (row) => {
                const sourceCatalogNameMap = {
                    KnownDiseaseAssociatedLoci: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Known disease-associated loci'>v1 &nbsp;<i>[1]</i></span>",
                    Illumina174kPolymorphicTRs: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Illumina 174k polymorphic TR catalog'>v1 &nbsp;<i>[2]</i></span>",
                    PerfectRepeatsInReference:  "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Perfect repeats in hg38 spanning  9bp and  3 repeats'>v1 &nbsp;<i>[3]</i></span>",
                    PolymorphicTRsInT2TAssemblies: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Polymorphic TRs in 78 T2T assemblies'>v1 &nbsp;<i>[4]</i></span>",
                    VamosCatalog: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v2 draft<br /><br /><b>Original source:</b> Vamos v2.1 catalog'>v2 draft &nbsp; <i>[5]</i></span>",
                }
                const [version, sourceCatalog] = row['Source'].split(':')
                return sourceCatalogNameMap[sourceCatalog]
            },
            getSortColumns: () => ['Source'],
            getRequiredColumns: () => ['Source'],
        },
        AoU1027_OE_LengthPercentile: {
            displayName: 'Constraint (O/E Length) Percentile',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['AoU1027_OE_LengthPercentile'],
            getValue: (row) => row['AoU1027_OE_LengthPercentile'] != null ? `${(100*row['AoU1027_OE_LengthPercentile']).toFixed(1)}%` : '',
            getSortColumns: () => ['AoU1027_OE_LengthPercentile'],
            getRequiredColumns: () => ['AoU1027_OE_LengthPercentile']
        },
        isPathogenic: {
            displayName: 'Disease-associated?',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['isPathogenic'],
            getValue: (row) => row['DiseaseInfo'] ? generateDiseaseAssociatedIcon(row, 'Yes') : '',
            getSortColumns: () => ['DiseaseInfo'],
            getRequiredColumns: () => ['DiseaseInfo']
        },
        variationCluster: {
            displayName: 'VC',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['variationCluster'],
            getValue: (row) => {
                const hasCluster = row['VariationCluster'] && row['VariationCluster'].trim() !== ''
                if (hasCluster) {
                    const refRegionSize = computeIntervalSize(row['ReferenceRegion'])
                    const clusterDetails = `
                            <div class="content" style="text-align: center;">
                                <div><span style="font-weight: bold">Variation Cluster Interval:</span> <br />${row['VariationCluster']}</div>
                                <br />
                                <div><span style="font-weight: bold">Variation Cluster Interval Size:</span> <br /><span style = "white-space: nowrap">reference repeat interval size (${refRegionSize} bp)</span> + ${row['VariationClusterSizeDiff']} bp</div>
                            </div>
                        `.replace(/\s+/g, ' ').trim()

                    return `<span class="action-cell show-popup" data-html='${clusterDetails}'>
                            <i class="check circle icon"></i><span class="action-link">Yes</span>
                        </span>: +${row['VariationClusterSizeDiff']}bp`
                }
                return ''
            },
            getSortColumns: () => ['VariationClusterSizeDiff'],
            getRequiredColumns: () => ['VariationClusterSizeDiff', 'VariationCluster']
        },
        NumRepeatsInReference: {
            displayName: '# of Repeats',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['NumRepeatsInReference'],
            getValue: (row) => (row['NumRepeatsInReference'] ? row['NumRepeatsInReference'] : ''),
            getSortColumns: () => ['NumRepeatsInReference'],
            getRequiredColumns: () => ['NumRepeatsInReference']
        },
        ReferenceRepeatPurity: {
            displayName: 'Purity',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRepeatPurity'],
            getValue: (row) => (row['ReferenceRepeatPurity'] ? row['ReferenceRepeatPurity'] : ''),
            getSortColumns: () => ['ReferenceRepeatPurity'],
            getRequiredColumns: () => ['ReferenceRepeatPurity']
        },
        TRsInRegion: {
            displayName: 'Nearby TRs',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['TRsInRegion'],
            getValue: (row) => (row['TRsInRegion'] ? (parseInt(row['TRsInRegion']) - 1) : ''),
            getSortColumns: () => ['TRsInRegion'],
            getRequiredColumns: () => ['TRsInRegion']
        },
        RepeatMaskerIntervals: {
            displayName: 'Repeat Masker',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RepeatMaskerIntervals'],
            getValue: (row) => parseRepeatMaskerIntervals(row['RepeatMaskerIntervals']),
            getSortColumns: () => ['RepeatMaskerIntervals'],
            getRequiredColumns: () => ['RepeatMaskerIntervals'],
        },
        VamosMotifFrequencies: {
            displayName: 'Motif Variability',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['VamosMotifFrequencies'],
            getValue: (row) => parseMotifFrequenciesString(row['VamosMotifFrequencies'], 20),
            getSortColumns: () => ['VamosNumUniqueMotifs', 'VamosMotifFrequencies'],
            getRequiredColumns: () => ['VamosNumUniqueMotifs', 'VamosMotifFrequencies'],
        },
        FlanksAndLocusMappability: {
            displayName: 'Mappability',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['FlanksAndLocusMappability'],
            getValue: (row) => row['FlanksAndLocusMappability'],
            getSortColumns: () => ['FlanksAndLocusMappability'],
            getRequiredColumns: () => ['FlanksAndLocusMappability']
        },
        GencodeGeneId: {
            displayName: 'Gencode Gene Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeGeneId'],
            getValue: (row) => row['GencodeGeneId'],
            getSortColumns: () => ['GencodeGeneId'],
            getRequiredColumns: () => ['GencodeGeneId']
        },
        GencodeTranscriptId: {
            displayName: 'Gencode Transcript',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeTranscriptId'],
            getValue: (row) => row['GencodeTranscriptId'],
            getSortColumns: () => ['GencodeTranscriptId'],
            getRequiredColumns: () => ['GencodeTranscriptId']
        },
        RefSeqGeneRegion: {
            displayName: 'RefSeq Region',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqGeneRegion'],
            getValue: (row) => getGeneRegionColumnValue(row['RefSeqGeneRegion']),
            getSortColumns: () => ['RefSeqGeneRegion'],
            getRequiredColumns: () => ['RefSeqGeneRegion']
        },
        RefSeqGeneId: {
            displayName: 'RefSeq Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqGeneId'],
            getValue: (row) => row['RefSeqGeneId'],
            getSortColumns: () => ['RefSeqGeneId'],
            getRequiredColumns: () => ['RefSeqGeneId']
        },
        RefSeqTranscriptId: {
            displayName: 'RefSeq Transcript Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqTranscriptId'],
            getValue: (row) => row['RefseqTranscriptId'],
            getSortColumns: () => ['RefseqTranscriptId'],
            getRequiredColumns: () => ['RefseqTranscriptId']
        },
        RefSeqGeneName: {
            displayName: 'RefSeq Gene',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqGeneName'],
            getValue: (row) => row['RefSeqGeneName'],
            getSortColumns: () => ['RefSeqGeneName'],
            getRequiredColumns: () => ['RefSeqGeneName']
        },
        ManeGeneRegion: {
            displayName: 'MANE Region',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeGeneRegion'],
            getValue: (row) => getGeneRegionColumnValue(row['ManeGeneRegion']),
            getSortColumns: () => ['ManeGeneRegion'],
            getRequiredColumns: () => ['ManeGeneRegion']
        },
        ManeGeneId: {
            displayName: 'MANE Gene Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeGeneId'],
            getValue: (row) => row['ManeGeneId'],
            getSortColumns: () => ['ManeGeneId'],
            getRequiredColumns: () => ['ManeGeneId']
        },
        ManeTranscriptId: {
            displayName: 'MANE Transcript',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeTranscriptId'],
            getValue: (row) => row['ManeTranscriptId'],
            getSortColumns: () => ['ManeTranscriptId'],
            getRequiredColumns: () => ['ManeTranscriptId']
        },
        ManeGeneName: {
            displayName: 'MANE Gene',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeGeneName'],
            getValue: (row) => row['ManeGeneName'],
            getSortColumns: () => ['ManeGeneName'],
            getRequiredColumns: () => ['ManeGeneName']
        },
        HPRC100_BiallelicHistogram: {
            displayName: 'HPRC100 Biallelic Histogram',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['HPRC100_BiallelicHistogram'],
            getValue: (row) => row['HPRC100_BiallelicHistogram'],
            getSortColumns: () => ['HPRC100_BiallelicHistogram'],
            getRequiredColumns: () => ['HPRC100_BiallelicHistogram']
        },
        TenK10K_BiallelicHistogram: {
            displayName: 'TenK10K Phase 1 Biallelic Histogram',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['TenK10K_BiallelicHistogram'],
            getValue: (row) => row['TenK10K_BiallelicHistogram'],
            getSortColumns: () => ['TenK10K_BiallelicHistogram'],
            getRequiredColumns: () => ['TenK10K_BiallelicHistogram']
        },
        dotPlot: {
            displayName: 'Dot Plot',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['dotPlot'],
            getValue: (row) => {
                const flankSize = Math.max(24, row["ReferenceMotif"].length * 5)
                const leftFlank = row["ReferenceLeftFlank"].slice(-flankSize)
                const rightFlank = row["ReferenceRightFlank"].slice(0, flankSize)

                return `<canvas class="dotPlot" data-repeat-seq="${row["ReferenceRepeatSequence"]}" data-left-flank="${leftFlank}" data-right-flank="${rightFlank}" data-reference-region="${row['ReferenceRegion']}" data-reference-region-size="${row['ReferenceRegionSize']}" data-flank-width="${flankSize}" data-repeats-in-reference="${row['NumRepeatsInReference']}" data-motif="${row['ReferenceMotif']}" style="width:48px; height:48px"></canvas>`
            },
            getSortColumns: () => ['ReferenceRepeatSequence'],
            getRequiredColumns: () => ['ReferenceRepeatSequence', 'ReferenceLeftFlank', 'ReferenceRightFlank', 'ReferenceRegion', 'NumRepeatsInReference', 'ReferenceMotif', 'ReferenceRegionSize'],
        }
    }


    const REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN = [
        'ReferenceRegion',
        'NumRepeatsInReference',
        'ReferenceMotif',
        'StdevFromIllumina174k',
        'AlleleFrequenciesFromIllumina174k',
        'StdevFromT2TAssemblies',
        'AlleleFrequenciesFromT2TAssemblies',
        'HPRC100_Stdev',
        'HPRC100_AlleleHistogram',
        'HPRC100_BiallelicHistogram',
        'TenK10K_AlleleHistogram',
        'TenK10K_BiallelicHistogram',
        'TenK10K_Stdev',
        'AoU1027_Stdev',
        'AoU1027_OE_LengthPercentile',
    ]


    const alleleHistogramColumnToOtherColumns = {
        'HPRC100_AlleleHistogram': ['HPRC100_Stdev'],
        'TenK10K_AlleleHistogram': ['TenK10K_Stdev'],
        'AlleleFrequenciesFromIllumina174k': ['StdevFromIllumina174k'],
        'AlleleFrequenciesFromT2TAssemblies': ['StdevFromT2TAssemblies'],
    }


    for (const columnName of ['HPRC100_AlleleHistogram', 'TenK10K_AlleleHistogram', 'AlleleFrequenciesFromIllumina174k', 'AlleleFrequenciesFromT2TAssemblies']) {
        const stdevColumnName = alleleHistogramColumnToOtherColumns[columnName][0]
        TABLE_COLUMNS[columnName] = {
            displayName: `Allele Distribution (${ALLELE_HISTOGRAM_SHORT_NAMES[columnName]})`,
            helpText: ALLELE_HISTOGRAM_HELP_TEXTS[columnName],
            getValue: (row) => getAlleleHistogramColumnValue(row, columnName),
            defaultSortDirection: 'DESC',
            getSortColumns: () => [stdevColumnName, 'NumRepeatsInReference'],
            getRequiredColumns: () => [columnName, 'NumRepeatsInReference', ...REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN]
        }
    }

    for (const columnName of ['HPRC100_Stdev', 'AoU1027_Stdev', 'TenK10K_Stdev', 'StdevFromIllumina174k', 'StdevFromT2TAssemblies']) {
        TABLE_COLUMNS[columnName] = {
            displayName: `<sub>${STDEV_SIGMA_SUBSCRIPTS[columnName]}</sub>`,
            helpText: STDEV_HELP_TEXTS[columnName],
            getValue: (row) => row[columnName],
            defaultSortDirection: 'DESC',
            getSortColumns: () => [columnName],
            getRequiredColumns: () => [columnName]
        }
    }


</script>
</head>

<!-- modal dialog for selecting IGV tracks -->
<div class="ui modal" id="igv-track-selection-dialog">
    <i class="close icon"></i>
    <div class="header" style="white-space: nowrap;">
        Select IGV Tracks
    </div>
    <div class="content" style="padding-top:0px;">
        <div class="ui form">
            <table class="ui stackable table igv-track-selection-table">
                <tr>
                    <td style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-tr-explorer-catalog-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    TRExplorer Catalog
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                    # of loci
                                </th>
                            </tr>
                        </table>
                        <table class="igv-checkbox-container-table" id="igv-variation-cluster-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Variation Clusters
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                </th>
                            </tr>
                        </table>
                        <table class="igv-checkbox-container-table" id="igv-known-disease-loci-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Known Disease-associated TR Loci
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                </th>
                            </tr>
                        </table>
                    </td>
                    <td style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-other-tr-catalog-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Other Genome-wide TR Catalogs
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                    # of loci
                                </th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-reference-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">Reference Tracks</th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-custom-tracks" style="width: 100%;">
                            <tr>
                                <th class="igv-checkbox-container-header-row">Custom Tracks <i class="question circle icon link" style="margin-left: 15px;" data-html="These inputs allow you to load your own custom tracks into IGV.js. They accept BED, BAM, VCF, GFF, BigWig, or any other IGV.js-compatible data format. The data file (and index) just have to be online at a publicly-accessible &nbsp;https://, &nbsp;gs://, &nbsp;or s3:// &nbsp; URL."></i></th>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="actions">
        <div class="ui deny button">
            Cancel
        </div>
        <div id="igv-tracks-modal-apply-button" class="ui positive right labeled icon button">
            Apply
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<div class="ui modal" id="whats-new-modal">
    <i class="close icon"></i>
    <div class="header">
        TRExplorer Updates
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%">
        <iframe src="whats_new.html" style="width: 100%; height: 100%; border: 0px; min-height: 380px"></iframe>
    </div>
</div>


<div class="ui modal" id="about-modal">
    <i class="close icon"></i>
    <div class="header">
        About TRExplorer
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%">
        <iframe src="about.html" style="width: 100%; height: 100%; border: 0px; min-height: 380px"></iframe>
    </div>
</div>


<!-- FAQ modal dialog -->
<div class="ui modal" id="faq-modal" style="height: 80%; min-height:75%">
    <i class="close icon"></i>
    <div class="header">
        Frequently Asked Questions
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%">
        <iframe src="FAQ.html" style="width: 100%; height: 100%; border: 0px"></iframe>
    </div>
</div>

<!-- downloads modal dialog -->
<div class="ui modal" id="downloads-modal" style="height: 88%; min-height: 88%">
    <i class="close icon"></i>
    <div class="header">
        Downloads
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%;">
        <iframe src="downloads.html" style="width: 100%; height: 100%; border: 0px;"></iframe>
    </div>
</div>


<body>
<style>
    .dotPlot {
        cursor: pointer;
        width: 48px;
        height: 48px;
    }
</style>
<!-- modal dialog for selecting results table columns -->
<div class="ui modal" id="results-table-column-settings-dialog">
    <i class="close icon"></i>
    <div class="header">
        Results Table Columns
    </div>
    <div class="content">
        <div class="ui form">
            <table class="ui stackable table results-table-column-settings-checkboxes" style="border: 0px !important"></table>
        </div>
    </div>
    <div class="actions">
        <div id="results-table-column-settings-cancel-button" class="ui deny button">Cancel</div>
        <div id="results-table-column-settings-apply-button" class="ui positive right labeled icon button">
            Apply
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<!-- modal dialog for polymorphism allele frequencies -->
<div class="ui modal" id="polymorphism-dialog">
    <i class="close icon"></i>
    <div class="header" id="polymorphism-dialog-header" style="text-align: center">
        Polymorphism
    </div>
    <div class="content scrolling">
        <div id="polymorphism-dialog-content"></div>
    </div>
</div>

<!-- modal dialog for displaying the dot plot and periodicity plot -->
<div class="ui modal" id="dot-plot-dialog">
    <i class="close icon"></i>
    <div class="header" id="dot-plot-dialog-header" style="text-align: center">
        Dot Plot
    </div>
    <div class="content scrolling">
        <div id="dot-plot-dialog-content" style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="font-size:1.5em; padding: 10px 10px"><b>Dot Plot</b></div>
            <canvas id="dot-plot-dialog-canvas" style="width: 100%; height: 100%"></canvas>
            <br /><br />
            <div style="font-size:1.5em; padding: 10px 10px"><b>Periodicity Plot</b></div>
            <canvas id="dot-plot-dialog-periodicity-plot-canvas" style="width: 100%"></canvas>
            <br /><br />
            <div style="font-size:1.5em; padding: 10px 10px"><b>Periodicity Plot Histogram</b></div>
            <div id="dot-plot-dialog-bar-plot"></div>
            <br /><br />
            <div style="font-size:1.5em; padding: 10px 10px"><b>Sequences</b></div>
            <div id="dot-plot-dialog-sequences"></div>
        </div>
    </div>
</div>


<div class="ui grid">

    <div class="ui row" id="header-stripe">
    <div class="three wide column" class="page-grid-margin" style="padding: 0px !important"></div>
    <div class="three wide column" id="header-title">
        <a href="index.html">
            <img src="tandem-repeat-explorer-logo-white.png" alt="TRExplorer Logo" style="height: 40px; margin-left: 10px;">
        </a>
    </div>
    <div class="seven wide column" id="header-nav">
        <a href="#" id="about-link">About</a>
        <a href="#" id="whats-new-link" style="white-space: nowrap">What's New</a>
        <a href="#" id="faq-link">FAQ</a>
        <a href="#" id="downloads-link">Downloads</a>
        <a href="https://github.com/broadinstitute/TRExplorer/issues/new?title=Add%20new%20TR%20locus%20to%20the%20TRExplorer%20website%20and%20catalog%3A&body=TR%20locus%20coordinates%20%28hg38%29%3A%0A%0ATR%20locus%20motif%20%28or%20motif%20size%29%3A%20%0A%0AI%20suggest%20adding%20this%20TR%20locus%20because%3A%20" target="_blank">Suggest New TR</a>
        <a href="https://github.com/broadinstitute/TRExplorer/issues" target="_blank">Issues</a>
        <a href="https://github.com/broadinstitute/TRExplorer" target="_blank" id="github-icon"><i class="github icon"></i></a>
    </div>
    <div class="three wide column" class="page-grid-margin" style="padding: 0px !important"></div>
</div>

<div class="ui row" id="igv-row">
    <div class="sixteen wide column">
        <div id="igv-viewport"></div>
    </div>
</div>

    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="show-igv-divider">
                <span id="show-igv-divider-text">Show IGV.js<i class="chevron down icon"></i></span>
                <span id="hide-igv-divider-text" style="display: none">Hide IGV.js<i class="chevron up icon"></i></span>
            </div>

            <form id="search-form" class="ui form">
                <div class="field">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
                        <label style="margin: 0; font-weight: 700 !important;">Search by region, gene, or transcript:</label>
                        <span style="margin-right: 145px; font-weight: 400 !important; color: #888; font-size: 0.9em;">
                            Examples: &nbsp; <a href="index.html?#showRs=1&searchQuery=chr4%3A3074000-3075000">
                                chr4:3074000-3075000
                            </a>, <a href="index.html?#showRs=1&searchQuery=ATXN1">
                                ATXN1
                            </a>, <a href="index.html?#showRs=1&searchQuery=ENSG00000165060">
                                ENSG00000165060
                            </a>, <a href="index.html?#showRs=1&searchQuery=ENST00000370475">
                                ENST00000370475
                            </a>
                        </span>
                    </div>
                    <div class="ui action input">
                        <input type="text" id="search-query" name="search-query" placeholder="eg. chr4:3074000-3075000, ATXN1, ENSG00000165060, ENST00000370475, or a comma-separated list of these">
                        <button id="filter-button" class="ui basic icon button" type="button" data-html="Show or hide additional TR filters" data-position="top center"><i class="filter icon rotated" style="transition: transform 0.3s;"></i></button>
                        <button id="search-button" class="ui primary button" type="submit">Search</button>
                    </div>
                </div>
            </form>

            <!-- Advanced Search Wrapper -->
            <div id="advanced-search-wrapper" style="padding-top: 20px">
                <!-- Form error message -->
                <div id="form-error-message" class="ui error message" style="display: none; margin-bottom: 1em;"></div>
                
                <!-- Advanced Search (Initially Hidden) -->
                <form id="advanced-search-form" class="ui form" style="display:none">

                    <div class="field" style="padding-top: 5px">
                        <label>Search TR Catalog</label>
                        <div class="ui selection dropdown" id="source-catalog-dropdown" style="max-width: 350px !important">
                            <input type="hidden" name="sourceCatalog">
                            <i class="dropdown icon"></i>
                            <div class="default text">Select catalog</div>
                            <div class="menu">
                                <div class="item" data-value="tr_explorer_catalog_v2">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span>TRExplorer catalog v2</span>
                                        <span style="color: #888; margin-left: 20px;">5,543,507 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="tr_explorer_catalog">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span>TRExplorer catalog v1</span>
                                        <span style="color: #888; margin-left: 20px;">4,863,041 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="illumina_174k_catalog">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span>Illumina 174k</span>
                                        <span style="color: #888; margin-left: 20px;">174,286 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="known_disease_loci">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span>Known disease-associated loci</span>
                                        <span style="color: #888; margin-left: 20px;">63 loci</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field" style="padding-top: 5px">
                        <label>Gene Region(s) or Locus Set(s)</label>
                        <div class="checkbox-group" style="padding-bottom: 15px">
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepCodingLoci">
                                <label>Coding</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepFiveUTRLoci">
                                <label>5' UTR</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepThreeUTRLoci">
                                <label>3' UTR</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepPromoterLoci">
                                <label>Promoter</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepIntronLoci">
                                <label>Intron</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepIntergenicLoci">
                                <label>Intergenic</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepNonCodingExonLoci">
                                <label>Exon (non-coding transcript)</label>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepLociThatOverlapDiseaseAssociatedLoci">
                                <label>Overlaps latest known disease-associated loci</label>
                            </div>
                        </div>
                    </div>

                    <div class="two fields" style="padding-top: 5px">
                        <div class="field" style="max-width: 430px; margin-right:20px">
                            <label>Motif Size(s)</label>
                            <input type="text" id="motif-size-input" name="keepMotifSize" placeholder="e.g., 3, 2-6, 7-, or a comma-separated list of these">
                        </div>
                        <div class="field" style="max-width: 440px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin: 0 0 .28571429rem 0;">
                                <label style="font-size: .92857143em; font-weight: 700">Motif(s)</label>
                                <a href="#" id="known-disease-motifs-link" style="color: #2185d0; font-size: 0.95em;">motifs of known disease-associated loci &gt;</a>
                            </div>
                            <input type="text" id="motif-input" name="keepMotif" placeholder="e.g., CAG, CCG, or a comma-separated list of these">
                        </div>
                    </div>

                    <div style="display: flex; gap: 120px;">
                        <div class="field" style="padding-top: 5px; max-width: 430px;">
                            <label>Polymorphism Filter</label>
                            <div class="checkbox-group" style="display: flex; align-items: center;">
                                <div class="ui checkbox" style="padding-right: 10px !important; display: inline-flex; align-items: center;">
                                    <input type="checkbox" name="polymorphismFilter">
                                    <label>Polymorphism filter:</label>
                                </div>
                                <div class="ui selection dropdown" id="polymorphism-filter-dropdown" style="min-width: 80px; margin-right: 10px !important; display: inline-block">
                                    <input type="hidden" name="polymorphismFilterType">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">Select filter</div>
                                    <div class="menu">
                                        <div class="item" data-value=""></div>
                                        <div class="item" data-value="sigma_HPRC100"><sub>HPRC100</sub></div>
                                        <div class="item" data-value="sigma_AoU1027"><sub>AoU1027</sub></div>
                                        <div class="item" data-value="sigma_TenK10K"><sub>10k10k</sub></div>
                                        <div class="item" data-value="sigma_1kGP"><sub>1kGP</sub></div>
                                        <div class="item" data-value="sigma_T2T"><sub>T2T</sub></div>
                                    </div>
                                </div>
                                <div style="display: inline-flex; align-items: center;">
                                    <span style="margin-right: 12px;"></span>
                                    <input type="text" id="polymorphism-threshold" name="polymorphismThreshold" placeholder="0.5" style="width: 60px;">
                                </div>
                            </div>
                        </div>

                        <div class="field" style="padding-top: 5px; max-width: 440px;">
                            <label>Variation Cluster Filter</label>
                            <div class="checkbox-group" style="display: flex; align-items: center;">
                                <div class="ui checkbox" style="padding-right: 10px !important">
                                    <input type="checkbox" name="vcFilter">
                                    <label>Variation cluster (VC) filter:</label>
                                </div>
                                <div class="ui selection dropdown" id="variation-cluster-filter-dropdown">
                                    <input type="hidden" name="vcFilterType">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">Select filter</div>
                                    <div class="menu">
                                        <div class="item" data-value=""></div>
                                        <div class="divider"></div>
                                        <div class="item" data-value="exclude">Exclude VCs</div>
                                        <div class="item" data-value="exclude_ge_50">Exclude VCs  +50bp</div>
                                        <div class="divider"></div>
                                        <div class="item" data-value="keep">Keep only VCs</div>
                                        <div class="item" data-value="keep_ge_50">Keep only VCs  +50bp</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
        <div class="three wide column"></div>
    </div>
    <div class="ui row">
        <div class="one wide column"></div>
        <div class="fourteen wide column">
            <!-- Results Area -->
            <div id="results-area" style="position: relative; z-index: 100;">
                <div id="loading-container" style="display: none">
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="ui small active inline loader"></div>
                        <span>Loading...</span>
                    </div>
                </div>
                <div class="pagination-container top-pagination"></div>
                <div id="results-table"></div>
                <div class="pagination-container bottom-pagination"></div>
                <div id="error-message" class="ui negative message" style="display: none">
                    <i class="close icon"></i>
                    <div class="header">Error</div>
                    <p id="error-text"></p>
                </div>
            </div>
        </div>
        <div class="one wide column"></div>
    </div>
</div>

<script>

    $('body').css('cursor', 'wait')

    const RESULTS_TABLE_COLUMN_NAMES = [
        'ReferenceRegion',
        'ReferenceMotif',
        'CanonicalMotif',
        'NumRepeatsInReference',
        'FlanksAndLocusMappability',
        'ReferenceRepeatPurity',
        'TRsInRegion',
        'dotPlot',

        'GencodeGeneRegion',
        'GencodeGeneName',
        'variationCluster',
        'Source',
        'isPathogenic',

        'GencodeGeneId',
        'GencodeTranscriptId',
        'RefSeqGeneRegion',
        'RefSeqGeneId',
        'RefSeqGeneName',
        'RefSeqTranscriptId',
        'ManeGeneRegion',
        'ManeGeneId',
        'ManeGeneName',

        'HPRC100_AlleleHistogram',
        'TenK10K_AlleleHistogram',
        'AlleleFrequenciesFromIllumina174k',
        'AlleleFrequenciesFromT2TAssemblies',

        'polymorphism',

        'HPRC100_Stdev',
        'AoU1027_Stdev',
        'TenK10K_Stdev',
        'StdevFromIllumina174k',
        'StdevFromT2TAssemblies',

        'HPRC100_BiallelicHistogram',
        'TenK10K_BiallelicHistogram',

        'VamosMotifFrequencies',
        'RepeatMaskerIntervals',
        'AoU1027_OE_LengthPercentile',
        'ReferenceLeftFlank',
        'ReferenceRepeatSequence',
        'ReferenceRightFlank',
    ]

    if (!RESULTS_TABLE_COLUMN_NAMES.every(columnName => Object.keys(TABLE_COLUMNS).includes(columnName))) {
        throw new Error('RESULTS_TABLE_COLUMN_NAMES is missing columns from TABLE_COLUMNS: ' + RESULTS_TABLE_COLUMN_NAMES.filter(columnName => !Object.keys(TABLE_COLUMNS).includes(columnName)).join(', '))
    }

    //index page-specific settings of the DEFAULT_GLOBAL_PAGE_STATE
    DEFAULT_GLOBAL_PAGE_STATE['showColumns'] = [
        'ReferenceRegion',
        'ReferenceMotif',
        'ReferenceRepeatPurity',
        'GencodeGeneRegion',
        'GencodeGeneName',
        'variationCluster',
        'Source',
        'HPRC100_AlleleHistogram',
        'VamosMotifFrequencies',
        'RepeatMaskerIntervals',
    ].map(columnName => RESULTS_TABLE_COLUMN_NAMES.indexOf(columnName)).join(SHOW_COLUMNS_VALUE_DELIMITER)

    //copy the default persistent page state
    let GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))

    const RESULTS_TABLE_COLUMN_SELECTION_CHECKBOXES = [
        'ReferenceRegion',
        'ReferenceMotif',
        'CanonicalMotif',
        'NumRepeatsInReference',
        'ReferenceRepeatPurity',
        'FlanksAndLocusMappability',
        'variationCluster',
        'TRsInRegion',
        'ReferenceRepeatSequence',
        'ReferenceLeftFlank',
        'ReferenceRightFlank',

        'GencodeGeneName',
        'GencodeGeneRegion',
        'GencodeGeneId',
        'GencodeTranscriptId',
        'RefSeqGeneRegion',
        'RefSeqGeneId',
        'RefSeqGeneName',
        'RefSeqTranscriptId',
        'ManeGeneRegion',
        'ManeGeneId',
        'ManeGeneName',

        'VamosMotifFrequencies',
        'polymorphism',

        'HPRC100_AlleleHistogram',
        'TenK10K_AlleleHistogram',  
        'AlleleFrequenciesFromIllumina174k',  
        'AlleleFrequenciesFromT2TAssemblies',  
        
        'HPRC100_Stdev',  
        'AoU1027_Stdev',  
        'TenK10K_Stdev',  
        'StdevFromIllumina174k',  
        'StdevFromT2TAssemblies',

        'Source',
        'RepeatMaskerIntervals',
        'isPathogenic',
        'AoU1027_OE_LengthPercentile',
        'dotPlot',

    ]

    const generateDiseaseAssociatedIcon = (row, linkText) => {
        if (row.DiseaseInfo == null) {
            return ''
        }
        let diseaseAssociatedIconHtml = ''
        let diseaseLocusId = ''
        let diseaseDescription = `<span style='font-weight: bold; white-space: nowrap; text-align: left; display: block;'>Disease-associated locus</span><br />`
        try {
            //console.log(row.DiseaseInfo)
            const diseaseInfo = JSON.parse(row.DiseaseInfo)
            const resources = []
            if (diseaseInfo.STRchiveId) {
                resources.push(`<a href='https://strchive.org/loci/${diseaseInfo.STRchiveId}' target='_blank'>STRchive</a>`)
            }
            if (diseaseInfo.STRipyId) {
                resources.push(`<a href='https://stripy.org/database/${diseaseInfo.STRipyId}' target='_blank'>STRipy</a>`)
            }
            if (diseaseInfo.locusId != 'RAI1') {
                resources.push(`<a href='https://gnomad.broadinstitute.org/short-tandem-repeat/${diseaseInfo.LocusId}?dataset=gnomad_r4' target='_blank'>gnomAD</a>`)
            }
            if (diseaseInfo.Diseases.length > 0 && diseaseInfo.Diseases[0].OMIM) {
                resources.push(`<a href='https://www.omim.org/entry/${diseaseInfo.Diseases[0].OMIM}' target='_blank'>OMIM</a>`)
            }
            diseaseDescription += `Expansions at this ${diseaseInfo.LocusId} locus cause ${diseaseInfo.Diseases.map(d => d.Name).join(' & ')}.<br />
            <br />
                <span style='display: block; white-space: nowrap;'>For more information, see:<br />${resources.join(', &nbsp; ')}</span>
            </span>`
        } catch (e) {
            diseaseLocusId = row.LocusId
            diseaseDescription = '<i>An error occurred while loading this information.</i>'
            console.error(`Error parsing ${row.LocusId} DiseaseInfo JSON: ${row.DiseaseInfo}`, e)
        }
        diseaseAssociatedIconHtml += `<i style="margin-left: 10px;" class="disease-associated-icon action-cell user md icon" data-title="${diseaseLocusId}" data-html="${diseaseDescription}"></i>`
        if (linkText) {
            diseaseAssociatedIconHtml = `<span class="">${diseaseAssociatedIconHtml} ${linkText}</span>`
        }
        return diseaseAssociatedIconHtml
    }

    const getHtmlAttributesForPolymorphism = (row) => {
        let polymorphismDetails = ``
        for (const dataColumn of REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN) {
            if (row[dataColumn] != null) {
                polymorphismDetails += `data-${dataColumn}='${row[dataColumn]}' `
            }
        }
        return polymorphismDetails
    }


    const readAndApplyPersistentPageStateFromUrl = async () => {
        GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))
        
        const hash = window.location.hash.substring(1)
        if (!hash) return
        
        const params = new URLSearchParams(hash)
        
        for (const [key, value] of params.entries()) {
            if (key in DEFAULT_GLOBAL_PAGE_STATE && value != null) {
                // Convert string values to appropriate types
                GLOBAL_PAGE_STATE[key] = value === 'true' ? true : 
                                        value === 'false' ? false :
                                        !isNaN(value) ? Number(value) : value
                if (key === 'showColumns') {
                    GLOBAL_PAGE_STATE['showColumns'] = `${value}` // convert to string
                }
            }
        }
        console.log("Starting to initialize page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)


        // igv
        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        }

        // advanced search wrapper
        if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {
            $('#advanced-search-form').show()
            $('#filter-button .filter.icon').removeClass('rotated')
        }

        // search
        $('#search-query').val(GLOBAL_PAGE_STATE['searchQuery'])

        $('select[name="sourceCatalog"]').val(GLOBAL_PAGE_STATE['sourceCatalog'])
        $('#source-catalog-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['sourceCatalog'])

        $('input[name="keepMotifSize"]').val(GLOBAL_PAGE_STATE['keepMotifSize'])
        $('input[name="keepMotif"]').val(GLOBAL_PAGE_STATE['keepMotif'])

        $('input[name="keepCodingLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepCodingLoci'] === 1)
        $('input[name="keepFiveUTRLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepFiveUTRLoci'] === 1)
        $('input[name="keepThreeUTRLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepThreeUTRLoci'] === 1)
        $('input[name="keepPromoterLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepPromoterLoci'] === 1)
        $('input[name="keepIntronLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepIntronLoci'] === 1)
        $('input[name="keepIntergenicLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepIntergenicLoci'] === 1)
        $('input[name="keepNonCodingExonLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepNonCodingExonLoci'] === 1)
        $('input[name="keepLociThatOverlapDiseaseAssociatedLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepLociThatOverlapDiseaseAssociatedLoci'] === 1)

        $('input[name="polymorphismFilter"]').prop('checked', GLOBAL_PAGE_STATE['polymorphismFilter'] === 1)
        $('select[name="polymorphismFilterType"]').val(GLOBAL_PAGE_STATE['polymorphismFilterType'])
        $('#polymorphism-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['polymorphismFilterType'])
        $('input[name="polymorphismThreshold"]').val(GLOBAL_PAGE_STATE['polymorphismThreshold'])

        $('input[name="vcFilter"]').prop('checked', GLOBAL_PAGE_STATE['vcFilter'] === 1)
        $('select[name="vcFilterType"]').val(GLOBAL_PAGE_STATE['vcFilterType'])
        $('#variation-cluster-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['vcFilterType'])
        // Restore custom track URLs
        for (let i = 1; i <= 3; i++) {
            $(`#igv-custom-track-url-${i}`).val(GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] || '')
        }

        if (GLOBAL_PAGE_STATE['showRs'] === 1) {
            if (!validateForm()) {
                return;
            }            
            await performSearch(false)
        }
    }


    $('#show-igv-divider').click(async () => {
        GLOBAL_PAGE_STATE['showIGV'] = (GLOBAL_PAGE_STATE['showIGV'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        } else {
            $('#igv-row').slideUp(500, () => {
                $('#hide-igv-divider-text').hide()
                $('#show-igv-divider-text').show()
            })
        }

    })


    const updatePaginationControls = () => {

        const $topPagination = $('.top-pagination')
        const $bottomPagination = $('.bottom-pagination')

        const currentPage = GLOBAL_PAGE_STATE['currentPage']
        const pageSize = GLOBAL_PAGE_STATE['pageSize']
        const totalResults = window.searchResults.total_results


        // Always show pagination controls if there are results
        if (totalResults > 0) {
            $topPagination.show()
            $bottomPagination.show()
        } else {
            $topPagination.hide()
            $bottomPagination.hide()
            return
        }

        const nFirstRowOnPage = (currentPage - 1) * pageSize + 1
        const nLastRowOnPage = Math.min(nFirstRowOnPage + pageSize - 1, totalResults)

        const totalPages = parseInt(Math.ceil(totalResults / pageSize))

        const paginationHtml = `
                <div class="total-results">
                    Showing ${nFirstRowOnPage.toLocaleString()}-${nLastRowOnPage.toLocaleString()} out of ${totalResults.toLocaleString()}
                </div>
                <div class="export-selector">
                    <span class="export-label"><b>Export to:</b></span>
                    <div class="ui selection dropdown export-dropdown" id="export-dropdown" style="min-width: 160px">
                        <input type="hidden" name="export-format">
                        <i class="dropdown icon"></i>
                        <div class="default text">Select format</div>
                        <div class="menu">
                            <div class="item" data-value="bed">BED</div>
                            <div class="item" data-value="tsv">TSV</div>
                            <div class="item" data-value="json">JSON</div>
                            <div class="divider"></div>
                            <div class="header">Tool input formats:</div>
                            <div class="item" data-value="expansion_hunter">ExpansionHunter</div>
                            <div class="item" data-value="gangstr">GangSTR</div>
                            <div class="item" data-value="hipstr">HipSTR</div>
                            <div class="item" data-value="trgt">TRGT</div>
                            <div class="item" data-value="longtr">LongTR</div>
                            <div class="item" data-value="vamos">Vamos</div>
                        </div>
                    </div>
                    <i class="question circle icon export-help-icon" data-html="Export all ${totalResults.toLocaleString()} search results to a file in the selected format"></i>
                </div>
                <div class="page-size-selector">
                    <span>Page size:</span>
                    <div class="ui selection dropdown page-size-select" style="min-width: 80px">
                        <input type="hidden" name="page-size">
                        <i class="dropdown icon"></i>
                        <div class="text">${pageSize}</div>
                        <div class="menu">
                            <div class="item" data-value="10">10</div>
                            <div class="item" data-value="20">20</div>
                            <div class="item" data-value="50">50</div>
                            <div class="item" data-value="100">100</div>
                            <div class="item" data-value="200">200</div>
                            <div class="item" data-value="500">500</div>
                            <div class="item" data-value="1000">1000</div>
                        </div>
                    </div>
                </div>
                <div class="pagination-controls">
                    <button class="ui icon button first-page ${currentPage === 1 ? 'disabled' : ''}" title="First page">
                        <i class="angle double left icon"></i>
                    </button>
                    <button class="ui icon button prev-page ${currentPage === 1 ? 'disabled' : ''}"
                            title="Previous page">
                        <i class="angle left icon"></i>
                    </button>
                    <div class="page-input-container">
                        <span>Page</span>
                        <input type="number" class="page-number-input" min="1" max="${totalPages}" value="${currentPage}">
                        <span class="total-pages">of ${totalPages.toLocaleString()}</span>
                    </div>
                    <button class="ui icon button next-page ${currentPage === totalPages ? 'disabled' : ''}"
                            title="Next page">
                        <i class="angle right icon"></i>
                    </button>
                    <button class="ui icon button last-page ${currentPage === totalPages ? 'disabled' : ''}"
                            title="Last page">
                        <i class="angle double right icon"></i>
                    </button>
                </div>
            `

        $topPagination.html(paginationHtml)
        $bottomPagination.html(paginationHtml)

        $('.export-help-icon').popup({ on: 'click' })

        // Add click handlers for all pagination containers
        $('.pagination-container').each(function() {
            const $container = $(this)

            // Handle page size selection using standard <select>
            $container.find('.page-size-select').dropdown({
                onChange: (value) => {
                    const newPageSize = parseInt(value)
                    if (newPageSize !== GLOBAL_PAGE_STATE['pageSize']) {
                        GLOBAL_PAGE_STATE['pageSize'] = newPageSize
                        GLOBAL_PAGE_STATE['currentPage'] = 1
                        writePersistentPageStateToUrl()
                        performSearch(true)
                    }
                },
                onShow: function() {
                    $(this).css('z-index', 1001)
                },
                onHide: function() {
                    $(this).css('z-index', '')
                }
            })

            // First page button
            $container.find('.first-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] = 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Previous page button
            $container.find('.prev-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] -= 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Next page button
            $container.find('.next-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] += 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Last page button
            $container.find('.last-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] = totalPages
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Page input handler
            $container.find('.page-number-input').on('change keypress', function(e) {
                if (e.type === 'change' || e.which === 13) {
                    const newPage = parseInt($(this).val())
                    if (newPage !== currentPage) {
                        GLOBAL_PAGE_STATE['currentPage'] = Math.max(1, Math.min(newPage, totalPages))
                        writePersistentPageStateToUrl()
                        performSearch(true)
                    }

                    if (e.type === 'keypress') {
                        e.preventDefault()
                    }
                }
            })
        })

        $('.export-dropdown').dropdown({
            onShow: function() {
                $(this).css('z-index', 10001)
            },
            onHide: function() {
                $(this).css('z-index', '')
            },
            onChange: async (value) => {
                if (!value) return

                $('.export-dropdown').dropdown('clear')

                // Format data based on export type
                let fileFormat
                if (value === 'expansion_hunter' || value == 'json') {
                    fileFormat = 'JSON'
                } else if (value === 'gangstr' || value === 'hipstr' || value === 'trgt' || value === 'longtr' || value === 'bed') {
                    fileFormat = 'BED'
                } else if (value === 'tsv' || value == 'vamos') {
                    fileFormat = 'TSV'
                } else {
                    throw new Error(`Invalid export-dropdown value: ${value}`)
                }

                let toolName
                let selectClause
                let conditions = [...window.lastSearchConditions]
                let sortClause = ['chrom', 'start_0based', 'end_1based'].join(', ')
                if (value === 'expansion_hunter') {
                    toolName = 'ExpansionHunter'
                    selectClause = `LocusId, ReferenceRegion, CONCAT('(', ReferenceMotif, ')*') AS LocusStructure, 'Repeat' AS VariantType`
                    conditions.push(`NsInFlanks<=5`)
                    alert('Note: The exported ExpansionHunter catalog will exclude any loci that have > 5 Ns within their flanking regions since ExpansionHunter does not support them.')
                } else if(value === 'gangstr') {
                    toolName = 'GangSTR'
                    selectClause = `CONCAT('chr', chrom), start_0based + 1 AS start_1based, end_1based, MotifSize, ReferenceMotif, '' AS OffTargetRegions`
                } else if(value === 'hipstr' || value === 'longtr') {
                    toolName = value === 'hipstr' ? 'HipSTR' : 'LongTR'
                    selectClause = `CONCAT('chr', chrom), start_0based + 1 AS start_1based, end_1based, MotifSize, NumRepeatsInReference, LocusId, ReferenceMotif`
                } else if(value === 'trgt') {
                    toolName = 'TRGT'
                    selectClause = `CONCAT('chr', chrom), start_0based, end_1based, CONCAT('ID=', LocusId, ';MOTIFS=', ReferenceMotif, ';STRUC=(', ReferenceMotif, ')n') AS InfoField`
                } else if(value === 'vamos') {
                    toolName = 'vamos'
                    selectClause = `CONCAT('chr', chrom), start_0based + 1 AS start_1based, end_1based, CASE WHEN VamosUniqueMotifs IS NOT NULL THEN VamosUniqueMotifs ELSE ReferenceMotif END AS UniqueMotifs, CONCAT('Export_', FORMAT_TIMESTAMP('%Y%m%d_%H%M%S', CURRENT_TIMESTAMP()), ':', source) AS Source, CASE WHEN MotifSize > 6 THEN 'VNTR' ELSE 'STR' END AS LocusType, MotifSize, -1 AS TEOverlap1, -1 AS TEOverlap2`
                    conditions.push(`IncludeInVamosCatalog=1`)
                    alert('Note: The exported Vamos catalog will exclude any loci that overlap larger loci since Vamos does not support overlapping locus definitions.')
                } else if(value === 'bed') {
                    selectClause = `CONCAT('chr', chrom), start_0based, end_1based, ReferenceMotif, MotifSize`
                } else if(value === 'tsv' || value === 'json') {
                    const tsv_columns = [
                        //'chrom_index',
                        `CONCAT('chr', chrom) AS chrom`,
                        'start_0based',
                        'end_1based',
                        'ReferenceRegion',
                        'LocusId',
                        'ReferenceMotif',
                        'MotifSize',
                        'CanonicalMotif',
                        'NumRepeatsInReference',
                        'ReferenceRepeatPurity',
                        'NsInFlanks',
                        'TRsInRegion',
                        'Source',
                        //'LeftFlankMappability',
                        //'RightFlankMappability',
                        'FlanksAndLocusMappability',
                        'VariationCluster',
                        'VariationClusterSizeDiff',
                        'KnownDiseaseAssociatedLocus',
                        'KnownDiseaseAssociatedMotif',
                        'GencodeGeneRegion',
                        'GencodeGeneName',
                        'GencodeGeneId',
                        'GencodeTranscriptId',
                        'RefseqGeneRegion',
                        'RefseqGeneName',
                        'RefseqGeneId',
                        'RefseqTranscriptId',
                        'ManeGeneRegion',
                        'ManeGeneName',
                        'ManeGeneId',
                        'ManeTranscriptId',

                        //'LPSLengthStdevFromHPRC100',
                        //'LPSMotifFromHPRC100',
                        //'LPSMotifFractionFromHPRC100',
                        //'LPSMotifDenominatorFromHPRC100',

                        'AlleleFrequenciesFromIllumina174k',
                        'StdevFromIllumina174k',
                        'AlleleFrequenciesFromT2TAssemblies',
                        'StdevFromT2TAssemblies',

                        'TenK10K_AlleleHistogram',
                        'TenK10K_ModeAllele',
                        'TenK10K_Stdev',
                        'TenK10K_Median',
                        'TenK10K_99thPercentile',

                        'HPRC100_AlleleHistogram',
                        'HPRC100_ModeAllele',
                        'HPRC100_Stdev',
                        'HPRC100_Median',
                        'HPRC100_99thPercentile',

                        'AoU1027_MinAllele',
                        'AoU1027_ModeAllele',
                        'AoU1027_Stdev',
                        'AoU1027_Median',
                        'AoU1027_99thPercentile',
                        'AoU1027_MaxAllele',
                        //'AoU1027_UniqueAlleles',   // TODO restore this field when I get new data table with bug fix

                        'AoU1027_OE_Length',
                        'AoU1027_OE_LengthPercentile',

                        'RepeatMaskerIntervals',
                        'VamosMotifFrequencies',
                    ]
                    selectClause = tsv_columns.join(', ')
                    sortClause = window.lastSearchSortClause
                } else {
                    throw new Error(`Invalid export-dropdown value: ${value}`)
                }

                try {
                    $('body').css('cursor', 'wait')

                    const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : ''
                    const query = `SELECT ${selectClause} FROM ${COMPLETE_TABLE_ID} ${whereClause} ORDER BY ${sortClause}`
                    const results = await queryBigQuery(query, null, null, fileFormat, toolName)

                    if (results.public_urls) {
                        if (results.public_urls.length > 1) {
                            if (!confirm(`The requested export is very large, so it was split into ${results.public_urls.length} separate files. Would you like to download them?`)) {
                                return;
                            }
                        }
                        for (const url of results.public_urls) {
                            console.log('Downloading URL:', url)
                            // Create and trigger download link using jQuery
                            const $link = $('<a>')
                                .attr('href', url)
                                .appendTo('body')
                            $link[0].click()

                            // Add a small delay between downloads
                            await new Promise(resolve => setTimeout(resolve, 2000))

                            // Keep track of the link for later removal
                            if (!window.downloadLinks) {
                                window.downloadLinks = []
                            }
                            window.downloadLinks.push($link)

                            // If this is the first link, start the cleanup timer
                            if (window.downloadLinks.length === 1) {
                                setTimeout(() => {
                                    window.downloadLinks.forEach($link => {
                                        $link.remove()
                                    })
                                    window.downloadLinks = []
                                }, 2*60*1000)
                            }

                        }
                    }

                } catch (error) {
                    console.error('Error exporting data:', error)
                    alert('Error exporting data: ' + error.message)
                } finally {
                    $('body').css('cursor', 'default')
                }
            }
        })
    }


    const createSmallAlleleFrequencyChart = function() {
        const frequencies = $(this).data('frequencies')
        const refAlleleSize = $(this).data('ref-allele-size')

        if (!frequencies) return   // Skip if no data

        const data = parseAlleleFrequenciesString(frequencies)

        const yLookup = {}
        const xLabels =  []
        const colors = []
        const borderColors = []
        for (let i = Math.min(...data.map(d => d.size)) - 1; i <= Math.max(...data.map(d => d.size)) + 1; i++) {
            xLabels.push(i)
            yLookup[i] = 0
        }
        for (let x of xLabels) {
            yLookup[x] = data.find(d => d.size === x)?.count || 0
            colors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 0.7)' : 'rgba(33, 133, 208, 0.5)')
            borderColors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 1)' : 'rgba(33, 133, 208, 1)')
        }

        //set y-limit to the nearest whole power of 10 divided by 2, rounding up
        const yLimit = Math.pow(10, Math.ceil(Math.log10(2 * Math.max(...data.map(d => d.count))))) / 2
        new Chart(this, {
            type: 'bar',
            data: {
                labels: xLabels,
                datasets: [{
                    data: xLabels.map(d => yLookup[d]),
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Count: ${context.raw}`
                            }
                        },
                        position: 'nearest',
                        yAlign: 'bottom'
                    }
                },
                scales: {
                    y: {
                        type: 'logarithmic',
                        min: 0,
                        max: parseInt(yLimit),
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                if (Math.floor(value) === value) {
                                    return parseInt(value)
                                }
                            },
                            padding: 3,
                        },
                        grid: {
                            drawTicks: false
                        }

                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            },
                            padding: 3
                        },
                        grid: {
                            drawTicks: false
                        }
                    }
                }
            }
        })

        this.style.minHeight = '55px'
        this.style.maxHeight = '55px'
        this.style.minWidth = '100px'
        this.style.maxWidth = '200px'
        this.style.height = '55px'

        $(this).parent().css('padding-top', '0')
        $(this).parent().css('padding-bottom', '0')
    }


    const displayError = (message) => {
        $('#error-text').text(message)
        $('#error-message').show()
        $('#results-table').empty()
    }

    const displaySearchResults = () => {

        const results = window.searchResults
        const sortColumn = GLOBAL_PAGE_STATE['sc']
        const sortDirection = GLOBAL_PAGE_STATE['sd']
        const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)

        const resultsTableElement = $('#results-table')

        resultsTableElement.removeClass('loading')
        if (!results.rows || results.rows.length === 0) {
            resultsTableElement.html('<div class="no-results">No matching results found</div>')
            $('.pagination-container').hide()
            return
        }

        let tableHtml = '<table class="ui celled sortable table"><thead><tr>'
        tableHtml += `<th style="text-align: center">
            <button id="results-table-settings-button" class="ui primary basic grey button" style="height:25px; padding:2px 3px 2px 13px; border-radius:5px; background-color: #FCFCFF !important" data-tooltip="Column descriptions and settings">
                <i class="setting icon"></i>
            </button>
        </th>`

        Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
            if (visibleColumns.includes(columnId)) {
                const columnObject = TABLE_COLUMNS[columnName]
                const isSorted = columnName === sortColumn
                let icon = '<i class="sort icon"></i>'
                if (isSorted) {
                    icon = sortDirection === 'ASC' ? '<i class="sort up icon"></i>' : '<i class="sort down icon"></i>'
                }
                tableHtml += `<th class="${isSorted ? 'sorted' : ''} results-table-sortable-header" data-column="${columnName}">${columnObject.displayName} ${icon}</th>`
            }
        })

        tableHtml += '<th></th></tr></thead><tbody>'

        const startIndex = GLOBAL_PAGE_STATE['pageSize'] * (GLOBAL_PAGE_STATE['currentPage'] - 1)

        results.rows.forEach((row, index) => {
            let diseaseAssociatedIconHtml = generateDiseaseAssociatedIcon(row)

            tableHtml += `<tr ${diseaseAssociatedIconHtml ? 'class="disease-associated-row"' : ''}>`
            tableHtml += `<td style="text-align: left;">
                <div style="min-width: 25px; padding-right: 5px; display: inline-block;">
                    <a class="row-locus-page-button action-link" data-locus-id="${row['LocusId']}" data-reference-region="${row['ReferenceRegion']}">#${(startIndex + index + 1).toLocaleString()}:</a>
                </div>
                <a class="row-igv-button action-link" data-reference-region="${row['ReferenceRegion']}">IGV</a>
                ${diseaseAssociatedIconHtml}
            </td>`

            Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
                if (visibleColumns.includes(columnId)) {
                    const columnObject = TABLE_COLUMNS[columnName]
                    let value
                    if (!columnObject || !columnObject.getValue) {
                        const label = columnObject ? 'columnObject' : 'columnObject.getValue'
                        console.log('WARNING: ', label, 'is undefined for columnId:', columnId, 'columnName:', columnName)
                        value = row[columnName]
                    } else {
                        value = columnObject.getValue(row)
                    }

                    tableHtml += `<td style="padding: 3px 5px 3px 10px">${value != null ? value : ''}</td>`
                }
            })
            tableHtml += `<td style="padding:15px"><a class="row-locus-page-button" style="cursor: pointer" data-locus-id="${row['LocusId']}" data-reference-region="${row['ReferenceRegion']}"><i class="chevron circle right icon"></i></a></td>`
            tableHtml += '</tr>'
        })
        tableHtml += '</tbody></table>'
        resultsTableElement.html(tableHtml)

        // Add click handlers for sortable headers
        resultsTableElement.find('.results-table-sortable-header').click(function() {
            const column = $(this).data('column')
            if (column === sortColumn) {
                if (sortDirection === 'ASC') {
                    if (!TABLE_COLUMNS[column]?.defaultSortDirection || TABLE_COLUMNS[column]?.defaultSortDirection == 'ASC') {
                        GLOBAL_PAGE_STATE['sd'] = 'DESC'
                    } else {
                        GLOBAL_PAGE_STATE['sc'] = DEFAULT_SORT_COLUMN
                        GLOBAL_PAGE_STATE['sd'] = DEFAULT_SORT_DIRECTION
                    }
                } else if (sortDirection === 'DESC') {
                    if (TABLE_COLUMNS[column]?.defaultSortDirection == 'DESC') {
                        GLOBAL_PAGE_STATE['sd'] = 'ASC'
                    } else {
                        GLOBAL_PAGE_STATE['sc'] = DEFAULT_SORT_COLUMN
                        GLOBAL_PAGE_STATE['sd'] = DEFAULT_SORT_DIRECTION
                    }
                }
            } else {
                GLOBAL_PAGE_STATE['sc'] = column
                GLOBAL_PAGE_STATE['sd'] = TABLE_COLUMNS[column]?.defaultSortDirection || 'ASC'
            }

            performSearch(true)
        })

        // render dot plot and add click handler
        resultsTableElement.find('.dotPlot').each(function() {
            const referenceRegion = $(this).data('reference-region')
            const referenceRegionSize = $(this).data('reference-region-size')
            const numRepeatsInReference = $(this).data('repeats-in-reference')
            const flankWidth = $(this).data('flank-width')
            const motif = $(this).data('motif')

            const leftFlank = $(this).data('left-flank')
            const repeatSeq = $(this).data('repeat-seq')
            const rightFlank = $(this).data('right-flank')
            const sequence = [leftFlank, repeatSeq, rightFlank].join('|')

            const pixelsPerCell = 2 // higher number increases resolution
            plotDotPlot(this, sequence, pixelsPerCell, false)
            $(this).click(() => {
                $('#dot-plot-dialog-header').html(`${referenceRegion} locus: ${referenceRegionSize}bp repeat +/- ${flankWidth}bp flanks; ${numRepeatsInReference} x ${motif}`)

                const dotPlotPixelsPerCell = 10
                const dotPlotDialogCanvas = $('#dot-plot-dialog-canvas').get(0)
                plotDotPlot(dotPlotDialogCanvas, sequence, dotPlotPixelsPerCell, false)

                const dotPlotDialogPeriodicityPlotCanvas = $('#dot-plot-dialog-periodicity-plot-canvas').get(0)
                const periodicityPlotPixelsPerCell = 10
                const minRunLength = 5
                const useBackwardLook = false
                const endWithPeriod = Math.max(motif.length * 2, 12)
                const periodicityMatrix = plotPeriodicityPlot(
                    dotPlotDialogPeriodicityPlotCanvas,
                    sequence,
                    periodicityPlotPixelsPerCell,
                    minRunLength,
                    useBackwardLook,
                    1,
                    endWithPeriod,
                )

                const barPlotDiv = $('#dot-plot-dialog-bar-plot').get(0)
                buildPeriodicityMatrixBarChart(barPlotDiv, periodicityMatrix)

                $('#dot-plot-dialog-sequences').html(`
                <table>
                <tr><td><b>Left Flank:</b></td></tr>
                <td><span style="font-family: monospace">${leftFlank}</span></td></tr>
                <tr><td><b>Repeat Sequence:</b></td></tr>
                <tr><td><span style="font-family: monospace">${repeatSeq}</span></td></tr>
                <tr><td><b>Right Flank:</b></td></tr>
                <tr><td><span style="font-family: monospace">${rightFlank}</span></td></tr>
                </table>
                `)
                $('#dot-plot-dialog').modal('show')
            })
        })

        // add click handler for locus page buttons
        $('.row-locus-page-button').click(function() {
            const locusId = $(this).data('locus-id')
            const referenceRegion = $(this).data('reference-region')
            if (!locusId || !referenceRegion) return

            // get url params
            let locusPageUrlArgs = `locusId=${locusId}&igvLoc=${referenceRegion}`
            const urlArgs = window.location.hash.substring(1)
            if (urlArgs) {
                const currentPageUrlParams = new URLSearchParams(urlArgs)
                for (const [key, value] of currentPageUrlParams.entries()) {
                    if (key != 'locusId' & key != 'igvLoc') {
                        locusPageUrlArgs += `&${key}=${value}`
                    }
                }
            }

            const locusPageUrl = `locus.html?#${locusPageUrlArgs}`
            window.open(locusPageUrl, '_blank')
        })

        // add click handlers for IGV buttons
        $('.row-igv-button').click(async function() {
            const referenceRegion = $(this).data('reference-region')
            if (!referenceRegion) return

            // Parse the locus to get chrom, start, end
            const match = referenceRegion.match(REFERENCE_REGION_REGEXP)
            if (!match) {
                console.warn(`Unexpected locus format: ${referenceRegion}`)
                return
            }

            const [_, chrom, start, end] = match
            const paddedStart = Math.max(0, parseInt(start.replace(',', '')) - IGV_LOCUS_PADDING)
            const paddedEnd = parseInt(end.replace(',', '')) + IGV_LOCUS_PADDING
            const paddedReferenceRegion = `${chrom}:${paddedStart}-${paddedEnd}`


            try {
                $('body').css('cursor', 'wait')

                // Navigate to the locus
                GLOBAL_PAGE_STATE['igvLoc'] = paddedReferenceRegion

                // Show IGV if hidden
                if (GLOBAL_PAGE_STATE['showIGV'] !== 1) {

                    GLOBAL_PAGE_STATE['showIGV'] = 1
                    writePersistentPageStateToUrl()

                    $('#igv-row').show()
                    $('#show-igv-divider-text').hide()
                    $('#hide-igv-divider-text').show()
                    await updateIgv()
                } else {
                    if (!window.igvBrowser) {
                        console.error("WARNING: IGV browser not initialized yet")
                        await updateIgv()
                    }
                    writePersistentPageStateToUrl()

                    await window.igvBrowser.search(paddedReferenceRegion)
                }

                // Scroll the page to the IGV browser
                $('#igv-row')[0].scrollIntoView({ behavior: 'smooth' })


                // Enable the "TRExplorer genome-wide catalog" track if it's not already enabled
                if (!GLOBAL_PAGE_STATE['igv_tr_explorer_catalog_v2']) {
                    GLOBAL_PAGE_STATE['igv_tr_explorer_catalog_v2'] = 1
                    writePersistentPageStateToUrl()

                    await updateIgv()
                }
            } finally {
                $('body').css('cursor', 'default')
            }
        })

        // init charts
        $('.allele-frequency-inline-chart').each(createSmallAlleleFrequencyChart)


        // init popups
        $('.show-popup').popup({ on: 'click', hoverable: true })
        $('.cell-in-polymorphism-column').click(showPolymorphismDialog)
        $('.disease-associated-icon').popup({ on: 'click' })

        // init click handler for "Column settings" modal
        $('#results-table-settings-button').click((e) => {
            e.preventDefault()

            // Clear existing checkboxes
            $('.results-table-column-settings-checkboxes tr').remove()

            // Create a flex container div
            $('.results-table-column-settings-checkboxes').html('<div class="results-table-column-settings-checkbox-flex-container"></div>')

            const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
            const checkboxes = RESULTS_TABLE_COLUMN_SELECTION_CHECKBOXES.map((columnName) => {
                const columnId = RESULTS_TABLE_COLUMN_NAMES.indexOf(columnName)
                const isChecked = visibleColumns.includes(columnId.toString())
                return `
                    <div class="results-table-column-settings-checkbox-item">
                        <div class="ui checkbox" style="display: inline-block; padding-right: 10px">
                            <input type="checkbox" name="show_column_${columnId}" ${isChecked ? 'checked' : ''}>
                            <label>${TABLE_COLUMNS[columnName]?.displayName || ''}</label>
                        </div>
                        ${TABLE_COLUMNS[columnName]?.helpText ? `<i class="question circle icon" data-html="${TABLE_COLUMNS[columnName].helpText}"></i>` : ''}
                    </div>`
            }).join('')

            $('.results-table-column-settings-checkbox-flex-container').append(checkboxes)

            // Initialize checkboxes
            $('.results-table-column-settings-checkboxes .ui.checkbox').checkbox()
            $('#results-table-column-settings-dialog').modal('show')
            $('.question').popup({ on: 'click' })
        })

        // handle Apply button click in column settings dialog
        $('#results-table-column-settings-apply-button').click(() => {
            const selectedColumns = []
            $('.results-table-column-settings-checkboxes input[type="checkbox"]').each(function() {
                if ($(this).prop('checked')) {
                    const columnId = $(this).attr('name').replace('show_column_', '')
                    selectedColumns.push(columnId)
                }
            })

            GLOBAL_PAGE_STATE['showColumns'] = selectedColumns.join(SHOW_COLUMNS_VALUE_DELIMITER)
            writePersistentPageStateToUrl()
            performSearch(true)

            $('#results-table-column-settings-dialog').modal('hide')
        })

        $('#results-table-column-settings-cancel-button').click(() => {
            $('#results-table-column-settings-dialog').modal('hide')
        })

        GLOBAL_PAGE_STATE['showRs'] = 1
        writePersistentPageStateToUrl()
    }

    const splitSearchQuery = (searchQuery) => {
        if (!searchQuery) {
            return []
        }

        searchQuery = searchQuery.trim()
        searchQuery = searchQuery.replace(/[]/g, '-') // Replace all unicode dash types with a regular dash

        // split by comma except where the comma is part of a large number (eg. 1,234,567)
        const searchQueryValues = searchQuery.split(/,(?!\d{3})/).map(q => q.trim()).filter(q => q !== '')

        return searchQueryValues
    }

    const performSearch = async (showTableWhileLoading = false) => {
        // Remove any error messages and no results message
        $('#error-message').hide()
        $('.no-results').hide()
        $('.top-pagination').hide()         // Hide only top pagination container during loading
        $('#loading-container').show()      // Show loading indicator

        // Add loading state to table without emptying it
        if (showTableWhileLoading) {
            $('.bottom-pagination').show()
            $('#results-table').addClass('loading')
        } else {
            $('#results-table').hide()
            $('.bottom-pagination').hide()
        }

        try {
            $('body').css('cursor', 'wait')

            let conditions = []
            let searchQuery = $('#search-query').val()
            if (searchQuery) {

                // Split input by commas to handle multiple values
                const queryValues = splitSearchQuery(searchQuery)

                // Process each query value and create query conditions
                const queryClauses = queryValues.map(queryValue => {

                    // Check if it's a genomic region (chr:start-end)
                    const regionMatch = queryValue.match(/^[\s]*(?:chr)?(\w+)[\s]*:[\s]*([\d,]+)[\s]*-[\s]*([\d,]+)[\s]*$/i)
                    if (regionMatch) {
                        let [_, chrom, start, end] = regionMatch
                        start = parseInt(start.replace(/,/g, ''))
                        end = parseInt(end.replace(/,/g, ''))
                        return `
                            (chrom = '${chrom}' AND start_0based < ${end} AND end_1based >= ${start})
                        `
                    } else {
                        const locusIdMatch = queryValue.match(/^[\s]*(?:chr)?(\w+)[\s]*-([\d,]+)-([\d,]+)-([ACGTNRYMKSWHBVD]+)[\s]*$/i)
                        if (locusIdMatch) {
                            //let [_, chrom, start, end, motif] = locusIdMatch
                            //start = parseInt(start.replace(/,/g, ''))
                            //end = parseInt(end.replace(/,/g, ''))
                            //return `(chrom = '${chrom}' AND start_0based < ${end - motif.length} AND end_1based >= ${start + motif.length} AND MotifSize = ${motif.length})`
                            return `LocusId = '${queryValue.trim()}'`

                        } else {
                            // Try other fields
                            return `
                                (UPPER(GencodeGeneName) = UPPER('${queryValue}')
                                OR UPPER(GencodeGeneId) = UPPER('${queryValue}')
                                OR UPPER(GencodeTranscriptId) = UPPER('${queryValue}')
                                OR UPPER(RefseqGeneName) = UPPER('${queryValue}')
                                OR UPPER(RefseqGeneId) = UPPER('${queryValue}')
                                OR UPPER(RefseqTranscriptId) = UPPER('${queryValue}')
                                OR UPPER(ManeGeneName) = UPPER('${queryValue}')
                                OR UPPER(ManeGeneId) = UPPER('${queryValue}')
                                OR UPPER(ManeTranscriptId) = UPPER('${queryValue}')
                                OR UPPER(LocusId) = UPPER('${queryValue}'))
                            `
                        }
                    }
                })
                
                // Combine all clauses with OR for multiple input values
                if (queryClauses.length > 0) {
                    conditions.push(`(${queryClauses.join(' OR ')})`)
                }
            }

            if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {

                // Add source catalog condition
                const sourceCatalog = $('#source-catalog-dropdown').dropdown('get value')
                if (sourceCatalog) {
                    switch (sourceCatalog) {
                        case 'tr_explorer_catalog_v2':
                            break   // No additional conditions needed
                        case 'tr_explorer_catalog':
                            conditions.push("Source LIKE 'TRExplorerV1%'")
                            break
                        case 'illumina_174k_catalog':
                            conditions.push(
                                "(FoundInIllumina174kPolymorphicTRs = 'Yes' OR (FoundInKnownDiseaseAssociatedLoci = 'Yes' AND FoundInIllumina174kPolymorphicTRs LIKE '%Yes%'))")
                            break
                        case 'known_disease_loci':
                            conditions.push("KnownDiseaseAssociatedLocus IS NOT NULL")
                            break
                    }
                }

                // Add variation cluster filter conditions
                const vcFilter = $('input[name="vcFilter"]').prop('checked')
                const vcFilterType = $('#variation-cluster-filter-dropdown').dropdown('get value')
                if (vcFilter && vcFilterType) {
                    switch (vcFilterType) {
                        case 'exclude':
                            conditions.push("(VariationCluster IS NULL OR VariationCluster = '')")
                            break
                        case 'exclude_ge_50':
                            conditions.push("(VariationCluster IS NULL OR VariationCluster = '' OR VariationClusterSizeDiff < 50)")
                            break
                        case 'keep':
                            conditions.push("(VariationCluster IS NOT NULL AND VariationCluster != '')")
                            break
                        case 'keep_ge_50':
                            conditions.push("(VariationCluster IS NOT NULL AND VariationCluster != '' AND VariationClusterSizeDiff >= 50)")
                            break
                    }
                }

                // Add polymorphism filter conditions
                const polymorphismFilter = $('input[name="polymorphismFilter"]').prop('checked')
                const polymorphismFilterType = $('#polymorphism-filter-dropdown').dropdown('get value')
                const polymorphismThreshold = $('input[name="polymorphismThreshold"]').val()
                if (polymorphismFilter && polymorphismFilterType && polymorphismThreshold) {
                    switch (polymorphismFilterType) {
                        case 'sigma_HPRC100':
                            conditions.push(`HPRC100_Stdev > ${polymorphismThreshold}`)
                            break
                        case 'sigma_AoU1027':
                            conditions.push(`AoU1027_Stdev > ${polymorphismThreshold}`)
                            break
                        case 'sigma_TenK10K':
                            conditions.push(`TenK10K_Stdev > ${polymorphismThreshold}`)
                            break
                        case 'sigma_1kGP':
                            conditions.push(`StdevFromIllumina174k > ${polymorphismThreshold}`)
                            break
                        case 'sigma_T2T':
                            conditions.push(`StdevFromT2TAssemblies > ${polymorphismThreshold}`)
                            break
                        default:
                            console.error(`Unknown polymorphism filter type: ${polymorphismFilterType}`)
                    }
                }

                // Add known disease-associated loci condition
                let knownDiseaseLoci = $('input[name="keepKdLoci"]').prop('checked')
                if (knownDiseaseLoci) {
                    conditions.push("KnownDiseaseAssociatedLocus IS NOT NULL AND KnownDiseaseAssociatedLocus != ''")
                }


                let motifSizeInput = $('input[name="keepMotifSize"]').val()
                if (motifSizeInput) {
                    motifSizeInput = motifSizeInput.trim()

                    let sizeClauses = []
                    
                    // Split input by commas and process each value
                    const values = motifSizeInput.split(',').map(v => v.trim()).filter(v => v !== '')
                    
                    values.forEach(value => {
                        // Handle open-ended ranges like "15-"
                        const openEndedMatch = value.match(/^(\d+)-$/)
                        if (openEndedMatch) {
                            const min = parseInt(openEndedMatch[1])
                            sizeClauses.push(`(MotifSize >= ${min})`)
                            return
                        }
                        
                        // Handle ranges like "2-6"
                        const rangeMatch = value.match(/^(\d+)-(\d+)$/)
                        if (rangeMatch) {
                            const min = parseInt(rangeMatch[1])
                            const max = parseInt(rangeMatch[2])
                            sizeClauses.push(`(MotifSize BETWEEN ${min} AND ${max})`)
                            return
                        }
                        
                        // Handle single numbers
                        const singleNumber = parseInt(value)
                        if (!isNaN(singleNumber)) {
                            sizeClauses.push(`(MotifSize = ${singleNumber})`)
                        }
                    })
                    
                    if (sizeClauses.length > 0) {
                        conditions.push(`(${sizeClauses.join(' OR ')})`)
                    }
                }

                const reverseCompliment = (m) => {
                    const complement = {
                        'A': 'T',
                        'T': 'A',
                        'C': 'G',
                        'G': 'C',
                        'R': 'Y',
                        'Y': 'R',
                        'M': 'K',
                        'K': 'M',
                        'B': 'V',
                        'D': 'H',
                        'H': 'D',
                        'V': 'B',
                    }
                    
                    return m.toUpperCase().split('').map(base => complement[base] || base).reverse().join('')
                }

                const computeCanonicalMotif = (m) => {
                    m = m.toUpperCase()
                    
                    const rotations = []
                    for (let i = 0; i < m.length; i++) {
                        rotations.push(m.slice(i) + m.slice(0, i))
                    }
                    
                    // Get reverse complement of each rotation
                    const allVariants = [...rotations, ...rotations.map(rot => reverseCompliment(rot))]
                    
                    // Return the lexicographically smallest variant
                    return allVariants.sort()[0]
                }

                
                let motifInput = $('#motif-input').val()
                if (motifInput) {
                    motifInput = motifInput.trim()
                    const motifs = motifInput.split(',').map(m => m.trim()).filter(m => m !== '')
                    if (motifs.length > 0) {
                        const motifClauses = motifs.map(motif => 
                            `UPPER(CanonicalMotif) = UPPER('${computeCanonicalMotif(motif)}')`
                        )
                        conditions.push(`(${motifClauses.join(' OR ')})`)
                    }
                }

                // Add gene region conditions
                const regionConditions = []
                
                if ($('input[name="keepCodingLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('CDS')")
                }
                if ($('input[name="keepFiveUTRLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('5\\' UTR')")
                }
                if ($('input[name="keepThreeUTRLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('3\\' UTR')")
                }
                if ($('input[name="keepPromoterLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('promoter')")
                }
                if ($('input[name="keepIntronLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('intron')")
                }
                if ($('input[name="keepIntergenicLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('intergenic')")
                }
                if ($('input[name="keepNonCodingExonLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('exon')")
                }
                if ($('input[name="keepLociThatOverlapDiseaseAssociatedLoci"]').prop('checked')) {
                    regionConditions.push("DiseaseInfo IS NOT NULL")
                }

                if (regionConditions.length > 0) {
                    conditions.push(`(${regionConditions.join(' OR ')})`)
                }
            }

            //retrieve all required columns for the visible columns
            let selectedColumns = [
                'LocusId',
                'ReferenceRegion',
                'DiseaseInfo',
            ]

            //add the visible columns to the selected columns
            const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
            Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
                if (visibleColumns.includes(columnId)) {
                    const columnObject = TABLE_COLUMNS[columnName]
                    columnObject.getRequiredColumns().forEach(column => {
                        if (!selectedColumns.includes(column)) {
                            selectedColumns.push(column)
                        }
                    })
                }
            })

            const sortColumn = GLOBAL_PAGE_STATE['sc']
            const sortDirection = GLOBAL_PAGE_STATE['sd']

            const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : ''
            const sortColumns = TABLE_COLUMNS[sortColumn]?.getSortColumns() || ['chrom', 'start_0based']
            const sortClause = sortColumns.map(column => `${column} ${sortDirection}`).join(', ')

            const query = `SELECT ${selectedColumns.join(', ')} FROM ${COMPLETE_TABLE_ID} ${whereClause} ORDER BY ${sortClause}`

            const startIndex = GLOBAL_PAGE_STATE['pageSize'] * (GLOBAL_PAGE_STATE['currentPage'] - 1)
            const pageSize = GLOBAL_PAGE_STATE['pageSize']

            window.lastSearchConditions = conditions
            window.lastSearchSortClause = sortClause

            window.searchResults = await queryBigQuery(query, startIndex, pageSize, null, null)

            // Remove loading indicator and placeholder before showing results
            $('#loading-container').hide()

            GLOBAL_PAGE_STATE['searchQuery'] = searchQuery

            GLOBAL_PAGE_STATE['sourceCatalog'] = $('#source-catalog-dropdown').dropdown('get value')

            GLOBAL_PAGE_STATE['keepMotifSize'] = $('#motif-size-input').val()
            GLOBAL_PAGE_STATE['keepMotif'] = $('#motif-input').val()

            GLOBAL_PAGE_STATE['keepCodingLoci'] = $('input[name="keepCodingLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepFiveUTRLoci'] = $('input[name="keepFiveUTRLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepThreeUTRLoci'] = $('input[name="keepThreeUTRLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepPromoterLoci'] = $('input[name="keepPromoterLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepIntronLoci'] = $('input[name="keepIntronLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepIntergenicLoci'] = $('input[name="keepIntergenicLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepNonCodingExonLoci'] = $('input[name="keepNonCodingExonLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepLociThatOverlapDiseaseAssociatedLoci'] = $('input[name="keepLociThatOverlapDiseaseAssociatedLoci"]').prop('checked') ? 1 : 0

            GLOBAL_PAGE_STATE['polymorphismFilter'] = $('input[name="polymorphismFilter"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['polymorphismFilterType'] = $('#polymorphism-filter-dropdown').dropdown('get value')
            GLOBAL_PAGE_STATE['polymorphismThreshold'] = $('input[name="polymorphismThreshold"]').val()
            GLOBAL_PAGE_STATE['vcFilter'] = $('input[name="vcFilter"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['vcFilterType'] = $('#variation-cluster-filter-dropdown').dropdown('get value')
            writePersistentPageStateToUrl()

            displaySearchResults()
            
            updatePaginationControls()
            
        } catch (error) {
            console.error('Error performing search:', error)
            $('#loading-container').hide()
            displayError('Error performing search: ' + error.message)
        } finally {
            $('body').css('cursor', 'default')
            $('#results-table').show()
            $('#results-table').removeClass('loading')
        }
    }

    // "About" modal
    ['whats-new', 'faq', 'downloads', 'about'].forEach(prefix => {
        $(`#${prefix}-link`).click((e) => {
            e.preventDefault()
            $(`#${prefix}-modal`).modal('show')
        })
    })

    const toggleAdvancedSearch = () => {
        GLOBAL_PAGE_STATE['showAdvFilters'] = (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {
            $('#advanced-search-form').slideDown(300)
            $('#filter-button .filter.icon').removeClass('rotated')

            $('select[name="sourceCatalog"]').val(GLOBAL_PAGE_STATE['sourceCatalog'])
            $('#source-catalog-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['sourceCatalog'])
            $('select[name="polymorphismFilterType"]').val(GLOBAL_PAGE_STATE['polymorphismFilterType'])
            $('#polymorphism-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['polymorphismFilterType'])
            $('input[name="polymorphismThreshold"]').val(GLOBAL_PAGE_STATE['polymorphismThreshold'])
            $('select[name="vcFilterType"]').val(GLOBAL_PAGE_STATE['vcFilterType'])
            $('#variation-cluster-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['vcFilterType'])

        } else {
            $('#advanced-search-form').slideUp(300)
            $('#filter-button .filter.icon').addClass('rotated')
        }
    }

        // "filter" button click handler
    $('#filter-button').click(toggleAdvancedSearch)

    // handle search
    const validateMotifSizeInput = (input) => {
        if (!input) return true; // Empty input is valid
        
        // First validate the overall format - only allow numbers, commas, and hyphens
        if (!/^[-\d\s,]+$/.test(input)) return false;
        
        const values = input.split(',').map(v => v.trim()).filter(v => v !== '');
        
        for (const value of values) {
            // Check for open-ended ranges like "15-"
            const openEndedMatch = value.match(/^(\d+)-$/);
            if (openEndedMatch) {
                const min = parseInt(openEndedMatch[1]);
                if (isNaN(min) || min < 1) return false;
                continue;
            }
            
            // Check for ranges like "2-6"
            const rangeMatch = value.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) {
                const min = parseInt(rangeMatch[1]);
                const max = parseInt(rangeMatch[2]);
                if (isNaN(min) || isNaN(max) || min < 1 || max < min) return false;
                continue;
            }
            
            // Check for single numbers
            const singleNumber = parseInt(value);
            if (isNaN(singleNumber) || singleNumber < 1) return false;
        }
        
        return true;
    };

    const validateMotifInput = (input) => {
        if (!input) return true; // Empty input is valid
        
        const motifs = input.split(',').map(m => m.trim()).filter(m => m !== '');
        
        for (const motif of motifs) {
            // Check if motif contains only valid DNA characters (A,C,G,T,N, case insensitive)
            if (!/^[ACGTNacgtn]+$/.test(motif)) {
                return false;
            }
        }
        
        return true;
    };

    const validateForm = () => {

        // Validate motif size input
        const motifSizeInput = $('#motif-size-input').val();
        if (!validateMotifSizeInput(motifSizeInput)) {
            // Ensure advanced search form is visible
            if (GLOBAL_PAGE_STATE['showAdvFilters'] !== 1) {
                toggleAdvancedSearch()
            }
            $('#form-error-message').html('<b>ERROR:</b> Invalid motif size filter. Please specify motif sizes or size ranges like: 3, 2-6, 7-').show();
            $('#motif-size-input').closest('.field').addClass('error');
            return false;
        } else {
            $('#motif-size-input').closest('.field').removeClass('error');
        }   

        // Validate motif input
        const motifInput = $('#motif-input').val();
        if (!validateMotifInput(motifInput)) {
            // Ensure advanced search form is visible
            if (GLOBAL_PAGE_STATE['showAdvFilters'] !== 1) {
                toggleAdvancedSearch()
            }
            $('#form-error-message').html('<b>ERROR:</b> Invalid motif filter. Motifs should only contain A, C, G, T, or N').show();
            $('#motif-input').closest('.field').addClass('error');
            return false;
        } else {
            $('#motif-input').closest('.field').removeClass('error');
        }

        // Validate polymorphism threshold input
        if ($('input[name="polymorphismFilter"]').prop('checked')) {
            const polymorphismFilterType = $('#polymorphism-filter-dropdown').dropdown('get value')
            const polymorphismThreshold = $('#polymorphism-threshold').val();

            if (!polymorphismFilterType || isNaN(polymorphismThreshold) || parseFloat(polymorphismThreshold) < 0) {
                // Ensure advanced search form is visible
                if (GLOBAL_PAGE_STATE['showAdvFilters'] !== 1) {
                    toggleAdvancedSearch()
                }
                if (!polymorphismFilterType) {
                    $('#form-error-message').html('<b>ERROR:</b> Nothing selected in the polymorphism filter dropdown').show();
                } else {
                    $('#form-error-message').html(`<b>ERROR:</b> The polymorphism filter value '${polymorphismThreshold}' is invalid`).show();
                }
                $('#polymorphism-threshold').closest('.field').addClass('error');
                return false;
            } else {
                $('#polymorphism-threshold').closest('.field').removeClass('error');
            }
        }

        // Validate variation cluster filter
        if ($('input[name="vcFilter"]').prop('checked')) {
            const variationClusterFilterType = $('#variation-cluster-filter-dropdown').dropdown('get value')
            if (!variationClusterFilterType) {
                $('#form-error-message').html('<b>ERROR:</b> Nothing selected in the variation cluster filter dropdown').show();
                $('#variation-cluster-filter-dropdown').closest('.field').addClass('error');
                return false;
            } else {
                $('#variation-cluster-filter-dropdown').closest('.field').removeClass('error');
            }
        }

        // Clear any form errors
        $('#form-error-message').hide();
        $('.field.error').removeClass('error');
        return true;
    }        

    function showPolymorphismDialog() {
        const row = $(this).data()

        for (const key of REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN) {
            //because data embedded in html data-.. attributes has lower-case keys
            const lowerCaseKey = key.toLowerCase()
            if (row[lowerCaseKey] != null) {
                row[key] = row[lowerCaseKey]
            }
        }

        const polymorphismDialogContent = generatePolymorphismDialogContent(row)
        $('#polymorphism-dialog-header').html(`${row.ReferenceMotif} repeats &nbsp; @ &nbsp; ${row.ReferenceRegion}`)
        $('#polymorphism-dialog-content').html('')
        $('#polymorphism-dialog-content').html(polymorphismDialogContent.replace(/\s+/g, ' ').trim())

        renderChartsInPolymorphismDialog(row)

        $('#polymorphism-dialog').modal('show')

        $('.question').popup({ on: 'click' })

    }

    const handleSearch = async (event) => {
        event.preventDefault()

        if (!validateForm()) {
            return;
        }

        GLOBAL_PAGE_STATE['currentPage'] = 1

        // set igvLoc to the first value in the search query
        const searchQuery = $('#search-query').val()
        if (searchQuery) {
            GLOBAL_PAGE_STATE['igvLoc'] = splitSearchQuery(searchQuery)[0]
        }

        await performSearch(false)
    }

    $('#search-form').submit(handleSearch)
    $('#advanced-search-form').submit(handleSearch)
    $('#advanced-search-form').find('input').keypress((e) => {
        if (e.which === 13) {
            e.preventDefault()
            handleSearch(e)
        }
    })

    // Initialize source catalog dropdown
    $('#source-catalog-dropdown').dropdown()
    
    // polymorphism filter dropdown
    $('#polymorphism-filter-dropdown').dropdown({
        onShow: function() {
            $(this).css('z-index', 10001)
        },
        onHide: function() {
            $(this).css('z-index', '')
        },
        onChange: (value) => {
            if (value) {
                $('input[name="polymorphismFilter"]').prop('checked', true)
            }
        }
    })

    // Add event handler for variation cluster filter dropdown
    $('#variation-cluster-filter-dropdown').dropdown({
        onShow: function() {
            $(this).css('z-index', 10001)
        },
        onHide: function() {
            $(this).css('z-index', '')
        },
        onChange: (value) => {
            if (value) {
                $('input[name="vcFilter"]').prop('checked', true)
            }
        }
    })
    
    $('#known-disease-motifs-link').click((e) => {
        e.preventDefault()

        $('#motif-input').val(MOTIFS_AT_KNOWN_DISEASE_ASSOCIATED_LOCI)
    })

    // handle browser forward & back buttons
    window.addEventListener('popstate', readAndApplyPersistentPageStateFromUrl)

    // init ui elements
    $('.ui.button').popup()
    $(".ui.checkbox").checkbox()


    $(document).ready(async () => {

        await readAndApplyPersistentPageStateFromUrl()

        console.log("Done initializing page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)
        $('body').css('cursor', 'default')
    })

</script>

</body>
</html>