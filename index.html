<!DOCTYPE html>
<html>
<head>
    <title>Tandem Repeat Explorer</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript" src="https://storage.googleapis.com/tgg-viewer/igv.js-bw2/dist/igv.min.js?version=2024-08-06"></script>
    <!-- script type="text/javascript" src="igv.min.js"></script -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H6MVWR637M"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-H6MVWR637M');
    </script>

    <style>
        /* Base styles */
        body {
            padding: 0;
            margin: 0;
            overflow-x: auto;  /* Enable horizontal scrolling for the entire page */
            min-width: 1000px; /* Set a minimum width to prevent content from becoming too narrow */
        }

        /* Header styles */
        #header-stripe {
            background-color: #1b1c1d;
            color: white;
            text-decoration: none;
            padding-top: 20px;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        #header-title a {
            color: white;
            font-size: 22px;
            font-family: 'Arial Narrow Bold', sans-serif;
            white-space: nowrap;
            font-weight: 700;
            vertical-align: middle;
        }

        #header-title a:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        #header-nav {
            display: flex;
            justify-content: right;
            vertical-align: middle;
            gap: 1.5em;
            font-size: 1.15em;
            font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        #header-nav a {
            color: rgba(255, 255, 255, 0.9);
            transition: color 0.2s;
        }

        #header-nav a:hover {
            color: white;
        }

        #github-icon {
            font-size: 1.3em;
        }

        /* IGV.js styles */
        #igv-row {
            display: none;
            margin-left: 20px;
            margin-right: 20px;
        }

        #advanced-search-form .checkbox {
            padding-right: 20px;
        }

        .igv-checkbox-container-table td {
            padding: 0px !important;
            width: 100%;
            border-top-width: 0px !important;
        }

        .igv-checkbox-container-header-row {
            padding: 7px 0px 7px 0px !important;
            border: 0px;
        }
        .igv-track-selection-table {
            border: 0px !important;
            padding: 0px;
        }

        .igv-track-selection-table td {
            vertical-align: top;
        }

        .igv-track-selection-table th {
            background: white;
        }

        .igv-number-of-loci-column {
            text-align: right !important;
            white-space: nowrap;
        }

        .igv-track-checkbox {
            margin-right: 15px;
            margin-bottom: 10px;
            display: block;
        }

        .question, .disease-associated-icon {
            margin-left: 10px;
            cursor: pointer;
        }

        .igv-row-sidebar-title {
            font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
            font-size: 18px;
            font-weight: 700;
        }

        .igv-row-sidebar-text {
            display: block;
            font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
            font-size: 14px;
        }

        #show-igv-divider {
            text-align: center;
            margin: 1.5em 0;
            position: relative;
            cursor: pointer;
        }

        #show-igv-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            border-top: 1px solid #ddd;
            z-index: 0;
        }

        #show-igv-divider span {
            position: relative;
            display: inline-block;
            background-color: white;
            padding: 0 15px;
            color: #1a3c6d;
            font-weight: 500;
            font-size: 0.95em;
            z-index: 1;
            transition: color 0.2s;
        }

        #show-igv-divider:hover span {
            color: #2185d0;
        }

        #show-igv-divider i {
            font-size: 0.8em;
            margin-left: 5px;
            transition: transform 0.2s;
        }

        #search-query {
            margin-right: 5px;
            border: 1px solid rgba(34, 36, 38, 0.15) !important;
            border-radius: 4px !important;
        }

        #filter-button {
            border-radius: 4px !important;
            margin-right: 10px;
        }

        #filter-button .chevron.icon {
            margin-left: 2px;
        }

        #filter-button .chevron.icon.rotated {
            transform: rotate(90deg);
        }

        #filter-button:hover {
            background-color: #f8f8f8 !important;
        }

        #search-button {
            border-radius: 4px !important;
        }

        /* Results table */
        #results-table {
            margin-top: 1em;
        }

        #results-table.loading {
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #results-table table.ui.table {
            border-left: none;
            border-right: none;
        }

        #results-table table.ui.table th,
        #results-table table.ui.table td {
            border-left: none;
            border-right: none;
        }

        #results-table table.ui.table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        #results-table table.ui.table tr:nth-child(odd) {
            background-color: white;
        }

        #results-table table.ui.table tr:hover {
            background-color: #e6f0ff;
        }

        #results-table table.ui.table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Loading indicators */
        .ui.loader {
            margin-top: 2em;
        }
        
        #loading-container {
            background: white;
            padding: 0.5em 0;
            margin-top: 3.7em;
            margin-bottom: 1em;
            border-radius: 4px;
            height: 40px;
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            color: #888;
            font-size: 1.1em;
            font-weight: 300;
            height: 100%;
        }

        .disease-associated-row {
            background-color: #fdeeee !important;
        }

        .disease-associated-row:hover {
            background-color: #eae9fc !important;
        }

        .loading-indicator .ui.loader {
            margin: 0;
            margin-right: 20px;
        }

        /* Pagination */
        .top-pagination {
            margin-top: 2.5em !important;
        }

        .pagination-container {
            margin-top: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            gap: 1em;
            flex-wrap: wrap;
        }
        
        .total-results {
            color: #666;
            font-size: 1.1em;
            white-space: nowrap;
            margin-right: 1em;
            order: 1;
        }
        
        .export-selector {
            display: flex;
            align-items: center;
            gap: 0.5em;
            color: #666;
            font-size: 1em;
            white-space: nowrap;
            order: 2;
            flex-grow: 1;
        }

        /* Make export dropdown menu tall enough to show all options */
        .export-selector .ui.selection.dropdown .menu {
            max-height: none !important;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5em;
            color: #666;
            font-size: 1em;
            white-space: nowrap;
            order: 3;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            order: 4;
        }
        
        .pagination-controls .ui.button {
            padding: 8px;
            min-width: 36px;
            background: white;
            border: 1px solid #ddd;
            box-shadow: none;
        }
        
        .pagination-controls .ui.button:hover {
            background: #f8f8f8;
        }
        
        .pagination-controls .ui.button.disabled {
            opacity: 0.5;
            background: white;
        }
        
        .page-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 4px;
            white-space: nowrap;
        }
        
        .page-input-container input {
            width: 60px;
            height: 36px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px;
        }
        
        .page-input-container .total-pages {
            color: #666;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 991px) {
            .pagination-container {
                justify-content: flex-start;
            }

            .total-results {
                flex-basis: 100%;
                margin-bottom: 0.5em;
            }

            .export-selector {
                margin: 0;
                margin-right: 1em;
            }
        }

        @media screen and (max-width: 767px) {
            .pagination-container {
                gap: 0.75em;
            }

            .export-selector, .page-size-selector {
                flex-basis: 100%;
                margin: 0;
            }

            .pagination-controls {
                width: 100%;
                justify-content: center;
            }
        }

        /* Misc UI elements */
        .no-results {
            margin-top: 2em;
            text-align: left;
            color: #888;
            font-size: 1.2em;
        }

        #results-area {
            position: relative;
        }

        .cell-with-icon-and-popup {
            cursor: pointer;
            color: #2185d0;
            transition: all 0.2s;
        }

        .cell-in-polymorphism-column {
            cursor: pointer;
            color: #2185d0;
        }

        .cell-popup-details-label {
            font-weight: bold;
        }

        .cell-action-link {
            color: #2185d0;
            cursor: pointer;
            border-bottom: 1px dotted #2185d0;
            transition: all 0.2s;
        }
        
        .cell-action-link:hover {
            opacity: 0.8;
        }

        /* Style for disabled export dropdown */
        .export-selector .ui.selection.dropdown.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Style for disabled export label */
        .export-selector .export-label {
            transition: opacity 0.2s;
        }
        .export-selector .ui.selection.dropdown.disabled + .export-label {
            opacity: 0.5;
        }

        .results-table-column-settings-checkbox-flex-container {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            max-height: calc(8 * 35px);
            gap: 5px 20px;
        }

        .results-table-column-settings-checkbox-item {
            min-width: 200px;
            padding: 5px 0;
        }
    </style>
</head>
<body>
<!-- modal dialog for selecting IGV tracks -->
<div class="ui modal" id="igv-track-selection-dialog">
    <i class="close icon"></i>
    <div class="header">
        Select IGV Tracks
    </div>
    <div class="content" style="padding-top:0px;">
        <div class="ui form">
            <table class="ui stackable table igv-track-selection-table">
                <tr>
                    <td style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-tr-explorer-catalog-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    TR Explorer Catalog
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                    # of loci
                                </th>
                            </tr>
                        </table>
                        <table class="igv-checkbox-container-table" id="igv-variation-cluster-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Variation Clusters
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                </th>
                            </tr>
                        </table>
                        <table class="igv-checkbox-container-table" id="igv-known-disease-loci-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Known Disease-associated TR Loci
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                </th>
                            </tr>
                        </table>
                    </td>
                    <td style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-other-tr-catalog-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Other Genome-wide TR Catalogs
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                    # of loci
                                </th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-reference-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">Reference Tracks</th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-custom-tracks" style="width: 100%;">
                            <tr>
                                <th class="igv-checkbox-container-header-row">Custom Tracks <i class="question circle icon link" style="margin-left: 15px;" data-html="These inputs allow you to load your own custom tracks into IGV.js. They accept BED, BAM, VCF, GFF, BigWig, or any other IGV.js-compatible data format. The data file (and index) just have to be online at a publicly-accessible &nbsp;https://, &nbsp;gs://, &nbsp;or s3:// &nbsp; URL."></i></th>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="actions">
        <div class="ui deny button">
            Cancel
        </div>
        <div id="igv-tracks-modal-apply-button" class="ui positive right labeled icon button">
            Apply
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<div class="ui modal" id="about-modal">
    <i class="close icon"></i>
    <div class="header">
        About TR Explorer
    </div>
    <div class="content" style="font-size: 1.1em;">
        <p><b>Features:</b>
            <ul>
                <li><b>Search</b> TRs by genomic intervals, genes, observed polymorphism rates, variation clusters, and other attributes</li>
                <li><b>Export</b> search results to BED, TSV, JSON or to the specific formats used as input to various TR genotyping tools</li>
                <li><b>Use IGV.js</b> to explore more than 10 recently-published or widely-used TR catalogs alongside other reference tracks</li>
            </ul>
        </p>

        <div class="ornamental-divider" style="
            height: 15px;
            width: 100%;
            margin: 2em auto;
            text-align: center;
            color: rgba(0,0,0,0.5);            
        ">
            <svg width="100%" height="30" viewBox="0 0 1000 30" preserveAspectRatio="xMidYMid meet">
                <!-- Continuous horizontal line -->
                <path d="M0,15 L1000,15" stroke="currentColor" stroke-width="1"/>
                
                <!-- Left diamonds -->
                <path d="M380,15 l10,-7 l10,7 l-10,7 z" fill="currentColor"/>
                <path d="M350,15 l8,-5 l8,5 l-8,5 z" fill="currentColor"/>
                                
                <!-- Right diamonds (mirrored) -->
                <path d="M620,15 l-10,-7 l-10,7 l10,7 z" fill="currentColor"/>
                <path d="M650,15 l-8,-5 l-8,5 l8,5 z" fill="currentColor"/>
            </svg>
        </div>

        <p>TR Explorer is a companion resource for the paper:</p>
        <p><strong>Defining a tandem repeat catalog and variation clusters for genome-wide analyses and population databases</strong></p>
        <p>Ben Weisburd, Egor Dolzhenko, Mark F. Bennett, Matt C. Danzi, Adam English, Laurel Hiatt, Hope Tanudisastro, Nehir Edibe Kurtas, Helyaneh Ziaei Jam, Harrison Brand, Fritz J. Sedlazeck, Melissa Gymrek, Harriet Dashnow, Michael A. Eberle, Heidi L. Rehm</p>
        <p><a href="https://www.biorxiv.org/content/10.1101/2024.10.04.615514v1" target="_blank"><em>bioRxiv 2024.10.04.615514</em></a></p>
        <p>It allows users to explore the catalog described in the paper, as well as other genome-wide TR catalogs.</p>
        
    </div>
</div>

<!-- modal dialog for selecting results table columns -->
<div class="ui modal" id="results-table-column-settings-dialog">
    <i class="close icon"></i>
    <div class="header">
        Results Table Columns
    </div>
    <div class="content">
        <div class="ui form">
            <table class="ui stackable table results-table-column-settings-checkboxes" style="border: 0px !important"></table>
        </div>
    </div>
    <div class="actions">
        <div class="ui deny button">
            Cancel
        </div>
        <div id="results-table-column-settings-apply-button" class="ui positive right labeled icon button">
            Apply
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<!-- modal dialog for polymorphism allele frequencies -->
<div class="ui modal" id="polymorphism-dialog">
    <i class="close icon"></i>
    <div class="header" id="polymorphism-dialog-header" style="text-align: center">
        Polymorphism
    </div>
    <div class="content scrolling">
        <div id="polymorphism-dialog-content"></div>
    </div>
</div>

<div class="ui stackable grid">
    <div class="ui row" id="header-stripe">
        <div class="three wide column" style="padding: 0px !important"></div>
        <div class="three wide column" id="header-title">
            <a href="/">
                <img src="tandem-repeat-explorer-logo-white.png" alt="TR Explorer Logo" style="height: 40px; margin-left: 10px;">
            </a>
        </div>
        <div class="seven wide column" id="header-nav">
            <a href="https://github.com/broadinstitute/tandem-repeat-catalog/releases/tag/v1.0" target="_blank">Downloads</a>
            <a href="#" id="about-link">About</a>
            <a href="https://github.com/bw2/tandem-repeat-explorer" target="_blank" id="github-icon"><i class="github icon"></i></a>
        </div>
        <div class="three wide column" style="padding: 0px !important"></div>
    </div>

    <div class="ui row" id="igv-row">
        <div class="sixteen wide column">
            <div id="igv-viewport"></div>
        </div>
    </div>

    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="show-igv-divider">
                <span id="show-igv-divider-text">Show IGV.js<i class="chevron down icon"></i></span>
                <span id="hide-igv-divider-text" style="display: none">Hide IGV.js<i class="chevron up icon"></i></span>
            </div>

            <form id="search-form" class="ui form">
                <div class="field">
                    <label>Search region(s), gene(s), or transcript(s)</label>
                    <div class="ui action input">
                        <input type="text" id="search-query" name="search-query" placeholder="eg. chr1:1000-2000, FMR1, ENSG00000102081, ENST00000518051, or a comma-separated list of these">
                        <button id="filter-button" class="ui basic icon button" type="button" data-html="Show or hide additional TR filters" data-position="top center"><i class="filter icon rotated" style="transition: transform 0.3s;"></i></button>
                        <button id="search-button" class="ui primary button" type="submit">Search</button>
                    </div>
                </div>
            </form>

            <!-- Advanced Search Wrapper -->
            <div id="advanced-search-wrapper" style="padding-top: 20px">
                <!-- Advanced Search (Initially Hidden) -->
                <form id="advanced-search-form" class="ui form" style="display:none">

                    <div class="field" style="padding-top: 5px">
                        <label>Search TR Catalog</label>
                        <div class="ui selection dropdown" id="source-catalog-dropdown" style="max-width: 350px !important">
                            <input type="hidden" name="sourceCatalog">
                            <i class="dropdown icon"></i>
                            <div class="default text">Select catalog</div>
                            <div class="menu">
                                <div class="item" data-value="tr_explorer_catalog">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span>TR Explorer catalog</span>
                                        <span style="color: #888; margin-left: 20px;">4,863,041 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="illumina_174k_catalog">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span>Illumina 174k</span>
                                        <span style="color: #888; margin-left: 20px;">174,286 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="known_disease_loci">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span>Known disease-associated loci</span>
                                        <span style="color: #888; margin-left: 20px;">63 loci</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field" style="padding-top: 5px">
                        <label>Gene Region(s)</label>
                        <div class="checkbox-group">
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepCodingLoci">
                                <label>Coding</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepFiveUTRLoci">
                                <label>5' UTR</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepThreeUTRLoci">
                                <label>3' UTR</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepPromoterLoci">
                                <label>Promoter</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepIntronLoci">
                                <label>Intron</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepIntergenicLoci">
                                <label>Intergenic</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepNonCodingExonLoci">
                                <label>Exon (non-coding transcript)</label>
                            </div>
                        </div>
                    </div>

                    <div class="two fields" style="padding-top: 5px">
                        <div class="field" style="max-width: 430px; margin-right:20px">
                            <label>Motif Size(s)</label>
                            <input type="text" id="motif-size-input" name="keepMotifSize" placeholder="e.g., 3, 2-6, or a comma-separated list of these">
                        </div>
                        <div class="field" style="max-width: 440px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin: 0 0 .28571429rem 0;">
                                <label style="font-size: .92857143em; font-weight: 700">Motif(s)</label>
                                <a href="#" id="known-disease-motifs-link" style="color: #2185d0; font-size: 0.95em;">motifs of known disease-associated loci &gt;</a>
                            </div>
                            <input type="text" id="motif-input" name="keepMotif" placeholder="e.g., CAG, CCG, or a comma-separated list of these">
                        </div>
                    </div>

                    <div class="field" style="padding-top: 5px">
                        <label>Other Filters</label>
                        <div class="checkbox-group">
                            <div class="ui checkbox" style="padding-right: 10px !important">
                                <input type="checkbox" name="polymorphismFilter">
                                <label>Polymorphism filter:</label>
                            </div>
                            <div class="ui selection dropdown" id="polymorphism-filter-dropdown" style="min-width: 250px; margin-right: 30px !important">
                                <input type="hidden" name="polymorphismFilterType">
                                <i class="dropdown icon"></i>
                                <div class="default text">Select filter</div>
                                <div class="menu">
                                    <div class="item" data-value=""></div>
                                    <div class="item" data-value="sigma_gt_0.0">σ<sub>LPS</sub> > 0.0</div>
                                    <div class="item" data-value="sigma_gt_0.3">σ<sub>LPS</sub> > 0.3</div>
                                    <div class="item" data-value="sigma_gt_0.5">σ<sub>LPS</sub> > 0.5</div>
                                    <div class="item" data-value="sigma_gt_1.0">σ<sub>LPS</sub> > 1.0</div>
                                    <div class="item" data-value="sigma_gt_3.0">σ<sub>LPS</sub> > 3.0</div>
                                    <div class="item" data-value="sigma_gt_5.0">σ<sub>LPS</sub> > 5.0</div>
                                </div>
                            </div>
                            <div class="ui checkbox" style="padding-right: 10px !important">
                                <input type="checkbox" name="vcFilter">
                                <label>Variation cluster (VC) filter:</label>
                            </div>
                            <div class="ui selection dropdown" id="variation-cluster-filter-dropdown">
                                <input type="hidden" name="vcFilterType">
                                <i class="dropdown icon"></i>
                                <div class="default text">Select filter</div>
                                <div class="menu">
                                    <div class="item" data-value=""></div>
                                    <div class="divider"></div>
                                    <div class="item" data-value="exclude">Exclude VCs</div>
                                    <div class="item" data-value="exclude_ge_50">Exclude VCs ≥ +50bp</div>
                                    <div class="divider"></div>
                                    <div class="item" data-value="keep">Keep only VCs</div>
                                    <div class="item" data-value="keep_ge_50">Keep only VCs ≥ +50bp</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <!-- Results Area -->
            <div id="results-area">
                <div id="loading-container" style="display: none">
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="ui small active inline loader"></div>
                        <span>Loading...</span>
                    </div>
                </div>
                <div class="pagination-container top-pagination"></div>
                <div id="results-table"></div>
                <div class="pagination-container bottom-pagination"></div>
                <div id="error-message" class="ui negative message" style="display: none">
                    <i class="close icon"></i>
                    <div class="header">Error</div>
                    <p id="error-text"></p>
                </div>
            </div>
        </div>
        <div class="three wide column"></div>
    </div>
</div>

<script>

    $('body').css('cursor', 'wait')

    const TR_CATALOG_BASE_URL = "https://storage.googleapis.com/tandem-repeat-catalog"

    const SHARED_TR_CATALOG_SIZES = {
        tr_explorer_catalog: 4863041,
        illumina_174k_catalog: 174300,
        known_disease_loci: 63
    }

    const TR_EXPLORER_SOURCE_CATALOGS = [
        ["igv_kd_loci_july_2024", "Known disease-associated TR loci (July 2024)", `${TR_CATALOG_BASE_URL}/other_catalogs/KnownDiseaseAssociatedLoci_July2024.bed.gz`, SHARED_TR_CATALOG_SIZES['known_disease_loci']],
        ["igv_illumina_174k_source", "Illumina 174k", `${TR_CATALOG_BASE_URL}/other_catalogs/Illumina174kPolymorphicTRs.bed.gz`, SHARED_TR_CATALOG_SIZES['illumina_174k_catalog']],
        ["igv_perfect_repeats_hg38", "Perfect repeats in hg38", `${TR_CATALOG_BASE_URL}/other_catalogs/PerfectRepeatsInGRCh38.bed.gz`, 4558281],
        ["igv_polymorphic_trs_in_t2t", "Polymorphic TRs in T2T assemblies", `${TR_CATALOG_BASE_URL}/other_catalogs/PolymorphicTRsInT2TAssemblies.bed.gz`, 1937805],
    ]

    const TR_EXPLORER_CATALOG  = [
        ["igv_tr_explorer_catalog", "TR Explorer genome-wide catalog", `${TR_CATALOG_BASE_URL}/v1.0/TR_Explorer.repeat_catalog_v1.hg38.1_to_1000bp_motifs.bed.gz`, SHARED_TR_CATALOG_SIZES['tr_explorer_catalog'], "TR catalog described in [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v1' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]"],
    ]

    const TR_VARIATION_CLUSTERS = [
        ["igv_variation_clusters", "Variation clusters", `${TR_CATALOG_BASE_URL}/v1.0/variation_clusters_v1.hg38.bed.gz`, 271362, "Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v1' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."],
    ];

    const KNOWN_TR_LOCI_TRACK = [
        ["igv_kd_loci", "gnomAD: known disease-associated loci (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/KnownDiseaseAssociatedLoci.bed.gz`, 68],
        ["igv_trgt_kd_loci", "TRGT repo: known disease-associated loci (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/TRGT.pathogenic_repeats.hg38.bed.gz`, 56],
        ["igv_strchive_kd_loci", "STRchive catalog for TRGT (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/STRchive-disease-loci-v2.4.0.hg38.TRGT.B2FLLAlV.bed.gz`, 73],
    ]

    const GENOME_WIDE_TR_CATALOGS = [
        ["igv_illumina_174k", "Illumina 174k", `${TR_CATALOG_BASE_URL}/other_catalogs/Illumina174kPolymorphicTRs.bed.gz`, SHARED_TR_CATALOG_SIZES['illumina_174k_catalog']],
        ["igv_trgt", "TRGT", `${TR_CATALOG_BASE_URL}/other_catalogs/TRGT.bed.gz`, 171146, "Genome-wide catalog provided in the <a href='https://github.com/PacificBiosciences/trgt/tree/3d10c75/repeats' target='_blank'>TRGT repo</a> (downloaded March, 2025)"],
        ["igv_ucsc_sr", "UCSC simple repeat track", `${TR_CATALOG_BASE_URL}/other_catalogs/UCSC_SimpleRepeatTrack.bed.gz`, 965511],
        ["igv_vamos", "VAMOS v2.1", `${TR_CATALOG_BASE_URL}/other_catalogs/VamosCatalog_v2.1.bed.gz`, 1243954],
        ["igv_gangstr", "GangSTR v17", `${TR_CATALOG_BASE_URL}/other_catalogs/GangSTR_v17.bed.gz`, 1340266],
        ["igv_hipstr", "HipSTR", `${TR_CATALOG_BASE_URL}/other_catalogs/HipSTR.bed.gz`, 1638945],
        ["igv_adotto", "Adotto v1.2", `${TR_CATALOG_BASE_URL}/other_catalogs/Adotto_v1.2.bed.gz`, 2934805],
        ["igv_popstr", "PopSTR v2", `${TR_CATALOG_BASE_URL}/other_catalogs/PopSTR_v2.bed.gz`, 5401401],
        ["igv_platinum_trs", "Platinum TRs", `${TR_CATALOG_BASE_URL}/other_catalogs/PlatinumTRs.bed.gz`, 7524815, "The TR catalog described in [<a href='https://pubmed.ncbi.nlm.nih.gov/39149261/' target=_blank>Porubsky et al. 2024</a>]"],
        ["igv_chiu", "Chiu et al.", `${TR_CATALOG_BASE_URL}/other_catalogs/Chiu_et_al.bed.gz`, 18759399, "The TR catalog described in [<a href='https://pubmed.ncbi.nlm.nih.gov/38947075/' target=_blank>Chiu et al. 2024</a>]"],
    ]

    REFERENCE_BASE_URL = "https://storage.googleapis.com/tgg-viewer/ref/GRCh38"

    const REFERENCE_TRACKS = [
        ["igv_gencode", "Gencode v46", `${REFERENCE_BASE_URL}/gencode_v46/gencode.v46.GRCh38.sorted.txt.gz`],
        ["igv_segdups", "SegDups > 1000bp", `${REFERENCE_BASE_URL}/segdups/segdups.gtf.gz`],
        ["igv_36k_map", "36-mer mappability", `${REFERENCE_BASE_URL}/mappability/GRCh38_no_alt_analysis_set_GCA_000001405.15-k36_m2.bw`],
        ["igv_100k_map", "100-mer mappability", `${REFERENCE_BASE_URL}/mappability/GRCh38_no_alt_analysis_set_GCA_000001405.15-k100_m2.bw`],
        ["igv_haploinsuf", "ClinGen haploinsufficiency track", `${REFERENCE_BASE_URL}/clingen/ClinGen_haploinsufficiency_gene_GRCh38.sorted.bed.gz`],
        ["igv_triplosens", "ClinGen triplosensitivity track", `${REFERENCE_BASE_URL}/clingen/ClinGen_triplosensitivity_gene_GRCh38.sorted.bed.gz`],
    ]

    const ALL_AVAILABLE_TRACKS = [
        ...TR_EXPLORER_SOURCE_CATALOGS,
        ...TR_EXPLORER_CATALOG,
        ...TR_VARIATION_CLUSTERS,
        ...GENOME_WIDE_TR_CATALOGS,
        ...KNOWN_TR_LOCI_TRACK,
        ...REFERENCE_TRACKS,
    ]

    // initialize BigQuery client
    const PROJECT_ID = 'cmg-analysis'
    const DATASET_ID = 'tandem_repeat_explorer'
    const TABLE_ID = 'catalog_20250424_174423'

    const DEFAULT_SORT_COLUMN = 'chrom_index, start_0based'
    const DEFAULT_SORT_DIRECTION = 'ASC'

    const RESULTS_TABLE_COLUMN_NAMES = [
        'interval',  // 0
        'motif',  // 1
        'geneRegion',  // 2
        'geneName',  // 3
        'variationCluster',  // 4
        'mappability',  // 5
        'trsInRegion',  // 6
        'gencodeGeneId',  // 7
        'gencodeTranscriptId',  // 8
        'refSeqGeneRegion',  // 9
        'refSeqGeneId',  // 10
        'refSeqGeneName',  // 11
        'maneGeneRegion',  // 12
        'maneGeneId',  // 13
        'maneGeneName',  // 14

        'HPRC100_AlleleHistogram',  // 15
        'TenK10K_AlleleHistogram',  // 16
        'AlleleFrequenciesFromIllumina174k',  // 17
        'AlleleFrequenciesFromT2TAssemblies',  // 18

        'polymorphism',  // 19
        
        'HPRC100_Stdev',  // 20
        'TenK10K_Stdev',  // 21
        'StdevFromIllumina174k',  // 22
        'StdevFromT2TAssemblies',  // 23
    ]

    const REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN = [
        'LPSLengthStdevFromHPRC100',
        'StdevFromIllumina174k', 
        'AlleleFrequenciesFromIllumina174k',
        'StdevFromT2TAssemblies',
        'AlleleFrequenciesFromT2TAssemblies',
        'ReferenceRegion',
        'NumRepeatsInReference',
        'ReferenceMotif',
        'TenK10K_AlleleHistogram',
        'TenK10K_Stdev',
        'HPRC100_AlleleHistogram',
        'HPRC100_Stdev',
    ]

    const SHOW_COLUMNS_VALUE_DELIMITER = 'i'

    // persistent page state (added to the URL)
    let DEFAULT_GLOBAL_PAGE_STATE = {
        currentPage: 1,
        pageSize: 100,
        
        sc: DEFAULT_SORT_COLUMN,
        sd: DEFAULT_SORT_DIRECTION,

        showIGV: 0,
        igvLoc: 'chr1:94418421-94418442',

        showRs: 0,  //show results table
        searchQuery: '',
        showAdvFilters: 0,

        // advanced search params
        sourceCatalog: 'tr_explorer_catalog', // Source catalog filter
        keepMotifSize: '',
        keepMotif: '',

        keepCodingLoci: 0,
        keepFiveUTRLoci: 0,
        keepThreeUTRLoci: 0,
        keepPromoterLoci: 0,
        keepIntronLoci: 0,
        keepIntergenicLoci: 0,
        keepNonCodingExonLoci: 0,

        polymorphismFilter: 0,
        polymorphismFilterType: '',
        vcFilter: 0,
        vcFilterType: '',

        // Custom track URLs
        igv_custom_track_url_1: '',
        igv_custom_track_url_2: '',
        igv_custom_track_url_3: '',

        showColumns: [0, 1, 2, 3, 4, 15, 19].join(SHOW_COLUMNS_VALUE_DELIMITER),
    }
    
    ALL_AVAILABLE_TRACKS.forEach((rt) => {
        DEFAULT_GLOBAL_PAGE_STATE[rt[0]] = 0
    })

    DEFAULT_GLOBAL_PAGE_STATE['igv_kd_loci'] = 1
    //DEFAULT_GLOBAL_PAGE_STATE['igv_tr_explorer_catalog'] = 1

    //copy the default persistent page state
    let GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))


    const STDEV_SIGMA_SUBSCRIPTS = {
        'HPRC100_Stdev': 'LPS2',
        'LPSLengthStdevFromHPRC100': 'LPS',
        'TenK10K_Stdev': '10k',
        'StdevFromIllumina174k': '1kGP',
        'StdevFromT2TAssemblies': 'T2T',
    }

    const ALLELE_HISTOGRAM_SHORT_NAMES = {
        'HPRC100_AlleleHistogram': 'HPRC100',
        'TenK10K_AlleleHistogram': 'TenK10K',
        'AlleleFrequenciesFromIllumina174k': '1kGP',
        'AlleleFrequenciesFromT2TAssemblies': 'T2T',
    }
    const ALLELE_FREQUENCY_CHART_TITLES = {
        'HPRC100_AlleleHistogram': 'Allele Frequencies from HPRC 100 PacBio samples',
        'TenK10K_AlleleHistogram': 'Allele Frequencies from TenK10K short-read genomes',
        'AlleleFrequenciesFromIllumina174k': 'Allele Frequencies from 1kGP short-read genomes',
        'AlleleFrequenciesFromT2TAssemblies': 'Allele Frequencies from 78 diploid T2T assemblies',
    }
    const ALLELE_FREQUENCY_CHART_SUBTITLES = {
        'HPRC100_AlleleHistogram': 'based on TRGT calls in 100 PacBio HiFi samples from the Human Pan-genome Reference Consortium (HPRC)',
        'TenK10K_AlleleHistogram': 'based on ExpansionHunter calls in 2,412 short-read genomes from the <a href=https://www.biorxiv.org/content/10.1101/2024.11.02.621562v2 target=_blank>TenK10K dataset</a>',
        'AlleleFrequenciesFromIllumina174k': 'based on ExpansionHunter calls in <a href=https://github.com/Illumina/RepeatCatalogs/blob/master/docs/str_diversity_1kg.md target=_blank>2,504 short-read genomes from 1kGP</a>',
        'AlleleFrequenciesFromT2TAssemblies': 'based on assembly-to-hg38 alignments of 78 diploid T2T assemblies as described in <a href=https://pubmed.ncbi.nlm.nih.gov/37214979 target=_blank>Weisburd et al. 2023</a>',
    }

    const STDEV_HELP_TEXTS = {
        'HPRC100_Stdev': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_AlleleHistogram']}. Allele sizes were computed using the longest pure segment (LPS) as described in [<a href=&#39;https://www.biorxiv.org/content/10.1101/2025.01.06.631535v2&#39; target=_blank>Danzi et al. 2025</a>]. <br /><br /><b>Range:</b> 0 to 330.7`,
        'LPSLengthStdevFromHPRC100': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_AlleleHistogram']}. This is the same data as σ<sub style=&#39;font-size: 0.7em;&#39;>${STDEV_SIGMA_SUBSCRIPTS['HPRC100_Stdev']}</sub>, but generated in September 2024 using an older version of the TRGT LPS pipeline.<br /><br /><b>Range:</b> 0 to 123.0`,
        'TenK10K_Stdev': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_AlleleHistogram']}. <br /><br />TenK10K primarily contains individuals of European and South or East Asian ancestry, as shown by the purple dots here: <img src=&#39;static/TenK10K_ancestry_PC1_vs_PC2.png&#39; style=&#39;max-width: 600px&#39;>`,
        'StdevFromIllumina174k': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromIllumina174k']}. <br /><br /><b>Range:</b> 0 to 31.5`,
        'StdevFromT2TAssemblies': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromT2TAssemblies']}. <br /><br /><b>Range:</b> 0 to 1267.3`
    }

    const ALLELE_HISTOGRAM_HELP_TEXTS = {
        'HPRC100_AlleleHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_AlleleHistogram']}.`,
        'TenK10K_AlleleHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_AlleleHistogram']}.`,
        'AlleleFrequenciesFromIllumina174k': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromIllumina174k']}.`,
        'AlleleFrequenciesFromT2TAssemblies': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromT2TAssemblies']}.`,
    }

    // based on https://raw.githubusercontent.com/broadinstitute/str-analysis/refs/heads/main/str_analysis/variant_catalogs/variant_catalog_without_offtargets.GRCh38.json
    const MOTIFS_AT_KNOWN_DISEASE_ASSOCIATED_LOCI =  [
        'CAG',
        'GCC',
        'GAA',
        'GTC',
        'CAGG',
        'TTTG',
        'GGGCC',
        'ATTCT',
        'GGCCCC',
        'GGCCTG',
        'GGCGCGGAGC',
        'CGCGGGGCGGGG',
        'CCTCGCTGTGCCGCTGCCGA',
        'CCTCATGGTGGTGGCTGGGGGCAG',
    
        /*
        //BEAN1
        "TAGAA",
        "TGGAA",

        //DAB1
        "GAAAT",

        //MARCHF6
        "ATTTC",

        //RAPGEF2, 
        "TTTCA",

        //RFC1
        "AAGGC",
        "AAGGG",
        "ACAGG",
        "AGAGG",
        "AGGGC",
        */
    ].join(', ')

    const computeIntervalSize = (interval) => {
        const [chrom, start_end] = interval.split(':')
        const [start, end] = start_end.split('-')
        return parseInt(end) - parseInt(start)
    }

    // column definitions
    let TABLE_COLUMNS = {
        interval: {
            displayName: 'Interval (hg38)',
            helpText: 'Genomic coordinates of the TR locus in the hg38 reference genome. <b>Example:</b> 1:94418421-94418442',
            getValue: (row) => row.ReferenceRegion.replace(/^chr/i, ''),
            getSortColumns: () => [DEFAULT_SORT_COLUMN],
            getRequiredColumns: () => ['chrom_index', 'start_0based', 'end_1based', 'ReferenceRegion']
        },
        motif: {
            displayName: 'Motif',
            helpText: 'The repeat motif and motif size. <b>Examples:</b> CAG (3), GGCCCC (6)',
            getValue: (row) => {
                const motif = row.ReferenceMotif
                const truncatedMotif = motif.length > 12 ? motif.substring(0, 12) + '...' : motif
                return `${truncatedMotif} &nbsp (${row.MotifSize})`
            },
            getSortColumns: () => ['MotifSize', 'ReferenceMotif'],
            getRequiredColumns: () => ['MotifSize', 'ReferenceMotif']
        },
        geneRegion: {
            displayName: 'Region',
            helpText: 'TR locus gene region. <b>Examples:</b> 5\'UTR, coding, etc.',
            getValue: (row) => {
                if (!row.GencodeGeneRegion) return ''
                const regionRename = {
                    'CDS': 'coding',
                    'exon': 'exon (non-coding gene)'
                }
                return regionRename[row.GencodeGeneRegion] || row.GencodeGeneRegion
            },
            getSortColumns: () => ['GencodeGeneRegion'],
            getRequiredColumns: () => ['GencodeGeneRegion'],
        },
        geneName: {
            displayName: 'Gene',
            helpText: 'Gencode gene name',
            getValue: (row) => row.GencodeGeneName,
            getSortColumns: () => ['GencodeGeneName'],
            getRequiredColumns: () => ['GencodeGeneName'],
        },
        polymorphism: {
            displayName: 'Polymorphism',
            helpText: 'Summary of available sources of polymorphism data for the TR locus',
            getValue: (row) => {
                let polymorphismDetails = ``
                    for (const dataColumn of REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN) {
                    if (row[dataColumn] != null) {
                        polymorphismDetails += `data-${dataColumn}='${row[dataColumn]}' `
                    }
                }
                        
                return `<span class="cell-in-polymorphism-column" ${polymorphismDetails}>
                            <span class="cell-action-link">
                                <b>σ<sub>${STDEV_SIGMA_SUBSCRIPTS['HPRC100_Stdev']}</sub></b>
                            </span>
                            <span style="color: #333;">
                                = ${row.HPRC100_Stdev != null ? row.HPRC100_Stdev.toFixed(1) : 'not available'} &nbsp; &nbsp; 
                            </span>
                            <span class="cell-action-link">                                    
                                ${row.TenK10K_Stdev != null ? `σ<sub>${STDEV_SIGMA_SUBSCRIPTS["TenK10K_Stdev"]}</sub>` : ''}  ${row.StdevFromIllumina174k != null ? `σ<sub>${STDEV_SIGMA_SUBSCRIPTS["StdevFromIllumina174k"]}</sub>` : ''}  ${row.StdevFromT2TAssemblies != null ? `σ<sub>${STDEV_SIGMA_SUBSCRIPTS["StdevFromT2TAssemblies"]}</sub>` : ''}
                            </span>
                        </span>
                        `
            },
            getSortColumns: () => ['HPRC100_Stdev'],
            getRequiredColumns: () => REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN,
        },
        variationCluster: {
            displayName: 'VC',
            helpText: 'Summarizes whether the TR locus resides within a variation cluster',
            getValue: (row) => {
                const hasCluster = row.VariationCluster && row.VariationCluster.trim() !== ''
                if (hasCluster) {
                    const refRegionSize = computeIntervalSize(row.ReferenceRegion)
                    const clusterDetails = `
                            <div class="content" style="text-align: center;">
                                <div><span class="cell-popup-details-label">Variation Cluster Interval:</span> <br />${row.VariationCluster}</div>
                                <br />
                                <div><span class="cell-popup-details-label">Variation Cluster Interval Size =</span> <br /><span style = "white-space: nowrap">reference repeat interval size (${refRegionSize} bp)</span> + ${row.VariationClusterSizeDiff} bp</div>
                            </div>
                        `.replace(/\s+/g, ' ').trim()

                    return `<span class="cell-with-icon-and-popup cell-in-variation-cluster-column" data-html='${clusterDetails}'>
                            <i class="check circle icon"></i><span class="cell-action-link">Yes</span>
                        </span>: +${row.VariationClusterSizeDiff}bp`
                }
                return ''
            },
            getSortColumns: () => ['VariationClusterSizeDiff'],
            getRequiredColumns: () => ['VariationClusterSizeDiff', 'VariationCluster']
        },
        trsInRegion: {
            displayName: 'Nearby TRs',
            helpText: 'Number of other TRs in the vicinity of this locus that are separated from each other by no more than 6bp of spacer sequence. <b>Range:</b> 1 to 13 TRs',
            getValue: (row) => (row.TRsInRegion ? (parseInt(row.TRsInRegion) - 1) : ''),
            getSortColumns: () => ['TRsInRegion'],
            getRequiredColumns: () => ['TRsInRegion']
        },
        mappability: {
            displayName: 'Mappability',
            helpText: 'UCSC 36-mer mappability scores averaged across the TR locus including +/- 150bp of flanking sequence. <b>Range:</b> 0 to 1',
            getValue: (row) => row.FlanksAndLocusMappability,
            getSortColumns: () => ['FlanksAndLocusMappability'],
            getRequiredColumns: () => ['FlanksAndLocusMappability']
        },
        gencodeGeneId: {
            displayName: 'Gencode Gene Id',
            helpText: 'Gencode gene ID (ENSG)',
            getValue: (row) => row.GencodeGeneId,
            getSortColumns: () => ['GencodeGeneId'],
            getRequiredColumns: () => ['GencodeGeneId']
        },
        gencodeTranscriptId: {
            displayName: 'Gencode Transcript Id',
            helpText: 'Gencode transcript ID (ENST)',
            getValue: (row) => row.GencodeTranscriptId,
            getSortColumns: () => ['GencodeTranscriptId'],
            getRequiredColumns: () => ['GencodeTranscriptId']
        },
        refSeqGeneRegion: {
            displayName: 'RefSeq Region',
            helpText: 'RefSeq gene region',
            getValue: (row) => row.RefSeqGeneRegion,
            getSortColumns: () => ['RefSeqGeneRegion'],
            getRequiredColumns: () => ['RefSeqGeneRegion']
        },
        refSeqGeneId: {
            displayName: 'RefSeq Id',
            helpText: 'RefSeq gene ID',
            getValue: (row) => row.RefSeqGeneId,
            getSortColumns: () => ['RefSeqGeneId'],
            getRequiredColumns: () => ['RefSeqGeneId']
        },
        refSeqGeneName: {
            displayName: 'RefSeq Gene',
            helpText: 'RefSeq gene name',
            getValue: (row) => row.RefSeqGeneName,
            getSortColumns: () => ['RefSeqGeneName'],
            getRequiredColumns: () => ['RefSeqGeneName']
        },
        maneGeneRegion: {
            displayName: 'MANE Region',
            helpText: 'MANE gene region',
            getValue: (row) => row.MANEGeneRegion,
            getSortColumns: () => ['MANEGeneRegion'],
            getRequiredColumns: () => ['MANEGeneRegion']
        },
        maneGeneId: {
            displayName: 'MANE Id',
            helpText: 'MANE gene ID',
            getValue: (row) => row.MANEGeneId,
            getSortColumns: () => ['MANEGeneId'],
            getRequiredColumns: () => ['MANEGeneId']
        },
        maneGeneName: {
            displayName: 'MANE Gene',
            helpText: 'MANE gene name',
            getValue: (row) => row.MANEGeneName,
            getSortColumns: () => ['MANEGeneName'],
            getRequiredColumns: () => ['MANEGeneName']
        },
    }


    for (const columnName of ['HPRC100_AlleleHistogram', 'TenK10K_AlleleHistogram', 'AlleleFrequenciesFromIllumina174k', 'AlleleFrequenciesFromT2TAssemblies']) {
        TABLE_COLUMNS[columnName] = {
            displayName: `Allele Distribution (${ALLELE_HISTOGRAM_SHORT_NAMES[columnName]})`,
            helpText: ALLELE_HISTOGRAM_HELP_TEXTS[columnName],
            getValue: (row) => `<canvas class="allele-frequency-inline-chart" data-frequencies="${row[columnName]}" data-ref-allele-size="${row['NumRepeatsInReference']}" style="width: 100%; height: 100px;"></canvas>`,
            getSortColumns: () => [columnName],
            getRequiredColumns: () => [columnName]
        }
    }

    for (const columnName of ['HPRC100_Stdev', 'TenK10K_Stdev', 'StdevFromIllumina174k', 'StdevFromT2TAssemblies']) {
        TABLE_COLUMNS[columnName] = {
            displayName: `σ<sub>${STDEV_SIGMA_SUBSCRIPTS[columnName]}</sub>`,
            helpText: STDEV_HELP_TEXTS[columnName],
            getValue: (row) => row[columnName],
            getSortColumns: () => [columnName],
            getRequiredColumns: () => [columnName]
        }
    }

    if (!RESULTS_TABLE_COLUMN_NAMES.every(columnName => Object.keys(TABLE_COLUMNS).includes(columnName))) {
        throw new Error('RESULTS_TABLE_COLUMN_NAMES is missing columns from TABLE_COLUMNS: ' + RESULTS_TABLE_COLUMN_NAMES.filter(columnName => !Object.keys(TABLE_COLUMNS).includes(columnName)).join(', '))
    }

    const readAndApplyPersistentPageStateFromUrl = async () => {
        GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))
        
        const hash = window.location.hash.substring(1)
        if (!hash) return
        
        const params = new URLSearchParams(hash)
        
        for (const [key, value] of params.entries()) {
            if (key in DEFAULT_GLOBAL_PAGE_STATE && value != null) {
                // Convert string values to appropriate types
                GLOBAL_PAGE_STATE[key] = value === 'true' ? true : 
                                        value === 'false' ? false :
                                        !isNaN(value) ? Number(value) : value
                if (key === 'showColumns') {
                    GLOBAL_PAGE_STATE['showColumns'] = `${value}` // convert to string
                }
            }
        }
        console.log("Starting to initialize page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)


        // igv
        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        }

        // advanced search wrapper
        if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {
            $('#advanced-search-form').show()
            $('#filter-button .filter.icon').removeClass('rotated')
        }

        // search
        $('#search-query').val(GLOBAL_PAGE_STATE['searchQuery'])

        $('select[name="sourceCatalog"]').val(GLOBAL_PAGE_STATE['sourceCatalog'])
        $('#source-catalog-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['sourceCatalog'])

        $('input[name="keepMotifSize"]').val(GLOBAL_PAGE_STATE['keepMotifSize'])
        $('input[name="keepMotif"]').val(GLOBAL_PAGE_STATE['keepMotif'])

        $('input[name="keepCodingLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepCodingLoci'] === 1)
        $('input[name="keepFiveUTRLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepFiveUTRLoci'] === 1)
        $('input[name="keepThreeUTRLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepThreeUTRLoci'] === 1)
        $('input[name="keepPromoterLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepPromoterLoci'] === 1)
        $('input[name="keepIntronLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepIntronLoci'] === 1)
        $('input[name="keepIntergenicLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepIntergenicLoci'] === 1)
        $('input[name="keepNonCodingExonLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepNonCodingExonLoci'] === 1)

        $('input[name="polymorphismFilter"]').prop('checked', GLOBAL_PAGE_STATE['polymorphismFilter'] === 1)
        $('select[name="polymorphismFilterType"]').val(GLOBAL_PAGE_STATE['polymorphismFilterType'])
        $('#polymorphism-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['polymorphismFilterType'])

        $('input[name="vcFilter"]').prop('checked', GLOBAL_PAGE_STATE['vcFilter'] === 1)
        $('select[name="vcFilterType"]').val(GLOBAL_PAGE_STATE['vcFilterType'])
        $('#variation-cluster-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['vcFilterType'])
        // Restore custom track URLs
        for (let i = 1; i <= 3; i++) {
            $(`#igv-custom-track-url-${i}`).val(GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] || '')
        }

        if (GLOBAL_PAGE_STATE['showRs'] === 1) {
            $('#search-form').submit()
        }
    }

    const writePersistentPageStateToUrl = () => {
        // Create object with only non-default values
        const nonDefaultParams = {}
        for (const [key, value] of Object.entries(GLOBAL_PAGE_STATE)) {
            if (value !== DEFAULT_GLOBAL_PAGE_STATE[key]) {
                nonDefaultParams[key] = value
            }
        }

        // Convert to URL hash using jQuery's param method
        const hash = '#' + $.param(nonDefaultParams)

        // Get current hash to check if state has changed
        const currentHash = window.location.hash
        if (currentHash !== hash) {
            // Update URL and add to browser history
            window.history.pushState(null, '', hash)
        }
    }

    const generateIgvConfig = (addSelectedTracks) => {

        const locus = GLOBAL_PAGE_STATE['igvLoc']

        // specify IGV tracks and the data to display in them
        const tracks = []


        if (addSelectedTracks) {
            tracks.push({
                name: "Refseq",
                format: "refgene",
                url: "https://hgdownload.soe.ucsc.edu/goldenPath/hg38/database/ncbiRefSeq.txt.gz",
                indexed: false,
                infoURL: "https://www.ncbi.nlm.nih.gov/gene/?term=$$",
                height: 150,
            })

            ALL_AVAILABLE_TRACKS.forEach((rt) => {
                const trackName = rt[0]
                const trackDisplayName = rt[1]
                const trackURL = rt[2]
                if (!GLOBAL_PAGE_STATE[trackName]) {
                    return
                }

                if (trackName == 'igv_gencode') {
                    tracks.push({
                        name: trackDisplayName,
                        format: 'refgene',
                        url: trackURL,
                        indexURL: `${trackURL}.tbi`,
                        indexed: true,
                        searchable: true,
                        height: 350,
                        visibilityWindow: -1,
                        displayMode: 'EXPANDED',
                        color: 'rgb(76,171,225)',
                    })
                } else {
                    tracks.push({
                        name: trackDisplayName,
                        url: trackURL
                    })
                }

            })

            // Add custom tracks if they have URLs
            for (let i = 1; i <= 3; i++) {
                const url = GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`]
                if (url && url.trim() !== '') {
                    tracks.push({
                        name: url.split('/').pop(),
                        url: url.trim()
                    })
                }
            }
        }

        const reference = {
            "id": "hg38",
            "name": "Human (GRCh38/hg38)",
            "fastaURL": "https://igv-genepattern-org.s3.amazonaws.com/genomes/seq/hg38/hg38.fa",
            "indexURL": "https://igv-genepattern-org.s3.amazonaws.com/genomes/seq/hg38/hg38.fa.fai",
            "cytobandURL": "https://s3.amazonaws.com/igv.org.genomes/hg38/annotations/cytoBandIdeo.txt.gz",
            "aliasURL": "https://s3.amazonaws.com/igv.org.genomes/hg38/hg38_alias.tab",
            "chromosomeOrder": "chr1, chr2, chr3, chr4, chr5, chr6, chr7, chr8, chr9, chr10, chr11, chr12, chr13, chr14, chr15, chr16, chr17, chr18, chr19, chr20, chr21, chr22, chrX, chrY",
            "tracks": tracks,
        }

        return {
            reference: reference,
            showCursorTrackingGuide: true,
            locus: locus,
        }
    }

    async function updateIgv() {

        // create igv.js browser object if it hasn't been created yet
        if (!window.igvBrowser) {
            const config = generateIgvConfig(false)
            window.igvBrowser = await igv.createBrowser(document.getElementById("igv-viewport"), config)

            //window.igvBrowser.trackViews.forEach((trackView) => { monkeyPatchPopupData(trackView.track) }
            window.igvBrowser.on('trackremoved', (track) => {
                // get the track id that matches the url
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    if (track.url === rt[2]) {
                        const trackName = rt[0]
                        $(`input[name="${trackName}"]`).prop('checked', false)
                        GLOBAL_PAGE_STATE[trackName] = 0
                        writePersistentPageStateToUrl()
                    }
                })
            })

            window.igvBrowser.on('locuschange', (locus) => {
                if (locus[0]) {
                    GLOBAL_PAGE_STATE['igvLoc'] = `${locus[0].chr}:${parseInt(locus[0].start)}-${parseInt(locus[0].end)}`
                    writePersistentPageStateToUrl()
                }
            })

            // add the IGV tracks selection button
            $('.igv-navbar-left-container').after(
                `<button id="igv-select-tracks-button" class="ui primary basic button" style="height:25px; padding:2px 15px 2px 30px; border-radius:5px; color:#06359d !important; background-color: white !important">
                   Select IGV Tracks
                   <i class="setting icon" style="margin-left:10px" />
                </button>`
            )

            $('#igv-tr-explorer-catalog-tracks-checkboxes').html($('#igv-tr-explorer-catalog-tracks-checkboxes').html() +
                TR_EXPLORER_CATALOG.map((rt) => `
                    <tr><td>
                        <div class="inline-field"><div class="ui checkbox igv-track-checkbox"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div> ${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '" ></i>' : ''}
                    </td><td class="igv-number-of-loci-column">
                         ${rt[3].toLocaleString()}
                    </td></tr>
                `).join(' ') + `
                    <tr>
                        <td style="padding: 5px 0px !important">
                            <i>Source Catalogs:</i>
                            <i class="question circle icon link" style="margin-left: 15px;" data-html="These 4 catalogs were merged to create the TR Explorer Catalog. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v1' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."></i>
                        </td>
                        <td></td>
                    </tr>
                ` +
                TR_EXPLORER_SOURCE_CATALOGS.map((rt) => `
                    <tr><td><div class="ui checkbox igv-track-checkbox" style="margin-left: 30px !important; display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
                `).join(' '))

            $('#igv-variation-cluster-tracks-checkboxes').html($('#igv-variation-cluster-tracks-checkboxes').html() +
                TR_VARIATION_CLUSTERS.map((rt) => `
                    <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
                `).join(' ')
            )

            $('#igv-other-tr-catalog-tracks-checkboxes').html($('#igv-other-tr-catalog-tracks-checkboxes').html() +
                GENOME_WIDE_TR_CATALOGS.map((rt) => `
                    <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
                `).join(' ')
            )

            $('#igv-known-disease-loci-checkboxes').html($('#igv-known-disease-loci-checkboxes').html() +
                KNOWN_TR_LOCI_TRACK.map((rt) => `
                    <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
                `).join(' ')
            )

            $('#igv-reference-tracks-checkboxes').html($('#igv-reference-tracks-checkboxes').html() +
                `<tr><td>` +
                REFERENCE_TRACKS.map((rt) => `
                    <div class="ui checkbox igv-track-checkbox"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>
                `).join(' ')
                + `</td></tr>`
            )

            $('#igv-custom-tracks').html($('#igv-custom-tracks').html() +
                `<tr>
                    <td colspan="2">
                        <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-1" placeholder="Enter a public data file URL for custom track #1. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                        <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-2" placeholder="Enter a public data file URL for custom track #2. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                        <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-3" placeholder="Enter a public data file URL for custom track #3. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                    </td>
                </tr>`
            )
            
            $(".ui.checkbox").checkbox()

            $('#igv-select-tracks-button').click(() => {
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    const trackName = rt[0]
                    const isChecked = GLOBAL_PAGE_STATE[trackName] === 1
                    $(`input[name="${trackName}"]`).prop('checked', isChecked)
                })

                $('#igv-track-selection-dialog').modal('show')
                $('.question').popup({ on: 'click' })
            })
            $('#igv-tracks-modal-apply-button').click(async() => {
                // update GLOBAL_PAGE_STATE with selected tracks
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    const trackName = rt[0]
                    const isChecked = $(`input[name="${trackName}"]`).is(':checked')
                    GLOBAL_PAGE_STATE[trackName] = isChecked ? 1 : 0
                })

                // update custom track URLs
                for (let i = 1; i <= 3; i++) {
                    const url = $(`#igv-custom-track-url-${i}`).val()
                    GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] = url || ''
                }

                writePersistentPageStateToUrl()
                await updateIgv()
            })
        }

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            const igvConfig = generateIgvConfig(true)

            console.log("Updating igv config to", igvConfig)
            await window.igvBrowser.loadSessionObject(igvConfig)
        }
    }

    $('#show-igv-divider').click(async () => {
        GLOBAL_PAGE_STATE['showIGV'] = (GLOBAL_PAGE_STATE['showIGV'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        } else {
            $('#igv-row').slideUp(500, () => {
                $('#hide-igv-divider-text').hide()
                $('#show-igv-divider-text').show()
            })
        }

    })

    const queryBigQuery = async (query, startIndex=null, pageSize=null, exportToFileFormat=null, toolName=null) => {
        try {
            const url = `https://us-central1-cmg-analysis.cloudfunctions.net/query_db`
            console.log(exportToFileFormat ? `Exporting to ${exportToFileFormat}:`: `Sending query:`, query.replace(/[\n\r\s]+/g, ' '))
            const requestBody = {
                sql: query,
                export_to_file_format: exportToFileFormat,
                tool_name: toolName,
                start_index: startIndex,
                page_size: pageSize,
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody),
            })

            if (!response.ok) {
                throw new Error(`BigQuery API error: ${response.status} ${response.statusText}`)
            }

            return await response.json()
        } catch (error) {
            console.error('Error querying BigQuery:', error)
            throw new Error(`BigQuery query error: ${error.message || 'Unknown error'}`)
        }
    }

    const updatePaginationControls = () => {

        const $topPagination = $('.top-pagination')
        const $bottomPagination = $('.bottom-pagination')

        const currentPage = GLOBAL_PAGE_STATE['currentPage']
        const pageSize = GLOBAL_PAGE_STATE['pageSize']
        const totalResults = window.searchResults.total_results


        // Always show pagination controls if there are results
        if (totalResults > 0) {
            $topPagination.show()
            $bottomPagination.show()
        } else {
            $topPagination.hide()
            $bottomPagination.hide()
            return
        }

        const nFirstRowOnPage = (currentPage - 1) * pageSize + 1
        const nLastRowOnPage = Math.min(nFirstRowOnPage + pageSize - 1, totalResults)

        const totalPages = parseInt(Math.ceil(totalResults / pageSize))

        const paginationHtml = `
                <div class="total-results">
                    Showing ${nFirstRowOnPage.toLocaleString()}-${nLastRowOnPage.toLocaleString()} out of ${totalResults.toLocaleString()}
                </div>
                <div class="export-selector">
                    <span class="export-label">Export to file:</span>
                    <div class="ui selection dropdown export-dropdown" id="export-dropdown" style="min-width: 160px">
                        <input type="hidden" name="export-format">
                        <i class="dropdown icon"></i>
                        <div class="default text">Select format</div>
                        <div class="menu">
                            <div class="item" data-value="bed">BED</div>
                            <div class="item" data-value="tsv">TSV</div>
                            <div class="item" data-value="json">JSON</div>
                            <div class="divider"></div>
                            <div class="header">Tool input formats:</div>
                            <div class="item" data-value="expansion_hunter">ExpansionHunter</div>
                            <div class="item" data-value="gangstr">GangSTR</div>
                            <div class="item" data-value="hipstr">HipSTR</div>
                            <div class="item" data-value="trgt">TRGT</div>
                            <div class="item" data-value="longtr">LongTR</div>
                        </div>
                    </div>
                    <i class="question circle icon export-help-icon" data-html="Export all ${totalResults.toLocaleString()} search results to a file in the selected format"></i>
                </div>
                <div class="page-size-selector">
                    <span>Page size:</span>
                    <div class="ui selection dropdown page-size-select" style="min-width: 80px;">
                        <input type="hidden" name="page-size">
                        <i class="dropdown icon"></i>
                        <div class="text">${pageSize}</div>
                        <div class="menu">
                            <div class="item" data-value="10">10</div>
                            <div class="item" data-value="20">20</div>
                            <div class="item" data-value="50">50</div>
                            <div class="item" data-value="100">100</div>
                            <div class="item" data-value="200">200</div>
                            <div class="item" data-value="500">500</div>
                            <div class="item" data-value="1000">1000</div>
                        </div>
                    </div>
                </div>
                <div class="pagination-controls">
                    <button class="ui icon button first-page ${currentPage === 1 ? 'disabled' : ''}" title="First page">
                        <i class="angle double left icon"></i>
                    </button>
                    <button class="ui icon button prev-page ${currentPage === 1 ? 'disabled' : ''}"
                            title="Previous page">
                        <i class="angle left icon"></i>
                    </button>
                    <div class="page-input-container">
                        <span>Page</span>
                        <input type="number" class="page-number-input" min="1" max="${totalPages}" value="${currentPage}">
                        <span class="total-pages">of ${totalPages.toLocaleString()}</span>
                    </div>
                    <button class="ui icon button next-page ${currentPage === totalPages ? 'disabled' : ''}"
                            title="Next page">
                        <i class="angle right icon"></i>
                    </button>
                    <button class="ui icon button last-page ${currentPage === totalPages ? 'disabled' : ''}"
                            title="Last page">
                        <i class="angle double right icon"></i>
                    </button>
                </div>
            `

        $topPagination.html(paginationHtml)
        $bottomPagination.html(paginationHtml)

        $('.export-help-icon').popup({ on: 'click' })

        // Add click handlers for all pagination containers
        $('.pagination-container').each(function() {
            const $container = $(this)

            // Handle page size selection using standard <select>
            $container.find('.page-size-select').dropdown({
                onChange: (value) => {
                    const newPageSize = parseInt(value)
                    if (newPageSize !== GLOBAL_PAGE_STATE['pageSize']) {
                        GLOBAL_PAGE_STATE['pageSize'] = newPageSize
                        GLOBAL_PAGE_STATE['currentPage'] = 1
                        writePersistentPageStateToUrl()
                        performSearch(true)
                    }
                }
            })

            // First page button
            $container.find('.first-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] = 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Previous page button
            $container.find('.prev-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] -= 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Next page button
            $container.find('.next-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] += 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Last page button
            $container.find('.last-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] = totalPages
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Page input handler
            $container.find('.page-number-input').on('change keypress', function(e) {
                if (e.type === 'change' || e.which === 13) {
                    const newPage = parseInt($(this).val())
                    if (newPage !== currentPage) {
                        GLOBAL_PAGE_STATE['currentPage'] = Math.max(1, Math.min(newPage, totalPages))
                        writePersistentPageStateToUrl()
                        performSearch(true)
                    }

                    if (e.type === 'keypress') {
                        e.preventDefault()
                    }
                }
            })
        })

        $('.export-dropdown').dropdown({
            onChange: async (value) => {
                if (!value) return

                $('.export-dropdown').dropdown('clear')

                const searchQuerySuffix = window.lastSearchQuerySuffix

                if (!searchQuerySuffix) {
                    alert('No results to export. Please perform a search first.')
                    return
                }


                // Format data based on export type
                let fileFormat
                if (value === 'expansion_hunter' || value == 'json') {
                    fileFormat = 'JSON'
                } else if (value === 'gangstr' || value === 'hipstr' || value === 'trgt' || value === 'longtr' || value === 'bed') {
                    fileFormat = 'BED'
                } else if (value === 'tsv') {
                    fileFormat = 'TSV'
                } else {
                    throw new Error(`Invalid export-dropdown value: ${value}`)
                }

                let toolName
                let selectClause
                if (value === 'expansion_hunter') {
                    toolName = 'ExpansionHunter'
                    selectClause = `LocusId, ReferenceRegion, CONCAT('(', ReferenceMotif, ')*') AS LocusStructure, 'Repeat' AS VariantType`
                } else if(value === 'gangstr') {
                    toolName = 'GangSTR'
                    selectClause = `chrom, start_0based + 1 AS start_1based, end_1based, MotifSize, ReferenceMotif, '' AS OffTargetRegions`
                } else if(value === 'hipstr' || value === 'longtr') {
                    toolName = value === 'hipstr' ? 'HipSTR' : 'LongTR'
                    selectClause = `chrom, start_0based + 1 AS start_1based, end_1based, MotifSize, NumRepeatsInReference, LocusId, ReferenceMotif`
                } else if(value === 'trgt') {
                    toolName = 'TRGT'
                    selectClause = `chrom, start_0based, end_1based, CONCAT('ID=', LocusId, ';MOTIFS=', ReferenceMotif, ';STRUC=(', ReferenceMotif, ')n') AS InfoField`
                } else if(value === 'bed') {
                    selectClause = `chrom, start_0based, end_1based, ReferenceMotif, MotifSize`
                } else if(value === 'tsv' || value === 'json') {
                    const tsv_columns = [
                        //'chrom_index',
                        'chrom',
                        'start_0based',
                        'end_1based',
                        'ReferenceRegion',
                        'LocusId',
                        'ReferenceMotif',
                        'MotifSize',
                        'CanonicalMotif',
                        'NumRepeatsInReference',
                        'ReferenceRepeatPurity',
                        'NsInFlanks',
                        'TRsInRegion',
                        'Source',
                        //'LeftFlankMappability',
                        //'RightFlankMappability',
                        'FlanksAndLocusMappability',
                        'VariationCluster',
                        'VariationClusterSizeDiff',
                        'KnownDiseaseAssociatedLocus',
                        'KnownDiseaseAssociatedMotif',
                        'GencodeGeneRegion',
                        'GencodeGeneName',
                        'GencodeGeneId',
                        'GencodeTranscriptId',
                        'RefseqGeneRegion',
                        'RefseqGeneName',
                        'RefseqGeneId',
                        'RefseqTranscriptId',
                        'ManeGeneRegion',
                        'ManeGeneName',
                        'ManeGeneId',
                        'ManeTranscriptId',
                        
                        'LPSLengthStdevFromHPRC100',
                        'LPSMotifFromHPRC100',
                        'LPSMotifFractionFromHPRC100',
                        'LPSMotifDenominatorFromHPRC100',

                        'AlleleFrequenciesFromIllumina174k',
                        'StdevFromIllumina174k',
                        'AlleleFrequenciesFromT2TAssemblies',
                        'StdevFromT2TAssemblies',

                        'TenK10K_AlleleHistogram',
                        'TenK10K_ModeAllele',
                        'TenK10K_Stdev',
                        'TenK10K_Median',
                        'TenK10K_99thPercentile',

                        'HPRC100_AlleleHistogram',
                        'HPRC100_ModeAllele',
                        'HPRC100_Stdev',
                        'HPRC100_Median',
                        'HPRC100_99thPercentile',
                    ]
                    selectClause = tsv_columns.join(', ')
                } else {
                    throw new Error(`Invalid export-dropdown value: ${value}`)
                }

                try {
                    $('body').css('cursor', 'wait')

                    const query = `SELECT ${selectClause} FROM ${searchQuerySuffix}`
                    const results = await queryBigQuery(query, null, null, fileFormat, toolName)

                    if (results.public_urls) {
                        if (results.public_urls.length > 1) {
                            if (!confirm(`The requested export is very large, so it was split into ${results.public_urls.length} separate files. Would you like to download them?`)) {
                                return;
                            }
                        }
                        for (const url of results.public_urls) {
                            console.log('Downloading URL:', url)
                            // Create and trigger download link using jQuery
                            const $link = $('<a>')
                                .attr('href', url)
                                .appendTo('body')
                            $link[0].click()

                            // Add a small delay between downloads
                            await new Promise(resolve => setTimeout(resolve, 2000))
                            
                            // Keep track of the link for later removal
                            if (!window.downloadLinks) {
                                window.downloadLinks = []
                            }
                            window.downloadLinks.push($link)
                            
                            // If this is the first link, start the cleanup timer
                            if (window.downloadLinks.length === 1) {
                                setTimeout(() => {
                                    window.downloadLinks.forEach($link => {
                                        $link.remove()
                                    })
                                    window.downloadLinks = []
                                }, 2*60*1000)
                            }

                        }
                    }
                                                        
                } catch (error) {
                    console.error('Error exporting data:', error)
                    alert('Error exporting data: ' + error.message)
                } finally {
                    $('body').css('cursor', 'default')
                }
            }
        })
    }

    const parseAlleleFrequenciesString = (frequenciesString) => {
        return frequenciesString.split(',').map(item => {
            const [size, count] = item.split(':')
            return {
                size: parseInt(size.replace('x', '')),
                count: parseInt(count)
            }
        })
    }

    const createAlleleFrequencyChart = function() {
        const frequencies = $(this).data('frequencies')
        const refAlleleSize = $(this).data('ref-allele-size')
        const chartWidth = $(this).data('chart-width')
        const chartHeight = $(this).data('chart-height')

        if (!frequencies) return   // Skip if no data

        const chartLabel = $(this).data('label')
        if (chartLabel) {
            console.log(chartLabel, ':', frequencies)
        }

        const data = parseAlleleFrequenciesString(frequencies)

        //data.sort((a, b) => a.size - b.size)

        const yLookup = {}
        const xLabels =  []
        const colors = []
        const borderColors = []
        for (let i = Math.min(...data.map(d => d.size)) - 1; i <= Math.max(...data.map(d => d.size)) + 1; i++) {
            xLabels.push(i)
            yLookup[i] = 0
        }
        for (let x of xLabels) {
            yLookup[x] = data.find(d => d.size === x)?.count || 0
            colors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 0.7)' : 'rgba(33, 133, 208, 0.5)')
            borderColors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 1)' : 'rgba(33, 133, 208, 1)')
        }

        // Destroy any existing chart on this canvas
        const existingChart = Chart.getChart(this);
        if (existingChart) {
            existingChart.destroy();
        }


        //set y-limit to the nearest whole power of 10 divided by 2, rounding up
        const yLimit = Math.pow(10, Math.ceil(Math.log10(2 * Math.max(...data.map(d => d.count))))) / 2
        new Chart(this, {
            type: 'bar',
            data: {
                labels: xLabels,
                datasets: [{
                    data: xLabels.map(d => yLookup[d]),
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: true,
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            boxHeight: 10,
                            padding: 5,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                return [{
                                    text: `Ref. Allele: ${refAlleleSize} repeats`,
                                    fillStyle: 'rgba(255, 165, 0, 0.7)',
                                    strokeStyle: 'rgba(255, 165, 0, 1)',
                                    lineWidth: 1,
                                    hidden: false,
                                    index: 0
                                }]
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Count: ${context.raw}`
                            }
                        },
                        position: 'nearest',
                        yAlign: 'bottom'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Repeat Count',
                            font: {
                                size: 13
                            },
                        },
                        ticks: {
                            font: {
                                size: 13
                            },
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        min: 0,
                        max: parseInt(yLimit),
                        title: {
                            display: true,
                            text: '# of samples',
                            font: {
                                size: 13
                            },
                        },
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (Math.floor(value) === value) {
                                    return parseInt(value)
                                }
                            },
                            font: {
                                size: 13
                            },
                        },
                        afterBuildTicks: (axis) => {
                            const ticks = [0, 3, 10, 30, 100, 300, 1000, 3000, 10000]
                            axis.ticks = ticks.filter(t => t <= axis.max).map(t => ({value: t}))
                        }
                    }
                }
            }
        })

        this.style.minWidth = chartWidth

        this.style.height = chartHeight
        this.style.minHeight = chartHeight
        this.style.maxHeight = chartHeight
    }

    const createSmallAlleleFrequencyChart = function() {
        const frequencies = $(this).data('frequencies')
        const refAlleleSize = $(this).data('ref-allele-size')
        
        if (!frequencies) return   // Skip if no data

        const data = parseAlleleFrequenciesString(frequencies)

        const yLookup = {}
        const xLabels =  []
        const colors = []
        const borderColors = []
        for (let i = Math.min(...data.map(d => d.size)) - 1; i <= Math.max(...data.map(d => d.size)) + 1; i++) {
            xLabels.push(i)
            yLookup[i] = 0
        }
        for (let x of xLabels) {
            yLookup[x] = data.find(d => d.size === x)?.count || 0
            colors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 0.7)' : 'rgba(33, 133, 208, 0.5)')
            borderColors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 1)' : 'rgba(33, 133, 208, 1)')
        }

        //set y-limit to the nearest whole power of 10 divided by 2, rounding up
        const yLimit = Math.pow(10, Math.ceil(Math.log10(2 * Math.max(...data.map(d => d.count))))) / 2
        new Chart(this, {
            type: 'bar',
            data: {
                labels: xLabels,
                datasets: [{
                    data: xLabels.map(d => yLookup[d]),
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Count: ${context.raw}`
                            }
                        },
                        position: 'nearest',
                        yAlign: 'bottom'
                    }
                },
                scales: {
                    y: {
                        type: 'logarithmic',
                        min: 0,
                        max: parseInt(yLimit),
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                if (Math.floor(value) === value) {
                                    return parseInt(value)
                                }
                            },
                            padding: 3,
                        },
                        grid: {
                            drawTicks: false
                        }

                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            },
                            padding: 3
                        },
                        grid: {
                            drawTicks: false
                        }
                    }
                }
            }
        })

        this.style.minHeight = '50px'
        
        $(this).parent().css('padding-top', '0')
        $(this).parent().css('padding-bottom', '0')
    }


    const displayError = (message) => {
        $('#error-text').text(message)
        $('#error-message').show()
        $('#results-table').empty()
    }

    const displaySearchResults = () => {
        
        const results = window.searchResults
        const sortColumn = GLOBAL_PAGE_STATE['sc']
        const sortDirection = GLOBAL_PAGE_STATE['sd']
        const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)

        const resultsTableElement = $('#results-table')

        resultsTableElement.removeClass('loading')
        if (!results.rows || results.rows.length === 0) {
            resultsTableElement.html('<div class="no-results">No matching results found</div>')
            $('.pagination-container').hide()
            return
        }

        let tableHtml = '<table class="ui celled sortable table"><thead><tr>'
        tableHtml += `<th style="text-align: center">
            <button id="results-table-settings-button" class="ui primary basic grey button" style="height:25px; padding:2px 3px 2px 13px; border-radius:5px; background-color: #FCFCFF !important" data-tooltip="Column descriptions and settings">
                <i class="setting icon"></i>
            </button>
        </th>`

        visibleColumns.forEach(columnId => {
            const columnName = RESULTS_TABLE_COLUMN_NAMES[columnId]
            if (columnName) {   
                const columnObject = TABLE_COLUMNS[columnName]
                const isSorted = columnId === sortColumn
                let icon = '<i class="sort icon"></i>'
                if (isSorted) {
                    icon = sortDirection === 'ASC' ? '<i class="sort up icon"></i>' : '<i class="sort down icon"></i>'
                }
                tableHtml += `<th class="${isSorted ? 'sorted' : ''} results-table-sortable-header" data-column="${columnId}">${columnObject.displayName} ${icon}</th>`
            }
        })

        tableHtml += '</tr></thead><tbody>'

        results.rows.forEach((row) => {
            let isDiseaseAssociated = false
            let diseaseAssociatedIcon = ''
            if (row.DiseaseInfo != null) {
                isDiseaseAssociated = true
                let diseaseLocusId = ''
                let diseaseDescription = `<span style='font-weight: bold; white-space: nowrap; text-align: left; display: block;'>Disease-associated locus</span><br />`
                try {
                    //console.log(row.DiseaseInfo)
                    const diseaseInfo = JSON.parse(row.DiseaseInfo)
                    const resources = []
                    if (diseaseInfo.STRchiveId) {
                        resources.push(`<a href='https://strchive.org/loci/${diseaseInfo.STRchiveId}' target='_blank'>STRchive</a>`)
                    }
                    if (diseaseInfo.STRipyId) {
                        resources.push(`<a href='https://stripy.org/database/${diseaseInfo.STRipyId}' target='_blank'>STRipy</a>`)
                    }
                    if (diseaseInfo.locusId != 'RAI1') {
                        resources.push(`<a href='https://gnomad.broadinstitute.org/short-tandem-repeat/${diseaseInfo.LocusId}?dataset=gnomad_r4' target='_blank'>gnomAD</a>`)
                    }
                    if (diseaseInfo.Diseases.length > 0 && diseaseInfo.Diseases[0].OMIM) {
                        resources.push(`<a href='https://www.omim.org/entry/${diseaseInfo.Diseases[0].OMIM}' target='_blank'>OMIM</a>`)
                    }
                    diseaseDescription += `Expansions at this ${diseaseInfo.LocusId} locus cause ${diseaseInfo.Diseases.map(d => d.Name).join(' & ')}.<br />
                    <br />
                        <span style='display: block; white-space: nowrap;'>For more information, see:<br />${resources.join(', &nbsp; ')}</span>
                    </span>`
                } catch (e) {
                    diseaseLocusId = row.LocusId
                    diseaseDescription = '<i>An error occurred while loading this information.</i>'
                    console.error(`Error parsing ${row.LocusId} DiseaseInfo JSON: ${row.DiseaseInfo}`, e)
                }
                diseaseAssociatedIcon += `<i style="margin-left: 10px;" class="disease-associated-icon user md icon" data-title="${diseaseLocusId}" data-html="${diseaseDescription}"></i>`
            }
            tableHtml += `<tr ${isDiseaseAssociated ? 'class="disease-associated-row"' : ''}>`
            tableHtml += `<td style="text-align: center;">
                <a class="row-igv-button cell-action-link" data-locus="${row.ReferenceRegion}">IGV</a>
                ${diseaseAssociatedIcon}
            </td>`
            
            const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
            visibleColumns.forEach(columnId => {
                const columnName = RESULTS_TABLE_COLUMN_NAMES[columnId]
                if (columnName) {
                    const columnObject = TABLE_COLUMNS[columnName]
                    let value
                    if (!columnObject || !columnObject.getValue) {
                        const label = columnObject ? 'columnObject' : 'columnObject.getValue'
                        console.log('WARNING: ', label, 'is undefined for columnId:', columnId, 'columnName:', columnName)
                        value = row[columnName]
                    } else {
                        value = columnObject.getValue(row)
                    }
                    
                    tableHtml += `<td>${value != null ? value : ''}</td>`
                }
            })
            tableHtml += '</tr>'
        })
        tableHtml += '</tbody></table>'
        resultsTableElement.html(tableHtml)

        // Add click handlers for sortable headers
        resultsTableElement.find('.results-table-sortable-header').click(function() {
            const column = $(this).data('column')
            if (column === sortColumn) {
                if (sortDirection === 'ASC') {
                    GLOBAL_PAGE_STATE['sd'] = 'DESC'
                } else if (sortDirection === 'DESC') {
                    GLOBAL_PAGE_STATE['sc'] = DEFAULT_SORT_COLUMN
                    GLOBAL_PAGE_STATE['sd'] = DEFAULT_SORT_DIRECTION  
                }
            } else {
                GLOBAL_PAGE_STATE['sc'] = column
                GLOBAL_PAGE_STATE['sd'] = 'ASC'
            }

            performSearch(true)
        })

        // Add click handlers for IGV buttons
        $('.row-igv-button').click(async function() {
            const locus = $(this).data('locus')
            if (!locus) return

            // Parse the locus to get chrom, start, end
            const match = locus.match(/^(?:chr)?([XYMTt0-9]+):(\d+)-(\d+)$/i)
            if (!match) return

            const [_, chrom, start, end] = match
            const padding = 150
            const paddedStart = Math.max(0, parseInt(start) - padding)
            const paddedEnd = parseInt(end) + padding
            const paddedLocus = `${chrom}:${paddedStart}-${paddedEnd}`


            try {
                $('body').css('cursor', 'wait')

                // Show IGV if hidden
                if (GLOBAL_PAGE_STATE['showIGV'] !== 1) {

                    GLOBAL_PAGE_STATE['showIGV'] = 1

                    $('#igv-row').show()
                    $('#show-igv-divider-text').hide()
                    $('#hide-igv-divider-text').show()
                    await updateIgv()
                }

                // Scroll the page to the IGV browser
                $('#igv-row')[0].scrollIntoView({ behavior: 'smooth' })

                // Navigate to the locus
                GLOBAL_PAGE_STATE['igvLoc'] = paddedLocus
                writePersistentPageStateToUrl()

                await window.igvBrowser.search(paddedLocus)

                // Enable the "TR Explorer genome-wide catalog" track if it's not already enabled
                if (!GLOBAL_PAGE_STATE['igv_tr_explorer_catalog']) {
                    GLOBAL_PAGE_STATE['igv_tr_explorer_catalog'] = 1
                    writePersistentPageStateToUrl()

                    await updateIgv()
                }
            } finally { 
                $('body').css('cursor', 'default')
            }
        })

        // Init charts
        $('.allele-frequency-inline-chart').each(createSmallAlleleFrequencyChart)


        // Initialize popups for variation cluster cells
        $('.cell-in-variation-cluster-column').popup({
            position: 'right center',
            on: 'click',
            hoverable: true,
        })

        // Initialize popups for polymorphism cells
        $('.cell-in-polymorphism-column').click(function() {
            const row = $(this).data()
            for (const key of REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN) {
                const lowerCaseKey = key.toLowerCase()
                if (row[lowerCaseKey] != null) {
                    row[key] = row[lowerCaseKey]
                }
            }
                        
            $('#polymorphism-dialog-header').html(`Polymorphism: &nbsp; ${row.ReferenceMotif} repeats &nbsp; @ &nbsp; ${row.ReferenceRegion}`)
            $('#polymorphism-dialog-content').html('')

            const stdevColumns = ['HPRC100_Stdev', 'LPSLengthStdevFromHPRC100', 'TenK10K_Stdev', 'StdevFromIllumina174k', 'StdevFromT2TAssemblies']
            const alleleFrequencyColumns = ['HPRC100_AlleleHistogram', 'TenK10K_AlleleHistogram', 'AlleleFrequenciesFromIllumina174k', 'AlleleFrequenciesFromT2TAssemblies']

            const nStdevsNotAvailable = [row.LPSLengthStdevFromHPRC100 == null, row.HPRC100_Stdev == null, row.TenK10K_Stdev == null, row.StdevFromIllumina174k == null, row.StdevFromT2TAssemblies == null].filter(Boolean).length

            let polymorphismDialogContent = `
                <div class="content" style="text-align: center">
            `

            if (nStdevsNotAvailable == stdevColumns.length) {
                polymorphismDialogContent += `
                        <span style="color: #686868;">No polymorphism data available.</span>
                        <br /><br />
                `
            } else {
                polymorphismDialogContent += `
                    <div><span class="cell-popup-details-label">Allele Frequency Distribution Summary Statistics</span></div>
                        <div style="margin-top: 5px">
                            <table style="margin: 0 auto">
                `
            }

            for (const key of stdevColumns) {
                if (row[key] != null) {
                    polymorphismDialogContent += `
                        <tr>
                            <td style="text-align: left;">
                                        <span style="font-size: 1.2em;">σ<sub style="font-size: 0.7em;">${STDEV_SIGMA_SUBSCRIPTS[key]}</sub></span>
                                    </td>
                                    <td style="text-align: right;">
                                        = ${row[key].toFixed(3)}
                                    </td>
                                    <td style="text-align: right;">
                                        <i class="question circle icon link" style="margin-left: 15px;" data-html="${STDEV_HELP_TEXTS[key]}"></i>
                                    </td>
                        </tr>
                    `
                }
            }
            polymorphismDialogContent += "</table>"

            if (nStdevsNotAvailable > 0) {
                polymorphismDialogContent += "<br />"
                let namesOfMissingSigmas = []
                for (const key of stdevColumns) {
                    if (row[key] == null) {
                        namesOfMissingSigmas.push(`<span style="font-size: 1.2em;">σ<sub style="font-size: 0.7em;">${STDEV_SIGMA_SUBSCRIPTS[key]}</sub></span>`)
                    }
                }
                polymorphismDialogContent += ` ${namesOfMissingSigmas.join(' &amp; ')} ${namesOfMissingSigmas.length > 1 ? 'are' : 'is'} not available for this locus`
            }

            polymorphismDialogContent += "</div>"
            // check if any of the allele frequency columns are available
            const alleleFrequencyColumnsAvailable = alleleFrequencyColumns.some(column => row[column] != null)
            if (alleleFrequencyColumnsAvailable) {
                // calculate the height of the allele frequency charts
                polymorphismDialogContent += `
                    <div style="margin-top: 15px;">
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px">
                `

                for (const column of alleleFrequencyColumns) {
                    if (row[column] != null) {
                        polymorphismDialogContent += `

                            <div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">
                                <div style="margin-bottom: 5px;"><b>${ALLELE_FREQUENCY_CHART_TITLES[column]}</b><br /><span style="color: #686868;">${ALLELE_FREQUENCY_CHART_SUBTITLES[column]}</span></div>
                                <canvas class="allele-frequency-chart" data-label="${ALLELE_HISTOGRAM_SHORT_NAMES[column]}" data-frequencies="${row[column]}" data-ref-allele-size="${row.NumRepeatsInReference}" data-chart-width="500px" data-chart-height="200px" style="width: 100%; height: 100px;"></canvas>
                            </div>
                        `
                    }
                }
                polymorphismDialogContent += '</div></div>'
            }

            $('#polymorphism-dialog-content').html(polymorphismDialogContent.replace(/\s+/g, ' ').trim())

            $('.allele-frequency-chart').each(createAlleleFrequencyChart)

            $('.question').popup({ on: 'click' })

            $('#polymorphism-dialog').modal('show')
        })

        

        $('.disease-associated-icon').popup({ on: 'click' })

        // "Column settings" modal
        $('#results-table-settings-button').click((e) => {
            e.preventDefault()
            
            // Clear existing checkboxes
            $('.results-table-column-settings-checkboxes tr').remove()
            
            // Create a flex container div instead of using table rows
            $('.results-table-column-settings-checkboxes').html('<div class="results-table-column-settings-checkbox-flex-container"></div>')
            
            const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
            const checkboxes = Object.entries(RESULTS_TABLE_COLUMN_NAMES).map(([columnId, columnName]) => {
                const isChecked = visibleColumns.includes(columnId)
                return `
                    <div class="results-table-column-settings-checkbox-item">
                        <div class="ui checkbox" style="display: inline-block; padding-right: 10px">
                            <input type="checkbox" name="show_column_${columnId}" ${isChecked ? 'checked' : ''}>
                            <label>${TABLE_COLUMNS[columnName].displayName}</label>
                        </div>
                        ${TABLE_COLUMNS[columnName].helpText ? `<i class="question circle icon" data-html="${TABLE_COLUMNS[columnName].helpText}"></i>` : ''}
                    </div>`
            }).join('')
            
            $('.results-table-column-settings-checkbox-flex-container').append(checkboxes)
            
            // Initialize checkboxes
            $('.results-table-column-settings-checkboxes .ui.checkbox').checkbox()
            $('#results-table-column-settings-dialog').modal('show')
            $('.question').popup({ on: 'click' })
        })

        // Handle Apply button click in column settings dialog
        $('#results-table-column-settings-apply-button').click(() => {
            const selectedColumns = []
            $('.results-table-column-settings-checkboxes input[type="checkbox"]').each(function() {
                if ($(this).prop('checked')) {
                    const columnId = $(this).attr('name').replace('show_column_', '')
                    selectedColumns.push(columnId)
                }
            })
            
            GLOBAL_PAGE_STATE['showColumns'] = selectedColumns.join(SHOW_COLUMNS_VALUE_DELIMITER) 
            writePersistentPageStateToUrl()
            performSearch(true)
            
            $('#results-table-column-settings-dialog').modal('hide')
        })

        GLOBAL_PAGE_STATE['showRs'] = 1
        writePersistentPageStateToUrl()
    }

    const performSearch = async (showTableWhileLoading = false) => {
        // Remove any error messages and no results message
        $('#error-message').hide()
        $('.no-results').hide()
        $('.top-pagination').hide()         // Hide only top pagination container during loading
        $('#loading-container').show()      // Show loading indicator
        
        // Add loading state to table without emptying it
        if (showTableWhileLoading) {
            $('.bottom-pagination').show()
            $('#results-table').addClass('loading')
        } else {
            $('#results-table').hide()
            $('.bottom-pagination').hide()
        }

        try {
            $('body').css('cursor', 'wait')

            let conditions = []

            let searchQuery = $('#search-query').val()
            if (searchQuery) {
                searchQuery = searchQuery.trim()

                // Split input by commas to handle multiple values
                const queryValues = searchQuery.split(',').map(q => q.trim()).filter(q => q !== '')
                
                // Process each query value and create query conditions
                const queryClauses = queryValues.map(queryValue => {
                    // Check if it's a genomic region (chr:start-end)
                    const regionMatch = queryValue.match(/^(?:chr)?(\w+)[\s]*:[\s]*([\d,]+)[\s]*-[\s]*([\d,]+)$/i)
                    if (regionMatch) {
                        let [_, chrom, start, end] = regionMatch
                        start = parseInt(start.replace(/,/g, ''))
                        end = parseInt(end.replace(/,/g, ''))
                        return `
                            (chrom = '${chrom}' AND start_0based < ${end} AND end_1based >= ${start})
                        `
                    } else {
                        // Try other fields
                        return `
                            (UPPER(GencodeGeneName) = UPPER('${queryValue}')
                            OR UPPER(GencodeGeneId) = UPPER('${queryValue}')
                            OR UPPER(GencodeTranscriptId) = UPPER('${queryValue}')
                            OR UPPER(RefseqGeneName) = UPPER('${queryValue}')
                            OR UPPER(RefseqGeneId) = UPPER('${queryValue}')
                            OR UPPER(RefseqTranscriptId) = UPPER('${queryValue}')
                            OR UPPER(ManeGeneName) = UPPER('${queryValue}')
                            OR UPPER(ManeGeneId) = UPPER('${queryValue}')
                            OR UPPER(ManeTranscriptId) = UPPER('${queryValue}')
                            OR UPPER(LocusId) = UPPER('${queryValue}'))
                        `
                    }
                })
                
                // Combine all clauses with OR for multiple input values
                if (queryClauses.length > 0) {
                    conditions.push(`(${queryClauses.join(' OR ')})`)
                }
            }

            if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {

                // Add source catalog condition
                const sourceCatalog = $('#source-catalog-dropdown').dropdown('get value')
                if (sourceCatalog) {
                    switch (sourceCatalog) {
                        case 'tr_explorer_catalog':
                            break   // No additional conditions needed
                        case 'illumina_174k_catalog':
                            conditions.push(
                                "(FoundInIllumina174kPolymorphicTRs = 'Yes' OR (FoundInKnownDiseaseAssociatedLoci = 'Yes' AND FoundInIllumina174kPolymorphicTRs LIKE '%Yes%'))")
                            break
                        case 'known_disease_loci':
                            conditions.push(
                                "KnownDiseaseAssociatedLocus IS NOT NULL")
                            break
                    }
                }

                // Add variation cluster filter conditions
                const vcFilter = $('input[name="vcFilter"]').prop('checked')
                const vcFilterType = $('#variation-cluster-filter-dropdown').dropdown('get value')
                if (vcFilter && vcFilterType) {
                    switch (vcFilterType) {
                        case 'exclude':
                            conditions.push("(VariationCluster IS NULL OR VariationCluster = '')")
                            break
                        case 'exclude_ge_50':
                            conditions.push("(VariationCluster IS NULL OR VariationCluster = '' OR VariationClusterSizeDiff < 50)")
                            break
                        case 'keep':
                            conditions.push("(VariationCluster IS NOT NULL AND VariationCluster != '')")
                            break
                        case 'keep_ge_50':
                            conditions.push("(VariationCluster IS NOT NULL AND VariationCluster != '' AND VariationClusterSizeDiff >= 50)")
                            break
                    }
                }

                // Add polymorphism filter conditions
                const polymorphismFilter = $('input[name="polymorphismFilter"]').prop('checked')
                const polymorphismFilterType = $('#polymorphism-filter-dropdown').dropdown('get value')
                if (polymorphismFilter && polymorphismFilterType) {
                    switch (polymorphismFilterType) {
                        case 'sigma_gt_0.0':
                            conditions.push("HPRC100_Stdev > 0.0")
                            break
                        case 'sigma_gt_0.3':
                            conditions.push("HPRC100_Stdev > 0.3")
                            break
                        case 'sigma_gt_0.5':
                            conditions.push("HPRC100_Stdev > 0.5")
                            break
                        case 'sigma_gt_1.0':
                            conditions.push("HPRC100_Stdev > 1.0")
                            break
                        case 'sigma_gt_3.0':
                            conditions.push("HPRC100_Stdev > 3.0")
                            break
                        case 'sigma_gt_5.0':
                            conditions.push("HPRC100_Stdev > 5.0")
                            break
                    }
                }

                // Add known disease-associated loci condition
                let knownDiseaseLoci = $('input[name="keepKdLoci"]').prop('checked')
                if (knownDiseaseLoci) {
                    conditions.push("KnownDiseaseAssociatedLocus IS NOT NULL AND KnownDiseaseAssociatedLocus != ''")
                }


                let motifSizeInput = $('input[name="keepMotifSize"]').val()
                if (motifSizeInput) {
                    motifSizeInput = motifSizeInput.trim()

                    let sizeClauses = []
                    
                    // Split input by commas and process each value
                    const values = motifSizeInput.split(',').map(v => v.trim()).filter(v => v !== '')
                    
                    values.forEach(value => {
                        // Handle open-ended ranges like "15-"
                        const openEndedMatch = value.match(/^(\d+)-$/)
                        if (openEndedMatch) {
                            const min = parseInt(openEndedMatch[1])
                            sizeClauses.push(`(MotifSize >= ${min})`)
                            return
                        }
                        
                        // Handle ranges like "2-6"
                        const rangeMatch = value.match(/^(\d+)-(\d+)$/)
                        if (rangeMatch) {
                            const min = parseInt(rangeMatch[1])
                            const max = parseInt(rangeMatch[2])
                            sizeClauses.push(`(MotifSize BETWEEN ${min} AND ${max})`)
                            return
                        }
                        
                        // Handle single numbers
                        const singleNumber = parseInt(value)
                        if (!isNaN(singleNumber)) {
                            sizeClauses.push(`(MotifSize = ${singleNumber})`)
                        }
                    })
                    
                    if (sizeClauses.length > 0) {
                        conditions.push(`(${sizeClauses.join(' OR ')})`)
                    }
                }

                const reverseCompliment = (m) => {
                    const complement = {
                        'A': 'T',
                        'T': 'A',
                        'C': 'G',
                        'G': 'C',
                        'R': 'Y',
                        'Y': 'R',
                        'M': 'K',
                        'K': 'M',
                        'B': 'V',
                        'D': 'H',
                        'H': 'D',
                        'V': 'B',
                    }
                    
                    return m.toUpperCase().split('').map(base => complement[base] || base).reverse().join('')
                }

                const computeCanonicalMotif = (m) => {
                    m = m.toUpperCase()
                    
                    const rotations = []
                    for (let i = 0; i < m.length; i++) {
                        rotations.push(m.slice(i) + m.slice(0, i))
                    }
                    
                    // Get reverse complement of each rotation
                    const allVariants = [...rotations, ...rotations.map(rot => reverseCompliment(rot))]
                    
                    // Return the lexicographically smallest variant
                    return allVariants.sort()[0]
                }

                
                let motifInput = $('#motif-input').val()
                if (motifInput) {
                    motifInput = motifInput.trim()
                    const motifs = motifInput.split(',').map(m => m.trim()).filter(m => m !== '')
                    if (motifs.length > 0) {
                        const motifClauses = motifs.map(motif => 
                            `UPPER(CanonicalMotif) = UPPER('${computeCanonicalMotif(motif)}')`
                        )
                        conditions.push(`(${motifClauses.join(' OR ')})`)
                    }
                }

                // Add gene region conditions
                const regionConditions = []
                
                if ($('input[name="keepCodingLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('CDS')")
                }
                if ($('input[name="keepFiveUTRLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('5\\' UTR')")
                }
                if ($('input[name="keepThreeUTRLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('3\\' UTR')")
                }
                if ($('input[name="keepPromoterLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('promoter')")
                }
                if ($('input[name="keepIntronLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('intron')")
                }
                if ($('input[name="keepIntergenicLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('intergenic')")
                }
                if ($('input[name="keepNonCodingExonLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('exon')")
                }

                if (regionConditions.length > 0) {
                    conditions.push(`(${regionConditions.join(' OR ')})`)
                }
            }

            //get all required columns for the visible columns
            let selectedColumns = [
                'LocusId',
                'ReferenceRegion',
                'DiseaseInfo',
            ]

            //add the visible columns to the selected columns
            const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
            Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
                if (visibleColumns.includes(columnId)) {
                    const columnObject = TABLE_COLUMNS[columnName]
                    columnObject.getRequiredColumns().forEach(column => {
                        if (!selectedColumns.includes(column)) {
                            selectedColumns.push(column)
                        }
                    })
                }
            })

            const sortColumn = GLOBAL_PAGE_STATE['sc']
            const sortDirection = GLOBAL_PAGE_STATE['sd']

            const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : ''
            const sortColumns = TABLE_COLUMNS[sortColumn]?.getSortColumns() || ['chrom', 'start_0based']
            const sortClause = sortColumns.map(column => `${column} ${sortDirection}`).join(', ')

            const querySuffix = `\`${PROJECT_ID}.${DATASET_ID}.${TABLE_ID}\` ${whereClause} ORDER BY ${sortClause}`
            const query = `SELECT ${selectedColumns.join(', ')} FROM ${querySuffix}`

            if (!showTableWhileLoading) {
                GLOBAL_PAGE_STATE['currentPage'] = 1
            }

            const startIndex = GLOBAL_PAGE_STATE['pageSize'] * (GLOBAL_PAGE_STATE['currentPage'] - 1)
            const pageSize = GLOBAL_PAGE_STATE['pageSize']

            window.lastSearchQuerySuffix = querySuffix
            window.searchResults = await queryBigQuery(query, startIndex, pageSize, null, null)

            console.log('Response:', window.searchResults)

            // Remove loading indicator and placeholder before showing results
            $('#loading-container').hide()

            GLOBAL_PAGE_STATE['searchQuery'] = searchQuery

            GLOBAL_PAGE_STATE['sourceCatalog'] = $('#source-catalog-dropdown').dropdown('get value')

            GLOBAL_PAGE_STATE['keepMotifSize'] = $('#motif-size-input').val()
            GLOBAL_PAGE_STATE['keepMotif'] = $('#motif-input').val()

            GLOBAL_PAGE_STATE['keepCodingLoci'] = $('input[name="keepCodingLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepFiveUTRLoci'] = $('input[name="keepFiveUTRLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepThreeUTRLoci'] = $('input[name="keepThreeUTRLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepPromoterLoci'] = $('input[name="keepPromoterLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepIntronLoci'] = $('input[name="keepIntronLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepIntergenicLoci'] = $('input[name="keepIntergenicLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepNonCodingExonLoci'] = $('input[name="keepNonCodingExonLoci"]').prop('checked') ? 1 : 0

            GLOBAL_PAGE_STATE['polymorphismFilter'] = $('input[name="polymorphismFilter"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['polymorphismFilterType'] = $('#polymorphism-filter-dropdown').dropdown('get value')
            GLOBAL_PAGE_STATE['vcFilter'] = $('input[name="vcFilter"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['vcFilterType'] = $('#variation-cluster-filter-dropdown').dropdown('get value')
            writePersistentPageStateToUrl()

            displaySearchResults()
            
            updatePaginationControls()
            
        } catch (error) {
            console.error('Error performing search:', error)
            $('#loading-container').hide()
            displayError('Error performing search: ' + error.message)
        } finally {
            $('body').css('cursor', 'default')
            $('#results-table').show()
            $('#results-table').removeClass('loading')
        }
    }

    // "About" modal
    $('#about-link').click((e) => {
        e.preventDefault()
        $('#about-modal').modal('show')
    })

    // "filter" button click handler
    $('#filter-button').click(() => {
        GLOBAL_PAGE_STATE['showAdvFilters'] = (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {
            $('#advanced-search-form').slideDown(300)
            $('#filter-button .filter.icon').removeClass('rotated')

            $('select[name="sourceCatalog"]').val(GLOBAL_PAGE_STATE['sourceCatalog'])
            $('#source-catalog-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['sourceCatalog'])
            $('select[name="polymorphismFilterType"]').val(GLOBAL_PAGE_STATE['polymorphismFilterType'])
            $('#polymorphism-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['polymorphismFilterType'])
            $('select[name="vcFilterType"]').val(GLOBAL_PAGE_STATE['vcFilterType'])
            $('#variation-cluster-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['vcFilterType'])

        } else {
            $('#advanced-search-form').slideUp(300)
            $('#filter-button .filter.icon').addClass('rotated')
        }
    })

    // handle search
    const handleSearch = async (event) => {
        event.preventDefault()
        await performSearch(false)
    }

    $('#search-form').submit(handleSearch)
    $('#advanced-search-form').submit(handleSearch)
    $('#advanced-search-form').find('input').keypress((e) => {
        if (e.which === 13) {
            e.preventDefault()
            handleSearch(e)
        }
    })

    // Initialize source catalog dropdown
    $('#source-catalog-dropdown').dropdown()
    
    // polymorphism filter dropdown
    $('#polymorphism-filter-dropdown').dropdown({
        onChange: (value) => {
            if (value) {
                $('input[name="polymorphismFilter"]').prop('checked', true)
            }
        }
    })

    // Add event handler for variation cluster filter dropdown
    $('#variation-cluster-filter-dropdown').dropdown({
        onChange: (value) => {
            if (value) {
                $('input[name="vcFilter"]').prop('checked', true)
            }
        }
    })
    
    $('#known-disease-motifs-link').click((e) => {
        e.preventDefault()

        $('#motif-input').val(MOTIFS_AT_KNOWN_DISEASE_ASSOCIATED_LOCI)
    })

    // handle browser forward & back buttons
    window.addEventListener('popstate', readAndApplyPersistentPageStateFromUrl)

    // init ui elements
    $('.ui.button').popup()
    $(".ui.checkbox").checkbox()


    $(document).ready(async () => {

        await readAndApplyPersistentPageStateFromUrl()

        console.log("Done initializing page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)
        $('body').css('cursor', 'default')
    })

</script>

</body>
</html>

