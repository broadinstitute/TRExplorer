<!DOCTYPE html>
<html>
    <head>
<title>TRExplorer</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2"></script>

<!-- script src="https://storage.googleapis.com/tgg-viewer/igv.js-bw2/dist/igv.min.js?version=2024-08-06"></script -->
<script src="https://cdn.jsdelivr.net/npm/igv@3.4.0/dist/igv.min.js"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6R8FPBQRFH"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-6R8FPBQRFH');
</script>


<style>
    /* Base styles */
    body {
        padding: 0;
        margin: 0;
        overflow-x: auto;  /* Enable horizontal scrolling for the entire page */
        min-width: 1000px; /* Set a minimum width to prevent content from becoming too narrow */
    }

    /* Header styles */
    #header-stripe {
        background-color: #1b1c1d;
        color: white;
        text-decoration: none;
        padding-top: 20px;
        padding-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }


    #header-title a {
        color: white;
        font-size: 22px;
        font-family: 'Arial Narrow Bold', sans-serif;
        white-space: nowrap;
        font-weight: 700;
        vertical-align: middle;
    }

    #header-title a:hover {
        color: rgba(255, 255, 255, 0.9);
    }

    #header-nav {
        display: flex;
        justify-content: right;
        vertical-align: middle;
        gap: 1.5em;
        font-size: 1.15em;
        font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
    }

    #header-nav a {
        color: rgba(255, 255, 255, 0.9);
        transition: color 0.2s;
    }

    #header-nav a:hover {
        color: white;
    }

    #github-icon {
        font-size: 1.3em;
    }

    /* IGV.js styles */
    #igv-row {
        display: none;
        margin-left: 20px;
        margin-right: 20px;
    }

    #advanced-search-form .checkbox {
        padding-right: 20px;
    }

    .igv-checkbox-container-table td {
        padding: 0px !important;
        width: 100%;
        border-top-width: 0px !important;
    }

    .igv-checkbox-container-header-row {
        padding: 7px 0px 7px 0px !important;
        border: 0px;
    }
    .igv-track-selection-table {
        border: 0px !important;
        padding: 0px;
    }

    .igv-track-selection-table td {
        vertical-align: top;
    }

    .igv-track-selection-table th {
        background: white;
    }

    .igv-number-of-loci-column {
        text-align: right !important;
        white-space: nowrap;
    }

    .igv-track-checkbox {
        margin-right: 15px;
        margin-bottom: 10px;
        display: block;
    }

    .question, .disease-associated-icon {
        margin-left: 10px;
        cursor: pointer;
    }

    .igv-row-sidebar-title {
        font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
        font-size: 18px;
        font-weight: 700;
    }

    .igv-row-sidebar-text {
        display: block;
        font-family: Lato, "Helvetica Neue", Arial, Helvetica, sans-serif;
        font-size: 14px;
    }

    #show-igv-divider {
        text-align: center;
        margin: 1.5em 0;
        position: relative;
        cursor: pointer;
    }

    #show-igv-divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        border-top: 1px solid #ddd;
        z-index: 0;
    }

    #show-igv-divider span {
        position: relative;
        display: inline-block;
        background-color: white;
        padding: 0 15px;
        color: #1a3c6d;
        font-weight: 500;
        font-size: 0.95em;
        z-index: 1;
        transition: color 0.2s;
    }

    #show-igv-divider:hover span {
        color: #2185d0;
    }

    #show-igv-divider i {
        font-size: 0.8em;
        margin-left: 5px;
        transition: transform 0.2s;
    }

    #search-query {
        margin-right: 5px;
        border: 1px solid rgba(34, 36, 38, 0.15) !important;
        border-radius: 4px !important;
    }

    #filter-button {
        border-radius: 4px !important;
        margin-right: 10px;
    }

    #filter-button .chevron.icon {
        margin-left: 2px;
    }

    #filter-button .chevron.icon.rotated {
        transform: rotate(90deg);
    }

    #filter-button:hover {
        background-color: #f8f8f8 !important;
    }

    #search-button {
        border-radius: 4px !important;
    }

    /* Results table */
    #results-table {
        margin-top: 1em;
        position: relative;  /* Add this to establish a positioning context */
    }

    #results-table.loading {
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    #results-table table.ui.table {
        border-left: none;
        border-right: none;
    }

    #results-table table.ui.table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: white;  /* Ensure header has solid background */
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);  /* Add subtle shadow for depth */
    }

    #results-table table.ui.table th,
    #results-table table.ui.table td {
        border-left: none;
        border-right: none;
    }

    #results-table table.ui.table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    #results-table table.ui.table tr:nth-child(odd) {
        background-color: white;
    }

    #results-table table.ui.table tr:hover {
        background-color: #e6f0ff;
    }

    #results-table table.ui.table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .show-popup {
        cursor: pointer;
    }

    /* Loading indicators */
    .ui.loader {
        margin-top: 2em;
    }

    #loading-container {
        background: white;
        padding: 0.5em 0;
        margin-top: 3.7em;
        margin-bottom: 1em;
        border-radius: 4px;
        height: 40px;
    }

    .loading-indicator {
        display: flex;
        align-items: center;
        color: #888;
        font-size: 1.1em;
        font-weight: 300;
        height: 100%;
    }

    .disease-associated-row {
        background-color: #ffdddd !important;
    }

    .disease-associated-row:hover {
        background-color: #eae9fc !important;
    }

    .loading-indicator .ui.loader {
        margin: 0;
        margin-right: 20px;
    }

    /* Pagination */
    .top-pagination {
        margin-top: 2.5em !important;
    }

    .pagination-container {
        margin-top: 1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        gap: 1em;
        flex-wrap: wrap;
    }

    .total-results {
        color: #666;
        font-size: 1.1em;
        white-space: nowrap;
        margin-right: 1em;
        order: 1;
    }

    .export-selector {
        display: flex;
        align-items: center;
        gap: 0.5em;
        color: #666;
        font-size: 1em;
        white-space: nowrap;
        order: 2;
        flex-grow: 1;
    }

    /* Make export dropdown menu tall enough to show all options */
    .export-selector .ui.selection.dropdown .menu {
        max-height: none !important;
    }

    .page-size-selector {
        display: flex;
        align-items: center;
        gap: 0.5em;
        color: #666;
        font-size: 1em;
        white-space: nowrap;
        order: 3;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        order: 4;
    }

    .pagination-controls .ui.button {
        padding: 8px;
        min-width: 36px;
        background: white;
        border: 1px solid #ddd;
        box-shadow: none;
    }

    .pagination-controls .ui.button:hover {
        background: #f8f8f8;
    }

    .pagination-controls .ui.button.disabled {
        opacity: 0.5;
        background: white;
    }

    .page-input-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0 4px;
        white-space: nowrap;
    }

    .page-input-container input {
        width: 60px;
        height: 36px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px;
    }

    .page-input-container .total-pages {
        color: #666;
    }

    /* Responsive adjustments */
    @media screen and (max-width: 1030px) {
        .page-grid-margin {
            max-width: 20px !important;
            width: 20px !important;
        }
    }

    @media screen and (max-width: 991px) {
        .pagination-container {
            justify-content: flex-start;
        }

        .total-results {
            flex-basis: 100%;
            margin-bottom: 0.5em;
        }

        .export-selector {
            margin: 0;
            margin-right: 1em;
        }
    }

    @media screen and (max-width: 767px) {
        .pagination-container {
            gap: 0.75em;
        }

        .export-selector, .page-size-selector {
            flex-basis: 100%;
            margin: 0;
        }

        .pagination-controls {
            width: 100%;
            justify-content: center;
        }
    }

    /* Misc UI elements */
    .no-results {
        margin-top: 2em;
        text-align: left;
        color: #888;
        font-size: 1.2em;
    }

    #results-area {
        position: relative;
    }

    .cell-with-icon-and-popup {
        cursor: pointer;
        color: #2185d0;
        transition: all 0.2s;
    }

    .cell-in-polymorphism-column {
        cursor: pointer;
        color: #2185d0;
    }

    .action-link {
        color: #2185d0;
        cursor: pointer;
        border-bottom: 1px dotted #2185d0;
        transition: all 0.2s;
    }

    .action-link:hover {
        opacity: 0.8;
    }

    /* Style for disabled export dropdown */
    .export-selector .ui.selection.dropdown.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Style for disabled export label */
    .export-selector .export-label {
        transition: opacity 0.2s;
    }
    .export-selector .ui.selection.dropdown.disabled + .export-label {
        opacity: 0.5;
    }

    .results-table-column-settings-checkbox-flex-container {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        max-height: calc(11 * 35px);
        gap: 5px 20px;
    }

    .results-table-column-settings-checkbox-item {
        min-width: 200px;
        padding: 5px 0;
    }

    #results-table-column-settings-dialog.ui.modal, #faq-modal.ui.modal, #downloads-modal.ui.modal, #whats-new-modal.ui.modal {
        width: 70% !important;
    }
</style>

<script>

    const TR_CATALOG_BASE_URL = "https://storage.googleapis.com/tandem-repeat-catalog"

    const SHARED_TR_CATALOG_SIZES = {
        known_disease_loci: 63,
        illumina_174k_catalog: 174300,
        tr_explorer_catalog: 4863041,
        tr_explorer_catalog_v2: 5543507,
    }

    const TR_EXPLORER_SOURCE_CATALOGS = [
        ["igv_kd_loci_july_2024", "Known disease-associated TR loci (July 2024)", `${TR_CATALOG_BASE_URL}/other_catalogs/KnownDiseaseAssociatedLoci_July2024.bed.gz`, SHARED_TR_CATALOG_SIZES['known_disease_loci']],
        ["igv_illumina_174k_source", "Illumina 174k", `${TR_CATALOG_BASE_URL}/other_catalogs/Illumina174kPolymorphicTRs.bed.gz`, SHARED_TR_CATALOG_SIZES['illumina_174k_catalog']],
        ["igv_perfect_repeats_hg38", "Perfect repeats in hg38", `${TR_CATALOG_BASE_URL}/other_catalogs/PerfectRepeatsInGRCh38.bed.gz`, 4558281],
        ["igv_polymorphic_trs_in_t2t", "Polymorphic TRs in T2T assemblies", `${TR_CATALOG_BASE_URL}/other_catalogs/PolymorphicTRsInT2TAssemblies.bed.gz`, 1937805],
    ]

    const TR_EXPLORER_CATALOG  = [
        ["igv_tr_explorer_catalog_v1", "TRExplorer catalog v1.0", `${TR_CATALOG_BASE_URL}/v1.0/TRExplorer.repeat_catalog_v1.hg38.1_to_1000bp_motifs.bed.gz`, SHARED_TR_CATALOG_SIZES['tr_explorer_catalog'], "TR catalog described in [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]"],
        ["igv_tr_explorer_catalog_v2", "TRExplorer catalog v2.0 draft", `${TR_CATALOG_BASE_URL}/v2.0/TRExplorer.repeat_catalog_v2.hg38.1_to_1000bp_motifs.bed.gz`, SHARED_TR_CATALOG_SIZES['tr_explorer_catalog_v2'], "Draft version 2.0 of the TR catalog described in [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]. This version introduces loci from the Vamos v2.1 catalog in order to improve coverage of VNTRs."],
    ]

    const TR_VARIATION_CLUSTERS = [
        ["igv_vc_v1", "Variation clusters v1.0", `${TR_CATALOG_BASE_URL}/v1.0/variation_clusters_v1.hg38.bed.gz`, 271362, "Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."],
        ["igv_vc_and_isolated_v1", "Variation clusters and isolated repeats v1.0", `${TR_CATALOG_BASE_URL}/v1.0/TRExplorer.variation_clusters_and_isolated_TRs_v1.hg38.TRGT.bed.gz`, 4542828, "This catalog contains intervals representing variation clusters, as well as entries for all TRExplorer catalog loci that are not within a variation cluster. Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."],
        ["igv_vc_and_isolated_v1_0_1", "Variation clusters and isolated repeats v1.0.1", `${TR_CATALOG_BASE_URL}/v1.0.1/TRExplorer.variation_clusters_and_isolated_TRs_v1.0.1.hg38.TRGT.bed.gz`, 4439813, "This catalog contains intervals representing variation clusters, as well as entries for all TRExplorer catalog loci that are not within a variation cluster. v1.0.1 removes 103,015 isolated repeat loci from v1.0 but that occur inside very large variation clusters which exceeded the max region size of the variation cluster algorithm. Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."],
    ];

    const KNOWN_TR_LOCI_TRACK = [
        ["igv_kd_loci", "Disease-associated loci (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/KnownDiseaseAssociatedLoci.bed.gz`, 68],
        ["igv_trgt_kd_loci", "TRGT repo: disease-associated loci (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/TRGT.pathogenic_repeats.hg38.bed.gz`, 56],
        ["igv_strchive_kd_loci", "STRchive catalog for TRGT (March 2025)", `${TR_CATALOG_BASE_URL}/other_catalogs/STRchive-disease-loci-v2.4.0.hg38.TRGT.B2FLLAlV.bed.gz`, 73],
    ]

    const GENOME_WIDE_TR_CATALOGS = [
        ["igv_illumina_174k", "Illumina 174k", `${TR_CATALOG_BASE_URL}/other_catalogs/Illumina174kPolymorphicTRs.bed.gz`, SHARED_TR_CATALOG_SIZES['illumina_174k_catalog']],
        ["igv_trgt", "TRGT", `${TR_CATALOG_BASE_URL}/other_catalogs/TRGT.bed.gz`, 171146, "Genome-wide catalog provided in the <a href='https://github.com/PacificBiosciences/trgt/tree/3d10c75/repeats' target='_blank'>TRGT repo</a> (downloaded March, 2025)"],
        ["igv_ucsc_sr", "UCSC simple repeat track", `${TR_CATALOG_BASE_URL}/other_catalogs/UCSC_SimpleRepeatTrack.bed.gz`, 965511],
        ["igv_vamos", "VAMOS v2.1", `${TR_CATALOG_BASE_URL}/other_catalogs/VamosCatalog_v2.1.bed.gz`, 1243954],
        ["igv_gangstr", "GangSTR v17", `${TR_CATALOG_BASE_URL}/other_catalogs/GangSTR_v17.bed.gz`, 1340266],
        ["igv_hipstr", "HipSTR", `${TR_CATALOG_BASE_URL}/other_catalogs/HipSTR.bed.gz`, 1638945],
        ["igv_adotto", "Adotto v1.2", `${TR_CATALOG_BASE_URL}/other_catalogs/Adotto_v1.2.bed.gz`, 2934805],
        ["igv_popstr", "PopSTR v2", `${TR_CATALOG_BASE_URL}/other_catalogs/PopSTR_v2.bed.gz`, 5401401],
        ["igv_platinum_trs", "Platinum TRs", `${TR_CATALOG_BASE_URL}/other_catalogs/PlatinumTRs.bed.gz`, 7524815, "The TR catalog described in [<a href='https://pubmed.ncbi.nlm.nih.gov/39149261/' target=_blank>Porubsky et al. 2024</a>]"],
        ["igv_chiu", "Chiu et al.", `${TR_CATALOG_BASE_URL}/other_catalogs/Chiu_et_al.bed.gz`, 18759399, "The TR catalog described in [<a href='https://pubmed.ncbi.nlm.nih.gov/38947075/' target=_blank>Chiu et al. 2024</a>]"],
    ]

    REFERENCE_BASE_URL = "https://storage.googleapis.com/tgg-viewer/ref/GRCh38"

    const REFERENCE_TRACKS = [
        ["igv_gencode", "Gencode v49", `${REFERENCE_BASE_URL}/gencode_v49/gencode.v49.GRCh38.sorted.txt.gz`],
        ["igv_segdups", "SegDups > 1000bp", `${REFERENCE_BASE_URL}/segdups/segdups.gtf.gz`],
        ["igv_36k_map", "36-mer mappability", `${REFERENCE_BASE_URL}/mappability/GRCh38_no_alt_analysis_set_GCA_000001405.15-k36_m2.bw`],
        ["igv_100k_map", "100-mer mappability", `${REFERENCE_BASE_URL}/mappability/GRCh38_no_alt_analysis_set_GCA_000001405.15-k100_m2.bw`],
        ["igv_haploinsuf", "ClinGen haploinsufficiency track", `${REFERENCE_BASE_URL}/clingen/ClinGen_haploinsufficiency_gene_GRCh38.sorted.bed.gz`],
        ["igv_triplosens", "ClinGen triplosensitivity track", `${REFERENCE_BASE_URL}/clingen/ClinGen_triplosensitivity_gene_GRCh38.sorted.bed.gz`],
        ["igv_repeatmask", "UCSC RepeatMasker", `${REFERENCE_BASE_URL}/hg38.RepeatMasker.bed.gz`],
    ]

    const ALL_AVAILABLE_TRACKS = [
        ...TR_EXPLORER_SOURCE_CATALOGS,
        ...TR_EXPLORER_CATALOG,
        ...TR_VARIATION_CLUSTERS,
        ...GENOME_WIDE_TR_CATALOGS,
        ...KNOWN_TR_LOCI_TRACK,
        ...REFERENCE_TRACKS,
    ]

    // initialize BigQuery client
    const PROJECT_ID = 'cmg-analysis'
    const DATASET_ID = 'tandem_repeat_explorer'
    const TABLE_ID = 'catalog_20251107_140924'
    const COMPLETE_TABLE_ID = `\`${PROJECT_ID}.${DATASET_ID}.${TABLE_ID}\``

    const SHOW_COLUMNS_VALUE_DELIMITER = 'i'

    const IGV_LOCUS_PADDING = 150
    const REFERENCE_REGION_REGEXP = /^(?:chr)?([XYMTt0-9]+):([\d,]+)-([\d,]+)$/i

    const ALL_STDEV_COLUMNS = [
        'HPRC100_Stdev',
        'AoU1027_Stdev',
        'TenK10K_Stdev',
        'StdevFromIllumina174k',
        'StdevFromT2TAssemblies',
    ]

    const STDEV_SIGMA_SUBSCRIPTS = {
        'HPRC100_Stdev': 'Hprc100',
        'AoU1027_Stdev': 'AoU1027',
        'TenK10K_Stdev': '10k10k',
        'StdevFromIllumina174k': '1kGP',
        'StdevFromT2TAssemblies': 'T2T',
    }

    const ALLELE_HISTOGRAM_SHORT_NAMES = {
        'HPRC100_AlleleHistogram': 'HPRC100',
        'TenK10K_AlleleHistogram': 'TenK10K Phase 1',
        'AlleleFrequenciesFromIllumina174k': '1kGP',
        'AlleleFrequenciesFromT2TAssemblies': 'T2T',
        'HPRC100_BiallelicHistogram': 'HPRC100',
        'TenK10K_BiallelicHistogram': 'TenK10K Phase 1',
    }
    const ALLELE_FREQUENCY_CHART_TITLES = {
        'HPRC100_AlleleHistogram': 'Allele Frequencies from HPRC 100 PacBio samples',
        'TenK10K_AlleleHistogram': 'Allele Frequencies from TenK10K Phase 1 short-read genomes',
        'AlleleFrequenciesFromIllumina174k': 'Allele Frequencies from 1kGP short-read genomes',
        'AlleleFrequenciesFromT2TAssemblies': 'Allele Frequencies from 78 diploid T2T assemblies',
        'HPRC100_BiallelicHistogram': 'Genotype Heatmap from HPRC 100 PacBio samples',
        'TenK10K_BiallelicHistogram': 'Genotype Heatmap from TenK10K Phase 1 short-read genomes',
    }

    const ALLELE_FREQUENCY_CHART_SUBTITLES = {
        'HPRC100_AlleleHistogram': 'based on TRGT calls in 100 PacBio HiFi samples from the Human Pan-genome Reference Consortium (HPRC)',
        'TenK10K_AlleleHistogram': 'based on ExpansionHunter calls in 1,925 short-read genomes from the <a href=https://www.biorxiv.org/content/10.1101/2024.11.02.621562v2 target=_blank>TenK10K Phase 1 dataset</a>',
        'AlleleFrequenciesFromIllumina174k': 'based on ExpansionHunter calls in <a href=https://github.com/Illumina/RepeatCatalogs/blob/master/docs/str_diversity_1kg.md target=_blank>2,504 short-read genomes from 1kGP</a>',
        'AlleleFrequenciesFromT2TAssemblies': 'based on assembly-to-hg38 alignments of 78 diploid T2T assemblies as described in <a href=https://pubmed.ncbi.nlm.nih.gov/37214979 target=_blank>Weisburd et al. 2023</a>',
        'HPRC100_BiallelicHistogram': 'based on TRGT calls in 100 PacBio HiFi samples from the Human Pan-genome Reference Consortium (HPRC)',
        'TenK10K_BiallelicHistogram': 'based on ExpansionHunter calls in 1,925 short-read genomes from the <a href=https://www.biorxiv.org/content/10.1101/2024.11.02.621562v2 target=_blank>TenK10K Phase 1 dataset</a>',
    }

    const STDEV_HELP_TEXTS = {
        'HPRC100_Stdev': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_AlleleHistogram']}. Allele sizes were computed using the longest pure segment (LPS) as described in [<a href=&quot;https://www.biorxiv.org/content/10.1101/2025.01.06.631535v2&quot; target=_blank>Danzi et al. 2025</a>]. <br /><br /><b>Range:</b> 0 to 330.7`,
        'AoU1027_Stdev': `This is the standard deviation of the allele frequency distribution based on TRGT calls in PacBio HiFi samples from 1,027 African American participants in the All of Us (AoU) project. Allele sizes were computed using the longest pure segment (LPS) as described in [<a href=&quot;https://www.biorxiv.org/content/10.1101/2025.01.06.631535v2&quot; target=_blank>Danzi et al. 2025</a>]. <br /><br /><b>Range:</b> 0 to 932.1`,
        'TenK10K_Stdev': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_AlleleHistogram']}. <br /><br />TenK10K Phase 1 primarily contains individuals of European ancestry.`,
        'StdevFromIllumina174k': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromIllumina174k']}. <br /><br /><b>Range:</b> 0 to 31.5`,
        'StdevFromT2TAssemblies': `This is the standard deviation of the allele frequency distribution ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromT2TAssemblies']}. <br /><br /><b>Range:</b> 0 to 1267.3`
    }

    const ALLELE_HISTOGRAM_HELP_TEXTS = {
        'HPRC100_AlleleHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_AlleleHistogram']}.`,
        'TenK10K_AlleleHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_AlleleHistogram']}.`,
        'AlleleFrequenciesFromIllumina174k': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromIllumina174k']}.`,
        'AlleleFrequenciesFromT2TAssemblies': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['AlleleFrequenciesFromT2TAssemblies']}.`,
        'HPRC100_BiallelicHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['HPRC100_BiallelicHistogram']}.`,
        'TenK10K_BiallelicHistogram': `Allele frequencies ${ALLELE_FREQUENCY_CHART_SUBTITLES['TenK10K_BiallelicHistogram']}.`,
    }

    const RESULTS_TABLE_COLUMN_HELP_TEXTS = {
        LocusId: 'A unique id of this TR locus in hg38',
        ReferenceRegion: 'Genomic coordinates of the TR locus in the hg38 reference genome. <b>Example:</b> 1:94418421-94418442',
        ReferenceRepeatSequence: 'The repeat sequence in hg38',
        ReferenceLeftFlank: 'The sequence immediately to the left of the TR locus in hg38',
        ReferenceRightFlank: 'The sequence immediately to the right of the TR locus in hg38',
        ReferenceMotif: 'The repeat motif in hg38 and its size in base pairs. <b>Examples:</b> CAG (3), GGCCCC (6)',
        CanonicalMotif: 'The repeat motif in hg38, normalized by computing all cyclic rotations of the motif and its reverse complement, and then selecting the one that is alphabetically first. <b>For example:</b> the canonical version of <i>CTG</i> is <i>AGC</i>',
        polymorphism: 'Summary of available polymorphism data for the TR locus',
        Source: 'TRExplorer catalog version, as well as the source catalog that contributed this TR locus to the TRExplorer catalog',
        TRsInRegion: 'Number of other TRs in the vicinity of this locus that are separated from each other by no more than 6bp of spacer sequence',
        NumRepeatsInReference: 'Number of repeats calculated by taking the width of the TR locus reference interval and dividing it by the motif size, then rounding down to the nearest integer',
        ReferenceRepeatPurity: 'The fraction of bases within the TR locus reference sequence that match perfect repeats of the specified motif. For example, CAG.CAG.CAG has purity = 1.0, while CAG.CAA.CAG has purity = 0.89. <b>Range:</b> 0 to 1',
        variationCluster: 'Summarizes whether the TR locus resides within a variation cluster. Variation Clusters (VCs) are genomic intervals that contain one or more TRs embedded within a wider region that harbors multiple common polymorphisms. For more details, see [<a href=\'https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2\' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]',
        isPathogenic: 'Whether this is a known disease-associated locus (provided as a separate column to enable sorting)',
        AoU1027_OE_LengthPercentile: 'Observed / Expected TR length metric from the TR constraint model described in [<a href=&quot;https://www.biorxiv.org/content/10.1101/2025.01.06.631535v2&quot; target=&quot;_blank&quot;>Danzi et al. 2025</a>], displayed as a percentile rank relative to all other TR loci in the catalog',
        RepeatMaskerIntervals: 'UCSC Repeat masker intervals that overlap the TR locus',
        VamosMotifFrequencies: 'Different motifs detected at this locus by the Vamos v2.1 pipeline when applied to 94 HPRC assemblies',
        FlanksAndLocusMappability: 'UCSC 36-mer mappability scores averaged across the TR locus and +/- 150bp of its flanking sequences. <b>Range:</b> 0 to 1',
        GencodeGeneRegion: 'The most significant gene region that overlaps the TR locus in Gencode v48',
        GencodeGeneName: 'Gencode v48 gene name',
        GencodeGeneId: 'Gencode v48 gene ID (ENSG)',
        GencodeTranscriptId: 'Gencode v48 transcript ID (ENST)',
        RefSeqGeneRegion: 'RefSeq gene region',
        RefSeqGeneId: 'RefSeq gene ID',
        RefSeqTranscriptId: 'RefSeq transcript ID',
        RefSeqGeneName: 'RefSeq gene name',
        ManeGeneRegion: 'MANE v1.4 gene region',
        ManeGeneId: 'MANE v1.4 gene ID',
        ManeGeneName: 'MANE v1.4 gene name',
        ManeTranscriptId: 'MANE v1.4 transcript id',
        HPRC100_BiallelicHistogram: 'Biallelic histogram of HPRC100',
        TenK10K_BiallelicHistogram: 'Biallelic histogram of TenK10K Phase 1',
    }

    /*
    const GENE_REGION_COLORS = {
        'CDS': 'rgb(208,5,5)',
        'exon': 'rgb(255,168,0)',
        'intron': 'rgb(40,126,40)',
        'intergenic': 'rgb(0,178,255)',
        '5\' UTR': 'rgb(0,72,255)',
        '3\' UTR': 'rgb(0,72,255)',
        'promoter': 'rgb(93,1,196)',
    }
    */

    const writePersistentPageStateToUrl = () => {
        // Create object with only non-default values
        const nonDefaultParams = {}
        for (const [key, value] of Object.entries(GLOBAL_PAGE_STATE)) {
            if (value !== DEFAULT_GLOBAL_PAGE_STATE[key]) {
                nonDefaultParams[key] = value
            }
        }

        // Convert to URL hash using jQuery's param method
        const hash = '#' + $.param(nonDefaultParams)

        // Get current hash to check if state has changed
        const currentHash = window.location.hash
        if (currentHash !== hash) {
            // Update URL and add to browser history
            window.history.pushState(null, '', hash)
        }
    }

    const computeIntervalSize = (interval) => {
        const [chrom, start_end] = interval.split(':')
        const [start, end] = start_end.split('-')
        return parseInt(end) - parseInt(start)
    }

    const generateIgvConfig = (addSelectedTracks) => {

        // specify IGV tracks and the data to display in them
        const tracks = []


        if (addSelectedTracks) {
            tracks.push({
                name: "Refseq",
                format: "refgene",
                url: `${REFERENCE_BASE_URL}/ncbiRefSeq.txt.gz`,
                indexed: true,
                indexURL: `${REFERENCE_BASE_URL}/ncbiRefSeq.txt.gz.tbi`,
                infoURL: "https://www.ncbi.nlm.nih.gov/gene/?term=$$",
                height: 150,
            })

            ALL_AVAILABLE_TRACKS.forEach((rt) => {
                const trackName = rt[0]
                const trackDisplayName = rt[1]
                const trackURL = rt[2]
                if (!GLOBAL_PAGE_STATE[trackName]) {
                    return
                }

                if (trackName == 'igv_gencode') {
                    tracks.push({
                        name: trackDisplayName,
                        format: 'refgene',
                        url: trackURL,
                        indexURL: `${trackURL}.tbi`,
                        indexed: true,
                        searchable: true,
                        height: 350,
                        visibilityWindow: -1,
                        displayMode: 'EXPANDED',
                        color: 'rgb(76,171,225)',
                    })
                } else if (trackURL.endsWith('.bed.gz')) {
                    tracks.push({
                        format: 'bed',
                        name: trackDisplayName,
                        url: trackURL,
                        indexURL: `${trackURL}.tbi`,
                        indexed: true,
                        searchable: false,
                        displayMode: 'EXPANDED',
                    })
                } else if (trackURL.endsWith('.gtf.gz')) {
                    tracks.push({
                        format: 'gtf',
                        name: trackDisplayName,
                        url: trackURL,
                        indexed: true,
                        searchable: false,
                        displayMode: 'EXPANDED',
                    })
                } else {
                    tracks.push({
                        name: trackDisplayName,
                        url: trackURL,
                    })
                }

            })

            // Add custom tracks if they have URLs
            for (let i = 1; i <= 3; i++) {
                const url = GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`]
                if (url && url.trim() !== '') {
                    tracks.push({
                        name: url.split('/').pop(),
                        url: url.trim()
                    })
                }
            }
        }

        const reference = {
            "id": "hg38",
            "name": "Human (GRCh38/hg38)",
            "fastaURL": "https://igv-genepattern-org.s3.amazonaws.com/genomes/seq/hg38/hg38.fa",
            "indexURL": "https://igv-genepattern-org.s3.amazonaws.com/genomes/seq/hg38/hg38.fa.fai",
            "cytobandURL": "https://s3.amazonaws.com/igv.org.genomes/hg38/annotations/cytoBandIdeo.txt.gz",
            "aliasURL": "https://s3.amazonaws.com/igv.org.genomes/hg38/hg38_alias.tab",
            "chromosomeOrder": "chr1, chr2, chr3, chr4, chr5, chr6, chr7, chr8, chr9, chr10, chr11, chr12, chr13, chr14, chr15, chr16, chr17, chr18, chr19, chr20, chr21, chr22, chrX, chrY",
            "tracks": tracks,
        }

        const locus = GLOBAL_PAGE_STATE['igvLoc']
        return {
            reference: reference,
            showCursorTrackingGuide: true,
            minimumBases: 40,  //required for https://github.com/igvteam/igv.js/issues/2046
            locus: locus,
        }
    }

    async function updateIgv() {

        // create igv.js browser object if it hasn't been created yet
        if (!window.igvBrowser) {
            const config = generateIgvConfig(false)
            window.igvBrowser = await igv.createBrowser(document.getElementById("igv-viewport"), config)

            //window.igvBrowser.trackViews.forEach((trackView) => { monkeyPatchPopupData(trackView.track) }
            window.igvBrowser.on('trackremoved', (track) => {
                // get the track id that matches the url
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    if (track.url === rt[2]) {
                        const trackName = rt[0]
                        $(`input[name="${trackName}"]`).prop('checked', false)
                        GLOBAL_PAGE_STATE[trackName] = 0
                        writePersistentPageStateToUrl()
                    }
                })
            })

            window.igvBrowser.on('locuschange', (locus) => {
                if (locus[0] && locus[0].chr && locus[0].start && locus[0].end) {
                    GLOBAL_PAGE_STATE['igvLoc'] = `${locus[0].chr}:${parseInt(locus[0].start)}-${parseInt(locus[0].end)}`
                    writePersistentPageStateToUrl()
                }
            })

            // add the IGV tracks selection button
            $($('#igv-viewport')[0].shadowRoot).find('.igv-navbar-left-container').after(
                //$('.igv-navbar-left-container').after(
                `<button id="igv-select-tracks-button" class="ui primary basic button" style="height:25px; padding:2px 15px 2px 30px; border-color:#06359d !important; border-width: 1px !important; border-radius:5px; color:#06359d !important; background-color: white !important; cursor: pointer;">
               Select IGV Tracks
               <i class="setting icon" style="margin-left:10px" />
            </button>`
            )

            $('#igv-tr-explorer-catalog-tracks-checkboxes').html($('#igv-tr-explorer-catalog-tracks-checkboxes').html() +
                TR_EXPLORER_CATALOG.map((rt) => `
                <tr><td>
                    <div class="inline-field"><div class="ui checkbox igv-track-checkbox"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div> ${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '" ></i>' : ''}
                </td><td class="igv-number-of-loci-column">
                     ${rt[3].toLocaleString()}
                </td></tr>
            `).join(' ') + `
                <tr>
                    <td style="padding: 5px 0px !important">
                        <i>Source Catalogs:</i>
                        <i class="question circle icon link" style="margin-left: 15px;" data-html="These 4 catalogs were merged to create the TRExplorer Catalog. For more details, see [<a href='https://www.biorxiv.org/content/10.1101/2024.10.04.615514v2' target=_blank>Weisburd, Dolzhenko et al. 2024</a>]."></i>
                    </td>
                    <td></td>
                </tr>
            ` +
                TR_EXPLORER_SOURCE_CATALOGS.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="margin-left: 30px !important; display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' '))

            $('#igv-variation-cluster-tracks-checkboxes').html($('#igv-variation-cluster-tracks-checkboxes').html() +
                TR_VARIATION_CLUSTERS.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' ')
            )

            $('#igv-other-tr-catalog-tracks-checkboxes').html($('#igv-other-tr-catalog-tracks-checkboxes').html() +
                GENOME_WIDE_TR_CATALOGS.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' ')
            )

            $('#igv-known-disease-loci-checkboxes').html($('#igv-known-disease-loci-checkboxes').html() +
                KNOWN_TR_LOCI_TRACK.map((rt) => `
                <tr><td><div class="ui checkbox igv-track-checkbox" style="display: inline-block"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>${rt[4] ? '<i class="question circle icon link" data-html="' + rt[4] + '"></i>' : ''}</td><td class="igv-number-of-loci-column">${rt[3].toLocaleString()}</td></tr>
            `).join(' ')
            )

            $('#igv-reference-tracks-checkboxes').html($('#igv-reference-tracks-checkboxes').html() +
                `<tr><td>` +
                REFERENCE_TRACKS.map((rt) => `
                <div class="ui checkbox igv-track-checkbox"><input type="checkbox" name="${rt[0]}" ${GLOBAL_PAGE_STATE[rt[0]] ? 'checked' : ''}><label>${rt[1]}</label></div>
            `).join(' ')
                + `</td></tr>`
            )

            $('#igv-custom-tracks').html($('#igv-custom-tracks').html() +
                `<tr>
                <td colspan="2">
                    <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-1" placeholder="Enter a public data file URL for custom track #1. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                    <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-2" placeholder="Enter a public data file URL for custom track #2. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                    <input type="text" style="margin-bottom: 10px; width:100%;" class="igv-custom-track-url" id="igv-custom-track-url-3" placeholder="Enter a public data file URL for custom track #3. It can be an indexed BED, BAM, VCF, or other file format supported by IGV.js" />
                </td>
            </tr>`
            )

            $(".ui.checkbox").checkbox()

            $($('#igv-viewport')[0].shadowRoot).find('#igv-select-tracks-button').click(() => {
                //$('#igv-select-tracks-button').click(() => {
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    const trackName = rt[0]
                    const isChecked = GLOBAL_PAGE_STATE[trackName] === 1
                    $(`input[name="${trackName}"]`).prop('checked', isChecked)
                })

                $('#igv-track-selection-dialog').modal('show')
                $('.question').popup({ on: 'click' })
            })
            $('#igv-tracks-modal-apply-button').click(async() => {
                // update GLOBAL_PAGE_STATE with selected tracks
                ALL_AVAILABLE_TRACKS.forEach((rt) => {
                    const trackName = rt[0]
                    const isChecked = $(`input[name="${trackName}"]`).is(':checked')
                    GLOBAL_PAGE_STATE[trackName] = isChecked ? 1 : 0
                })

                // update custom track URLs
                for (let i = 1; i <= 3; i++) {
                    const url = $(`#igv-custom-track-url-${i}`).val()
                    GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] = url || ''
                }

                writePersistentPageStateToUrl()
                await updateIgv()
            })
        }

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            const igvConfig = generateIgvConfig(true)

            console.log("Updating igv config to", igvConfig)
            await window.igvBrowser.loadSessionObject(igvConfig)
        }
    }

    const queryBigQuery = async (query, startIndex=null, pageSize=null, exportToFileFormat=null, toolName=null) => {
        try {
            const url = `https://us-central1-cmg-analysis.cloudfunctions.net/query_db`
            console.log("Page state:", GLOBAL_PAGE_STATE)
            console.log(exportToFileFormat ? `Exporting to ${toolName || ''} ${exportToFileFormat}:`: `Sending query:`, query.replace(/[\n\r\s]+/g, ' '))
            const requestBody = {
                sql: query,
                export_to_file_format: exportToFileFormat,
                tool_name: toolName,
                start_index: startIndex,
                page_size: pageSize,
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody),
            })

            if (!response.ok) {
                throw new Error(`BigQuery API error: ${response.status} ${response.statusText}`)
            }

            return await response.json()
        } catch (error) {
            console.error('Error querying BigQuery:', error)
            throw new Error(`BigQuery query error: ${error.message || 'Unknown error'}`)
        }
    }


    const parseAlleleFrequenciesString = (frequenciesString) => {
        try {
            const data = []
            const items = frequenciesString.split(',')
            for (let i = 0; i < items.length; i++) {
                const [size, count] = items[i].split(':')
                data.push({
                    size: parseInt(size.replace('x', '')),
                    count: parseInt(count)
                })
            }
            return data
        } catch (e) {
            console.error('Error parsing allele frequencies string:', e)
            return []
        }
    }

    const parseRepeatMaskerIntervals = (repeatMaskerIntervals) => {
        if (!repeatMaskerIntervals) {
            return ''
        }

        let values = new Set()
        let count = 0
        let details = []
        for (let token of repeatMaskerIntervals.split(', ')) {
            const tokenEntries = token.split(':')
            if (!'Simple_repeat|Low_complexity'.includes(tokenEntries[0])) {
                values.add(tokenEntries[0])
                count += 1
                details.push(`<span style='font-family: monospace'>${tokenEntries[0]}: ${tokenEntries[1]}</span>`)
            }
        }

        if (count == 0) {
            return ''
        }

        return `<span class="show-popup action-link" data-html="${details.join('<br />')}">${Array.from(values).join(', ')}</span>`
    }

    const showTruncatedSequence = (sequence, truncateAt=12, showSize=true, leftTruncate=false) => {
        let sequenceSizeString = ''
        if (showSize) {
            sequenceSizeString += `(${sequence.length})`
        }
        if (sequence.length > truncateAt) {
            let result = `<span class="show-popup action-link" style="font-family: monospace" data-html="<span style='font-family: monospace'>${sequence.replace(/.{1,100}/g, chunk => chunk + ' ')}</span>">`
            if (leftTruncate) {
                const truncatedSequence = sequence.substring(sequence.length - truncateAt, sequence.length)
                result += `${sequenceSizeString} &nbsp; ...${truncatedSequence}`
            } else {
                const truncatedSequence = sequence.substring(0, truncateAt)
                result += `${truncatedSequence}... &nbsp; ${sequenceSizeString}`
            }
            result += `</span>`
            return result
        } else {
            let result = `<span style="font-family: monospace">`
            if (leftTruncate) {
                result += `${sequenceSizeString} &nbsp; ${sequence}`
            } else {
                result += `${sequence} &nbsp; ${sequenceSizeString}`
            }
            result += `</span>`
            return result
        }
    }

    const parseMotifFrequenciesString = (frequenciesString, maxRowsToShow=null) => {
        if (!frequenciesString) {
            return ''
        }

        try {
            const items = frequenciesString.split(',')
            let total = 0
            let motifCounts = {}
            let efficientMotifs = {}
            for (let i = 0; i < items.length; i++) {
                let motif, efficientMotif, count
                if (items[i].indexOf(':') < 3) {
                    [motif, count] = items[i].split(':')
                    efficientMotif = ''
                } else {
                    [motif, efficientMotif, count] = items[i].split(':')
                }
                count = parseInt(count)
                motif = motif.trim()
                motifCounts[motif] = count
                efficientMotifs[motif] = efficientMotif.trim()
                total += count
            }

            // convert counts to fractions
            let motifCount = 0
            let homopolymerMotifCount = 0
            for (let motif in motifCounts) {
                motifCounts[motif] /= total
                if (motifCounts[motif] >= 0.01) {
                    motifCount += 1
                    if (motif.length == 1) {
                        homopolymerMotifCount += 1
                    }
                }
            }

            if (motifCount <= 1 || homopolymerMotifCount == motifCount) {
                return ''
            }

            const truncateMotifAt = 35
            let resultMotifs = []
            for (let motif in motifCounts) {
                let motifRow
                let motifPercentString
                if (motifCounts[motif] >= 0.01) {
                    motifRow = '<tr>'
                    motifPercentString = (motifCounts[motif] * 100.0).toFixed(0)
                } else {
                    motifRow = `<tr style='color:#AAAAAA'>`
                    motifPercentString = (motifCounts[motif] * 100.0).toFixed(1)
                }
                motifRow += `<td style='text-align:right'><i>${motifPercentString}%</i></td>`
                motifRow += `<td><span style='white-space: nowrap; font-family: monospace'>${motif.length > truncateMotifAt ? (motif.substring(0, truncateMotifAt) + '... (' + motif.length + 'bp)') : motif}</span></td>`
                if (efficientMotifs[motif]) {
                    motifRow += `<td><span style='white-space: nowrap; font-family: monospace'>`
                    if (efficientMotifs[motif] != motif) {
                        motifRow += `${efficientMotifs[motif].length <= truncateMotifAt ? efficientMotifs[motif] : (efficientMotifs[motif].substring(0, truncateMotifAt) + '... (' + efficientMotifs[motif].length + 'bp)')}`
                    } else {
                        motifRow += '<i>same as motif</i>'
                    }
                    motifRow += `</span></td>`
                } else {
                    motifRow += `<td><i>unavailable</i></td>`
                }
                motifRow += '</tr>'

                resultMotifs.push(motifRow)
            }

            const totalMotifs = resultMotifs.length

            if (maxRowsToShow && resultMotifs.length > maxRowsToShow) {
                resultMotifs = resultMotifs.slice(0, maxRowsToShow)
                resultMotifs.push(`<tr><td colspan='3' style='text-align:center; color:#AAAAAA'><i>... ${Object.keys(motifCounts).length - maxRowsToShow} more motifs. See locus page ...</i></td></tr>`)
            }

            let data_html = `<table style='border-spacing: 20px 3px'><tr><td><b>Frequency</b></td><td><b>Motif</b></td><td><span style='white-space: nowrap'><b>Efficient Motif</b></span></td></tr>${resultMotifs.join('')}</table><br />`
            data_html += `<b>Details:</b> Motifs detected at this locus by the Vamos v2.1 pipeline when applied to 94 HPRC T2T assemblies. Percentages represent what fraction of the 94 haplotype sequences that is covered by each motif.<br /><br />`

            return `<span class="show-popup action-link" data-html="${data_html}">${totalMotifs} motifs</span>`
        } catch (e) {
            console.error('Error parsing motif frequencies string:', e)
            return ''
        }
    }

    const createAlleleFrequencyChart = (chartData) => {
        const frequencies = chartData.frequencies
        const thisObj = chartData.thisObj
        const refAlleleSize = chartData.refAlleleSize
        const chartWidth = chartData.chartWidth
        const chartHeight = chartData.chartHeight
        const minAlleleSize = chartData.minAlleleSize
        const maxAlleleSize = chartData.maxAlleleSize

        const chartLabel = chartData.label

        //frequencies.sort((a, b) => a.size - b.size)

        const yLookup = {}
        const xLabels =  []
        const colors = []
        const borderColors = []
        for (let i = minAlleleSize - 1; i <= maxAlleleSize + 1; i++) {
            xLabels.push(i)
            yLookup[i] = 0
        }
        for (let x of xLabels) {
            yLookup[x] = frequencies.find(f => f.size === x)?.count || 0
            colors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 0.7)' : 'rgba(33, 133, 208, 0.5)')
            borderColors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 1)' : 'rgba(33, 133, 208, 1)')
        }

        // Destroy any existing chart on this canvas
        const existingChart = Chart.getChart(thisObj);
        if (existingChart) {
            existingChart.destroy();
        }


        //set y-limit to the nearest whole power of 10 divided by 2, rounding up
        const yLimit = Math.pow(10, Math.ceil(Math.log10(2 * Math.max(...frequencies.map(f => f.count))))) / 2
        new Chart(thisObj, {
            type: 'bar',
            data: {
                labels: xLabels,
                datasets: [{
                    data: xLabels.map(d => yLookup[d]),
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: true,
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            boxHeight: 10,
                            padding: 5,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                return [{
                                    text: `Ref. Allele: ${refAlleleSize} repeats`,
                                    fillStyle: 'rgba(255, 165, 0, 0.7)',
                                    strokeStyle: 'rgba(255, 165, 0, 1)',
                                    lineWidth: 1,
                                    hidden: false,
                                    index: 0
                                }]
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Count: ${context.raw}`
                            }
                        },
                        position: 'nearest',
                        yAlign: 'bottom'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Repeat Count',
                            font: {
                                size: 13
                            },
                        },
                        ticks: {
                            font: {
                                size: 13
                            },
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        min: 0,
                        max: parseInt(yLimit),
                        title: {
                            display: true,
                            text: '# of alleles',
                            font: {
                                size: 13
                            },
                        },
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (Math.floor(value) === value) {
                                    return parseInt(value)
                                }
                            },
                            font: {
                                size: 13
                            },
                        },
                        afterBuildTicks: (axis) => {
                            const ticks = [0, 3, 10, 30, 100, 300, 1000, 3000, 10000]
                            axis.ticks = ticks.filter(t => t <= axis.max).map(t => ({value: t}))
                        }
                    }
                }
            }
        })

        thisObj.style.minWidth = chartWidth

        thisObj.style.height = chartHeight
        thisObj.style.minHeight = chartHeight
        thisObj.style.maxHeight = chartHeight
    }

    const parseBiallelicHistogramString = function(frequenciesString) {
        // example: frequencies = "2/2:58,2/3:34,3/3:4"
        const data = []
        const lookup = {}
        const items = frequenciesString.split(',')
        for (let i = 0; i < items.length; i++) {
            try {
                const value = items[i].split(':')
                const genotype = value[0].split('/')
                const allele1 = parseInt(genotype[0])
                const allele2 = parseInt(genotype[1])
                const shortAlleleSize = Math.min(allele1, allele2)
                const longAlleleSize = Math.max(allele1, allele2)
                const count = parseInt(value[1])
                data.push({ x: longAlleleSize, y: shortAlleleSize, v: count})
                lookup[`${shortAlleleSize}/${longAlleleSize}`] = count
            } catch (e) {
                console.error('Error parsing biallelic histogram string:', e)
                return [[], {}]
            }
        }

        return [data, lookup]
    }

    const createBiallelicHistogramChart = (chartData) => {
        let data = chartData.data
        let lookup = chartData.lookup
        const thisObj = chartData.thisObj
        const refAlleleSize = chartData.refAlleleSize
        const chartWidth = chartData.chartWidth
        const chartHeight = chartData.chartHeight
        const minAlleleSize = chartData.minAlleleSize - 1
        const maxAlleleSize = chartData.maxAlleleSize + 1

        // Find the range of allele sizes
        const allShortAlleles = data.map(d => d.y)
        const allLongAlleles = data.map(d => d.x)

        // Calculate bin size if range exceeds 30
        const maxBins = 20
        const needsBinning = (maxAlleleSize - minAlleleSize) > maxBins
        const binSize = needsBinning ? Math.ceil((maxAlleleSize - minAlleleSize) / maxBins) : 1

        // Create labels for both axes
        const shortAlleleLabels = []
        const longAlleleLabels = []

        // Create binned or regular labels
        for (let i = Math.max(0, minAlleleSize - binSize); i <= maxAlleleSize + binSize; i += binSize) {
            const binEnd = i + binSize
            const label = needsBinning ? `${i}-${binEnd}` : i
            shortAlleleLabels.push(label)
            longAlleleLabels.push(label)
        }

        if (needsBinning) {
            data = []
            for (const shortAlleleLabel of shortAlleleLabels) {
                for (const longAlleleLabel of longAlleleLabels) {
                    let binCount = 0
                    const shortAlleleStart = parseInt(shortAlleleLabel.split('-')[0])
                    const shortAlleleEnd = parseInt(shortAlleleLabel.split('-')[1])
                    const longAlleleStart = parseInt(longAlleleLabel.split('-')[0])
                    const longAlleleEnd = parseInt(longAlleleLabel.split('-')[1])
                    for (let short = shortAlleleStart; short < shortAlleleEnd; short++) {
                        for (let long = longAlleleStart; long < longAlleleEnd; long++) {
                            const value = lookup[`${short}/${long}`]
                            if (value) {
                                binCount += value
                            }
                        }
                    }
                    data.push({x: longAlleleLabel, y: shortAlleleLabel, v: binCount})
                }
            }

            lookup = {}
            for (const d of data) {
                if (d.v > 0) {
                    lookup[`${d.y}/${d.x}`] = d.v
                }
            }
        }

        // Calculate maxCount from the binned data
        const maxCount = Math.max(...data.map(d => d.v))

        // Destroy any existing chart
        const existingChart = Chart.getChart(thisObj)
        if (existingChart) {
            existingChart.destroy()
        }

        // Create the chart
        new Chart(thisObj, {
            type: 'matrix',
            data: {
                datasets: [{
                    data: data,
                    backgroundColor: function(context) {
                        const value = context.dataset.data[context.dataIndex].v
                        if (value === 0) return 'rgba(255, 255, 255, 0)'
                        const alpha = Math.pow(value / maxCount, 0.5)  // Square root to make small values more visible
                        return `rgba(33, 133, 208, ${alpha})`
                    },
                    borderColor: 'rgba(0, 0, 0, 0.5)',
                    borderWidth: function(context) {
                        const value = context.dataset.data[context.dataIndex].v
                        if (value === 0) return 0
                        return 1
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    x: {
                        type: 'category',
                        offset: false,  // Remove offset to center labels
                        labels: longAlleleLabels,
                        title: {
                            display: true,
                            text: 'Long allele (repeats)',
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: true
                        }
                    },
                    y: {
                        type: 'category',
                        offset: false,  // Remove offset to center labels
                        reverse: true,  // Reverse y-axis
                        labels: shortAlleleLabels,
                        title: {
                            display: true,
                            text: 'Short allele (repeats)',
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: true
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                const c = context[0]
                                const value = c.dataset.data[c.dataIndex].v
                                if (value === 0) return ''
                                const shortLabel = shortAlleleLabels[c.parsed.y]
                                const longLabel = longAlleleLabels[c.parsed.x]
                                // if it's a bin, show the range
                                if (typeof shortLabel === 'string' && typeof longLabel === 'string' && shortLabel.includes('-') && longLabel.includes('-')) {
                                    const shortStart = parseInt(shortLabel.split('-')[0])
                                    const shortEnd = parseInt(shortLabel.split('-')[1])
                                    const longStart = parseInt(longLabel.split('-')[0])
                                    const longEnd = parseInt(longLabel.split('-')[1])
                                    return `Genotype Bin:\n${longStart}  long  allele < ${longEnd}\n${shortStart}  short allele < ${shortEnd}`
                                } else {
                                    return `Genotype: ${shortLabel}/${longLabel}`
                                }
                            },
                            label: function(context) {
                                const c = context
                                const value = c.dataset.data[c.dataIndex].v
                                if (value === 0) return null
                                const shortLabel = shortAlleleLabels[c.parsed.y]
                                const longLabel = longAlleleLabels[c.parsed.x]
                                const genotype = `${shortLabel}/${longLabel}`
                                return `Individuals: ${lookup[genotype] || 0}`
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        })

        thisObj.style.minWidth = chartWidth
        thisObj.style.height = chartWidth
        thisObj.style.minHeight = chartWidth
        thisObj.style.maxHeight = chartWidth
    }

    const getGeneRegionColumnValue = (geneRegion) => {
        if (!geneRegion) return ''
        //const color = GENE_REGION_COLORS[geneRegion]
        const regionRename = {
            'CDS': 'coding',
            'exon': 'exon (non-coding gene)'
        }
        return `${regionRename[geneRegion] || geneRegion}`
    }

    const getPolymorphismSummaryColumnValue = (row) => {
        return `<span class="cell-in-polymorphism-column" ${getHtmlAttributesForPolymorphism(row)}>
            <span class="action-link">
                <b><sub>${STDEV_SIGMA_SUBSCRIPTS['HPRC100_Stdev']}</sub></b>
            </span>
            <span style="color: #333;">
                = ${row.HPRC100_Stdev != null ? row.HPRC100_Stdev.toFixed(1) : '<span style="color: #888888;">not available</span>'} &nbsp; &nbsp;
            </span>
            ${row.AoU1027_Stdev != null ? `<span class="action-link"><sub>${STDEV_SIGMA_SUBSCRIPTS["AoU1027_Stdev"]}</sub></span>` : ''}
            ${row.AoU1027_Stdev != null ? `<span style="color: #333;">
                = ${row.AoU1027_Stdev != null ? row.AoU1027_Stdev.toFixed(1) : '<span style="color: #888888;">not available</span>'} &nbsp; &nbsp;
            </span>` : ''}
            <span class="action-link">
                ${row['TenK10K_Stdev'] != null ? `<sub>${STDEV_SIGMA_SUBSCRIPTS["TenK10K_Stdev"]}</sub>` : ''}  ${row.StdevFromIllumina174k != null ? `<sub>${STDEV_SIGMA_SUBSCRIPTS["StdevFromIllumina174k"]}</sub>` : ''}  ${row.StdevFromT2TAssemblies != null ? `<sub>${STDEV_SIGMA_SUBSCRIPTS["StdevFromT2TAssemblies"]}</sub>` : ''}
            </span>
        </span>
        `
    }

    const getAlleleHistogramColumnValue = (row, columnName) => {
        if (row[columnName] ) {
            return `<canvas class="allele-frequency-inline-chart cell-in-polymorphism-column" ${getHtmlAttributesForPolymorphism(row)} data-frequencies="${row[columnName]}" data-ref-allele-size="${row['NumRepeatsInReference']}" style="width: 100%; height: 100px"></canvas>`
        } else {
            let otherHistograms = ''
            for ( const c of ALL_STDEV_COLUMNS ) {
                if (row[c] != null) {
                    otherHistograms += `<span class="action-link"><sub>${STDEV_SIGMA_SUBSCRIPTS[c]}</sub></span>`
                }
            }

            let result = `<span class="cell-in-polymorphism-column" ${getHtmlAttributesForPolymorphism(row)}><span style="color: #888888; text-align: center; display: block; width: 100%;">`
            if (otherHistograms) {
                result += `not available (but has ${otherHistograms})`
            } else {
                result += `not available`
            }
            result += `</span></span>`
            return result
        }
    }

    let TABLE_COLUMNS = {
        LocusId: {
            displayName: 'LocusId',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['LocusId'],
            getValue: (row, truncateAt=30) => showTruncatedSequence(row['LocusId'], truncateAt=truncateAt, showSize=false),
            getSortColumns: () => ['chrom_index', 'start_0based', 'end_1based', 'LocusId'],
            getRequiredColumns: () => ['chrom_index', 'start_0based', 'end_1based', 'LocusId']
        },
        ReferenceRegion: {
            displayName: 'Interval (hg38)',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRegion'],
            getValue: (row) => row['ReferenceRegion'].replace(/^chr/i, ''),
            getSortColumns: () => ['chrom_index', 'start_0based', 'end_1based'],
            getRequiredColumns: () => ['chrom_index', 'start_0based', 'end_1based', 'ReferenceRegion']
        },
        ReferenceMotif: {
            displayName: 'Motif',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceMotif'],
            getValue: (row, truncateAt=12) => showTruncatedSequence(row['ReferenceMotif'], truncateAt=truncateAt, showSize=true),
            getSortColumns: () => ['MotifSize', 'ReferenceMotif'],
            getRequiredColumns: () => ['MotifSize', 'ReferenceMotif']
        },
        CanonicalMotif: {
            displayName: 'Canonical Motif',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['CanonicalMotif'],
            getValue: (row, truncateAt=12) => showTruncatedSequence(row['CanonicalMotif'], truncateAt=truncateAt, showSize=true),
            getSortColumns: () => ['MotifSize', 'CanonicalMotif'],
            getRequiredColumns: () => ['MotifSize', 'CanonicalMotif']
        },
        ReferenceRepeatSequence: {
            displayName: 'Repeat Sequence',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRepeatSequence'],
            getValue: (row, truncateAt=50) => showTruncatedSequence(row['ReferenceRepeatSequence'], truncateAt=truncateAt, showSize=true),
            getSortColumns: () => ['ReferenceRepeatSequence'],
            getRequiredColumns: () => ['ReferenceRepeatSequence']
        },
        ReferenceLeftFlank: {
            displayName: 'Left Flank',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceLeftFlank'],
            getValue: (row, truncateAt=50) => `<div style='text-align: right'>${showTruncatedSequence(row['ReferenceLeftFlank'], truncateAt=truncateAt, showSize=true, leftTruncate=true)}</div>`,
            getSortColumns: () => ['ReferenceLeftFlank'],
            getRequiredColumns: () => ['ReferenceLeftFlank']
        },
        ReferenceRightFlank: {
            displayName: 'Right Flank',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRightFlank'],
            getValue: (row, truncateAt=50) => showTruncatedSequence(row['ReferenceRightFlank'], truncateAt=truncateAt, showSize=true),
            getSortColumns: () => ['ReferenceRightFlank'],
            getRequiredColumns: () => ['ReferenceRightFlank']
        },
        GencodeGeneRegion: {
            displayName: 'Region',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeGeneRegion'],
            getValue: (row) => getGeneRegionColumnValue(row['GencodeGeneRegion']),
            getSortColumns: () => ['GencodeGeneRegion'],
            getRequiredColumns: () => ['GencodeGeneRegion'],
        },
        GencodeGeneName: {
            displayName: 'Gene',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeGeneName'],
            getValue: (row) => row['GencodeGeneName'],
            getSortColumns: () => ['GencodeGeneName'],
            getRequiredColumns: () => ['GencodeGeneName'],
        },
        polymorphism: {
            displayName: 'Polymorphism Summary',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['polymorphism'],
            getValue: getPolymorphismSummaryColumnValue,
            getSortColumns: () => ['HPRC100_Stdev'],
            getRequiredColumns: () => REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN,
        },
        Source: {
            displayName: 'Source',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['Source'],
            getValue: (row) => {
                const sourceCatalogNameMap = {
                    KnownDiseaseAssociatedLoci: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Known disease-associated loci'>v1 &nbsp;<i>[1]</i></span>",
                    Illumina174kPolymorphicTRs: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Illumina 174k polymorphic TR catalog'>v1 &nbsp;<i>[2]</i></span>",
                    PerfectRepeatsInReference:  "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Perfect repeats in hg38 spanning  9bp and  3 repeats'>v1 &nbsp;<i>[3]</i></span>",
                    PolymorphicTRsInT2TAssemblies: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v1<br /><br /><b>Original source:</b> Polymorphic TRs in 78 T2T assemblies'>v1 &nbsp;<i>[4]</i></span>",
                    VamosCatalog: "<span class='show-popup action-link' data-html='<b>Source catalog:</b> TRExplorer v2 draft<br /><br /><b>Original source:</b> Vamos v2.1 catalog'>v2 draft &nbsp; <i>[5]</i></span>",
                }
                const [version, sourceCatalog] = row['Source'].split(':')
                return sourceCatalogNameMap[sourceCatalog]
            },
            getSortColumns: () => ['Source'],
            getRequiredColumns: () => ['Source'],
        },
        AoU1027_OE_LengthPercentile: {
            displayName: 'Constraint (O/E Length) Percentile',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['AoU1027_OE_LengthPercentile'],
            getValue: (row) => row['AoU1027_OE_LengthPercentile'] != null ? `${(100*row['AoU1027_OE_LengthPercentile']).toFixed(1)}%` : '',
            getSortColumns: () => ['AoU1027_OE_LengthPercentile'],
            getRequiredColumns: () => ['AoU1027_OE_LengthPercentile']
        },
        isPathogenic: {
            displayName: 'Disease-associated?',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['isPathogenic'],
            getValue: (row) => row['DiseaseInfo'] ? generateDiseaseAssociatedIcon(row, 'Yes') : '',
            getSortColumns: () => ['DiseaseInfo'],
            getRequiredColumns: () => ['DiseaseInfo']
        },
        variationCluster: {
            displayName: 'VC',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['variationCluster'],
            getValue: (row) => {
                const hasCluster = row['VariationCluster'] && row['VariationCluster'].trim() !== ''
                if (hasCluster) {
                    const refRegionSize = computeIntervalSize(row['ReferenceRegion'])
                    const clusterDetails = `
                            <div class="content" style="text-align: center;">
                                <div><span style="font-weight: bold">Variation Cluster Interval:</span> <br />${row['VariationCluster']}</div>
                                <br />
                                <div><span style="font-weight: bold">Variation Cluster Interval Size =</span> <br /><span style = "white-space: nowrap">reference repeat interval size (${refRegionSize} bp)</span> + ${row['VariationClusterSizeDiff']} bp</div>
                            </div>
                        `.replace(/\s+/g, ' ').trim()

                    return `<span class="cell-with-icon-and-popup show-popup" data-html='${clusterDetails}'>
                            <i class="check circle icon"></i><span class="action-link">Yes</span>
                        </span>: +${row['VariationClusterSizeDiff']}bp`
                }
                return ''
            },
            getSortColumns: () => ['VariationClusterSizeDiff'],
            getRequiredColumns: () => ['VariationClusterSizeDiff', 'VariationCluster']
        },
        NumRepeatsInReference: {
            displayName: '# of Repeats',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['NumRepeatsInReference'],
            getValue: (row) => (row['NumRepeatsInReference'] ? row['NumRepeatsInReference'] : ''),
            getSortColumns: () => ['NumRepeatsInReference'],
            getRequiredColumns: () => ['NumRepeatsInReference']
        },
        ReferenceRepeatPurity: {
            displayName: 'Purity',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ReferenceRepeatPurity'],
            getValue: (row) => (row['ReferenceRepeatPurity'] ? row['ReferenceRepeatPurity'] : ''),
            getSortColumns: () => ['ReferenceRepeatPurity'],
            getRequiredColumns: () => ['ReferenceRepeatPurity']
        },
        TRsInRegion: {
            displayName: 'Nearby TRs',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['TRsInRegion'],
            getValue: (row) => (row['TRsInRegion'] ? (parseInt(row['TRsInRegion']) - 1) : ''),
            getSortColumns: () => ['TRsInRegion'],
            getRequiredColumns: () => ['TRsInRegion']
        },
        RepeatMaskerIntervals: {
            displayName: 'Repeat Masker',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RepeatMaskerIntervals'],
            getValue: (row) => parseRepeatMaskerIntervals(row['RepeatMaskerIntervals']),
            getSortColumns: () => ['RepeatMaskerIntervals'],
            getRequiredColumns: () => ['RepeatMaskerIntervals'],
        },
        VamosMotifFrequencies: {
            displayName: 'Motif Variability',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['VamosMotifFrequencies'],
            getValue: (row) => parseMotifFrequenciesString(row['VamosMotifFrequencies'], 20),
            getSortColumns: () => ['VamosUniqueMotifs', 'VamosMotifFrequencies'],
            getRequiredColumns: () => ['VamosUniqueMotifs', 'VamosMotifFrequencies'],
        },
        FlanksAndLocusMappability: {
            displayName: 'Mappability',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['FlanksAndLocusMappability'],
            getValue: (row) => row['FlanksAndLocusMappability'],
            getSortColumns: () => ['FlanksAndLocusMappability'],
            getRequiredColumns: () => ['FlanksAndLocusMappability']
        },
        GencodeGeneId: {
            displayName: 'Gencode Gene Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeGeneId'],
            getValue: (row) => row['GencodeGeneId'],
            getSortColumns: () => ['GencodeGeneId'],
            getRequiredColumns: () => ['GencodeGeneId']
        },
        GencodeTranscriptId: {
            displayName: 'Gencode Transcript',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['GencodeTranscriptId'],
            getValue: (row) => row['GencodeTranscriptId'],
            getSortColumns: () => ['GencodeTranscriptId'],
            getRequiredColumns: () => ['GencodeTranscriptId']
        },
        RefSeqGeneRegion: {
            displayName: 'RefSeq Region',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqGeneRegion'],
            getValue: (row) => getGeneRegionColumnValue(row['RefSeqGeneRegion']),
            getSortColumns: () => ['RefSeqGeneRegion'],
            getRequiredColumns: () => ['RefSeqGeneRegion']
        },
        RefSeqGeneId: {
            displayName: 'RefSeq Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqGeneId'],
            getValue: (row) => row['RefSeqGeneId'],
            getSortColumns: () => ['RefSeqGeneId'],
            getRequiredColumns: () => ['RefSeqGeneId']
        },
        RefSeqTranscriptId: {
            displayName: 'RefSeq Transcript Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqTranscriptId'],
            getValue: (row) => row['RefseqTranscriptId'],
            getSortColumns: () => ['RefseqTranscriptId'],
            getRequiredColumns: () => ['RefseqTranscriptId']
        },
        RefSeqGeneName: {
            displayName: 'RefSeq Gene',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['RefSeqGeneName'],
            getValue: (row) => row['RefSeqGeneName'],
            getSortColumns: () => ['RefSeqGeneName'],
            getRequiredColumns: () => ['RefSeqGeneName']
        },
        ManeGeneRegion: {
            displayName: 'MANE Region',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeGeneRegion'],
            getValue: (row) => getGeneRegionColumnValue(row['ManeGeneRegion']),
            getSortColumns: () => ['ManeGeneRegion'],
            getRequiredColumns: () => ['ManeGeneRegion']
        },
        ManeGeneId: {
            displayName: 'MANE Gene Id',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeGeneId'],
            getValue: (row) => row['ManeGeneId'],
            getSortColumns: () => ['ManeGeneId'],
            getRequiredColumns: () => ['ManeGeneId']
        },
        ManeTranscriptId: {
            displayName: 'MANE Transcript',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeTranscriptId'],
            getValue: (row) => row['ManeTranscriptId'],
            getSortColumns: () => ['ManeTranscriptId'],
            getRequiredColumns: () => ['ManeTranscriptId']
        },
        ManeGeneName: {
            displayName: 'MANE Gene',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['ManeGeneName'],
            getValue: (row) => row['ManeGeneName'],
            getSortColumns: () => ['ManeGeneName'],
            getRequiredColumns: () => ['ManeGeneName']
        },
        HPRC100_BiallelicHistogram: {
            displayName: 'HPRC100 Biallelic Histogram',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['HPRC100_BiallelicHistogram'],
            getValue: (row) => row['HPRC100_BiallelicHistogram'],
            getSortColumns: () => ['HPRC100_BiallelicHistogram'],
            getRequiredColumns: () => ['HPRC100_BiallelicHistogram']
        },
        TenK10K_BiallelicHistogram: {
            displayName: 'TenK10K Phase 1 Biallelic Histogram',
            defaultSortDirection: 'DESC',
            helpText: RESULTS_TABLE_COLUMN_HELP_TEXTS['TenK10K_BiallelicHistogram'],
            getValue: (row) => row['TenK10K_BiallelicHistogram'],
            getSortColumns: () => ['TenK10K_BiallelicHistogram'],
            getRequiredColumns: () => ['TenK10K_BiallelicHistogram']
        }
    }
</script>
</head>

<!-- modal dialog for selecting IGV tracks -->
<div class="ui modal" id="igv-track-selection-dialog">
    <i class="close icon"></i>
    <div class="header" style="white-space: nowrap;">
        Select IGV Tracks
    </div>
    <div class="content" style="padding-top:0px;">
        <div class="ui form">
            <table class="ui stackable table igv-track-selection-table">
                <tr>
                    <td style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-tr-explorer-catalog-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    TRExplorer Catalog
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                    # of loci
                                </th>
                            </tr>
                        </table>
                        <table class="igv-checkbox-container-table" id="igv-variation-cluster-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Variation Clusters
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                </th>
                            </tr>
                        </table>
                        <table class="igv-checkbox-container-table" id="igv-known-disease-loci-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Known Disease-associated TR Loci
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                </th>
                            </tr>
                        </table>
                    </td>
                    <td style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-other-tr-catalog-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">
                                    Other Genome-wide TR Catalogs
                                </th>
                                <th class="igv-checkbox-container-header-row igv-number-of-loci-column">
                                    # of loci
                                </th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-reference-tracks-checkboxes">
                            <tr>
                                <th class="igv-checkbox-container-header-row">Reference Tracks</th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 10px 25px !important">
                        <table class="igv-checkbox-container-table" id="igv-custom-tracks" style="width: 100%;">
                            <tr>
                                <th class="igv-checkbox-container-header-row">Custom Tracks <i class="question circle icon link" style="margin-left: 15px;" data-html="These inputs allow you to load your own custom tracks into IGV.js. They accept BED, BAM, VCF, GFF, BigWig, or any other IGV.js-compatible data format. The data file (and index) just have to be online at a publicly-accessible &nbsp;https://, &nbsp;gs://, &nbsp;or s3:// &nbsp; URL."></i></th>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="actions">
        <div class="ui deny button">
            Cancel
        </div>
        <div id="igv-tracks-modal-apply-button" class="ui positive right labeled icon button">
            Apply
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<div class="ui modal" id="whats-new-modal">
    <i class="close icon"></i>
    <div class="header">
        TRExplorer Updates
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%">
        <iframe src="whats_new.html" style="width: 100%; height: 100%; border: 0px; min-height: 380px"></iframe>
    </div>
</div>


<div class="ui modal" id="about-modal">
    <i class="close icon"></i>
    <div class="header">
        About TRExplorer
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%">
        <iframe src="about.html" style="width: 100%; height: 100%; border: 0px; min-height: 380px"></iframe>
    </div>
</div>


<!-- FAQ modal dialog -->
<div class="ui modal" id="faq-modal" style="height: 80%; min-height:75%">
    <i class="close icon"></i>
    <div class="header">
        Frequently Asked Questions
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%">
        <iframe src="FAQ.html" style="width: 100%; height: 100%; border: 0px"></iframe>
    </div>
</div>

<!-- downloads modal dialog -->
<div class="ui modal" id="downloads-modal" style="height: 88%; min-height: 88%">
    <i class="close icon"></i>
    <div class="header">
        Downloads
    </div>
    <div class="content" style="font-size: 1.1em; height: 100%;">
        <iframe src="downloads.html" style="width: 100%; height: 100%; border: 0px;"></iframe>
    </div>
</div>

<body>
<style>
    .locus-info-label {
        font-weight: bold;
        padding-right: 10px;
        white-space: nowrap;
    }

    .locus-info-table {
        font-size: 1.12em;
        border-collapse: separate;
        border-spacing: 12px 6px;
    }
</style>
<div class="ui stackable grid">

    <div class="ui row" id="header-stripe">
    <div class="three wide column" class="page-grid-margin" style="padding: 0px !important"></div>
    <div class="three wide column" id="header-title">
        <a href="index.html">
            <img src="tandem-repeat-explorer-logo-white.png" alt="TRExplorer Logo" style="height: 40px; margin-left: 10px;">
        </a>
    </div>
    <div class="seven wide column" id="header-nav">
        <a href="#" id="about-link">About</a>
        <a href="#" id="whats-new-link" style="white-space: nowrap">What's New</a>
        <a href="#" id="faq-link">FAQ</a>
        <a href="#" id="downloads-link">Downloads</a>
        <a href="https://github.com/broadinstitute/TRExplorer/issues/new?title=Add%20new%20TR%20locus%20to%20the%20TRExplorer%20website%20and%20catalog%3A&body=TR%20locus%20coordinates%20%28hg38%29%3A%0A%0ATR%20locus%20motif%20%28or%20motif%20size%29%3A%20%0A%0AI%20suggest%20adding%20this%20TR%20locus%20because%3A%20" target="_blank">Suggest New TR</a>
        <a href="https://github.com/broadinstitute/TRExplorer/issues" target="_blank">Issues</a>
        <a href="https://github.com/broadinstitute/TRExplorer" target="_blank" id="github-icon"><i class="github icon"></i></a>
    </div>
    <div class="three wide column" class="page-grid-margin" style="padding: 0px !important"></div>
</div>

<div class="ui row" id="igv-row">
    <div class="sixteen wide column">
        <div id="igv-viewport"></div>
    </div>
</div>

    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="show-igv-divider">
                <span id="show-igv-divider-text">Show IGV.js<i class="chevron down icon"></i></span>
                <span id="hide-igv-divider-text" style="display: none">Hide IGV.js<i class="chevron up icon"></i></span>
            </div>
        </div>
        <div class="three wide column"></div>
    </div>
    <div class="ui row">
        <div class="two wide column"></div>
        <div class="six wide column">
            <div id="locus-page-row1-box1" style="min-width: 600px !important; width: 600px !important"></div>
        </div>
        <div class="six wide column">
            <div id="locus-page-row1-box2"></div>
        </div>
        <div class="two wide column"></div>
    </div>
    <div class="ui row">
        <div class="two wide column"></div>
        <div class="six wide column">
            <div id="locus-page-row2-box1"></div>
        </div>
        <div class="six wide column">
            <div id="locus-page-row2-box2"></div>
        </div>
        <div class="two wide column"></div>
    </div>
    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="locus-page-results-area" style="position: relative; z-index: 100;"></div>
        </div>
        <div class="three wide column"></div>
    </div>
</div>

<script>

    $('body').css('cursor', 'wait')

    const REQUIRED_DATA_COLUMNS_FOR_LOCUS_PAGE = [
        "LocusId",
        "ReferenceRegion",

        "NumRepeatsInReference",
        "ReferenceMotif",
        "CanonicalMotif",

        "DiseaseInfo",
        "KnownDiseaseAssociatedMotif",
        "KnownDiseaseAssociatedLocus",

        "ReferenceRepeatPurity",
        "TRsInRegion",
        "Source",
        "LeftFlankMappability",
        "RightFlankMappability",
        "FlanksAndLocusMappability",
        "VariationCluster",
        "VariationClusterSizeDiff",
        "RepeatMaskerIntervals",

        "GencodeGeneRegion",
        "GencodeGeneName",
        "GencodeGeneId",
        "GencodeTranscriptId",
        "RefseqGeneRegion",
        "RefseqGeneName",
        "RefseqGeneId",
        "RefseqTranscriptId",
        "ManeGeneRegion",
        "ManeGeneName",
        "ManeGeneId",
        "ManeTranscriptId",

        "StdevFromIllumina174k",
        "AlleleFrequenciesFromIllumina174k",

        "StdevFromT2TAssemblies",
        "AlleleFrequenciesFromT2TAssemblies",

        "HPRC100_Stdev",
        "HPRC100_AlleleHistogram",
        "HPRC100_BiallelicHistogram",

        "TenK10K_AlleleHistogram",
        "TenK10K_BiallelicHistogram",
        "TenK10K_Stdev",

        "AoU1027_MinAllele",
        "AoU1027_ModeAllele",
        "AoU1027_Stdev",
        "AoU1027_Median",
        "AoU1027_99thPercentile",
        "AoU1027_MaxAllele",
        "AoU1027_UniqueAlleles",
        "AoU1027_NumCalledAlleles",
        "AoU1027_OE_LengthPercentile",

        "VamosUniqueMotifs",
        "VamosEfficientMotifs",
        "VamosMotifFrequencies",
        "VamosNumUniqueMotifsAbove1Percent",

        "ReferenceRepeatSequence",
        "ReferenceLeftFlank",
        "ReferenceRightFlank",
    ]

    // persistent page state (added to the URL)
    let DEFAULT_GLOBAL_PAGE_STATE = {

        locusId: '',

        showIGV: 0,
        igvLoc: 'chr4:3074821-3074990',

        // Custom track URLs
        igv_custom_track_url_1: '',
        igv_custom_track_url_2: '',
        igv_custom_track_url_3: '',
    }

    ALL_AVAILABLE_TRACKS.forEach((rt) => {
        DEFAULT_GLOBAL_PAGE_STATE[rt[0]] = 0
    })

    DEFAULT_GLOBAL_PAGE_STATE['igv_kd_loci'] = 1
    //DEFAULT_GLOBAL_PAGE_STATE['igv_tr_explorer_catalog_v2'] = 1

    //copy the default persistent page state
    let GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))

    const readAndApplyPersistentPageStateFromUrl = async () => {
        GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))
        
        const hash = window.location.hash.substring(1)
        if (!hash) return
        
        const params = new URLSearchParams(hash)
        
        for (const [key, value] of params.entries()) {
            if (key in DEFAULT_GLOBAL_PAGE_STATE && value != null) {
                // Convert string values to appropriate types
                GLOBAL_PAGE_STATE[key] = value === 'true' ? true : 
                                        value === 'false' ? false :
                                        !isNaN(value) ? Number(value) : value
            }
        }
        console.log("Starting to initialize page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)


        // igv
        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        }

        // Restore custom track URLs
        for (let i = 1; i <= 3; i++) {
            $(`#igv-custom-track-url-${i}`).val(GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] || '')
        }

        await performSearch()
    }

    $('#show-igv-divider').click(async () => {
        GLOBAL_PAGE_STATE['showIGV'] = (GLOBAL_PAGE_STATE['showIGV'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        } else {
            $('#igv-row').slideUp(500, () => {
                $('#hide-igv-divider-text').hide()
                $('#show-igv-divider-text').show()
            })
        }

    })

    const displayError = (message) => {
        $('#error-text').text(message)
        $('#error-message').show()
        $('#results-table').empty()
    }

    const displaySearchResults = () => {
        // display the search results in the results-table div
        const row = window.searchResults.rows[0]

        const getHelpIcon = (columnName) => {
            return TABLE_COLUMNS[columnName]?.helpText ? `<i class="question circle outline icon" style="margin-left:10px" data-html="${TABLE_COLUMNS[columnName].helpText}"></i>` : ''
        }
        let locusPageRow1Box1 = '<table class="locus-info-table">'
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Reference Region:</td><td>${TABLE_COLUMNS['ReferenceRegion'].getValue(row)} &nbsp; &nbsp; (<a id="show-igv-button" class="action-link">IGV.js</a>)</td><td>${getHelpIcon('ReferenceRegion')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Repeats in Reference Region:</td><td>${TABLE_COLUMNS['NumRepeatsInReference'].getValue(row)}</td><td>${getHelpIcon('NumRepeatsInReference')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Reference Motif:</td><td>${TABLE_COLUMNS['ReferenceMotif'].getValue(row, truncateAt=35)}</td><td>${getHelpIcon('ReferenceMotif')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Canonical Motif:</td><td>${TABLE_COLUMNS['CanonicalMotif'].getValue(row, truncateAt=35)}</td><td>${getHelpIcon('CanonicalMotif')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Reference Repeat Purity:</td><td>${TABLE_COLUMNS['ReferenceRepeatPurity'].getValue(row)}</td><td>${getHelpIcon('ReferenceRepeatPurity')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Variantion Cluster:</td><td>${TABLE_COLUMNS['variationCluster'].getValue(row) || 'no'}</td><td>${getHelpIcon('variationCluster')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Other TRs Nearby:</td><td>${TABLE_COLUMNS['TRsInRegion'].getValue(row) || 'no'}</td><td>${getHelpIcon('TRsInRegion')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Mappability:</td><td>${TABLE_COLUMNS['FlanksAndLocusMappability'].getValue(row)}</td><td>${getHelpIcon('FlanksAndLocusMappability')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Locus Id:</td><td>${showTruncatedSequence(row['LocusId'], truncateAt=30, showSize=false)}</td><td>${getHelpIcon('LocusId')}</td></tr>`

        locusPageRow1Box1 += '</table>'
        $("#locus-page-row1-box1").html(locusPageRow1Box1)

        let locusPageRow1Box2 = '<table class="locus-info-table">'
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Source:</td><td>${TABLE_COLUMNS['Source'].getValue(row)}</td><td>${getHelpIcon('Source')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Repeat Masker:</td><td>${TABLE_COLUMNS['RepeatMaskerIntervals'].getValue(row)}</td><td>${getHelpIcon('RepeatMaskerIntervals')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Gencode Gene:</td><td>${TABLE_COLUMNS['GencodeGeneName'].getValue(row)}</td><td>${getHelpIcon('GencodeGeneName')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Gencode Region:</td><td>${TABLE_COLUMNS['GencodeGeneRegion'].getValue(row)}</td><td>${getHelpIcon('GencodeGeneRegion')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Gencode Gene Id:</td><td>${TABLE_COLUMNS['GencodeGeneId'].getValue(row)}</td><td>${getHelpIcon('GencodeGeneId')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Gene:</td><td>${TABLE_COLUMNS['ManeGeneName'].getValue(row)}</td><td>${getHelpIcon('ManeGeneName')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Region:</td><td>${TABLE_COLUMNS['ManeGeneRegion'].getValue(row)}</td><td>${getHelpIcon('ManeGeneRegion')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Gene Id:</td><td>${TABLE_COLUMNS['ManeGeneId'].getValue(row)}</td><td>${getHelpIcon('ManeGeneId')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Transcript Id:</td><td>${TABLE_COLUMNS['ManeTranscriptId'].getValue(row)}</td><td>${getHelpIcon('ManeTranscriptId')}</td></tr>`
        locusPageRow1Box2 += '</table>'
        $("#locus-page-row1-box2").html(locusPageRow1Box2)


        /*
                'ReferenceLeftFlank',
        'ReferenceRepeatSequence',
        'ReferenceRightFlank',
VamosMotifFrequencies
         */
        let locusPageRow2Box1 = ''
        $("#locus-page-row2-box1").html(locusPageRow2Box1)


        let locusPageRow2Box2 = ''
        $("#locus-page-row2-box2").html(locusPageRow2Box2)

        $('#locus-page-results-area').html('')

        const stdevColumns = ['HPRC100_Stdev', 'AoU1027_Stdev', 'TenK10K_Stdev', 'StdevFromIllumina174k', 'StdevFromT2TAssemblies']
        const alleleFrequencyColumns = ['HPRC100_AlleleHistogram', 'TenK10K_AlleleHistogram', 'AlleleFrequenciesFromIllumina174k', 'AlleleFrequenciesFromT2TAssemblies']

        const nStdevsNotAvailable = [row.HPRC100_Stdev == null, row.AoU1027_Stdev == null, row.TenK10K_Stdev == null, row.StdevFromIllumina174k == null, row.StdevFromT2TAssemblies == null].filter(Boolean).length

        let locusPageContent = `
            <div class="content" style="text-align: center">
        `

        if (nStdevsNotAvailable == stdevColumns.length) {
            locusPageContent += `
                    <span style="color: #686868;">No polymorphism data available.</span>
                    <br /><br />
            `
        } else {
            locusPageContent += `
                <div><span style="font-weight: bold">Allele Frequency Distribution Summary Statistics</span></div>
                    <div style="margin-top: 5px">
                        <table style="margin: 0 auto">
            `
        }

        for (const key of stdevColumns) {
            if (row[key] != null) {
                locusPageContent += `
                    <tr>
                        <td style="text-align: left;">
                            <span style="font-size: 1.2em;"><sub style="font-size: 0.7em;">${STDEV_SIGMA_SUBSCRIPTS[key]}</sub></span>
                        </td>
                        <td style="text-align: right;">
                            = ${row[key].toFixed(3)}
                        </td>
                        <td style="text-align: right;">
                            <i class="question circle icon link" style="margin-left: 15px;" data-html="${STDEV_HELP_TEXTS[key]}"></i>
                        </td>
                    </tr>
                `
            }
        }
        locusPageContent += "</table>"

        if (nStdevsNotAvailable > 0) {
            locusPageContent += "<br />"
            let namesOfMissingSigmas = []
            for (const key of stdevColumns) {
                if (row[key] == null) {
                    namesOfMissingSigmas.push(`<span style="font-size: 1.2em;"><sub style="font-size: 0.7em;">${STDEV_SIGMA_SUBSCRIPTS[key]}</sub></span>`)
                }
            }
            locusPageContent += ` ${namesOfMissingSigmas.join(' &amp; ')} ${namesOfMissingSigmas.length > 1 ? 'are' : 'is'} not available for this locus`
        }

        if (row.AoU1027_OE_LengthPercentile != null) {
            locusPageContent += `
                <div style="margin-top: 25px">
                    Constraint (O/E Length) percentile = ${((100*row.AoU1027_OE_LengthPercentile).toFixed(1))}% <i class="question circle icon link" style="margin-left: 15px;" data-html="${RESULTS_TABLE_COLUMN_HELP_TEXTS['AoU1027_OE_LengthPercentile']}"></i>
                </div>
            `
        }

        locusPageContent += "</div>"
        // check if any of the allele frequency columns are available
        const alleleFrequencyColumnsAvailable = alleleFrequencyColumns.some(column => row[column] != null)
        if (alleleFrequencyColumnsAvailable) {
            // calculate the height of the allele frequency charts
            locusPageContent += `
                <div style="margin-top: 15px;">
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px">
            `

            for (const column of alleleFrequencyColumns) {
                if (row[column] != null) {
                    locusPageContent += `

                        <div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">
                            <div style="margin-bottom: 5px;"><b>${ALLELE_FREQUENCY_CHART_TITLES[column]}</b><br /><span style="color: #686868;">${ALLELE_FREQUENCY_CHART_SUBTITLES[column]}</span></div>
                            <canvas class="allele-frequency-chart" data-label="${ALLELE_HISTOGRAM_SHORT_NAMES[column]}" data-frequencies-column="${column}" data-ref-allele-size="${row.NumRepeatsInReference}" data-chart-width="500px" data-chart-height="200px" style="width: 100%; height: 100px;"></canvas>
                        </div>
                    `
                }
            }
            locusPageContent += '</div></div>'
        }

        const biallelicHistogramColumns = ['HPRC100_BiallelicHistogram', 'TenK10K_BiallelicHistogram']
        const biallelicHistogramColumnsAvailable = biallelicHistogramColumns.some(column => row[column] != null)
        if (biallelicHistogramColumnsAvailable) {
            locusPageContent += `
                <div style="margin-top: 15px;">
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px">
            `
            for (const column of biallelicHistogramColumns) {
                if (row[column] != null) {
                    locusPageContent += `
                        <div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">
                            <div style="margin-bottom: 5px;"><b>${ALLELE_FREQUENCY_CHART_TITLES[column]}</b><br /><span style="color: #686868;">${ALLELE_FREQUENCY_CHART_SUBTITLES[column]}</span></div>
                            <canvas class="biallelic-histogram-chart" data-label="${ALLELE_HISTOGRAM_SHORT_NAMES[column]}" data-frequencies-column="${column}" data-ref-allele-size="${row.NumRepeatsInReference}" data-chart-width="500px" data-chart-height="200px" style="width: 100%; height: 100px;"></canvas>
                        </div>
                    `
                }
            }
            locusPageContent += '</div></div>'
        }

        $('#locus-page-results-area').html(locusPageContent.replace(/\s+/g, ' ').trim())

        let alleleFrequencyChartData = []
        $('.allele-frequency-chart').each(function() {
            const frequenciesColumn = $(this).data('frequencies-column')
            const frequenciesString = row[frequenciesColumn]
            if (!frequenciesString) return   // Skip if no data

            const frequencies = parseAlleleFrequenciesString(frequenciesString)

            alleleFrequencyChartData.push({
                frequencies: frequencies,
                thisObj: this,
                refAlleleSize: $(this).data('ref-allele-size'),
                chartWidth: $(this).data('chart-width'),
                chartHeight: $(this).data('chart-height'),
                label: $(this).data('label'),
                minAlleleSize: Math.min(...frequencies.map(f => f.size)),
                maxAlleleSize: Math.max(...frequencies.map(f => f.size))
            })
        })

        //compute overall min, max for all charts and then create the charts
        let overallMinAlleleSize = Math.min(...alleleFrequencyChartData.map(d => d.minAlleleSize))
        let overallMaxAlleleSize = Math.max(...alleleFrequencyChartData.map(d => d.maxAlleleSize))

        alleleFrequencyChartData.forEach((chartData) => {
            chartData.minAlleleSize = overallMinAlleleSize
            chartData.maxAlleleSize = overallMaxAlleleSize

            createAlleleFrequencyChart(chartData)
        })

        let biallelicHistogramChartData = []
        $('.biallelic-histogram-chart').each(function() {
            const frequenciesColumn = $(this).data('frequencies-column')
            let frequenciesString = row[frequenciesColumn]
            if (!frequenciesString) return   // Skip if no data

            let [data, lookup] = parseBiallelicHistogramString(frequenciesString)

            biallelicHistogramChartData.push({
                data: data,
                lookup: lookup,
                thisObj: this,
                refAlleleSize: $(this).data('ref-allele-size'),
                chartWidth: $(this).data('chart-width'),
                chartHeight: $(this).data('chart-height'),
                label: $(this).data('label'),
                minAlleleSize: Math.min(...data.map(f => Math.min(f.x, f.y))),
                maxAlleleSize: Math.max(...data.map(f => Math.max(f.x, f.y)))
            })
        })

        overallMinAlleleSize = Math.min(...biallelicHistogramChartData.map(d => d.minAlleleSize))
        overallMaxAlleleSize = Math.max(...biallelicHistogramChartData.map(d => d.maxAlleleSize))

        biallelicHistogramChartData.forEach((chartData) => {
            chartData.minAlleleSize = overallMinAlleleSize
            chartData.maxAlleleSize = overallMaxAlleleSize

            createBiallelicHistogramChart(chartData)
        })

        $('.question').popup({ on: 'click' })
        $('.show-popup').popup({ on: 'click', hoverable: true })
        $('#show-igv-button').click(async () => {
            const row = window.searchResults.rows[0]
            GLOBAL_PAGE_STATE['igvLoc'] = row['ReferenceRegion']

            if (GLOBAL_PAGE_STATE['showIGV'] === 0) {
                $('#show-igv-divider').click()
            } else {
                writePersistentPageStateToUrl()

                if (!window.igvBrowser) {
                    console.error("WARNING: IGV browser not initialized yet")
                    await updateIgv()
                }
                await window.igvBrowser.search(row['ReferenceRegion'])
            }
        })


    }

    const performSearch = async () => {
        // Remove any error messages and no results message
        $('#error-message').hide()
        $('#loading-container').show()      // Show loading indicator
        
        try {
            $('body').css('cursor', 'wait')

            let locusId = GLOBAL_PAGE_STATE['locusId']
            if (!locusId) {
                displayError('Missing locusId URL parameter (eg. ?locusId=4-3074876-3074933-CAG)')
                return
            }

            let selectedColumns = REQUIRED_DATA_COLUMNS_FOR_LOCUS_PAGE
            const whereClause = `WHERE LocusId = '${locusId}'`
            const query = `SELECT ${selectedColumns.join(', ')} FROM ${COMPLETE_TABLE_ID} ${whereClause}`

            window.searchResults = await queryBigQuery(query, 0, 1, null, null)

            console.log("search results:", window.searchResults)
            // Remove loading indicator and placeholder before showing results
            $('#loading-container').hide()

            displaySearchResults()

        } catch (error) {
            console.error('Error performing search:', error)
            $('#loading-container').hide()
            displayError('Error performing search: ' + error.message)
        } finally {
            $('body').css('cursor', 'default')
            $('#results-table').show()
            $('#results-table').removeClass('loading')
        }
    }

    // initialize the "What's new", "FAQ", "Downloads", and "About" modals
    ['whats-new', 'faq', 'downloads', 'about'].forEach(prefix => {
        $(`#${prefix}-link`).click((e) => {
            e.preventDefault()
            $(`#${prefix}-modal`).modal('show')
        })
    })

    // handle browser forward & back buttons
    window.addEventListener('popstate', readAndApplyPersistentPageStateFromUrl)

    // init ui elements
    $('.ui.button').popup()
    $(".ui.checkbox").checkbox()


    $(document).ready(async () => {

        await readAndApplyPersistentPageStateFromUrl()

        console.log("Done initializing page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)
        $('body').css('cursor', 'default')
    })

</script>

</body>
</html>