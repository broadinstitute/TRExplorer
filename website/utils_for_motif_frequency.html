<script>
    /** --------- START of utils for motif frequency  ---------- */

    const computeMotifFrequenciesTableHtml = (motifFrequencyTableRows, showTitle = false) => {
        const helpText = `
        Motifs detected at this locus by the Vamos v2.1 pipeline when applied to 94 HPRC T2T assemblies.
        Percentages represent what fraction of the 94 haplotype sequences is covered by each motif.
        `

        let result = ''
        result += `<div class='info-font-size' style='display: flex; flex-direction: column; align-items: center'>`
        if (showTitle) {
            result += `<span style='font-weight: bold; margin-bottom: 20px'>Motif Variability <i class='question circle icon link' style='margin-left: 15px;' data-html='${helpText}'></i></span>`
        }
        result += `<table style='border-spacing: 20px 3px'>`
        result += `<tr><td><b>Frequency</b></td><td><b>Motif</b></td><td><span style='white-space: nowrap'><b>Efficient Motif</b></span></td></tr>`
        result += `${motifFrequencyTableRows.join('')}`
        result += `</table>`
        result += '</div>'
        if (!showTitle) {
            result += `<br /><div style='text-align: justify; color: #555555' ><b>Details:</b> ${helpText}</div>`
        }
        return result
    }

    const computeMotifFrequenciesTableRows = (frequenciesString) => {
        if (!frequenciesString) {
            return []
        }
        const items = frequenciesString.split(',')
        let total = 0
        let motifCounts = {}
        let efficientMotifs = {}
        for (let i = 0; i < items.length; i++) {
            let motif = '', efficientMotif = '', count = '0'
            const numTokens = items[i].split(':').length
            if (numTokens == 3) {
                [motif, efficientMotif, count] = items[i].split(':')
            } else if(numTokens == 2) {
                [motif, count] = items[i].split(':')
            }

            count = parseInt(count)
            if (Number.isNaN(count)) {
                console.warn(`Unable to parse the count for motif ${motif} in ${frequenciesString}. Skipping...`)
                continue
            }
            motif = motif.trim()
            motifCounts[motif] = count
            efficientMotifs[motif] = efficientMotif.trim()
            total += count
        }

        const minimumFrequencyThreshold = 0  // 0.01

        // convert counts to fractions
        let motifCount = 0
        let homopolymerMotifCount = 0
        for (let motif in motifCounts) {
            motifCounts[motif] /= total
            if (motifCounts[motif] >= minimumFrequencyThreshold) {
                motifCount += 1
                if (motif.length == 1) {
                    homopolymerMotifCount += 1
                }
            }
        }

        if (motifCount <= 1 || homopolymerMotifCount == motifCount) {
            return []
        }

        const truncateMotifAt = 35
        let resultMotifs = []
        for (let motif in motifCounts) {
            let motifRow
            let motifPercentString
            if (motifCounts[motif] >= 0.01) {
                motifRow = '<tr>'
                motifPercentString = (motifCounts[motif] * 100.0).toFixed(0)
            } else {
                motifRow = `<tr style='color:#AAAAAA'>`
                motifPercentString = (motifCounts[motif] * 100.0).toFixed(1)
            }
            motifRow += `<td style='text-align:right'><i>${motifPercentString}%</i></td>`
            motifRow += `<td><span style='white-space: nowrap; font-family: monospace'>${motif.length > truncateMotifAt ? (motif.substring(0, truncateMotifAt) + '... (' + motif.length + 'bp)') : motif}</span></td>`
            if (efficientMotifs[motif]) {
                motifRow += `<td><span style='white-space: nowrap; font-family: monospace'>`
                if (efficientMotifs[motif] != motif) {
                    motifRow += `${efficientMotifs[motif].length <= truncateMotifAt ? efficientMotifs[motif] : (efficientMotifs[motif].substring(0, truncateMotifAt) + '... (' + efficientMotifs[motif].length + 'bp)')}`
                } else {
                    motifRow += '<i>same as motif</i>'
                }
                motifRow += `</span></td>`
            } else {
                motifRow += `<td><i>unavailable</i></td>`
            }
            motifRow += '</tr>'

            resultMotifs.push(motifRow)
        }

        return resultMotifs
    }

    const parseMotifFrequenciesString = (frequenciesString, maxRowsToShow=null) => {
        if (!frequenciesString) {
            return ''
        }

        try {
            let resultMotifs = computeMotifFrequenciesTableRows(frequenciesString)
            const totalMotifs = resultMotifs.length
            if (maxRowsToShow && resultMotifs.length > maxRowsToShow) {
                resultMotifs = resultMotifs.slice(0, maxRowsToShow)
                resultMotifs.push(`<tr><td colspan='3' style='text-align:center; color:#AAAAAA'><i>... ${totalMotifs - maxRowsToShow} more motifs. See locus page ...</i></td></tr>`)
            }

            if (totalMotifs > 0) {
                const dataHtml = computeMotifFrequenciesTableHtml(resultMotifs)
                return `<span class="show-popup action-link" data-html="${dataHtml}">${totalMotifs} motifs</span>`
            } else {
                return ''
            }
        } catch (e) {
            console.error('Error parsing motif frequencies string:', e)
            return ''
        }
    }

    /** --------- END of utils for motif frequency  ---------- */
</script>