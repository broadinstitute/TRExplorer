<!DOCTYPE html>
<html>
    {% include "header_template.html" %}
<body>
<style>
    .locus-info-label {
        font-weight: bold;
        padding-right: 10px;
        white-space: nowrap;
    }

    .locus-info-table {
        font-size: 1.12em;
        border-collapse: separate;
        border-spacing: 12px 6px;
    }

    .left-col {
        display: flex;
        padding-right: 20px;
        justify-content: flex-end;    /* horizontal centering */
    }
    .right-col {
        display: flex;
        padding-left: 20px;
        justify-content: flex-start;    /* horizontal centering */
    }
</style>
<div class="ui stackable grid">

    {% include "body_header_template.html" %}

    <div class="ui row" style="padding-bottom: 0;">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="show-igv-divider">
                <span id="show-igv-divider-text">Show IGV.js<i class="chevron down icon"></i></span>
                <span id="hide-igv-divider-text" style="display: none">Hide IGV.js<i class="chevron up icon"></i></span>
            </div>
        </div>
        <div class="three wide column"></div>
    </div>
    <div class="ui row">
        <div class="two wide column"></div>
        <div class="six wide column" style="min-width: 600px !important;">
            <div id="locus-page-row1-box1" class="left-col"></div>
        </div>
        <div class="six wide column">
            <div id="locus-page-row1-box2" class="right-col"></div>
        </div>
        <div class="two wide column"></div>
    </div>
    <div class="ui row">
        <div class="two wide column"></div>
        <div class="six wide column" style="min-width: 600px !important;">
            <div id="locus-page-row2-box1" class="left-col"></div>
        </div>
        <div class="six wide column">
            <div id="locus-page-row2-box2" class="right-col"></div>
        </div>
        <div class="two wide column"></div>
    </div>
    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="locus-page-summary-stats"></div>
        </div>
        <div class="three wide column"></div>
    </div>
    <div class="ui row">
        <div class="four wide column"></div>
        <div class="eight wide column" style="display: flex; justify-content: center">
            <div id="locus-page-efficient-motifs"></div>
        </div>
        <div class="four wide column"></div>
    </div>
    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="locus-page-polymorphism-data" style="position: relative; z-index: 100;"></div>
        </div>
        <div class="three wide column"></div>
    </div>
    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="locus-page-literature-review"></div>
        </div>
        <div class="three wide column"></div>
    </div>
</div>
<div style="min-height: 50px;"></div>

<script>
    // Add back link and page title above IGV (outside igv-row so it's always visible)
    $('#igv-row').before(`
        <div class="ui row" style="padding-bottom: 0;">
            <div class="two wide column"></div>
            <div class="twelve wide column" style="padding: 10px 20px 5px 20px; display: flex; align-items: center;">
                <a id="back-to-search-link" href="index.html" style="font-size: 1.1em; white-space: nowrap;">&lt; Back to search page</a>
                <div id="locus-page-title" style="flex: 1; text-align: center; font-size: 1.3em; font-weight: 600;"></div>
                <div style="width: 140px;"></div>
            </div>
            <div class="two wide column"></div>
        </div>
    `)

    $('body').css('cursor', 'wait')

    const REQUIRED_DATA_COLUMNS_FOR_LOCUS_PAGE = [
        "LocusId",
        "ReferenceRegion",

        "NumRepeatsInReference",
        "ReferenceMotif",
        "CanonicalMotif",

        "DiseaseInfo",
        "KnownDiseaseAssociatedMotif",
        "KnownDiseaseAssociatedLocus",

        "ReferenceRepeatPurity",
        "TRsInRegion",
        "Source",
        "LeftFlankMappability",
        "RightFlankMappability",
        "FlanksAndLocusMappability",
        "VariationCluster",
        "VariationClusterSizeDiff",

        "GencodeGeneRegion",
        "GencodeGeneName",
        "GencodeGeneId",
        "GencodeTranscriptId",
        "RefseqGeneRegion",
        "RefseqGeneName",
        "RefseqGeneId",
        "RefseqTranscriptId",
        "ManeGeneRegion",
        "ManeGeneName",
        "ManeGeneId",
        "ManeTranscriptId",

        "StdevFromIllumina174k",
        "AlleleFrequenciesFromIllumina174k",

        "StdevFromT2TAssemblies",
        "AlleleFrequenciesFromT2TAssemblies",

        "HPRC256_AlleleHistogram",
        "HPRC256_BiallelicHistogram",
        "HPRC256_MinAllele",
        "HPRC256_ModeAllele",
        "HPRC256_Stdev",
        "HPRC256_Median",
        "HPRC256_99thPercentile",
        "HPRC256_MaxAllele",
        "HPRC256_UniqueAlleleLengths",
        "HPRC256_NumCalledAlleles",
        "HPRC256_StdevRankByMotif",
        "HPRC256_StdevRankTotalNumberByMotif",

        "TenK10K_AlleleHistogram",
        "TenK10K_BiallelicHistogram",
        "TenK10K_MinAllele",
        "TenK10K_ModeAllele",
        "TenK10K_Stdev",
        "TenK10K_Median",
        "TenK10K_99thPercentile",
        "TenK10K_MaxAllele",
        "TenK10K_UniqueAlleleLengths",
        "TenK10K_NumCalledAlleles",
        "TenK10K_StdevRankByMotif",
        "TenK10K_StdevRankTotalNumberByMotif",

        "AoU1027_MinAllele",
        "AoU1027_ModeAllele",
        "AoU1027_Stdev",
        "AoU1027_Median",
        "AoU1027_99thPercentile",
        "AoU1027_MaxAllele",
        "AoU1027_NumCalledAlleles",
        "AoU1027_StdevRankByMotif",
        "AoU1027_StdevRankTotalNumberByMotif",
        "AoU1027_OE_LengthPercentile",

        "RepeatMaskerIntervals",
        'NonCodingAnnotations',

        "VamosUniqueMotifs",
        "VamosEfficientMotifs",
        "VamosMotifFrequencies",
        "VamosNumUniqueMotifs",

        "ReferenceRepeatSequence",
        "ReferenceLeftFlank",
        "ReferenceRightFlank",

        "Tanudisastro2024_SignificantCellTypes",
        "Tanudisastro2024_MinPvalue",
        "Tanudisastro2024_Details",

        "Manigbas2024_AssociatedTraits",
        "Manigbas2024_MinPvalue",
        "Manigbas2024_Details",
    ]

    //locus page-specific settings of the DEFAULT_GLOBAL_PAGE_STATE
    DEFAULT_GLOBAL_PAGE_STATE['locusId'] = ''
    DEFAULT_GLOBAL_PAGE_STATE['refRegion'] = ''

    let GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))

    const readAndApplyPersistentPageStateFromUrl = async () => {
        GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))

        const urlArgs = window.location.hash.substring(1)
        if (!urlArgs) return

        const params = new URLSearchParams(urlArgs)
        for (const [urlKey, value] of params.entries()) {
            // Convert abbreviated URL param name to internal state name if needed
            const key = URL_PARAM_REVERSE_ALIASES[urlKey] || urlKey
            if (key in DEFAULT_GLOBAL_PAGE_STATE && value != null) {
                // Convert string values to appropriate types
                GLOBAL_PAGE_STATE[key] = value === 'true' ? true :
                                        value === 'false' ? false :
                                        !isNaN(value) ? Number(value) : value
            }
        }
        console.log("Starting to initialize page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)


        // igv
        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        }

        // Restore custom track URLs
        for (let i = 1; i <= 3; i++) {
            $(`#igv-custom-track-url-${i}`).val(GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] || '')
        }

        await performSearch()
    }

    $('#show-igv-divider').click(async () => {
        GLOBAL_PAGE_STATE['showIGV'] = (GLOBAL_PAGE_STATE['showIGV'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        } else {
            $('#igv-row').slideUp(500, () => {
                $('#hide-igv-divider-text').hide()
                $('#show-igv-divider-text').show()
            })
        }
    })

    const displayError = (message) => {
        $('#error-text').text(message)
        $('#error-message').show()
        $('#results-table').empty()
    }

    function generatePheWASSection(row) {
        // Check if locus was tested in PheWAS (has Details)
        if (row['Manigbas2024_Details'] === null || row['Manigbas2024_Details'] === undefined) {
            return ''  // Not tested
        }

        let details
        try {
            details = JSON.parse(row['Manigbas2024_Details'] || '{}')
        } catch (e) {
            console.error('Failed to parse Manigbas2024_Details:', e)
            return '<div class="ui error message">Error loading PheWAS details</div>'
        }

        // Details is directly keyed by trait names
        const traitNames = Object.keys(details)

        let html = '<h4>PheWAS (Manigbas et al. 2024)</h4>'

        if (traitNames.length === 0) {
            html += `<p><i>This locus was tested in the UK Biobank PheWAS (n=168,554 individuals, 30,291 traits) but showed no significant fine-mapped trait associations.</i></p>`
        } else {
            html += `<p>Fine-mapped causal associations with <b>${traitNames.length}</b> human trait(s):</p>`

            // Full table
            html += `<table class="ui compact striped table">
                <thead><tr>
                    <th>Trait</th><th>Type</th><th>P-value</th><th>-log10(p)</th><th>CAVIAR Prob</th><th>Sample Size</th><th>Replicated (AoU)</th>
                </tr></thead><tbody>`

            // Sort traits by p-value (most significant first)
            const sortedTraitNames = [...traitNames].sort((a, b) => {
                const pvalA = details[a]?.pvalue ?? Infinity
                const pvalB = details[b]?.pvalue ?? Infinity
                return pvalA - pvalB
            })

            for (const traitName of sortedTraitNames) {
                const d = details[traitName]
                if (!d) continue
                const replicatedText = d.replicatedInAoU
                    ? '<span style="color: green;">Yes</span>'
                    : '<span style="color: gray;">No</span>'
                const caviarColor = d.caviarProbability >= 0.9 ? 'green' : (d.caviarProbability >= 0.5 ? 'orange' : '')
                html += `<tr>
                    <td>${traitName}</td>
                    <td>${d.traitType || ''}</td>
                    <td>${d.pvalue != null ? d.pvalue.toExponential(2) : ''}</td>
                    <td>${d.log10Pvalue != null ? d.log10Pvalue.toFixed(1) : ''}</td>
                    <td style="color: ${caviarColor}; font-weight: ${caviarColor ? 'bold' : 'normal'};">
                        ${d.caviarProbability != null ? (d.caviarProbability * 100).toFixed(1) + '%' : ''}
                    </td>
                    <td>${d.sampleSize != null ? d.sampleSize.toLocaleString() : ''}</td>
                    <td>${replicatedText}</td>
                </tr>`
            }
            html += '</tbody></table>'
        }

        html += `<p style="font-size: 0.9em; color: #666;">
            Source: <a href="https://www.nature.com/articles/s41467-024-54678-0" target="_blank">Manigbas et al. 2024</a>
            (UK Biobank PheWAS, n=168,554 individuals, 30,291 traits)
        </p>`

        return html
    }

    function generateTanudisastroSection(row) {
        if (!row['Tanudisastro2024_SignificantCellTypes']) return ''

        const cellTypes = row['Tanudisastro2024_SignificantCellTypes'].split(',')
        let details
        try {
            details = JSON.parse(row['Tanudisastro2024_Details'] || '{}')
        } catch (e) {
            console.error('Failed to parse Tanudisastro2024_Details:', e)
            return '<div class="ui error message">Error loading sc-eTR details</div>'
        }
        const tanudisastroLocusId = details.Tanudisastro2024_LocusId
        const isFuzzyMatch = tanudisastroLocusId !== row['LocusId']

        let html = '<h4>sc-eTRs (Tanudisastro et al. 2024)</h4>'

        if (isFuzzyMatch) {
            html += `<div class="ui warning message" style="padding: 10px;">
                <i class="info circle icon"></i>
                Matched to Tanudisastro et al. locus <code>${tanudisastroLocusId}</code>
                via coordinate overlap (Jaccard >= 0.2).
            </div>`
        }

        html += `<p>Significant expression associations in <b>${cellTypes.length}</b> immune cell type(s):</p>`

        html += `<table class="ui compact striped table">
            <thead><tr>
                <th>Cell Type</th><th>eGene</th><th>P-value</th><th>Effect Size</th><th>Rank / Total</th>
            </tr></thead><tbody>`

        // Sort cell types by p-value (most significant first)
        const sortedCellTypes = [...cellTypes].sort((a, b) => {
            const pvalA = details[a]?.pvalue ?? Infinity
            const pvalB = details[b]?.pvalue ?? Infinity
            return pvalA - pvalB
        })

        for (const cellType of sortedCellTypes) {
            const d = details[cellType]
            if (!d) continue
            html += `<tr>
                <td>${cellType}</td>
                <td>${d.eGene || ''}</td>
                <td>${d.pvalue != null ? d.pvalue.toExponential(2) : ''}</td>
                <td>${d.effectSize != null ? d.effectSize.toFixed(3) : ''}</td>
                <td>${d.rank || ''} / ${d.totalInCellType || ''}</td>
            </tr>`
        }
        html += '</tbody></table>'

        html += '<p style="font-size: 0.9em; color: #666;">Source: <a href="https://www.biorxiv.org/content/10.1101/2024.11.02.621562" target="_blank">Tanudisastro et al. 2024</a></p>'

        return html
    }

    function generateLiteratureReviewSection(row) {
        // Generate both sections
        const tanudisastroHtml = generateTanudisastroSection(row)
        const pheWASHtml = generatePheWASSection(row)

        // If neither section has content, return empty
        if (!tanudisastroHtml && !pheWASHtml) {
            return ''
        }

        // Combine sections with spacing
        let combinedHtml = ''
        if (tanudisastroHtml) {
            combinedHtml += tanudisastroHtml
        }
        if (pheWASHtml) {
            if (combinedHtml) {
                combinedHtml += '<div style="margin-top: 30px;"></div>'  // Spacing between sections
            }
            combinedHtml += pheWASHtml
        }

        return combinedHtml
    }

    const displaySearchResults = () => {

        const row = window.searchResults.rows[0]

        const getHelpIcon = (columnName) => {
            return TABLE_COLUMNS[columnName]?.helpText ? `<i class="question circle outline icon" style="margin-left:10px" data-html="${TABLE_COLUMNS[columnName].helpText}"></i>` : ''
        }

        // Generate the tables at the top of the page
        let locusPageRow1Box1 = '<table class="locus-info-table">'
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Reference Region:</td><td>${TABLE_COLUMNS['ReferenceRegion'].getValue(row)} &nbsp; &nbsp; (<a id="show-igv-button" class="action-link">IGV</a>)</td><td>${getHelpIcon('ReferenceRegion')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Reference Motif:</td><td>${TABLE_COLUMNS['ReferenceMotif'].getValue(row, 35)}</td><td>${getHelpIcon('ReferenceMotif')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Canonical Motif:</td><td>${TABLE_COLUMNS['CanonicalMotif'].getValue(row, 35)}</td><td>${getHelpIcon('CanonicalMotif')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Repeats in Reference:</td><td>${TABLE_COLUMNS['NumRepeatsInReference'].getValue(row)}</td><td>${getHelpIcon('NumRepeatsInReference')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Repeat Purity:</td><td>${TABLE_COLUMNS['ReferenceRepeatPurity'].getValue(row)}</td><td>${getHelpIcon('ReferenceRepeatPurity')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Other TRs Nearby:</td><td>${TABLE_COLUMNS['TRsInRegion'].getValue(row) || 'no'}</td><td>${getHelpIcon('TRsInRegion')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Mappability:</td><td>${TABLE_COLUMNS['FlanksAndLocusMappability'].getValue(row)}</td><td>${getHelpIcon('FlanksAndLocusMappability')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Variation Cluster:</td><td>${TABLE_COLUMNS['variationCluster'].getValue(row) || 'no'}</td><td>${getHelpIcon('variationCluster')}</td></tr>`
        locusPageRow1Box1 += `<tr><td class="locus-info-label">Locus Id:</td><td style="font-size:0.9em !important">${showTruncatedSequence(row['LocusId'], 30, false)}</td><td>${getHelpIcon('LocusId')}</td></tr>`
        locusPageRow1Box1 += `<tr><td colspan="3" style="padding-top: 30px"></td></tr>`
        locusPageRow1Box1 += `<tr><td colspan="3" style="position: relative"><div style="position: absolute; top: 0px; left: 0px; z-index: 1000">`
        locusPageRow1Box1 += `<div class="locus-info-label" style="padding-bottom: 10px">Repeat sequence in hg38:</div>`
        locusPageRow1Box1 += `${showTruncatedSequence(row['ReferenceRepeatSequence'], 100, true, false, true)}`
        locusPageRow1Box1 += `</div></td></tr>`
        locusPageRow1Box1 += '</table>'

        $("#locus-page-row1-box1").html(locusPageRow1Box1)

        let locusPageRow1Box2 = '<table class="locus-info-table">'
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Gencode Gene:</td><td>${TABLE_COLUMNS['GencodeGeneName'].getValue(row) || ''}</td><td>${getHelpIcon('GencodeGeneName')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Gencode Region:</td><td>${TABLE_COLUMNS['GencodeGeneRegion'].getValue(row)  || ''}</td><td>${getHelpIcon('GencodeGeneRegion')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Gencode Gene Id:</td><td>${TABLE_COLUMNS['GencodeGeneId'].getValue(row) || ''}</td><td>${getHelpIcon('GencodeGeneId')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Gene:</td><td>${TABLE_COLUMNS['ManeGeneName'].getValue(row) || ''}</td><td>${getHelpIcon('ManeGeneName')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Region:</td><td>${TABLE_COLUMNS['ManeGeneRegion'].getValue(row) || ''}</td><td>${getHelpIcon('ManeGeneRegion')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Gene Id:</td><td>${TABLE_COLUMNS['ManeGeneId'].getValue(row) || ''}</td><td>${getHelpIcon('ManeGeneId')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">MANE Transcript Id:</td><td>${TABLE_COLUMNS['ManeTranscriptId'].getValue(row) || ''}</td><td>${getHelpIcon('ManeTranscriptId')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Repeat Masker:</td><td>${TABLE_COLUMNS['RepeatMaskerIntervals'].getValue(row) || ''}</td><td>${getHelpIcon('RepeatMaskerIntervals')}</td></tr>`
        locusPageRow1Box2 += `<tr><td class="locus-info-label">Source:</td><td>${TABLE_COLUMNS['Source'].getValue(row)}</td><td>${getHelpIcon('Source')}</td></tr>`
        locusPageRow1Box2 += '</table> <br />'

        $("#locus-page-row1-box2").html(locusPageRow1Box2)

        // get url params
        const urlArgs = window.location.hash.substring(1)
        const homePageUrl = `index.html?#${urlArgs}`

        // Update the back link with the current URL parameters
        $('#back-to-search-link').attr('href', homePageUrl)

        let locusPageRow2Box1 = `<div style="padding: 40px 12px 0px 12px">`
        locusPageRow2Box1 += `<div class="locus-info-label info-font-size" style="padding-bottom: 10px">Left flank:</div>${showTruncatedSequence(row['ReferenceLeftFlank'], 58, true, true, true)}`
        locusPageRow2Box1 += `</div>`
        $("#locus-page-row2-box1").html(locusPageRow2Box1)

        let locusPageRow2Box2 = `<div style="padding: 40px 12px 0px 12px">`
        locusPageRow2Box2 += `<div class="locus-info-label info-font-size" style="padding-bottom: 10px">Right flank:</div>${showTruncatedSequence(row['ReferenceRightFlank'], 58, true, false, true)}`
        locusPageRow2Box2 += `</div>`
        $("#locus-page-row2-box2").html(locusPageRow2Box2)


        // Generate summary stats table (above motif variability)
        const summaryStatsHtml = generateSummaryStatsTable(row)
        $('#locus-page-summary-stats').html(summaryStatsHtml)

        // Generate motif variability section
        const motifFrequencyTableRows = computeMotifFrequenciesTableRows(row['VamosMotifFrequencies'])
        let motifFrequencyTableHtml
        if (motifFrequencyTableRows.length > 1) {
            motifFrequencyTableHtml = computeMotifFrequenciesTableHtml(motifFrequencyTableRows, true)
            motifFrequencyTableHtml = `<div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">${motifFrequencyTableHtml}</div>`
        } else {
            motifFrequencyTableHtml = ''
        }
        $('#locus-page-efficient-motifs').html(motifFrequencyTableHtml)

        // Generate allele frequency charts section (hide sigma summary since we show the table above)
        const polymorphismContent = generatePolymorphismDialogContent(row, { showSigmaSummary: false })
        if (polymorphismContent) {
            $('#locus-page-polymorphism-data').html(`<div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">${polymorphismContent}</div>`.replace(/\s+/g, ' ').trim())
        } else {
            $('#locus-page-polymorphism-data').html('')
        }

        renderChartsInPolymorphismDialog(row);

        // Generate Literature Review section
        const literatureReviewHtml = generateLiteratureReviewSection(row)
        if (literatureReviewHtml) {
            $('#locus-page-literature-review').html(
                `<div style="border-top: 1px dashed #ccc; padding: 23px 20px 15px 15px;">
                    <h3>Literature Review</h3>
                    ${literatureReviewHtml}
                </div>`
            )
        } else {
            $('#locus-page-literature-review').html('')
        }

        $('.question').popup({ on: 'click' })
        $('.show-popup').popup({ on: 'click', hoverable: true })

        // Consolidated click handler for showing IGV and navigating to the locus
        const showIgvAndNavigate = async () => {
            const row = window.searchResults.rows[0]
            GLOBAL_PAGE_STATE['igvLoc'] = row['ReferenceRegion']

            // Show IGV if hidden
            if (GLOBAL_PAGE_STATE['showIGV'] === 0) {
                await $('#show-igv-divider').click()
            } else {
                writePersistentPageStateToUrl()
                if (!window.igvBrowser) {
                    await updateIgv()
                }
                await window.igvBrowser.search(row['ReferenceRegion'])
            }

            // Scroll the page to the IGV browser
            $('#igv-row')[0].scrollIntoView({ behavior: 'smooth' })
        }

        // Attach handler to both the (IGV) link and the Reference Region link
        $('#show-igv-button').click(showIgvAndNavigate)
        $('.row-igv-button').click(showIgvAndNavigate)
    }

    const performSearch = async () => {
        // Remove any error messages and no results message
        $('#error-message').hide()
        $('#loading-container').show()      // Show loading indicator

        try {
            $('body').css('cursor', 'wait')

            let locusId = GLOBAL_PAGE_STATE['locusId']
            if (!locusId) {
                displayError('Missing locusId URL parameter (eg. ?locusId=4-3074876-3074933-CAG)')
                return
            }

            const locusIdMatch = locusId.match(LOCUS_ID_REGEXP)
            if (!locusIdMatch) {
                displayError(`Invalid locusId format: ${locusId}. Expected format: chrom-start-end-motif (eg. 4-3074876-3074933-CAG)`)
                return
            }
            let [_, chrom, start_0based, end_1based, motif] = locusIdMatch

            // Set page titles immediately (before waiting for search results)
            const referenceRegion = `chr${chrom}:${start_0based}-${end_1based}`
            const truncatedMotif = motif.length > 35 ? motif.substring(0, 35) + '...' : motif
            document.title = `TRExplorer: ${locusId}`
            $('#locus-page-title').text(`Locus Page: ${referenceRegion} ${truncatedMotif}`)

            // the BigQuery table is partitioned on chrom_index and clustered by start_0based, so include these in the W
            start_0based = parseInt(start_0based.replace(/,/g, ''))
            const chromIndex = CHROM_TO_CHROM_INDEX[chrom]
            let selectedColumns = REQUIRED_DATA_COLUMNS_FOR_LOCUS_PAGE
            const whereClause = `WHERE (chrom_index=${chromIndex} AND start_0based=${start_0based} AND LocusId = '${locusId}')`
            const query = `SELECT ${selectedColumns.join(', ')} FROM ${COMPLETE_TABLE_ID} ${whereClause}`

            window.searchResults = await queryBigQuery(query, 0, 1, null, null)

            console.log("Search results:", window.searchResults)

            // Remove loading indicator and placeholder before showing results
            $('#loading-container').hide()

            if (!window.searchResults.rows || window.searchResults.rows.length == 0) {
                console.log("ERROR: row not found", whereClause)
                return
            }

            displaySearchResults()

        } catch (error) {
            console.error('Error performing search:', error)
            $('#loading-container').hide()
            displayError('Error performing search: ' + error.message)
        } finally {
            $('body').css('cursor', 'default')
            $('#results-table').show()
            $('#results-table').removeClass('loading')
        }
    }

    // initialize the "What's new", "FAQ", "Downloads", and "About" modals
    ['whats-new', 'faq', 'downloads', 'about'].forEach(prefix => {
        $(`#${prefix}-link`).click((e) => {
            e.preventDefault()
            $(`#${prefix}-modal`).modal('show')
        })
    })

    // handle browser forward & back buttons
    window.addEventListener('popstate', readAndApplyPersistentPageStateFromUrl)

    // init ui elements
    $('.ui.button').popup()
    $(".ui.checkbox").checkbox()


    $(document).ready(async () => {

        await readAndApplyPersistentPageStateFromUrl()

        console.log("Done initializing page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)
        $('body').css('cursor', 'default')
    })

</script>

</body>
</html>
