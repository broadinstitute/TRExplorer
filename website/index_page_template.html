<!DOCTYPE html>
<html>

{% include "header_template.html" %}

<body>
<!-- modal dialog for selecting results table columns -->
<div class="ui modal" id="results-table-column-settings-dialog">
    <i class="close icon"></i>
    <div class="header">
        Results Table Columns
    </div>
    <div class="content">
        <div class="ui form">
            <table class="ui stackable table results-table-column-settings-checkboxes" style="border: 0px !important"></table>
        </div>
    </div>
    <div class="actions">
        <div id="results-table-column-settings-cancel-button" class="ui deny button">Cancel</div>
        <div id="results-table-column-settings-apply-button" class="ui positive right labeled icon button">
            Apply
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<!-- modal dialog for selecting columns to export -->
<div class="ui modal" id="export-column-dialog">
    <i class="close icon"></i>
    <div class="header" id="export-dialog-title">
        Select columns to include
    </div>
    <div class="content">
        <div class="ui form">
            <div class="export-column-checkboxes-flex-container" id="export-column-checkboxes"></div>
        </div>
    </div>
    <div class="actions">
        <div id="export-dialog-cancel-button" class="ui deny button">Cancel</div>
        <div id="export-dialog-download-button" class="ui positive right labeled icon button">
            Download
            <i class="download icon"></i>
        </div>
    </div>
</div>

<!-- modal dialog for polymorphism allele frequencies -->
<div class="ui modal" id="polymorphism-dialog">
    <i class="close icon"></i>
    <div class="header" id="polymorphism-dialog-header" style="text-align: center">
        Polymorphism
    </div>
    <div class="content scrolling">
        <div id="polymorphism-dialog-content"></div>
    </div>
</div>


<div class="ui grid">

    {% include "body_header_template.html" %}

    <div class="ui row">
        <div class="three wide column"></div>
        <div class="ten wide column">
            <div id="show-igv-divider">
                <span id="show-igv-divider-text">Show IGV.js<i class="chevron down icon"></i></span>
                <span id="hide-igv-divider-text" style="display: none">Hide IGV.js<i class="chevron up icon"></i></span>
            </div>

            <form id="search-form" class="ui form">
                <div class="field">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
                        <label style="margin: 0; font-weight: 700 !important;">Search by region, gene, or transcript:</label>
                        <span style="margin-right: 145px; font-weight: 400 !important; color: #888; font-size: 0.9em;">
                            Examples: &nbsp; <a href="index.html?#showRs=1&searchQuery=chr4%3A3074000-3075000">
                                chr4:3074000-3075000
                            </a>, <a href="index.html?#showRs=1&searchQuery=ATXN1">
                                ATXN1
                            </a>, <a href="index.html?#showRs=1&searchQuery=ENSG00000165060">
                                ENSG00000165060
                            </a>, <a href="index.html?#showRs=1&searchQuery=ENST00000370475">
                                ENST00000370475
                            </a>
                        </span>
                    </div>
                    <div class="ui action input">
                        <input type="text" id="search-query" name="search-query" placeholder="eg. chr4:3074000-3075000, ATXN1, ENSG00000165060, ENST00000370475, or a list of these">
                        <button id="filter-button" class="ui basic icon button" type="button" data-html="Show or hide additional TR filters" data-position="top center"><i class="filter icon rotated" style="transition: transform 0.3s;"></i></button>
                        <button id="search-button" class="ui primary button" type="submit">Search</button>
                    </div>
                </div>
            </form>

            <!-- Advanced Search Wrapper -->
            <div id="advanced-search-wrapper" style="padding-top: 20px">
                <!-- Form error message -->
                <div id="form-error-message" class="ui error message" style="display: none; margin-bottom: 1em;"></div>
                
                <!-- Advanced Search (Initially Hidden) -->
                <form id="advanced-search-form" class="ui form" style="display:none">

                    <div class="field" style="padding-top: 5px; max-width: 155px">
                        <label>Search TR Catalog</label>
                        <div class="ui selection dropdown" id="source-catalog-dropdown" style="min-width: 420px !important">
                            <input type="hidden" name="sourceCatalog">
                            <i class="dropdown icon"></i>
                            <div class="default text">Select catalog</div>
                            <div class="menu">
                                <div class="item" data-value="tr_explorer_catalog_v2">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">TRExplorer catalog v2</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">5,599,658 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="tr_explorer_catalog">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">TRExplorer catalog v1</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">4,863,041 loci</span>
                                    </div>
                                </div>
                                <div class="divider"></div>
                                <div class="header">v1 sources</div>
                                <div class="item" data-value="source_KnownDiseaseAssociatedLoci">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Known disease-associated loci (v1)</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">83 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Illumina174kPolymorphicTRs">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Illumina 174k polymorphic TRs</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">174,244 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_PerfectRepeatsInReference">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Perfect repeats in hg38</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">4,391,197 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_PolymorphicTRsInT2TAssemblies">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Polymorphic TRs in 78 T2T assemblies</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">297,517 loci</span>
                                    </div>
                                </div>
                                <div class="divider"></div>
                                <div class="header">v2 sources</div>
                                <div class="item" data-value="source_KnownDiseaseAssociatedLociV2">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Known disease-associated loci (v2)</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">7 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_PolymorphicTRsInT2TAssembliesV2">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Polymorphic TRs in 321 T2T assemblies</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">280,262 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_KnownFunctionalVNTRs">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Known functional VNTRs</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">13 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_HipSTRCatalog">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">HipSTR catalog</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">129,523 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_AdottoTRsFromDanzi2025">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Danzi et al. 2025 (Adotto)</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">263,108 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_ClinvarIndelsThatAreTRs2025">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">ClinVar indels that are TRs</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">815 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Tanudisastro2025">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Tanudisastro et al. 2025</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">1,209 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Manigbas2024">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Manigbas et al. 2024</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">2,347 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Sulovari2021">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Sulovari et al. 2021</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">388 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Garg2021">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Garg et al. 2021</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">1,300 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Mukamel2021">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Mukamel et al. 2021</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">39 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Annear2021">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Annear et al. 2021</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">156 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_Hause2016">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Hause et al. 2016</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">604 loci</span>
                                    </div>
                                </div>
                                <div class="item" data-value="source_VamosV3">
                                    <div style="display: flex; justify-content: space-between; width: 100%;">
                                        <span style="white-space: nowrap;">Vamos v3 catalog</span>
                                        <span style="color: #888; margin-left: 20px; white-space: nowrap;">56,846 loci</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field" style="padding-top: 5px">
                        <label>Gene Region(s) or Locus Set(s)</label>
                        <div class="checkbox-group" style="padding-bottom: 15px">
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepCodingLoci">
                                <label>Coding</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepFiveUTRLoci">
                                <label>5' UTR</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepThreeUTRLoci">
                                <label>3' UTR</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepPromoterLoci">
                                <label>Promoter</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepIntronLoci">
                                <label>Intron</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepIntergenicLoci">
                                <label>Intergenic</label>
                            </div>
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepNonCodingExonLoci">
                                <label>Exon (non-coding transcript)</label>
                            </div>
                        </div>
                        <div class="checkbox-group" style="display: flex; align-items: center; flex-wrap: wrap; gap: 30px;">
                            <div class="ui checkbox">
                                <input type="checkbox" name="keepLociThatOverlapDiseaseAssociatedLoci">
                                <label>Overlaps latest known disease-associated loci</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div class="ui checkbox" style="padding-right: 10px !important;">
                                    <input type="checkbox" name="keepLociThatOverlapLocusSet">
                                    <label>Overlaps loci from</label>
                                </div>
                                <div class="ui selection dropdown" id="overlap-locus-set-dropdown" style="min-width: 155px;">
                                    <input type="hidden" name="keepLociThatOverlapLocusSetSelection">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">Select catalog</div>
                                    <div class="menu">
                                        <div class="item" data-value="gangstr_v17">GangSTR Catalog v17</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="two fields" style="padding-top: 5px">
                        <div class="field" style="max-width: 430px; margin-right:20px">
                            <label>Motif Size(s)</label>
                            <input type="text" id="motif-size-input" name="keepMotifSize" placeholder="e.g., 3, 2-6, 7-, or a comma-separated list of these">
                        </div>
                        <div class="field" style="max-width: 440px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin: 0 0 .28571429rem 0;">
                                <label style="font-size: .92857143em; font-weight: 700">Motif(s)</label>
                                <a href="#" id="known-disease-motifs-link" style="color: #2185d0; font-size: 0.95em;">motifs of known disease-associated loci &gt;</a>
                            </div>
                            <input type="text" id="motif-input" name="keepMotif" placeholder="e.g., CAG, CCG, or a comma-separated list of these">
                        </div>
                    </div>

                    <div style="display: flex; gap: 120px;">
                        <div class="field" style="padding-top: 5px; max-width: 430px;">
                            <label>Polymorphism Filter</label>
                            <div class="checkbox-group" style="display: flex; align-items: center;">
                                <div class="ui checkbox" style="padding-right: 10px !important; display: inline-flex; align-items: center;">
                                    <input type="checkbox" name="polymorphismFilter">
                                    <label>Polymorphism filter:</label>
                                </div>
                                <div class="ui selection dropdown" id="polymorphism-filter-dropdown" style="min-width: 80px; margin-right: 10px !important; display: inline-block">
                                    <input type="hidden" name="polymorphismFilterType">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">Select filter</div>
                                    <div class="menu">
                                        <div class="item" data-value=""></div>
                                        <div class="item" data-value="sigma_HPRC256">σ<sub>HPRC256</sub></div>
                                        <div class="item" data-value="sigma_AoU1027">σ<sub>AoU1027</sub></div>
                                        <div class="item" data-value="sigma_TenK10K">σ<sub>10k10k</sub></div>
                                        <div class="item" data-value="sigma_1kGP">σ<sub>1kGP</sub></div>
                                        <div class="item" data-value="sigma_T2T">σ<sub>T2T</sub></div>
                                    </div>
                                </div>
                                <div style="display: inline-flex; align-items: center;">
                                    <span style="margin-right: 12px;">≥</span>
                                    <input type="text" id="polymorphism-threshold" name="polymorphismThreshold" placeholder="0.5" style="width: 60px;">
                                </div>
                            </div>
                        </div>

                        <div class="field" style="padding-top: 5px; max-width: 440px;">
                            <label>Variation Cluster Filter</label>
                            <div class="checkbox-group" style="display: flex; align-items: center;">
                                <div class="ui checkbox" style="padding-right: 10px !important">
                                    <input type="checkbox" name="vcFilter">
                                    <label>Variation cluster (VC) filter:</label>
                                </div>
                                <div class="ui selection dropdown" id="variation-cluster-filter-dropdown">
                                    <input type="hidden" name="vcFilterType">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">Select filter</div>
                                    <div class="menu">
                                        <div class="item" data-value=""></div>
                                        <div class="divider"></div>
                                        <div class="item" data-value="exclude">Exclude VCs</div>
                                        <div class="item" data-value="exclude_ge_50">Exclude VCs ≥ +50bp</div>
                                        <div class="divider"></div>
                                        <div class="item" data-value="keep">Keep only VCs</div>
                                        <div class="item" data-value="keep_ge_50">Keep only VCs ≥ +50bp</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
        <div class="three wide column"></div>
    </div>
    <div class="ui row">
        <div class="one wide column"></div>
        <div class="fourteen wide column">
            <!-- Results Area -->
            <div id="results-area" style="position: relative; z-index: 100;">
                <div id="loading-container" style="display: none">
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="ui small active inline loader"></div>
                        <span>Loading...</span>
                    </div>
                </div>
                <div class="pagination-container top-pagination"></div>
                <div id="results-table"></div>
                <div class="pagination-container bottom-pagination"></div>
                <div id="error-message" class="ui negative message" style="display: none">
                    <i class="close icon"></i>
                    <div class="header">Error</div>
                    <p id="error-text"></p>
                </div>
            </div>
        </div>
        <div class="one wide column"></div>
    </div>
</div>

<script>

    $('body').css('cursor', 'wait')

    const RESULTS_TABLE_COLUMN_NAMES = [
        'ReferenceRegion',
        'ReferenceMotif',
        'CanonicalMotif',
        'NumRepeatsInReference',
        'FlanksAndLocusMappability',
        'ReferenceRepeatPurity',
        'TRsInRegion',
        'dotPlot',

        'GencodeGeneRegion',
        'GencodeGeneName',
        'variationCluster',
        'Source',
        'isPathogenic',

        'GencodeGeneId',
        'GencodeTranscriptId',
        'RefseqGeneRegion',
        'RefseqGeneId',
        'RefseqGeneName',
        'RefseqTranscriptId',
        'ManeGeneRegion',
        'ManeGeneId',
        'ManeGeneName',

        'VamosMotifFrequencies',

        'polymorphism',

        'HPRC256_AlleleHistogram',
        'TenK10K_AlleleHistogram',
        'AlleleFrequenciesFromIllumina174k',
        'AlleleFrequenciesFromT2TAssemblies',

        'HPRC256_BiallelicHistogram',
        'TenK10K_BiallelicHistogram',


        'HPRC256_Stdev',
        'AoU1027_Stdev',
        'TenK10K_Stdev',
        'StdevFromIllumina174k',
        'StdevFromT2TAssemblies',

        'RepeatMaskerIntervals',
        'NonCodingAnnotations',
        'AoU1027_OE_LengthPercentile',
        'ReferenceLeftFlank',
        'ReferenceRepeatSequence',
        'ReferenceRightFlank',
    ]

    if (!RESULTS_TABLE_COLUMN_NAMES.every(columnName => Object.keys(TABLE_COLUMNS).includes(columnName))) {
        throw new Error('RESULTS_TABLE_COLUMN_NAMES is missing columns from TABLE_COLUMNS: ' + RESULTS_TABLE_COLUMN_NAMES.filter(columnName => !Object.keys(TABLE_COLUMNS).includes(columnName)).join(', '))
    }

    //index page-specific settings of the DEFAULT_GLOBAL_PAGE_STATE
    DEFAULT_GLOBAL_PAGE_STATE['showColumns'] = [
        'ReferenceRegion',
        'ReferenceMotif',
        'ReferenceRepeatPurity',
        'GencodeGeneRegion',
        'GencodeGeneName',
        'variationCluster',
        'Source',
        'AoU1027_Stdev',
        'HPRC256_AlleleHistogram',
        'VamosMotifFrequencies',
        'RepeatMaskerIntervals',
        //'NonCodingAnnotations',
    ].map(columnName => RESULTS_TABLE_COLUMN_NAMES.indexOf(columnName)).join(SHOW_COLUMNS_VALUE_DELIMITER)

    //copy the default persistent page state
    let GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))

    const RESULTS_TABLE_COLUMN_SELECTION_CHECKBOXES = [
        'ReferenceRegion',
        'ReferenceMotif',
        'CanonicalMotif',
        'NumRepeatsInReference',
        'ReferenceRepeatPurity',
        'FlanksAndLocusMappability',
        'variationCluster',
        'TRsInRegion',
        'ReferenceRepeatSequence',
        'ReferenceLeftFlank',
        'ReferenceRightFlank',

        'GencodeGeneName',
        'GencodeGeneRegion',
        'GencodeGeneId',
        'GencodeTranscriptId',
        'RefseqGeneRegion',
        'RefseqGeneId',
        'RefseqGeneName',
        'RefseqTranscriptId',
        'ManeGeneRegion',
        'ManeGeneId',
        'ManeGeneName',

        'VamosMotifFrequencies',
        'polymorphism',

        'HPRC256_AlleleHistogram',
        'TenK10K_AlleleHistogram',
        'AlleleFrequenciesFromIllumina174k',
        'AlleleFrequenciesFromT2TAssemblies',

        'HPRC256_Stdev',
        'AoU1027_Stdev',
        'TenK10K_Stdev',
        'StdevFromIllumina174k',
        'StdevFromT2TAssemblies',

        'Source',
        'RepeatMaskerIntervals',
        'NonCodingAnnotations',
        'isPathogenic',
        'AoU1027_OE_LengthPercentile',
        'dotPlot',

    ]

    // Columns available for TSV/JSON export with their display names and group
    // Generated from BIGQUERY_COLUMNS in global_constants.py
    const EXPORT_COLUMN_OPTIONS = {{ exportable_columns_json }}

    // Store pending export type when showing the dialog
    let pendingExportType = null

    const generateDiseaseAssociatedIcon = (row, linkText) => {
        if (row.DiseaseInfo == null) {
            return ''
        }
        let diseaseAssociatedIconHtml = ''
        let diseaseLocusId = ''
        let diseaseDescription = `<span style='font-weight: bold; white-space: nowrap; text-align: left; display: block;'>Disease-associated locus</span><br />`
        try {
            //console.log(row.DiseaseInfo)
            const diseaseInfo = JSON.parse(row.DiseaseInfo)
            const resources = []
            if (diseaseInfo.STRchiveId) {
                resources.push(`<a href='https://strchive.org/loci/${diseaseInfo.STRchiveId}' target='_blank'>STRchive</a>`)
            }
            if (diseaseInfo.STRipyId) {
                resources.push(`<a href='https://stripy.org/database/${diseaseInfo.STRipyId}' target='_blank'>STRipy</a>`)
            }
            if (diseaseInfo.locusId != 'RAI1') {
                resources.push(`<a href='https://gnomad.broadinstitute.org/short-tandem-repeat/${diseaseInfo.LocusId}?dataset=gnomad_r4' target='_blank'>gnomAD</a>`)
            }
            if (diseaseInfo.Diseases.length > 0 && diseaseInfo.Diseases[0].OMIM) {
                resources.push(`<a href='https://www.omim.org/entry/${diseaseInfo.Diseases[0].OMIM}' target='_blank'>OMIM</a>`)
            }
            diseaseDescription += `Expansions at this ${diseaseInfo.LocusId} locus cause ${diseaseInfo.Diseases.map(d => d.Name).join(' & ')}.<br />
            <br />
                <span style='display: block; white-space: nowrap;'>For more information, see:<br />${resources.join(', &nbsp; ')}</span>
            </span>`
        } catch (e) {
            diseaseLocusId = row.LocusId
            diseaseDescription = '<i>An error occurred while loading this information.</i>'
            console.error(`Error parsing ${row.LocusId} DiseaseInfo JSON: ${row.DiseaseInfo}`, e)
        }
        diseaseAssociatedIconHtml += `<i style="margin-right: 10px;" class="disease-associated-icon action-cell user md icon" data-title="${diseaseLocusId}" data-html="${diseaseDescription}"></i>`
        if (linkText) {
            diseaseAssociatedIconHtml = `<span class="">${diseaseAssociatedIconHtml} ${linkText}</span>`
        }
        return diseaseAssociatedIconHtml
    }

    const getHtmlAttributesForPolymorphism = (row) => {
        let polymorphismDetails = ``
        for (const dataColumn of REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN) {
            if (row[dataColumn] != null) {
                polymorphismDetails += `data-${dataColumn}='${row[dataColumn]}' `
            }
        }
        return polymorphismDetails
    }


    const readAndApplyPersistentPageStateFromUrl = async () => {
        GLOBAL_PAGE_STATE = JSON.parse(JSON.stringify(DEFAULT_GLOBAL_PAGE_STATE))

        const hash = window.location.hash.substring(1)
        if (!hash) return

        const params = new URLSearchParams(hash)

        for (const [urlKey, value] of params.entries()) {
            // Convert abbreviated URL param name to internal state name if needed
            const key = URL_PARAM_REVERSE_ALIASES[urlKey] || urlKey
            if (key in DEFAULT_GLOBAL_PAGE_STATE && value != null) {
                // Convert string values to appropriate types
                GLOBAL_PAGE_STATE[key] = value === 'true' ? true :
                                        value === 'false' ? false :
                                        !isNaN(value) ? Number(value) : value
                if (key === 'showColumns') {
                    GLOBAL_PAGE_STATE['showColumns'] = `${value}` // convert to string
                }
            }
        }
        console.log("Starting to initialize page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)


        // igv
        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
        }

        // advanced search wrapper
        if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {
            $('#advanced-search-form').show()
            $('#filter-button .filter.icon').removeClass('rotated')
        }

        // search
        $('#search-query').val(GLOBAL_PAGE_STATE['searchQuery'])

        $('select[name="sourceCatalog"]').val(GLOBAL_PAGE_STATE['sourceCatalog'])
        $('#source-catalog-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['sourceCatalog'])

        $('input[name="keepMotifSize"]').val(GLOBAL_PAGE_STATE['keepMotifSize'])
        $('input[name="keepMotif"]').val(GLOBAL_PAGE_STATE['keepMotif'])

        $('input[name="keepCodingLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepCodingLoci'] === 1)
        $('input[name="keepFiveUTRLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepFiveUTRLoci'] === 1)
        $('input[name="keepThreeUTRLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepThreeUTRLoci'] === 1)
        $('input[name="keepPromoterLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepPromoterLoci'] === 1)
        $('input[name="keepIntronLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepIntronLoci'] === 1)
        $('input[name="keepIntergenicLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepIntergenicLoci'] === 1)
        $('input[name="keepNonCodingExonLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepNonCodingExonLoci'] === 1)
        $('input[name="keepLociThatOverlapDiseaseAssociatedLoci"]').prop('checked', GLOBAL_PAGE_STATE['keepLociThatOverlapDiseaseAssociatedLoci'] === 1)
        $('input[name="keepLociThatOverlapLocusSet"]').prop('checked', GLOBAL_PAGE_STATE['keepLociThatOverlapLocusSet'] === 1)
        $('select[name="keepLociThatOverlapLocusSetSelection"]').val(GLOBAL_PAGE_STATE['keepLociThatOverlapLocusSetSelection'])
        $('#overlap-locus-set-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['keepLociThatOverlapLocusSetSelection'])

        $('input[name="polymorphismFilter"]').prop('checked', GLOBAL_PAGE_STATE['polymorphismFilter'] === 1)
        $('select[name="polymorphismFilterType"]').val(GLOBAL_PAGE_STATE['polymorphismFilterType'])
        $('#polymorphism-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['polymorphismFilterType'])
        $('input[name="polymorphismThreshold"]').val(GLOBAL_PAGE_STATE['polymorphismThreshold'])

        $('input[name="vcFilter"]').prop('checked', GLOBAL_PAGE_STATE['vcFilter'] === 1)
        $('select[name="vcFilterType"]').val(GLOBAL_PAGE_STATE['vcFilterType'])
        $('#variation-cluster-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['vcFilterType'])
        // Restore custom track URLs
        for (let i = 1; i <= 3; i++) {
            $(`#igv-custom-track-url-${i}`).val(GLOBAL_PAGE_STATE[`igv_custom_track_url_${i}`] || '')
        }

        if (GLOBAL_PAGE_STATE['showRs'] === 1) {
            if (!validateForm()) {
                return;
            }            
            await performSearch(false)
        }
    }


    $('#show-igv-divider').click(async () => {
        GLOBAL_PAGE_STATE['showIGV'] = (GLOBAL_PAGE_STATE['showIGV'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showIGV'] === 1) {
            $('#igv-row').show()
            $('#show-igv-divider-text').hide()
            $('#hide-igv-divider-text').show()
            await updateIgv()
            updateIgvNavButtons()
        } else {
            $('#igv-row').slideUp(500, () => {
                $('#hide-igv-divider-text').hide()
                $('#show-igv-divider-text').show()
            })
            updateIgvNavButtons()
        }

    })

    // IGV navigation button handlers
    $('#igv-nav-prev').click(async () => {
        if (window.igvNavIndex > 0) {
            await navigateIgvToResult(window.igvNavIndex - 1)
        }
    })

    $('#igv-nav-next').click(async () => {
        if (window.searchResults && window.igvNavIndex < window.searchResults.rows.length - 1) {
            await navigateIgvToResult(window.igvNavIndex + 1)
        }
    })

    $('#igv-nav-jump-to-table').click(() => {
        // Find the row in the table corresponding to current igvNavIndex
        const rows = $('#results-table tbody tr')
        if (rows.length > window.igvNavIndex) {
            const targetRow = $(rows[window.igvNavIndex])

            // Scroll to the row
            targetRow[0].scrollIntoView({ behavior: 'smooth', block: 'center' })

            // Remove any existing animation class and re-add to trigger blink
            targetRow.removeClass('highlight-blink')
            // Force reflow to restart animation
            void targetRow[0].offsetWidth
            targetRow.addClass('highlight-blink')

            // Remove the class after animation completes
            setTimeout(() => {
                targetRow.removeClass('highlight-blink')
            }, 2500)
        }
    })


    const updatePaginationControls = () => {

        const $topPagination = $('.top-pagination')
        const $bottomPagination = $('.bottom-pagination')

        const currentPage = GLOBAL_PAGE_STATE['currentPage']
        const pageSize = GLOBAL_PAGE_STATE['pageSize']
        const totalResults = window.searchResults.total_results


        // Always show pagination controls if there are results
        if (totalResults > 0) {
            $topPagination.show()
            $bottomPagination.show()
        } else {
            $topPagination.hide()
            $bottomPagination.hide()
            return
        }

        const nFirstRowOnPage = (currentPage - 1) * pageSize + 1
        const nLastRowOnPage = Math.min(nFirstRowOnPage + pageSize - 1, totalResults)

        const totalPages = parseInt(Math.ceil(totalResults / pageSize))

        const paginationHtml = `
                <div class="total-results">
                    Showing ${nFirstRowOnPage.toLocaleString()}-${nLastRowOnPage.toLocaleString()} out of ${totalResults.toLocaleString()}
                </div>
                <div class="export-selector">
                    <span class="export-label"><b>Export to:</b></span>
                    <div class="ui selection dropdown export-dropdown" id="export-dropdown" style="min-width: 160px">
                        <input type="hidden" name="export-format">
                        <i class="dropdown icon"></i>
                        <div class="default text">Select format</div>
                        <div class="menu">
                            <div class="item" data-value="bed">BED</div>
                            <div class="item" data-value="tsv">TSV</div>
                            <div class="item" data-value="json">JSON</div>
                            <div class="divider"></div>
                            <div class="header">Tool input formats:</div>
                            <div class="item" data-value="expansion_hunter">ExpansionHunter</div>
                            <div class="item" data-value="gangstr">GangSTR</div>
                            <div class="item" data-value="hipstr">HipSTR</div>
                            <div class="item" data-value="trgt">TRGT</div>
                            <div class="item" data-value="vamos">Vamos</div>
                            <div class="item" data-value="longtr">LongTR</div>
                            <div class="item" data-value="medaka">Medaka Tandem</div>
                            <div class="item" data-value="strdust">STRdust</div>
                        </div>
                    </div>
                    <i class="question circle icon export-help-icon" data-html="Export all ${totalResults.toLocaleString()} search results to a file in the selected format"></i>
                </div>
                <div class="page-size-selector">
                    <span>Page size:</span>
                    <div class="ui selection dropdown page-size-select" style="min-width: 80px">
                        <input type="hidden" name="page-size">
                        <i class="dropdown icon"></i>
                        <div class="text">${pageSize}</div>
                        <div class="menu">
                            <div class="item" data-value="10">10</div>
                            <div class="item" data-value="20">20</div>
                            <div class="item" data-value="50">50</div>
                            <div class="item" data-value="100">100</div>
                            <div class="item" data-value="200">200</div>
                            <div class="item" data-value="500">500</div>
                            <div class="item" data-value="1000">1000</div>
                        </div>
                    </div>
                </div>
                <div class="pagination-controls">
                    <button class="ui icon button first-page ${currentPage === 1 ? 'disabled' : ''}" title="First page">
                        <i class="angle double left icon"></i>
                    </button>
                    <button class="ui icon button prev-page ${currentPage === 1 ? 'disabled' : ''}"
                            title="Previous page">
                        <i class="angle left icon"></i>
                    </button>
                    <div class="page-input-container">
                        <span>Page</span>
                        <input type="number" class="page-number-input" min="1" max="${totalPages}" value="${currentPage}">
                        <span class="total-pages">of ${totalPages.toLocaleString()}</span>
                    </div>
                    <button class="ui icon button next-page ${currentPage === totalPages ? 'disabled' : ''}"
                            title="Next page">
                        <i class="angle right icon"></i>
                    </button>
                    <button class="ui icon button last-page ${currentPage === totalPages ? 'disabled' : ''}"
                            title="Last page">
                        <i class="angle double right icon"></i>
                    </button>
                </div>
            `

        $topPagination.html(paginationHtml)
        $bottomPagination.html(paginationHtml)

        $('.export-help-icon').popup({ on: 'click' })

        // Add click handlers for all pagination containers
        $('.pagination-container').each(function() {
            const $container = $(this)

            // Handle page size selection using standard <select>
            $container.find('.page-size-select').dropdown({
                onChange: (value) => {
                    const newPageSize = parseInt(value)
                    if (newPageSize !== GLOBAL_PAGE_STATE['pageSize']) {
                        GLOBAL_PAGE_STATE['pageSize'] = newPageSize
                        GLOBAL_PAGE_STATE['currentPage'] = 1
                        writePersistentPageStateToUrl()
                        performSearch(true)
                    }
                },
                onShow: function() {
                    $(this).css('z-index', 1001)
                },
                onHide: function() {
                    $(this).css('z-index', '')
                }
            })

            // First page button
            $container.find('.first-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] = 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Previous page button
            $container.find('.prev-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] -= 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Next page button
            $container.find('.next-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] += 1
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Last page button
            $container.find('.last-page').click(() => {
                if (!$(this).hasClass('disabled')) {
                    GLOBAL_PAGE_STATE['currentPage'] = totalPages
                    writePersistentPageStateToUrl()
                    performSearch(true)
                }
            })

            // Page input handler
            $container.find('.page-number-input').on('change keypress', function(e) {
                if (e.type === 'change' || e.which === 13) {
                    const newPage = parseInt($(this).val())
                    if (newPage !== currentPage) {
                        GLOBAL_PAGE_STATE['currentPage'] = Math.max(1, Math.min(newPage, totalPages))
                        writePersistentPageStateToUrl()
                        performSearch(true)
                    }

                    if (e.type === 'keypress') {
                        e.preventDefault()
                    }
                }
            })
        })

        $('.export-dropdown').dropdown({
            onShow: function() {
                $(this).css('z-index', 10001)
            },
            onHide: function() {
                $(this).css('z-index', '')
            },
            onChange: async (value) => {
                if (!value) return

                $('.export-dropdown').dropdown('clear')

                // For TSV and JSON exports, show the column selection dialog
                if (value === 'tsv' || value === 'json') {
                    showExportColumnDialog(value)
                    return
                }

                // For all other formats, proceed with the export directly
                await performExport(value)
            }
        })
    }

    const showExportColumnDialog = (exportType) => {
        pendingExportType = exportType

        // Set dialog title based on export type
        const titleText = exportType === 'json'
            ? 'Select fields to include in the JSON file'
            : 'Select columns to include in the TSV'
        $('#export-dialog-title').text(titleText)

        // Get currently visible columns in the results table
        const visibleColumnIds = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
        const visibleColumnNames = visibleColumnIds.map(id => RESULTS_TABLE_COLUMN_NAMES[parseInt(id)])

        // Load saved export column selections from localStorage, or fall back to visible table columns
        const savedSelections = localStorage.getItem('exportColumnSelections')
        const preSelectedExportColumns = savedSelections
            ? new Set(JSON.parse(savedSelections))
            : new Set(visibleColumnNames.flatMap(columnName =>
                TABLE_COLUMNS[columnName] ? TABLE_COLUMNS[columnName].getRequiredColumns() : []))

        // Build checkboxes grouped by category
        const checkboxesContainer = $('#export-column-checkboxes')
        checkboxesContainer.empty()

        // Group columns by their group property
        const groupedColumns = {}
        EXPORT_COLUMN_OPTIONS.forEach(opt => {
            if (!groupedColumns[opt.group]) {
                groupedColumns[opt.group] = []
            }
            groupedColumns[opt.group].push(opt)
        })

        // Define the order in which groups should appear
        const groupOrder = [
            'Core',
            'Additional Layers',
            'Gene Annotations',
            'Vamos',
            'Polymorphism (TenK10K)',
            'Polymorphism (HPRC256)',
            'Polymorphism (AoU1027)',
        ]

        // Create HTML for each group in the specified order
        groupOrder.filter(groupName => groupedColumns[groupName]).forEach(groupName => {
            const columns = groupedColumns[groupName]
            const groupDiv = $(`<div class="export-column-group">
                <div class="export-column-group-header">${groupName}</div>
                <div class="export-column-group-items"></div>
            </div>`)

            const itemsContainer = groupDiv.find('.export-column-group-items')

            columns.forEach(opt => {
                const isChecked = preSelectedExportColumns.has(opt.name) ? 'checked' : ''
                // Escape description for HTML attribute (replace quotes and special chars)
                const escapedDescription = opt.description
                    ? opt.description.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    : ''
                const helpIcon = opt.description
                    ? `<span class="export-column-help-icon" data-tooltip="${escapedDescription}" data-position="top center">(?)</span>`
                    : ''
                const checkboxHtml = `
                    <div class="export-column-checkbox-item">
                        <div class="ui checkbox">
                            <input type="checkbox" name="export_col_${opt.name}" data-column-name="${opt.name}" ${isChecked}>
                            <label>${opt.displayName}</label>
                        </div>
                        ${helpIcon}
                    </div>
                `
                itemsContainer.append(checkboxHtml)
            })

            checkboxesContainer.append(groupDiv)
        })

        // Initialize Semantic UI checkboxes
        $('#export-column-checkboxes .ui.checkbox').checkbox()

        // Show the dialog
        $('#export-column-dialog').modal('show')
    }

    const performExport = async (value, selectedColumns = null) => {
        // Format data based on export type
        let fileFormat
        if (value === 'expansion_hunter' || value == 'json') {
            fileFormat = 'JSON'
        } else if (value === 'gangstr' || value === 'hipstr' || value === 'trgt' || value === 'longtr' || value === 'medaka' || value === 'strdust' || value === 'bed') {
            fileFormat = 'BED'
        } else if (value === 'tsv' || value == 'vamos') {
            fileFormat = 'TSV'
        } else {
            throw new Error(`Invalid export-dropdown value: ${value}`)
        }

        let toolName
        let selectClause
        let conditions = [...window.lastSearchConditions]
        let sortClause = ['chrom', 'start_0based', 'end_1based'].join(', ')
        if (value === 'expansion_hunter') {
            toolName = 'ExpansionHunter'
            selectClause = `LocusId, ReferenceRegion, CONCAT('(', ReferenceMotif, ')*') AS LocusStructure, 'Repeat' AS VariantType`
            conditions.push(`NsInFlanks<=5`)
            alert('Note: The exported ExpansionHunter catalog will exclude any loci that have > 5 Ns within their flanking regions since ExpansionHunter does not support them.')
        } else if(value === 'gangstr') {
            toolName = 'GangSTR'
            selectClause = `CONCAT('chr', chrom), start_0based + 1 AS start_1based, end_1based, MotifSize, ReferenceMotif, '' AS OffTargetRegions`
        } else if(value === 'hipstr') {
            toolName = 'HipSTR'
            selectClause = `CONCAT('chr', chrom), start_0based + 1 AS start_1based, end_1based, MotifSize, NumRepeatsInReference, LocusId, ReferenceMotif`
        } else if(value === 'trgt') {
            toolName = 'TRGT'
            selectClause = `CONCAT('chr', chrom), start_0based, end_1based, CONCAT('ID=', LocusId, ';MOTIFS=', ReferenceMotif, ';STRUC=(', ReferenceMotif, ')n') AS InfoField`
        } else if(value === 'vamos') {
            toolName = 'vamos'
            selectClause = `CONCAT('chr', chrom), start_0based + 1 AS start_1based, end_1based, CASE WHEN VamosUniqueMotifs IS NOT NULL THEN VamosUniqueMotifs ELSE ReferenceMotif END AS UniqueMotifs, CONCAT('Export_', FORMAT_TIMESTAMP('%Y%m%d_%H%M%S', CURRENT_TIMESTAMP()), ':', source) AS Source, CASE WHEN MotifSize > 6 THEN 'VNTR' ELSE 'STR' END AS LocusType, MotifSize, -1 AS TEOverlap1, -1 AS TEOverlap2`
            conditions.push(`IncludeInVamosCatalog=1`)
            alert('Note: The exported Vamos catalog will exclude any loci that overlap larger loci since Vamos does not support overlapping locus definitions.')
        } else if(value === 'longtr') {
            toolName = 'LongTR'
            selectClause = `CONCAT('chr', chrom), start_0based + 1 AS start_1based, end_1based, ReferenceMotif, LocusId`
            conditions.push(`start_0based + 1 < end_1based`)
        } else if(value === 'medaka') {
            toolName = 'Medaka'
            selectClause = `CONCAT('chr', chrom), start_0based, end_1based, LocusId`
        } else if(value === 'strdust') {
            toolName = 'STRdust'
            selectClause = `CONCAT('chr', chrom), start_0based, end_1based, LocusId`
        } else if(value === 'bed') {
            selectClause = `CONCAT('chr', chrom), start_0based, end_1based, ReferenceMotif, MotifSize`
        } else if(value === 'tsv' || value === 'json') {
            // Use selected columns if provided, otherwise use default list
            if (selectedColumns && selectedColumns.length > 0) {
                // Map selected column names to their SQL column expressions
                const columnExpressions = selectedColumns.map(colName => {
                    const colOption = EXPORT_COLUMN_OPTIONS.find(opt => opt.name === colName)
                    return colOption ? colOption.column : colName
                })
                selectClause = columnExpressions.join(', ')
            } else {
                // Fallback to default columns if none selected
                const defaultColumns = [
                    `CONCAT('chr', chrom) AS chrom`,
                    'start_0based',
                    'end_1based',
                    'ReferenceRegion',
                    'LocusId',
                    'ReferenceMotif',
                    'MotifSize',
                ]
                selectClause = defaultColumns.join(', ')
            }
            sortClause = window.lastSearchSortClause
        } else {
            throw new Error(`Invalid export-dropdown value: ${value}`)
        }

        try {
            $('body').css('cursor', 'wait')

            const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : ''
            const query = `SELECT ${selectClause} FROM ${COMPLETE_TABLE_ID} ${whereClause} ORDER BY ${sortClause}`
            const results = await queryBigQuery(query, null, null, fileFormat, toolName)

            if (results.public_urls) {
                if (results.public_urls.length > 1) {
                    if (!confirm(`The requested export is very large, so it was split into ${results.public_urls.length} separate files. Would you like to download them?`)) {
                        return;
                    }
                }
                for (const url of results.public_urls) {
                    console.log('Downloading URL:', url)
                    // Create and trigger download link using jQuery
                    const $link = $('<a>')
                        .attr('href', url)
                        .appendTo('body')
                    $link[0].click()

                    // Add a small delay between downloads
                    await new Promise(resolve => setTimeout(resolve, 2000))

                    // Keep track of the link for later removal
                    if (!window.downloadLinks) {
                        window.downloadLinks = []
                    }
                    window.downloadLinks.push($link)

                    // If this is the first link, start the cleanup timer
                    if (window.downloadLinks.length === 1) {
                        setTimeout(() => {
                            window.downloadLinks.forEach($link => {
                                $link.remove()
                            })
                            window.downloadLinks = []
                        }, 2*60*1000)
                    }

                }
            }

        } catch (error) {
            console.error('Error exporting data:', error)
            alert('Error exporting data: ' + error.message)
        } finally {
            $('body').css('cursor', 'default')
        }
    }

    // Handle export dialog download button
    $('#export-dialog-download-button').click(async () => {
        if (!pendingExportType) return

        // Collect selected columns
        const selectedColumns = []
        $('#export-column-checkboxes input[type="checkbox"]:checked').each(function() {
            const columnName = $(this).data('column-name')
            if (columnName) {
                selectedColumns.push(columnName)
            }
        })

        if (selectedColumns.length === 0) {
            alert('Please select at least one column to export.')
            return
        }

        // Save selections to localStorage
        localStorage.setItem('exportColumnSelections', JSON.stringify(selectedColumns))

        // Hide the dialog
        $('#export-column-dialog').modal('hide')

        // Perform the export with selected columns
        await performExport(pendingExportType, selectedColumns)

        pendingExportType = null
    })

    // Handle export dialog cancel button
    $('#export-dialog-cancel-button').click(() => {
        pendingExportType = null
        $('#export-column-dialog').modal('hide')
    })


    const createSmallAlleleFrequencyChart = function() {
        const frequencies = $(this).data('frequencies')
        const refAlleleSize = $(this).data('ref-allele-size')

        if (!frequencies) return   // Skip if no data

        const data = parseAlleleFrequenciesString(frequencies)

        const yLookup = {}
        const xLabels =  []
        const colors = []
        const borderColors = []
        for (let i = Math.min(...data.map(d => d.size)) - 1; i <= Math.max(...data.map(d => d.size)) + 1; i++) {
            xLabels.push(i)
            yLookup[i] = 0
        }
        for (let x of xLabels) {
            yLookup[x] = data.find(d => d.size === x)?.count || 0
            colors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 0.7)' : 'rgba(33, 133, 208, 0.5)')
            borderColors.push(x === refAlleleSize ? 'rgba(255, 165, 0, 1)' : 'rgba(33, 133, 208, 1)')
        }

        //set y-limit to the nearest whole power of 10 divided by 2, rounding up
        const maxCount = Math.max(...data.map(d => d.count))
        const yLimit = Math.pow(10, Math.ceil(Math.log10(2 * maxCount))) / 2
        new Chart(this, {
            type: 'bar',
            data: {
                labels: xLabels,
                datasets: [{
                    data: xLabels.map(d => yLookup[d]),
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Count: ${context.raw}`
                            }
                        },
                        position: 'nearest',
                        yAlign: 'bottom'
                    }
                },
                scales: {
                    y: {
                        type: 'logarithmic',
                        min: 0,
                        max: parseInt(yLimit),
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                if (Math.floor(value) === value) {
                                    return parseInt(value)
                                }
                            },
                            padding: 3,
                        },
                        grid: {
                            drawTicks: false
                        }

                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            },
                            padding: 3
                        },
                        grid: {
                            drawTicks: false
                        }
                    }
                }
            }
        })

        this.style.minHeight = '55px'
        this.style.maxHeight = '55px'
        this.style.minWidth = '100px'
        this.style.maxWidth = '200px'
        this.style.height = '55px'

        $(this).parent().css('padding-top', '0')
        $(this).parent().css('padding-bottom', '0')
    }


    // IGV navigation state
    window.igvNavIndex = 0

    // Update IGV navigation buttons visibility and state
    const updateIgvNavButtons = () => {
        const hasResults = window.searchResults && window.searchResults.rows && window.searchResults.rows.length > 1
        const igvVisible = GLOBAL_PAGE_STATE['showIGV'] === 1

        if (hasResults && igvVisible) {
            $('#igv-nav-container').show()
            const totalResults = window.searchResults.rows.length
            const currentIndex = window.igvNavIndex

            // Update index display
            $('#igv-nav-index').text(`${currentIndex + 1} of ${totalResults}`)

            // Update button states
            $('#igv-nav-prev').prop('disabled', currentIndex <= 0)
            $('#igv-nav-next').prop('disabled', currentIndex >= totalResults - 1)
        } else {
            $('#igv-nav-container').hide()
        }
    }

    // Navigate IGV to a specific result index
    const navigateIgvToResult = async (index) => {
        if (!window.searchResults || !window.searchResults.rows) return
        if (index < 0 || index >= window.searchResults.rows.length) return

        const row = window.searchResults.rows[index]
        const referenceRegion = row['ReferenceRegion']
        if (!referenceRegion) return

        const match = referenceRegion.match(REFERENCE_REGION_REGEXP)
        if (!match) {
            console.warn(`Unexpected locus format: ${referenceRegion}`)
            return
        }

        const [_, chrom, start, end] = match
        const paddedStart = Math.max(0, parseInt(start.replace(',', '')) - IGV_LOCUS_PADDING)
        const paddedEnd = parseInt(end.replace(',', '')) + IGV_LOCUS_PADDING
        const paddedReferenceRegion = `${chrom}:${paddedStart}-${paddedEnd}`

        window.igvNavIndex = index
        GLOBAL_PAGE_STATE['igvLoc'] = paddedReferenceRegion
        writePersistentPageStateToUrl()

        if (window.igvBrowser) {
            await window.igvBrowser.search(paddedReferenceRegion)
        }

        updateIgvNavButtons()
    }

    const displayError = (message) => {
        $('#error-text').text(message)
        $('#error-message').show()
        $('#results-table').empty()
    }

    const displaySearchResults = () => {

        const results = window.searchResults
        const sortColumn = GLOBAL_PAGE_STATE['sc']
        const sortDirection = GLOBAL_PAGE_STATE['sd']
        const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)

        const resultsTableElement = $('#results-table')

        resultsTableElement.removeClass('loading')
        if (!results.rows || results.rows.length === 0) {
            resultsTableElement.html('<div class="no-results">No matching results found</div>')
            $('.pagination-container').hide()
            return
        }

        let tableHtml = '<table class="ui celled sortable table"><thead><tr>'
        tableHtml += `<th style="width: 1%; padding: 2px 4px; text-align: center; vertical-align: middle;">
            <button id="results-table-settings-button" class="ui primary basic grey button" style="height:25px; width:30px; padding:0; border-radius:5px; background-color: #FCFCFF !important; display: inline-flex; align-items: center; justify-content: center;" data-tooltip="Column descriptions and settings">
                <i class="setting icon" style="margin: 0;"></i>
            </button>
        </th>`

        Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
            if (visibleColumns.includes(columnId)) {
                const columnObject = TABLE_COLUMNS[columnName]
                const isSorted = columnName === sortColumn
                let icon = '<i class="sort icon"></i>'
                if (isSorted) {
                    icon = sortDirection === 'ASC' ? '<i class="sort up icon"></i>' : '<i class="sort down icon"></i>'
                }
                tableHtml += `<th class="${isSorted ? 'sorted' : ''} results-table-sortable-header" data-column="${columnName}">${columnObject.displayName} ${icon}</th>`
            }
        })

        tableHtml += '<th></th></tr></thead><tbody>'

        const startIndex = GLOBAL_PAGE_STATE['pageSize'] * (GLOBAL_PAGE_STATE['currentPage'] - 1)

        //console.log("Search results:", results.rows)

        results.rows.forEach((row, index) => {
            let diseaseAssociatedIconHtml = generateDiseaseAssociatedIcon(row)

            tableHtml += `<tr ${diseaseAssociatedIconHtml ? 'class="disease-associated-row"' : ''}>`
            tableHtml += `<td style="text-align: center; white-space: nowrap; padding: 3px 5px;">
                <span style="font-weight: bold;">#${(startIndex + index + 1).toLocaleString()}</span>
            </td>`

            Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
                if (visibleColumns.includes(columnId)) {
                    const columnObject = TABLE_COLUMNS[columnName]
                    let value
                    if (!columnObject || !columnObject.getValue) {
                        const label = columnObject ? 'columnObject' : 'columnObject.getValue'
                        console.log('WARNING: ', label, 'is undefined for columnId:', columnId, 'columnName:', columnName)
                        value = row[columnName]
                    } else {
                        value = columnObject.getValue(row)
                    }

                    tableHtml += `<td style="padding: 3px 5px 3px 10px">${value != null ? value : ''}</td>`
                }
            })
            tableHtml += `<td style="padding: 8px 10px; white-space: nowrap; text-align: right;">${diseaseAssociatedIconHtml}<button class="ui basic mini button row-locus-page-button" data-locus-id="${row['LocusId']}" data-reference-region="${row['ReferenceRegion']}" style="padding: 5px 10px; color: #2185d0; font-weight: 500; border: 1px solid #2185d0; box-shadow: 0 1px 2px rgba(0,0,0,0.08);">locus &gt;</button></td>`
            tableHtml += '</tr>'
        })
        tableHtml += '</tbody></table>'
        resultsTableElement.html(tableHtml)

        // Add click handlers for sortable headers
        resultsTableElement.find('.results-table-sortable-header').click(function() {
            const column = $(this).data('column')
            if (column === sortColumn) {
                if (sortDirection === 'ASC') {
                    if (!TABLE_COLUMNS[column]?.defaultSortDirection || TABLE_COLUMNS[column]?.defaultSortDirection == 'ASC') {
                        GLOBAL_PAGE_STATE['sd'] = 'DESC'
                    } else {
                        GLOBAL_PAGE_STATE['sc'] = DEFAULT_SORT_COLUMN
                        GLOBAL_PAGE_STATE['sd'] = DEFAULT_SORT_DIRECTION
                    }
                } else if (sortDirection === 'DESC') {
                    if (TABLE_COLUMNS[column]?.defaultSortDirection == 'DESC') {
                        GLOBAL_PAGE_STATE['sd'] = 'ASC'
                    } else {
                        GLOBAL_PAGE_STATE['sc'] = DEFAULT_SORT_COLUMN
                        GLOBAL_PAGE_STATE['sd'] = DEFAULT_SORT_DIRECTION
                    }
                }
            } else {
                GLOBAL_PAGE_STATE['sc'] = column
                GLOBAL_PAGE_STATE['sd'] = TABLE_COLUMNS[column]?.defaultSortDirection || 'ASC'
            }

            performSearch(true)
        })

        Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
            if (visibleColumns.includes(columnId)) {
                const initValueFunc = TABLE_COLUMNS[columnName].initializeValue
                if (initValueFunc) {
                    initValueFunc()
                }

            }
        })

        // add click handler for locus page buttons
        $('.row-locus-page-button').click(function() {
            const locusId = $(this).data('locus-id')
            const referenceRegion = $(this).data('reference-region')
            if (!locusId || !referenceRegion) return

            // get url params
            let locusPageUrlArgs = `locusId=${locusId}&igvLoc=${referenceRegion}`
            const urlArgs = window.location.hash.substring(1)
            if (urlArgs) {
                const currentPageUrlParams = new URLSearchParams(urlArgs)
                for (const [key, value] of currentPageUrlParams.entries()) {
                    if (key != 'locusId' & key != 'igvLoc') {
                        locusPageUrlArgs += `&${key}=${value}`
                    }
                }
            }

            const locusPageUrl = `locus.html?#${locusPageUrlArgs}`
            window.open(locusPageUrl, '_blank')
        })

        // add click handlers for IGV buttons
        $('.row-igv-button').click(async function() {
            const referenceRegion = $(this).data('reference-region')
            const rowIndex = $(this).data('row-index')
            if (!referenceRegion) return

            // Parse the locus to get chrom, start, end
            const match = referenceRegion.match(REFERENCE_REGION_REGEXP)
            if (!match) {
                console.warn(`Unexpected locus format: ${referenceRegion}`)
                return
            }

            const [_, chrom, start, end] = match
            const paddedStart = Math.max(0, parseInt(start.replace(',', '')) - IGV_LOCUS_PADDING)
            const paddedEnd = parseInt(end.replace(',', '')) + IGV_LOCUS_PADDING
            const paddedReferenceRegion = `${chrom}:${paddedStart}-${paddedEnd}`

            // Update navigation index
            if (rowIndex !== undefined) {
                window.igvNavIndex = rowIndex
            }

            try {
                $('body').css('cursor', 'wait')

                // Navigate to the locus
                GLOBAL_PAGE_STATE['igvLoc'] = paddedReferenceRegion

                // Show IGV if hidden
                if (GLOBAL_PAGE_STATE['showIGV'] !== 1) {

                    GLOBAL_PAGE_STATE['showIGV'] = 1
                    writePersistentPageStateToUrl()

                    $('#igv-row').show()
                    $('#show-igv-divider-text').hide()
                    $('#hide-igv-divider-text').show()
                }

                // Scroll to the IGV browser first, then update/search
                $('#igv-row')[0].scrollIntoView({ behavior: 'smooth' })

                if (!window.igvBrowser) {
                    await updateIgv()
                } else {
                    writePersistentPageStateToUrl()
                    await window.igvBrowser.search(paddedReferenceRegion)
                }


                // Enable the "TRExplorer genome-wide catalog" track if it's not already enabled
                if (!GLOBAL_PAGE_STATE['igv_tr_explorer_catalog_v2']) {
                    GLOBAL_PAGE_STATE['igv_tr_explorer_catalog_v2'] = 1
                    writePersistentPageStateToUrl()

                    await updateIgv()
                }

                // Update navigation buttons
                updateIgvNavButtons()
            } finally {
                $('body').css('cursor', 'default')
            }
        })

        // init charts
        $('.allele-frequency-inline-chart').each(createSmallAlleleFrequencyChart)

        // init popups
        $('.show-popup').popup({ on: 'click', hoverable: true })
        $('.cell-in-polymorphism-column').click(showPolymorphismDialog)
        $('.disease-associated-icon').popup({ on: 'click' })

        // init click handler for "Column settings" modal
        $('#results-table-settings-button').click((e) => {
            e.preventDefault()

            // Clear existing checkboxes
            $('.results-table-column-settings-checkboxes tr').remove()

            // Create a flex container div
            $('.results-table-column-settings-checkboxes').html('<div class="results-table-column-settings-checkbox-flex-container"></div>')

            const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
            const checkboxes = RESULTS_TABLE_COLUMN_SELECTION_CHECKBOXES.map((columnName) => {
                const columnId = RESULTS_TABLE_COLUMN_NAMES.indexOf(columnName)
                const isChecked = visibleColumns.includes(columnId.toString())
                return `
                    <div class="results-table-column-settings-checkbox-item">
                        <div class="ui checkbox" style="display: inline-block; padding-right: 10px">
                            <input type="checkbox" name="show_column_${columnId}" ${isChecked ? 'checked' : ''}>
                            <label>${TABLE_COLUMNS[columnName]?.displayName || ''}</label>
                        </div>
                        ${TABLE_COLUMNS[columnName]?.helpText ? `<i class="question circle icon" data-html="${TABLE_COLUMNS[columnName].helpText}"></i>` : ''}
                    </div>`
            }).join('')

            $('.results-table-column-settings-checkbox-flex-container').append(checkboxes)

            // Initialize checkboxes
            $('.results-table-column-settings-checkboxes .ui.checkbox').checkbox()
            $('#results-table-column-settings-dialog').modal('show')
            $('.question').popup({ on: 'click' })
        })

        // handle Apply button click in column settings dialog
        $('#results-table-column-settings-apply-button').click(() => {
            const selectedColumns = []
            $('.results-table-column-settings-checkboxes input[type="checkbox"]').each(function() {
                if ($(this).prop('checked')) {
                    const columnId = $(this).attr('name').replace('show_column_', '')
                    selectedColumns.push(columnId)
                }
            })

            GLOBAL_PAGE_STATE['showColumns'] = selectedColumns.join(SHOW_COLUMNS_VALUE_DELIMITER)
            writePersistentPageStateToUrl()
            performSearch(true)

            $('#results-table-column-settings-dialog').modal('hide')
        })

        $('#results-table-column-settings-cancel-button').click(() => {
            $('#results-table-column-settings-dialog').modal('hide')
        })

        GLOBAL_PAGE_STATE['showRs'] = 1
        writePersistentPageStateToUrl()
    }

    const splitSearchQuery = (searchQuery) => {
        if (!searchQuery) {
            return []
        }

        searchQuery = searchQuery.trim()
        searchQuery = searchQuery.replace(/[–—−‐‑‒﹘﹣－‾]/g, '-') // Replace all unicode dash types with a regular dash

        // split by comma (except where the comma is part of a large number like 1,234,567) or whitespace
        const searchQueryValues = searchQuery.split(/,(?!\d{3})|\s+/).map(q => q.trim()).filter(q => q !== '')

        return searchQueryValues
    }

    const performSearch = async (showTableWhileLoading = false) => {
        // Remove any error messages and no results message
        $('#error-message').hide()
        $('.no-results').hide()
        $('.top-pagination').hide()         // Hide only top pagination container during loading
        $('#loading-container').show()      // Show loading indicator

        // Add loading state to table without emptying it
        if (showTableWhileLoading) {
            $('.bottom-pagination').show()
            $('#results-table').addClass('loading')
        } else {
            $('#results-table').hide()
            $('.bottom-pagination').hide()
        }

        try {
            $('body').css('cursor', 'wait')

            let conditions = []
            let searchQuery = $('#search-query').val()
            if (searchQuery) {

                // Split input by commas to handle multiple values
                const queryValues = splitSearchQuery(searchQuery)

                // Process each query value and create query conditions
                const queryClauses = queryValues.map(queryValue => {
                    queryValue = queryValue.trim()
                    // Check if it's a genomic region (chr:start-end)
                    const regionMatch = queryValue.match(REFERENCE_REGION_REGEXP)
                    if (regionMatch) {
                        let [_, chrom, start, end] = regionMatch
                        start = parseInt(start.replace(/,/g, ''))
                        end = parseInt(end.replace(/,/g, ''))
                        const chromIndex = CHROM_TO_CHROM_INDEX[chrom]
                        return `
                            (chrom_index = ${chromIndex} AND start_0based < ${end} AND end_1based >= ${start})
                        `
                    } else {
                        const locusIdMatch = queryValue.match(LOCUS_ID_REGEXP)
                        if (locusIdMatch) {
                            let [_, chrom, start_0based, __, ___] = locusIdMatch
                            start_0based = parseInt(start_0based.replace(/,/g, ''))
                            const chromIndex = CHROM_TO_CHROM_INDEX[chrom]
                            //end = parseInt(end.replace(/,/g, ''))

                            return `(chrom_index = ${chromIndex} AND start_0based = ${start_0based} AND LocusId = '${queryValue}')`

                        } else {
                            // Try other fields
                            return `
                                (UPPER(GencodeGeneName) = UPPER('${queryValue}')
                                OR UPPER(GencodeGeneId) = UPPER('${queryValue}')
                                OR UPPER(GencodeTranscriptId) = UPPER('${queryValue}')
                                OR UPPER(RefseqGeneName) = UPPER('${queryValue}')
                                OR UPPER(RefseqGeneId) = UPPER('${queryValue}')
                                OR UPPER(RefseqTranscriptId) = UPPER('${queryValue}')
                                OR UPPER(ManeGeneName) = UPPER('${queryValue}')
                                OR UPPER(ManeGeneId) = UPPER('${queryValue}')
                                OR UPPER(ManeTranscriptId) = UPPER('${queryValue}')
                                OR UPPER(LocusId) = UPPER('${queryValue}'))
                            `
                        }
                    }
                })
                
                // Combine all clauses with OR for multiple input values
                if (queryClauses.length > 0) {
                    conditions.push(`(${queryClauses.join(' OR ')})`)
                }
            }

            if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {

                // Add source catalog condition
                const sourceCatalog = $('#source-catalog-dropdown').dropdown('get value')
                if (sourceCatalog) {
                    switch (sourceCatalog) {
                        case 'tr_explorer_catalog_v2':
                            break   // No additional conditions needed
                        case 'tr_explorer_catalog':
                            conditions.push("Source LIKE 'TRExplorerV1%'")
                            break
                        // v1 sources
                        case 'source_PerfectRepeatsInReference':
                            conditions.push("Source = 'TRExplorerV1:PerfectRepeatsInReference'")
                            break
                        case 'source_PolymorphicTRsInT2TAssemblies':
                            conditions.push("Source = 'TRExplorerV1:PolymorphicTRsInT2TAssemblies'")
                            break
                        case 'source_Illumina174kPolymorphicTRs':
                            conditions.push("Source = 'TRExplorerV1:Illumina174kPolymorphicTRs'")
                            break
                        case 'source_KnownDiseaseAssociatedLoci':
                            conditions.push("Source = 'TRExplorerV1:KnownDiseaseAssociatedLoci'")
                            break
                        // v2 sources
                        case 'source_PolymorphicTRsInT2TAssembliesV2':
                            conditions.push("Source = 'TRExplorerV2:PolymorphicTRsInT2TAssembliesV2'")
                            break
                        case 'source_AdottoTRsFromDanzi2025':
                            conditions.push("Source = 'TRExplorerV2:AdottoTRsFromDanzi2025'")
                            break
                        case 'source_HipSTRCatalog':
                            conditions.push("Source = 'TRExplorerV2:HipSTRCatalog'")
                            break
                        case 'source_Manigbas2024':
                            conditions.push("Source = 'TRExplorerV2:Manigbas2024'")
                            break
                        case 'source_Garg2021':
                            conditions.push("Source = 'TRExplorerV2:Garg2021'")
                            break
                        case 'source_Tanudisastro2025':
                            conditions.push("Source = 'TRExplorerV2:Tanudisastro2025'")
                            break
                        case 'source_ClinvarIndelsThatAreTRs2025':
                            conditions.push("Source = 'TRExplorerV2:ClinvarIndelsThatAreTRs2025'")
                            break
                        case 'source_Hause2016':
                            conditions.push("Source = 'TRExplorerV2:Hause2016'")
                            break
                        case 'source_Sulovari2021':
                            conditions.push("Source = 'TRExplorerV2:Sulovari2021'")
                            break
                        case 'source_Annear2021':
                            conditions.push("Source = 'TRExplorerV2:Annear2021'")
                            break
                        case 'source_Mukamel2021':
                            conditions.push("Source = 'TRExplorerV2:Mukamel2021'")
                            break
                        case 'source_KnownFunctionalVNTRs':
                            conditions.push("Source = 'TRExplorerV2:KnownFunctionalVNTRs'")
                            break
                        case 'source_KnownDiseaseAssociatedLociV2':
                            conditions.push("Source = 'TRExplorerV2:KnownDiseaseAssociatedLociV2'")
                            break
                        case 'source_VamosV3':
                            conditions.push("Source = 'TRExplorerV2:VamosV3'")
                            break
                    }
                }

                // Add variation cluster filter conditions
                const vcFilter = $('input[name="vcFilter"]').prop('checked')
                const vcFilterType = $('#variation-cluster-filter-dropdown').dropdown('get value')
                if (vcFilter && vcFilterType) {
                    switch (vcFilterType) {
                        case 'exclude':
                            conditions.push("(VariationCluster IS NULL OR VariationCluster = '')")
                            break
                        case 'exclude_ge_50':
                            conditions.push("(VariationCluster IS NULL OR VariationCluster = '' OR VariationClusterSizeDiff < 50)")
                            break
                        case 'keep':
                            conditions.push("(VariationCluster IS NOT NULL AND VariationCluster != '')")
                            break
                        case 'keep_ge_50':
                            conditions.push("(VariationCluster IS NOT NULL AND VariationCluster != '' AND VariationClusterSizeDiff >= 50)")
                            break
                    }
                }

                // Add polymorphism filter conditions
                const polymorphismFilter = $('input[name="polymorphismFilter"]').prop('checked')
                const polymorphismFilterType = $('#polymorphism-filter-dropdown').dropdown('get value')
                const polymorphismThreshold = $('input[name="polymorphismThreshold"]').val()
                if (polymorphismFilter && polymorphismFilterType && polymorphismThreshold) {
                    switch (polymorphismFilterType) {
                        case 'sigma_HPRC256':
                            conditions.push(`HPRC256_Stdev > ${polymorphismThreshold}`)
                            break
                        case 'sigma_AoU1027':
                            conditions.push(`AoU1027_Stdev > ${polymorphismThreshold}`)
                            break
                        case 'sigma_TenK10K':
                            conditions.push(`TenK10K_Stdev > ${polymorphismThreshold}`)
                            break
                        case 'sigma_1kGP':
                            conditions.push(`StdevFromIllumina174k > ${polymorphismThreshold}`)
                            break
                        case 'sigma_T2T':
                            conditions.push(`StdevFromT2TAssemblies > ${polymorphismThreshold}`)
                            break
                        default:
                            console.error(`Unknown polymorphism filter type: ${polymorphismFilterType}`)
                    }
                }

                // Add known disease-associated loci condition
                let knownDiseaseLoci = $('input[name="keepKdLoci"]').prop('checked')
                if (knownDiseaseLoci) {
                    conditions.push("KnownDiseaseAssociatedLocus IS NOT NULL AND KnownDiseaseAssociatedLocus != ''")
                }


                let motifSizeInput = $('input[name="keepMotifSize"]').val()
                if (motifSizeInput) {
                    motifSizeInput = motifSizeInput.trim()

                    let sizeClauses = []
                    
                    // Split input by commas and process each value
                    const values = motifSizeInput.split(',').map(v => v.trim()).filter(v => v !== '')
                    
                    values.forEach(value => {
                        // Handle open-ended ranges like "15-"
                        const openEndedMatch = value.match(/^(\d+)-$/)
                        if (openEndedMatch) {
                            const min = parseInt(openEndedMatch[1])
                            sizeClauses.push(`(MotifSize >= ${min})`)
                            return
                        }
                        
                        // Handle ranges like "2-6"
                        const rangeMatch = value.match(/^(\d+)-(\d+)$/)
                        if (rangeMatch) {
                            const min = parseInt(rangeMatch[1])
                            const max = parseInt(rangeMatch[2])
                            sizeClauses.push(`(MotifSize BETWEEN ${min} AND ${max})`)
                            return
                        }
                        
                        // Handle single numbers
                        const singleNumber = parseInt(value)
                        if (!isNaN(singleNumber)) {
                            sizeClauses.push(`(MotifSize = ${singleNumber})`)
                        }
                    })
                    
                    if (sizeClauses.length > 0) {
                        conditions.push(`(${sizeClauses.join(' OR ')})`)
                    }
                }

                const reverseCompliment = (m) => {
                    const complement = {
                        'A': 'T',
                        'T': 'A',
                        'C': 'G',
                        'G': 'C',
                        'R': 'Y',
                        'Y': 'R',
                        'M': 'K',
                        'K': 'M',
                        'B': 'V',
                        'D': 'H',
                        'H': 'D',
                        'V': 'B',
                    }
                    
                    return m.toUpperCase().split('').map(base => complement[base] || base).reverse().join('')
                }

                const computeCanonicalMotif = (m) => {
                    m = m.toUpperCase()
                    
                    const rotations = []
                    for (let i = 0; i < m.length; i++) {
                        rotations.push(m.slice(i) + m.slice(0, i))
                    }
                    
                    // Get reverse complement of each rotation
                    const allVariants = [...rotations, ...rotations.map(rot => reverseCompliment(rot))]
                    
                    // Return the lexicographically smallest variant
                    return allVariants.sort()[0]
                }

                
                let motifInput = $('#motif-input').val()
                if (motifInput) {
                    motifInput = motifInput.trim()
                    const motifs = motifInput.split(',').map(m => m.trim()).filter(m => m !== '')
                    if (motifs.length > 0) {
                        const motifClauses = motifs.map(motif => 
                            `UPPER(CanonicalMotif) = UPPER('${computeCanonicalMotif(motif)}')`
                        )
                        conditions.push(`(${motifClauses.join(' OR ')})`)
                    }
                }

                // Add gene region conditions
                const regionConditions = []
                
                if ($('input[name="keepCodingLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('CDS')")
                }
                if ($('input[name="keepFiveUTRLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('5\\' UTR')")
                }
                if ($('input[name="keepThreeUTRLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('3\\' UTR')")
                }
                if ($('input[name="keepPromoterLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('promoter')")
                }
                if ($('input[name="keepIntronLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('intron')")
                }
                if ($('input[name="keepIntergenicLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('intergenic')")
                }
                if ($('input[name="keepNonCodingExonLoci"]').prop('checked')) {
                    regionConditions.push("UPPER(GencodeGeneRegion) = UPPER('exon')")
                }
                if ($('input[name="keepLociThatOverlapDiseaseAssociatedLoci"]').prop('checked')) {
                    regionConditions.push("DiseaseInfo IS NOT NULL")
                }
                if ($('input[name="keepLociThatOverlapLocusSet"]').prop('checked')) {
                    const locusSetType = $('#overlap-locus-set-dropdown').dropdown('get value')
                    if (locusSetType === 'gangstr_v17') {
                        regionConditions.push("FoundInGangSTRCatalog = 1")
                    }
                }

                if (regionConditions.length > 0) {
                    conditions.push(`(${regionConditions.join(' OR ')})`)
                }
            }

            //retrieve all required columns for the visible columns
            let selectedColumns = [
                'LocusId',
                'ReferenceRegion',
                'DiseaseInfo',
            ]

            //add the visible columns to the selected columns
            const visibleColumns = GLOBAL_PAGE_STATE['showColumns'].split(SHOW_COLUMNS_VALUE_DELIMITER)
            Object.entries(RESULTS_TABLE_COLUMN_NAMES).forEach(([columnId, columnName]) => {
                if (visibleColumns.includes(columnId)) {
                    const columnObject = TABLE_COLUMNS[columnName]
                    columnObject.getRequiredColumns().forEach(column => {
                        if (!selectedColumns.includes(column)) {
                            selectedColumns.push(column)
                        }
                    })
                }
            })

            const sortColumn = GLOBAL_PAGE_STATE['sc']
            const sortDirection = GLOBAL_PAGE_STATE['sd']

            const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : ''
            const sortColumns = TABLE_COLUMNS[sortColumn]?.getSortColumns() || ['chrom', 'start_0based']
            const sortClause = sortColumns.map(column => `${column} ${sortDirection}`).join(', ')

            // For large sequences, use CASE to avoid fetching huge strings (10kb limit)
            const selectClauseColumns = selectedColumns.map(col => {
                if (col === 'ReferenceRepeatSequence' || col === 'ReferenceLeftFlank' || col === 'ReferenceRightFlank') {
                    return `CASE WHEN ReferenceRegionSize <= 10000 THEN ${col} ELSE NULL END AS ${col}`
                }
                return col
            })

            const query = `SELECT ${selectClauseColumns.join(', ')} FROM ${COMPLETE_TABLE_ID} ${whereClause} ORDER BY ${sortClause}`

            const startIndex = GLOBAL_PAGE_STATE['pageSize'] * (GLOBAL_PAGE_STATE['currentPage'] - 1)
            const pageSize = GLOBAL_PAGE_STATE['pageSize']

            window.lastSearchConditions = conditions
            window.lastSearchSortClause = sortClause

            window.searchResults = await queryBigQuery(query, startIndex, pageSize, null, null)

            // Reset navigation index for new search results
            window.igvNavIndex = 0

            // Remove loading indicator and placeholder before showing results
            $('#loading-container').hide()

            GLOBAL_PAGE_STATE['searchQuery'] = searchQuery

            GLOBAL_PAGE_STATE['sourceCatalog'] = $('#source-catalog-dropdown').dropdown('get value')

            GLOBAL_PAGE_STATE['keepMotifSize'] = $('#motif-size-input').val()
            GLOBAL_PAGE_STATE['keepMotif'] = $('#motif-input').val()

            GLOBAL_PAGE_STATE['keepCodingLoci'] = $('input[name="keepCodingLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepFiveUTRLoci'] = $('input[name="keepFiveUTRLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepThreeUTRLoci'] = $('input[name="keepThreeUTRLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepPromoterLoci'] = $('input[name="keepPromoterLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepIntronLoci'] = $('input[name="keepIntronLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepIntergenicLoci'] = $('input[name="keepIntergenicLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepNonCodingExonLoci'] = $('input[name="keepNonCodingExonLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepLociThatOverlapDiseaseAssociatedLoci'] = $('input[name="keepLociThatOverlapDiseaseAssociatedLoci"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepLociThatOverlapLocusSet'] = $('input[name="keepLociThatOverlapLocusSet"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['keepLociThatOverlapLocusSetSelection'] = $('#overlap-locus-set-dropdown').dropdown('get value')

            GLOBAL_PAGE_STATE['polymorphismFilter'] = $('input[name="polymorphismFilter"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['polymorphismFilterType'] = $('#polymorphism-filter-dropdown').dropdown('get value')
            GLOBAL_PAGE_STATE['polymorphismThreshold'] = $('input[name="polymorphismThreshold"]').val()
            GLOBAL_PAGE_STATE['vcFilter'] = $('input[name="vcFilter"]').prop('checked') ? 1 : 0
            GLOBAL_PAGE_STATE['vcFilterType'] = $('#variation-cluster-filter-dropdown').dropdown('get value')
            writePersistentPageStateToUrl()

            displaySearchResults()

            updatePaginationControls()
            updateIgvNavButtons()
            
        } catch (error) {
            console.error('Error performing search:', error)
            $('#loading-container').hide()
            displayError('Error performing search: ' + error.message)
        } finally {
            $('body').css('cursor', 'default')
            $('#results-table').show()
            $('#results-table').removeClass('loading')
        }
    }

    // "About" modal
    ['whats-new', 'faq', 'downloads', 'about'].forEach(prefix => {
        $(`#${prefix}-link`).click((e) => {
            e.preventDefault()
            $(`#${prefix}-modal`).modal('show')
        })
    })

    const toggleAdvancedSearch = () => {
        GLOBAL_PAGE_STATE['showAdvFilters'] = (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) ? 0 : 1
        writePersistentPageStateToUrl()

        if (GLOBAL_PAGE_STATE['showAdvFilters'] === 1) {
            $('#advanced-search-form').slideDown(300)
            $('#filter-button .filter.icon').removeClass('rotated')

            $('select[name="sourceCatalog"]').val(GLOBAL_PAGE_STATE['sourceCatalog'])
            $('#source-catalog-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['sourceCatalog'])
            $('select[name="polymorphismFilterType"]').val(GLOBAL_PAGE_STATE['polymorphismFilterType'])
            $('#polymorphism-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['polymorphismFilterType'])
            $('input[name="polymorphismThreshold"]').val(GLOBAL_PAGE_STATE['polymorphismThreshold'])
            $('select[name="vcFilterType"]').val(GLOBAL_PAGE_STATE['vcFilterType'])
            $('#variation-cluster-filter-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['vcFilterType'])
            $('select[name="keepLociThatOverlapLocusSetSelection"]').val(GLOBAL_PAGE_STATE['keepLociThatOverlapLocusSetSelection'])
            $('#overlap-locus-set-dropdown').dropdown('set selected', GLOBAL_PAGE_STATE['keepLociThatOverlapLocusSetSelection'])

        } else {
            $('#advanced-search-form').slideUp(300)
            $('#filter-button .filter.icon').addClass('rotated')
        }
    }

        // "filter" button click handler
    $('#filter-button').click(toggleAdvancedSearch)

    // handle search
    const validateMotifSizeInput = (input) => {
        if (!input) return true; // Empty input is valid
        
        // First validate the overall format - only allow numbers, commas, and hyphens
        if (!/^[-\d\s,]+$/.test(input)) return false;
        
        const values = input.split(',').map(v => v.trim()).filter(v => v !== '');
        
        for (const value of values) {
            // Check for open-ended ranges like "15-"
            const openEndedMatch = value.match(/^(\d+)-$/);
            if (openEndedMatch) {
                const min = parseInt(openEndedMatch[1]);
                if (isNaN(min) || min < 1) return false;
                continue;
            }
            
            // Check for ranges like "2-6"
            const rangeMatch = value.match(/^(\d+)-(\d+)$/);
            if (rangeMatch) {
                const min = parseInt(rangeMatch[1]);
                const max = parseInt(rangeMatch[2]);
                if (isNaN(min) || isNaN(max) || min < 1 || max < min) return false;
                continue;
            }
            
            // Check for single numbers
            const singleNumber = parseInt(value);
            if (isNaN(singleNumber) || singleNumber < 1) return false;
        }
        
        return true;
    };

    const validateMotifInput = (input) => {
        if (!input) return true; // Empty input is valid
        
        const motifs = input.split(',').map(m => m.trim()).filter(m => m !== '');
        
        for (const motif of motifs) {
            // Check if motif contains only valid DNA characters (A,C,G,T,N, case insensitive)
            if (!/^[ACGTNacgtn]+$/.test(motif)) {
                return false;
            }
        }
        
        return true;
    };

    const validateForm = () => {

        // Validate motif size input
        const motifSizeInput = $('#motif-size-input').val();
        if (!validateMotifSizeInput(motifSizeInput)) {
            // Ensure advanced search form is visible
            if (GLOBAL_PAGE_STATE['showAdvFilters'] !== 1) {
                toggleAdvancedSearch()
            }
            $('#form-error-message').html('<b>ERROR:</b> Invalid motif size filter. Please specify motif sizes or size ranges like: 3, 2-6, 7-').show();
            $('#motif-size-input').closest('.field').addClass('error');
            return false;
        } else {
            $('#motif-size-input').closest('.field').removeClass('error');
        }   

        // Validate motif input
        const motifInput = $('#motif-input').val();
        if (!validateMotifInput(motifInput)) {
            // Ensure advanced search form is visible
            if (GLOBAL_PAGE_STATE['showAdvFilters'] !== 1) {
                toggleAdvancedSearch()
            }
            $('#form-error-message').html('<b>ERROR:</b> Invalid motif filter. Motifs should only contain A, C, G, T, or N').show();
            $('#motif-input').closest('.field').addClass('error');
            return false;
        } else {
            $('#motif-input').closest('.field').removeClass('error');
        }

        // Validate polymorphism threshold input
        if ($('input[name="polymorphismFilter"]').prop('checked')) {
            const polymorphismFilterType = $('#polymorphism-filter-dropdown').dropdown('get value')
            const polymorphismThreshold = $('#polymorphism-threshold').val();

            if (!polymorphismFilterType || isNaN(polymorphismThreshold) || parseFloat(polymorphismThreshold) < 0) {
                // Ensure advanced search form is visible
                if (GLOBAL_PAGE_STATE['showAdvFilters'] !== 1) {
                    toggleAdvancedSearch()
                }
                if (!polymorphismFilterType) {
                    $('#form-error-message').html('<b>ERROR:</b> Nothing selected in the polymorphism filter dropdown').show();
                } else {
                    $('#form-error-message').html(`<b>ERROR:</b> The polymorphism filter value '${polymorphismThreshold}' is invalid`).show();
                }
                $('#polymorphism-threshold').closest('.field').addClass('error');
                return false;
            } else {
                $('#polymorphism-threshold').closest('.field').removeClass('error');
            }
        }

        // Validate variation cluster filter
        if ($('input[name="vcFilter"]').prop('checked')) {
            const variationClusterFilterType = $('#variation-cluster-filter-dropdown').dropdown('get value')
            if (!variationClusterFilterType) {
                $('#form-error-message').html('<b>ERROR:</b> Nothing selected in the variation cluster filter dropdown').show();
                $('#variation-cluster-filter-dropdown').closest('.field').addClass('error');
                return false;
            } else {
                $('#variation-cluster-filter-dropdown').closest('.field').removeClass('error');
            }
        }

        // Clear any form errors
        $('#form-error-message').hide();
        $('.field.error').removeClass('error');
        return true;
    }        

    function showPolymorphismDialog() {
        const row = $(this).data()

        for (const key of REQUIRED_DATA_COLUMNS_FOR_POLYMORPHISM_COLUMN) {
            //because data embedded in html data-.. attributes has lower-case keys
            const lowerCaseKey = key.toLowerCase()
            if (row[lowerCaseKey] != null) {
                row[key] = row[lowerCaseKey]
            }
        }

        const polymorphismDialogContent = generatePolymorphismDialogContent(row)
        $('#polymorphism-dialog-header').html(`${row.ReferenceMotif} repeats &nbsp; @ &nbsp; ${row.ReferenceRegion}`)
        $('#polymorphism-dialog-content').html('')
        $('#polymorphism-dialog-content').html(polymorphismDialogContent.replace(/\s+/g, ' ').trim())

        renderChartsInPolymorphismDialog(row)

        $('#polymorphism-dialog').modal('show')

        $('.question').popup({ on: 'click' })

    }

    const handleSearch = async (event) => {
        event.preventDefault()

        if (!validateForm()) {
            return;
        }

        GLOBAL_PAGE_STATE['currentPage'] = 1

        // update igvLoc if the first value in the search query is a region or locus id
        let searchQuery = $('#search-query').val()
        if (searchQuery) {
            const searchItem = splitSearchQuery(searchQuery)[0]
            const regionMatch = searchItem.match(REFERENCE_REGION_REGEXP)
            if (regionMatch) {
                GLOBAL_PAGE_STATE['igvLoc'] = searchItem
            } else {
                const locusIdMatch = searchItem.match(LOCUS_ID_REGEXP)
                if (locusIdMatch) {
                    let [_, chrom, start_0based, end_1based, __] = locusIdMatch
                    GLOBAL_PAGE_STATE['igvLoc'] = `${chrom}:${start_0based}-${end_1based}`
                }
            }
        }

        await performSearch(false)
    }

    $('#search-form').submit(handleSearch)
    $('#advanced-search-form').submit(handleSearch)
    $('#advanced-search-form').find('input').keypress((e) => {
        if (e.which === 13) {
            e.preventDefault()
            handleSearch(e)
        }
    })

    // Initialize source catalog dropdown
    $('#source-catalog-dropdown').dropdown()
    
    // Polymorphism filter dropdown
    $('#polymorphism-filter-dropdown').dropdown({
        onShow: function() {
            $(this).css('z-index', 10001)
        },
        onHide: function() {
            $(this).css('z-index', '')
        },
        onChange: (value) => {
            if (value) {
                $('input[name="polymorphismFilter"]').prop('checked', true)
            }
        }
    })

    // Add event handler for variation cluster filter dropdown
    $('#variation-cluster-filter-dropdown').dropdown({
        onShow: function() {
            $(this).css('z-index', 10001)
        },
        onHide: function() {
            $(this).css('z-index', '')
        },
        onChange: (value) => {
            if (value) {
                $('input[name="vcFilter"]').prop('checked', true)
            }
        }
    })

    // Add event handler for overlap locus set filter dropdown
    $('#overlap-locus-set-dropdown').dropdown({
        onShow: function() {
            $(this).css('z-index', 10001)
        },
        onHide: function() {
            $(this).css('z-index', '')
        },
        onChange: (value) => {
            if (value) {
                $('input[name="keepLociThatOverlapLocusSet"]').prop('checked', true)
            }
        }
    })

    $('#known-disease-motifs-link').click((e) => {
        e.preventDefault()

        $('#motif-input').val(MOTIFS_AT_KNOWN_DISEASE_ASSOCIATED_LOCI)
    })

    // handle browser forward & back buttons
    window.addEventListener('popstate', readAndApplyPersistentPageStateFromUrl)

    // init ui elements
    $('.ui.button').popup()
    $(".ui.checkbox").checkbox()


    $(document).ready(async () => {

        await readAndApplyPersistentPageStateFromUrl()

        console.log("Done initializing page. GLOBAL_PAGE_STATE:", GLOBAL_PAGE_STATE)
        $('body').css('cursor', 'default')
    })

</script>

</body>
</html>
